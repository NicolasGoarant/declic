<%# app/views/shared/_navbar.html.erb %>
<main class="main-content <%= content_for?(:main_classes) ? yield(:main_classes) : '' %>">
  <%= yield %>
</main>

<header class="fixed inset-x-0 top-0 z-[1000] bg-white border-b border-gray-200 shadow-sm">
  <div class="mx-auto max-w-6xl h-14 px-4 flex items-center justify-between">
    <!-- Logo -->
    <%= link_to root_path, class: "flex items-center gap-2" do %>
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-fuchsia-600 via-purple-600 to-indigo-600 grid place-content-center shadow-sm">
        <span class="text-white font-bold text-xs">D</span>
      </div>
      <span class="font-semibold">Déclic</span>
    <% end %>

    <!-- Liens desktop -->
    <nav class="hidden md:flex items-center gap-6 text-sm">
      <%= link_to "Explorer",    root_path(anchor: "explorer"),    class: "hover:text-gray-900" %>
      <%= link_to "Parcours",    root_path(anchor: "parcours"),    class: "hover:text-gray-900" %>
      <%= link_to "Témoignages", root_path(anchor: "temoignages"), class: "hover:text-gray-900" %>
    </nav>

    <!-- CTA desktop -->
    <div class="hidden md:flex items-center">
      <%= link_to "Proposer", new_opportunity_path,
            class: "inline-flex items-center px-3 py-1.5 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm text-sm font-medium" %>
    </div>

    <!-- Burger mobile -->
    <button id="btn-open-menu"
            class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-xl bg-white shadow ring-1 ring-violet-200 hover:ring-violet-300 hover:shadow-md transition"
            aria-controls="mobile-menu" aria-expanded="false" aria-label="Ouvrir le menu">
      <svg viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke-width="2" aria-hidden="true">
        <defs>
          <linearGradient id="burgGrad" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0"  stop-color="#a855f7"/><stop offset="1" stop-color="#6366f1"/>
          </linearGradient>
        </defs>
        <path stroke="url(#burgGrad)" stroke-linecap="round" d="M4 7h16M4 12h16M4 17h16"/>
      </svg>
    </button>
  </div>
</header>

<!-- Menu mobile (BLANC, opaque, au-dessus de Leaflet) -->
<div id="mobile-menu" class="md:hidden hidden" aria-hidden="true">
  <!-- Overlay -->
  <div id="mobile-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-[1px] z-[2000]"></div>

  <!-- Panneau -->
  <div id="mobile-panel"
       class="fixed top-16 right-3 z-[2001] w-[320px] sm:w-[360px]
              rounded-2xl bg-white text-slate-900 shadow-2xl ring-1 ring-black/10
              p-4 pt-10 opacity-0 scale-95 -translate-y-2 transition">

    <!-- Fermer -->
    <button id="btn-close-menu"
            class="absolute right-2 top-2 inline-flex items-center justify-center w-10 h-10 rounded-full
                   bg-gray-100 hover:bg-gray-200 ring-1 ring-gray-300 text-gray-700"
            aria-label="Fermer le menu">✕</button>

    <!-- Liens -->
    <nav class="space-y-2 text-[15px] pt-6">
      <%= link_to root_path(anchor: "explorer"),
          class: "flex items-center gap-3 px-4 py-3 rounded-xl bg-gray-50 hover:bg-gray-100 ring-1 ring-black/5" do %>
        <span>🗺️</span><span>Explorer</span>
      <% end %>

      <%= link_to root_path(anchor: "parcours"),
          class: "flex items-center gap-3 px-4 py-3 rounded-xl bg-gray-50 hover:bg-gray-100 ring-1 ring-black/5" do %>
        <span>🧭</span><span>Parcours</span>
      <% end %>

      <%= link_to root_path(anchor: "temoignages"),
          class: "flex items-center gap-3 px-4 py-3 rounded-xl bg-gray-50 hover:bg-gray-100 ring-1 ring-black/5" do %>
        <span>💬</span><span>Témoignages</span>
      <% end %>

      <div class="pt-2">
        <%= link_to new_opportunity_path,
            class: "w-full inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl
                    bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-700" do %>
          <span>✨</span><span>Proposer une opportunité</span>
        <% end %>
      </div>
    </nav>

    <div class="mt-3 text-gray-500 text-xs">
      © <%= Time.current.year %> Déclic — donnez du sens à votre vie.
    </div>
  </div>
</div>

<script>
/* Menu mobile : compact, OPAQUE, z-index > Leaflet */
(function(){
  const menu   = document.getElementById('mobile-menu');
  const panel  = document.getElementById('mobile-panel');
  const overlay= document.getElementById('mobile-overlay');
  const openB  = document.getElementById('btn-open-menu');
  const closeB = document.getElementById('btn-close-menu');
  if(!menu || !panel || !overlay || !openB || !closeB) return;

  const lock = () => document.documentElement.classList.add('overflow-hidden');
  const unlock = () => document.documentElement.classList.remove('overflow-hidden');

  function open(){
    if(!menu.classList.contains('hidden')) return;
    menu.classList.remove('hidden'); menu.removeAttribute('aria-hidden');
    openB.setAttribute('aria-expanded','true');
    requestAnimationFrame(()=>{ panel.classList.remove('opacity-0','scale-95','-translate-y-2'); });
    document.addEventListener('keydown', onKey);
    overlay.addEventListener('click', close, { once:false });
    lock();
  }
  function close(){
    if(menu.classList.contains('hidden')) return;
    panel.classList.add('opacity-0','scale-95','-translate-y-2');
    const onEnd = () => {
      menu.classList.add('hidden'); menu.setAttribute('aria-hidden','true');
      panel.removeEventListener('transitionend', onEnd);
    };
    panel.addEventListener('transitionend', onEnd, { once:true });
    openB.setAttribute('aria-expanded','false');
    document.removeEventListener('keydown', onKey);
    overlay.removeEventListener('click', close);
    unlock();
  }
  function onKey(e){ if(e.key === 'Escape') close(); }

  openB.addEventListener('click', open);
  closeB.addEventListener('click', close);
  document.addEventListener('turbo:before-cache', close);
})();
</script>
