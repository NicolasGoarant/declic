<%# app/views/opportunities/show.html.erb â€” version stable (fix marges & responsive chips) %>
<% content_for :main_classes, "pt-0" %>

<%
# --- Helpers Ruby ---
def safe_attr(obj, *names)
  names.each { |n| return obj.public_send(n) if obj.respond_to?(n) && obj.public_send(n).present? }
  nil
end

def plainify(text)
  text.to_s.gsub(/!\[[^\]]*\]\([^)]+\)/, "").gsub(/\[([^\]]+)\]\((.*?)\)/, '\1').gsub(/[*_`>#]/, "")
      .gsub(/\n+/, " ").squeeze(" ").strip
end

def render_md_light(text)
  t = text.to_s.gsub("\r\n", "\n")

  # 1) SUPPRIMER les images Markdown (Ã©vite l'affichage de "![...](...)")
  t = t.gsub(/!\[[^\]]*\]\((https?:\/\/[^\)]+)\)/i, "")

  # 2) (optionnel mais utile) retirer les URLs Unsplash isolÃ©es
  t = t.gsub(%r{https?://images\.unsplash\.com/\S+}i, "")

  # 3) Titres "###"
  t = t.lines.map { |l| l.sub(/^###\s*(.+)\s*$/, '<h3>\1</h3>') }.join

  # 4) Retirer le gras **...** pour un rendu sobre
  t = t.gsub(/\*\*(.+?)\*\*/, '\1')

  html = simple_format(t, {}, wrapper_tag: "p")
  html = html.gsub(%r{<p>\s*(<h3>.*?</h3>)\s*</p>}m, '\1')

  sanitize(html, tags: %w[p h3 br a ul ol li em], attributes: %w[href target rel])
end

def extract_source_url(md)
  md[/https?:\/\/[^\s\)]+/]&.strip
end

def extract_when_line(md)
  return nil if md.blank?
  md.each_line do |line|
    s = line.strip
    if s.start_with?("ğŸ—“ï¸") || s =~ /\*\*Quand\s*\?\*\*/i || s =~ /Quand\s*\?/i
      return s.sub(/^ğŸ—“ï¸\s*/,"").sub(/\*\*Quand\s*\?\*\*\s*/i,"").sub(/Quand\s*\?\s*/i,"").strip
    end
  end
  md[/(\b(?:lundi|mardi|mercredi|jeudi|vendredi|samedi|dimanche)\b.*?\d{1,2}[:h]\d{2}.*?(?:[â€“-]\s*\d{1,2}[:h]\d{2})?)/i]&.strip
end

def when_text_for(op, desc_md)
  from_md = extract_when_line(desc_md)
  return from_md if from_md.present?
  tc = safe_attr(op, :time_commitment).to_s.strip
  return "Prochain crÃ©neau : #{tc}" if tc =~ /(lundi|mardi|mercredi|jeudi|vendredi|samedi|dimanche|[0-2]?\d[:h][0-5]\d)/i
end

# --- DonnÃ©es ---
cat = safe_attr(@opportunity, :category).to_s
accent1, accent2 = case cat
  when "benevolat" then ["#f43f5e","#ec4899"]
  when "formation" then ["#3b82f6","#38bdf8"]
  when "rencontres" then ["#10b981","#06b6d4"]
  when "entreprendre" then ["#f59e0b","#ef4444"]
  else ["#7e5bef","#3b82f6"]
end

title   = safe_attr(@opportunity, :title, :name) || "OpportunitÃ© locale"
org     = safe_attr(@opportunity, :organization, :organizer)
loc     = safe_attr(@opportunity, :location, :address, :place)
lat     = safe_attr(@opportunity, :latitude, :lat)
lon     = safe_attr(@opportunity, :longitude, :lon)
img     = safe_attr(@opportunity, :image_url, :cover_url) ||
          "https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?q=80&w=1600&auto=format&fit=crop"
desc_md = safe_attr(@opportunity, :description, :details) || ""
desc_plain = plainify(desc_md)
when_line  = when_text_for(@opportunity, desc_md)
source_url = extract_source_url(desc_md)
search_q   = [title, org, loc].compact.join(" ")
search_url = "https://www.google.com/search?q=#{ERB::Util.url_encode(search_q)}"
when_display = when_line.presence || "CrÃ©neaux rÃ©guliers â€” voir la page de lâ€™organisateur"

if desc_plain.length < 400
  desc_md += <<~MD

  ### Ã€ quoi Ã§a ressemble ?
  Un temps pratique et bienveillant pour apprendre en faisant, poser tes questions et repartir avec des outils concrets.

  ### Ce que tu feras
  â€¢ Exercices guidÃ©s pas Ã  pas
  â€¢ Ã‰changes entre pairs
  â€¢ Retours personnalisÃ©s
  Ambiance simple, matÃ©riel fourni si besoin.

  ### Pour qui ?
  CurieuxÂ·ses, dÃ©butantÂ·es ou profils en reconversion â€” aucun prÃ©requis technique, juste lâ€™envie dâ€™essayer.
  MD
end
%>

<% content_for :title, title %>
<% content_for :description, desc_plain.truncate(160) %>

<style>
  .op{--a1:<%= accent1 %>;--a2:<%= accent2 %>;color:#0f172a;font-family:"Inter",system-ui,sans-serif;}
  .op .container{max-width:1240px;margin:0 auto;padding:0 28px;}

  /* --- HERO --- */
  .op-hero{position:relative;overflow:hidden;}
  .op-hero::before{
    content:"";position:absolute;inset:0;
    background:url('<%= img %>') center/cover no-repeat;
    filter:saturate(1.05) contrast(1.02) brightness(1.02);
    opacity:.38;
  }
  .op-hero::after{
    content:"";position:absolute;inset:0;
    background:linear-gradient(120deg,color-mix(in srgb,var(--a1) 35%,transparent) 0%,color-mix(in srgb,var(--a2) 35%,transparent) 100%);
  }
  .op-hero-inner{position:relative;z-index:2;padding:108px 0 44px;}

  /* --- BOUTONS/CHIPS --- */
  .chip{
    display:inline-flex;align-items:center;gap:.5rem;
    background:#fff;border:1px solid #e8e8ee;color:#0f172a;
    padding:.55rem .95rem;border-radius:999px;font-weight:700;
    margin:6px;max-width:100%;white-space:normal;
    overflow-wrap:anywhere;line-height:1.25;
  }
  .meta{
    display:flex;flex-wrap:wrap;gap:12px;
    margin-top:14px;margin-bottom:12px;
  }
  @media (max-width:640px){
    .meta{flex-direction:column;align-items:flex-start;}
  }

  /* --- IMAGE --- */
  .op-illu{max-width:910px;margin:32px auto 42px;}
  .op-illu img{width:100%;border-radius:18px;box-shadow:0 10px 28px rgba(0,0,0,.10);}

  /* --- BODY --- */
  .op-section{padding:42px 0;}
  .op-h2{font-family:"Epilogue";font-weight:900;font-size:1.9rem;margin:0 0 1rem;}
  .op-prose h3{font-size:1.18rem;margin:1.1rem 0 .55rem;}
  .op-prose p{line-height:1.72;margin:.7rem 0;}

  /* --- INFOS --- */
  .op-infos{background:#f8f9fb;border:1px solid #e6e8ee;border-radius:14px;padding:22px;
            box-shadow:0 10px 24px rgba(15,23,42,.05);margin-top:22px;}
  .op-infos label{display:block;font-weight:800;color:#64748b;text-transform:uppercase;
                  font-size:.82rem;margin-bottom:.25rem;}
  .op-infos .val{font-weight:700;margin-bottom:.7rem;}
  #map{height:340px;border-radius:12px;margin-top:12px;}
</style>

<div class="op">
  <div class="container" style="padding-top:10px;">
    <%= link_to "â† Retour aux opportunitÃ©s", opportunities_path, style:"color:#{accent1};font-weight:800;text-decoration:none;" %>
  </div>

  <header class="op-hero">
    <div class="container op-hero-inner">
      <span class="chip"><%= cat.present? ? cat.capitalize : "OpportunitÃ©" %></span>
      <h1 style="font-family:'Epilogue';font-weight:900;font-size:clamp(2.3rem,4.6vw,3.3rem);margin:.3rem 0 .6rem;">
        <%= title %>
      </h1>
      <p class="chapo" style="font-weight:600;font-size:1.04rem;max-width:920px;"><%= desc_plain.truncate(220) %></p>

      <div class="meta">
        <span class="chip">ğŸ—“ï¸ <%= when_display %></span>
        <% if extract_when_line(desc_md).blank? && safe_attr(@opportunity,:time_commitment).present? %>
          <span class="chip">Format : <%= safe_attr(@opportunity,:time_commitment) %></span>
        <% end %>
        <% if source_url.present? %>
          <span class="chip"><a href="<%= source_url %>" target="_blank" rel="noreferrer">ğŸ”— Voir la page de lâ€™organisateur</a></span>
        <% else %>
          <span class="chip"><a href="<%= search_url %>" target="_blank" rel="noreferrer">ğŸ” Rechercher lâ€™info</a></span>
        <% end %>
      </div>
    </div>
  </header>

  <div class="op-illu">
    <img src="<%= img %>" alt="">
  </div>

  <section class="op-section">
    <div class="container">
      <h2 class="op-h2">ğŸ“‹ Le projet</h2>
      <div class="op-prose"><%= render_md_light(desc_md) %></div>

      <% if org.present? || loc.present? || (lat && lon) %>
        <div class="op-infos">
          <% if org.present? %><label>ğŸ› Organisation</label><div class="val"><%= org %></div><% end %>
          <% if loc.present? %><label>ğŸ“ Adresse</label><div class="val"><%= loc %></div><% end %>
          <label>ğŸ—“ Date & horaires</label><div class="val"><%= when_display %></div>
          <label>ğŸ”— Lien</label>
          <div class="val">
            <% if source_url.present? %>
              <a href="<%= source_url %>" target="_blank" rel="noreferrer"><%= source_url %></a>
            <% else %>
              <a href="<%= search_url %>" target="_blank" rel="noreferrer">Chercher Â« <%= search_q %> Â»</a>
            <% end %>
          </div>
          <% if lat && lon %><div id="map" data-lat="<%= lat %>" data-lon="<%= lon %>"></div><% end %>
        </div>
      <% end %>
    </div>
  </section>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<% content_for :scripts do %>
<script>
document.addEventListener("turbo:load", initOppMap);
document.addEventListener("DOMContentLoaded", initOppMap);
function initOppMap(){
  const el=document.getElementById("map");
  if(!el||!window.L) return;
  const lat=parseFloat(el.dataset.lat), lon=parseFloat(el.dataset.lon);
  if(isNaN(lat)||isNaN(lon)) return;
  const map=L.map(el,{zoomControl:false,attributionControl:false}).setView([lat,lon],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
  const icon=L.divIcon({
    html:'<div style="width:28px;height:28px;border-radius:999px;border:2px solid #fff;background:<%= accent1 %>;display:flex;align-items:center;justify-content:center;color:#fff;box-shadow:0 1px 6px rgba(0,0,0,.3);font-size:14px;">ğŸ“</div>',
    className:'', iconSize:[28,32], iconAnchor:[14,28]
  });
  L.marker([lat,lon],{icon}).addTo(map);
  setTimeout(()=>map.invalidateSize(),200);
}
</script>
<% end %>
