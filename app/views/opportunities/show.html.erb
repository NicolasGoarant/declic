<%# app/views/opportunities/show.html.erb - Version finale am√©lior√©e %>
<% content_for :main_classes, "pt-0" %>

<%
  is_eco = @opportunity.category.to_s.downcase == "ecologiser"
  opportunity_emoji = (defined?(emoji_for_category) ? emoji_for_category(@opportunity.category) : "‚ú®")

  # Couleurs selon cat√©gorie
  case @opportunity.category.to_s.downcase
  when "benevolat"
    badge_color = "#f43f5e"
    cta_gradient = "linear-gradient(135deg, #fb7185 0%, #f43f5e 100%)"
    btn_gradient = "linear-gradient(to right, #f43f5e, #e11d48)"
  when "ecologiser"
    badge_color = "#10b981"
    cta_gradient = "linear-gradient(135deg, #34d399 0%, #10b981 100%)"
    btn_gradient = "linear-gradient(to right, #10b981, #059669)"
  when "formation"
    badge_color = "#3b82f6"
    cta_gradient = "linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)"
    btn_gradient = "linear-gradient(to right, #3b82f6, #2563eb)"
  when "rencontres"
    badge_color = "#f59e0b"
    cta_gradient = "linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)"
    btn_gradient = "linear-gradient(to right, #f59e0b, #d97706)"
  when "entreprendre"
    badge_color = "#fb923c"
    cta_gradient = "linear-gradient(135deg, #fb923c 0%, #f97316 100%)"
    btn_gradient = "linear-gradient(to right, #fb923c, #ea580c)"
  else
    badge_color = "#6366f1"
    cta_gradient = "linear-gradient(135deg, #818cf8 0%, #6366f1 100%)"
    btn_gradient = "linear-gradient(to right, #6366f1, #4f46e5)"
  end

  # Logique image : priorit√© √† l'upload, puis URL externe, puis fallback
  hero_img = nil

  # 1. Priorit√© √† l'upload Active Storage
  if @opportunity.respond_to?(:image) && @opportunity.image.attached?
    hero_img = url_for(@opportunity.image) rescue nil
  # 2. Sinon, URL externe
  elsif @opportunity.respond_to?(:image_url) && @opportunity.image_url.present?
    hero_img = @opportunity.image_url
  end

  # 3. Fallback par d√©faut si rien
  hero_img ||= "https://images.unsplash.com/photo-1542838132-92c53300491e?w=1200&q=80"
%>

<style>
.opp-wrap { background: linear-gradient(135deg, rgba(255,237,213,0.3) 0%, rgba(254,243,199,0.2) 50%, rgba(253,230,138,0.15) 100%); min-height: 100vh; padding-bottom: 5rem; }
.opp-container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }

/* Header */
.opp-hero { background: white; padding: 1rem 0; }
.opp-badge { display: inline-flex; align-items: center; gap: 0.375rem; background: <%= badge_color %>; color: white; padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; margin-bottom: 0.5rem; }
.opp-date { color: #64748b; font-size: 0.75rem; margin-left: 0.5rem; }
.opp-title { font-size: 1.75rem; font-weight: 900; color: #0f172a; margin: 0.75rem 0; line-height: 1.2; }
.opp-back { display: inline-flex; align-items: center; gap: 0.25rem; color: #334155; font-size: 0.875rem; font-weight: 600; text-decoration: none; margin-bottom: 0.5rem; }
.opp-back:hover { color: #0f172a; }
.opp-location { display: flex; align-items: center; gap: 0.375rem; color: #334155; font-size: 0.875rem; margin: 0.5rem 0; }

.opp-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; margin: 1rem 0; }
.opp-chip { display: inline-flex; align-items: center; gap: 0.375rem; background: white; border: 1px solid #e2e8f0; border-radius: 9999px; padding: 0.375rem 0.75rem; font-size: 0.75rem; font-weight: 600; color: #334155; }
.opp-chip.free { background: #dcfce7; border-color: #86efac; color: #166534; }
.opp-chip.format { background: #dbeafe; border-color: #93c5fd; color: #1e40af; }

/* Galerie photo */
.opp-gallery { margin: 1rem 0 2rem; }
.opp-gallery-main { background: #e5e7eb; border-radius: 1rem; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15); aspect-ratio: 16/9; width: 100%; }
.opp-gallery-main img { width: 100%; height: 100%; object-fit: cover; }
.opp-gallery-placeholder { display: flex; align-items: center; justify-content: center; color: #9ca3af; font-style: italic; font-size: 0.875rem; height: 100%; padding: 1rem; text-align: center; }

@media (max-width: 768px) {
  .opp-title { font-size: 1.5rem; }
}

/* Grid */
.opp-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; padding: 1.5rem 0; }
@media (min-width: 1024px) {
  .opp-grid { grid-template-columns: 1fr 420px; }
}

/* Cards */
.opp-card { background: white; border: 2px solid #cbd5e1; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1rem; }
.opp-card-title { font-size: 1.125rem; font-weight: 800; color: #0f172a; margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.5rem; }

/* Description avec texte plus gros et gras */
.opp-text { font-size: 1rem; color: #1e293b; line-height: 1.7; font-weight: 500; }
.opp-text p { margin: 0.75rem 0; }
.opp-text strong, .opp-text b { font-weight: 700; color: #0f172a; }

/* Statistiques d'impact */
.opp-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.25rem; background: #f7fafc; border-radius: 0.75rem; padding: 1.75rem; margin: 1.75rem 0; }
.opp-stat { text-align: center; }
.opp-stat-number { font-size: 2.25rem; font-weight: 700; color: <%= badge_color %>; display: block; line-height: 1; }
.opp-stat-label { color: #475569; font-size: 0.875rem; margin-top: 0.5rem; font-weight: 500; }

/* Citation / T√©moignage */
.opp-quote { background: #f7fafc; border-left: 4px solid <%= badge_color %>; padding: 1.5rem 1.75rem; margin: 1.75rem 0; font-style: italic; font-size: 1.05rem; color: #2d3748; border-radius: 0 0.5rem 0.5rem 0; line-height: 1.7; }
.opp-quote-author { margin-top: 0.75rem; font-style: normal; font-weight: 700; font-size: 0.9rem; color: #475569; }

/* D√©fis surmont√©s */
.opp-challenge { background: #fff5f5; border-left: 4px solid #fc8181; padding: 1.5rem; margin: 1.75rem 0; border-radius: 0 0.5rem 0.5rem 0; }
.opp-challenge-title { color: #c53030; margin-bottom: 1rem; font-size: 1.05rem; font-weight: 800; display: flex; align-items: center; gap: 0.5rem; }
.opp-challenge ul { margin-left: 1.5rem; color: #475569; }
.opp-challenge li { margin: 0.75rem 0; font-size: 0.95rem; line-height: 1.6; }
.opp-challenge li strong { color: #0f172a; }

/* Fais ton D√©clic - Sidebar avec couleur dynamique */
.opp-cta { background: <%= cta_gradient %>; border-radius: 1rem; padding: 1.25rem; color: white; margin-bottom: 1rem; }
.opp-cta-title { font-size: 1.125rem; font-weight: 800; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
.opp-cta-subtitle { font-size: 0.875rem; margin-bottom: 1rem; opacity: 0.95; }
.opp-cta-item { display: flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; }
.opp-cta-btn { display: block; width: 100%; text-align: center; background: white; color: <%= badge_color %>; padding: 0.875rem; border-radius: 0.75rem; font-size: 1.125rem; font-weight: 800; text-decoration: none; margin-bottom: 0.75rem; border: none; cursor: pointer; }
.opp-cta-btn:hover { opacity: 0.95; transform: translateY(-1px); transition: all 0.2s; }
.opp-cta-actions { display: flex; gap: 0.5rem; }
.opp-cta-action { flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.375rem; background: rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 0.5rem; font-size: 0.75rem; font-weight: 600; border: none; color: white; cursor: pointer; text-decoration: none; }
.opp-cta-action:hover { background: rgba(255,255,255,0.3); }

/* Appels √† l'action violets */
.opp-action-section { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); border-radius: 1rem; padding: 2rem; text-align: center; margin: 2rem 0; color: white; }
.opp-action-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 1rem; }
.opp-action-subtitle { font-size: 1rem; margin-bottom: 1.5rem; opacity: 0.95; }
.opp-action-buttons { display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap; }
.opp-action-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.875rem 1.5rem; border-radius: 0.75rem; font-weight: 700; font-size: 0.95rem; text-decoration: none; transition: all 0.2s; border: none; cursor: pointer; }
.opp-action-btn.primary { background: white; color: #9333ea; }
.opp-action-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
.opp-action-btn.secondary { background: transparent; color: white; border: 2px solid white; }
.opp-action-btn.secondary:hover { background: rgba(255,255,255,0.1); }

/* Partage social */
.opp-share { background: #f7fafc; border-radius: 0.75rem; padding: 1.5rem; text-align: center; margin: 2rem 0; }
.opp-share-title { font-size: 1rem; font-weight: 700; color: #0f172a; margin-bottom: 1.25rem; }
.opp-share-buttons { display: flex; gap: 0.625rem; justify-content: center; flex-wrap: wrap; }
.opp-share-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; border-radius: 0.625rem; text-decoration: none; color: white; font-weight: 600; font-size: 0.875rem; transition: opacity 0.2s; border: none; cursor: pointer; }
.opp-share-btn:hover { opacity: 0.85; transform: translateY(-1px); }
.opp-share-btn.facebook { background: #1877f2; }
.opp-share-btn.twitter { background: #1da1f2; }
.opp-share-btn.linkedin { background: #0077b5; }

/* Map */
.opp-map-card { background: white; border: 2px solid #cbd5e1; border-radius: 1rem; overflow: hidden; }
.opp-map { width: 100%; height: 240px; background: #e5e7eb; }
.opp-map-info { padding: 1rem; }
.opp-map-location { display: flex; align-items: start; gap: 0.5rem; margin-bottom: 0.75rem; }
.opp-map-icon { width: 1.25rem; height: 1.25rem; color: #a855f7; flex-shrink: 0; }
.opp-map-title { font-size: 0.875rem; font-weight: 700; color: #0f172a; margin-bottom: 0.25rem; }
.opp-map-address { font-size: 0.75rem; color: #64748b; }
.opp-map-link { display: block; text-align: center; font-size: 0.75rem; color: #a855f7; font-weight: 600; text-decoration: none; }

/* Footer */
.opp-footer { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 2px solid #cbd5e1; padding: 0.75rem; z-index: 50; box-shadow: 0 -4px 12px rgba(0,0,0,0.1); }
.opp-footer-inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; gap: 0.75rem; }
.opp-btn-back { display: inline-flex; align-items: center; gap: 0.375rem; background: white; border: 1px solid #cbd5e1; border-radius: 9999px; padding: 0.5rem 1rem; color: #334155; font-weight: 600; font-size: 0.875rem; text-decoration: none; }
.opp-btn-back:hover { background: #f8fafc; }
.opp-spacer { flex: 1; }
.opp-btn-save { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 9999px; background: white; border: 1px solid #cbd5e1; color: #334155; font-weight: 600; font-size: 0.875rem; cursor: pointer; }
.opp-btn-save:hover { background: #fef3c7; }
.opp-btn-share { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1.25rem; border-radius: 9999px; background: <%= btn_gradient %>; color: white; font-weight: 700; font-size: 0.875rem; text-decoration: none; border: none; cursor: pointer; }
.opp-btn-share:hover { opacity: 0.9; }
</style>

<div class="opp-wrap">
  <div class="opp-hero">
    <div class="opp-container">
      <%= link_to "‚Üê Retour", opportunities_path, class: "opp-back" %>

      <div>
        <span class="opp-badge">
          <span><%= opportunity_emoji %></span>
          <span><%= @opportunity.category %></span>
        </span>
        <span class="opp-date">Publi√©e le <%= l(@opportunity.created_at, format: :long, locale: :fr) %></span>
      </div>

      <h1 class="opp-title">
        <%= opportunity_emoji %> <%= @opportunity.title %>
      </h1>

      <div class="opp-location">
        <svg style="width: 1rem; height: 1rem;" fill="currentColor" viewBox="0 0 24 24">
          <path fill-rule="evenodd" d="M11.54 22.351l.07.04.03.015a.75.75 0 0 0 .72 0l.03-.015.07-.04c.565-.326 1.49-.926 2.43-1.81.94-.883 1.86-2.01 2.43-3.346.57-1.337.86-2.98.86-4.84a6 6 0 1 0-12 0c0 1.86.29 3.503.86 4.84.57 1.336 1.49 2.463 2.43 3.346.94.884 1.865 1.484 2.43 1.81ZM12 13.5a2.25 2.25 0 1 0 0-4.5 2.25 2.25 0 0 0 0 4.5Z" clip-rule="evenodd"/>
        </svg>
        <span><%= @opportunity.location %></span>
      </div>

      <div class="opp-chips">
        <span class="opp-chip">‚è±Ô∏è [D]J par semaine</span>
        <span class="opp-chip">‚è∞ 2h</span>
        <span class="opp-chip free">üí∞ Gratuit</span>
        <span class="opp-chip format">üë• D√©butant - En √©quipe</span>
      </div>

      <%# GALERIE PHOTO %>
      <div class="opp-gallery">
        <div class="opp-gallery-main">
          <% if hero_img.present? %>
            <img src="<%= hero_img %>" alt="<%= @opportunity.title %>" loading="lazy">
          <% else %>
            <div class="opp-gallery-placeholder">Photo de l'initiative</div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="opp-container">
    <div class="opp-grid">
      <%# COLONNE PRINCIPALE %>
      <div>
        <%# En quelques mots %>
        <div class="opp-card">
          <h2 class="opp-card-title">üí° En quelques mots</h2>
          <div class="opp-text">
            <%= simple_format(@opportunity.description.gsub(/\*\*(.+?)\*\*/, '<strong>\1</strong>').html_safe) %>
          </div>

          <%# CITATION / T√âMOIGNAGE %>
          <% if @opportunity.quote.present? %>
            <div class="opp-quote">
              <%= @opportunity.quote %>
              <% if @opportunity.quote_author.present? %>
                <div class="opp-quote-author">‚Äî <%= @opportunity.quote_author %></div>
              <% end %>
            </div>
          <% end %>

          <%# STATISTIQUES D'IMPACT %>
          <%
            # Collecter les stats non-vides
            stats = []
            stats << { number: @opportunity.stat_1_number, label: @opportunity.stat_1_label } if @opportunity.stat_1_number.present?
            stats << { number: @opportunity.stat_2_number, label: @opportunity.stat_2_label } if @opportunity.stat_2_number.present?
            stats << { number: @opportunity.stat_3_number, label: @opportunity.stat_3_label } if @opportunity.stat_3_number.present?
            stats << { number: @opportunity.stat_4_number, label: @opportunity.stat_4_label } if @opportunity.stat_4_number.present?
          %>

          <% if stats.any? %>
            <div class="opp-stats">
              <% stats.each do |stat| %>
                <div class="opp-stat">
                  <span class="opp-stat-number"><%= stat[:number] %></span>
                  <span class="opp-stat-label"><%= stat[:label] %></span>
                </div>
              <% end %>
            </div>
          <% end %>

          <%# D√âFIS SURMONT√âS %>
          <div class="opp-challenge">
            <h3 class="opp-challenge-title">üí™ Les d√©fis surmont√©s</h3>
            <ul>
              <li><strong>Trouver un lieu :</strong> N√©gociation avec la mairie pendant 2 mois, puis accord pour une salle municipale gratuite</li>
              <li><strong>Assurance :</strong> Souscription d'une assurance responsabilit√© civile via l'association de quartier (120‚Ç¨/an)</li>
              <li><strong>Mat√©riel :</strong> Appel aux dons qui a permis de collecter outils, fer √† souder et machines √† coudre d'occasion</li>
            </ul>
          </div>
        </div>

        <%# APPELS √Ä L'ACTION VIOLETS %>
        <div class="opp-action-section">
          <h2 class="opp-action-title">Pr√™t¬∑e √† passer √† l'action ?</h2>
          <p class="opp-action-subtitle">Marie partage son exp√©rience et ses conseils pour lancer un Repair Caf√©</p>
          <div class="opp-action-buttons">
            <a href="#" class="opp-action-btn primary">
              üöÄ Lancer mon Repair Caf√©
            </a>
            <a href="mailto:<%= @opportunity.contact_email || 'contact@example.com' %>" class="opp-action-btn secondary">
              üí¨ Contacter Marie
            </a>
            <a href="#" class="opp-action-btn secondary">
              üì• Kit de d√©marrage
            </a>
          </div>
        </div>

        <%# PARTAGE SOCIAL %>
        <div class="opp-share">
          <h3 class="opp-share-title">Partager cette histoire inspirante</h3>
          <div class="opp-share-buttons">
            <button onclick="shareToFacebook()" class="opp-share-btn facebook">
              <svg style="width: 1rem; height: 1rem;" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
              Facebook
            </button>
            <button onclick="shareToTwitter()" class="opp-share-btn twitter">
              <svg style="width: 1rem; height: 1rem;" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
              Twitter
            </button>
            <button onclick="shareToLinkedin()" class="opp-share-btn linkedin">
              <svg style="width: 1rem; height: 1rem;" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
              LinkedIn
            </button>
          </div>
        </div>
      </div>

      <%# SIDEBAR DROITE %>
      <div>
        <%# Carte %>
        <div class="opp-map-card">
          <% if @opportunity.latitude.present? && @opportunity.longitude.present? %>
            <div id="opportunity-map" class="opp-map"
                 data-lat="<%= @opportunity.latitude %>"
                 data-lon="<%= @opportunity.longitude %>"></div>
          <% else %>
            <div class="opp-map"></div>
          <% end %>

          <div class="opp-map-info">
            <div class="opp-map-location">
              <svg class="opp-map-icon" fill="currentColor" viewBox="0 0 24 24">
                <path fill-rule="evenodd" d="M11.54 22.351l.07.04.03.015a.75.75 0 0 0 .72 0l.03-.015.07-.04c.565-.326 1.49-.926 2.43-1.81.94-.883 1.86-2.01 2.43-3.346.57-1.337.86-2.98.86-4.84a6 6 0 1 0-12 0c0 1.86.29 3.503.86 4.84.57 1.336 1.49 2.463 2.43 3.346.94.884 1.865 1.484 2.43 1.81ZM12 13.5a2.25 2.25 0 1 0 0-4.5 2.25 2.25 0 0 0 0 4.5Z" clip-rule="evenodd"/>
              </svg>
              <div>
                <p class="opp-map-title"><%= @opportunity.organization || "Lieu de l'initiative" %></p>
                <p class="opp-map-address"><%= @opportunity.address || @opportunity.location %></p>
              </div>
            </div>
            <a href="https://www.google.com/maps/search/?api=1&query=<%= CGI.escape(@opportunity.location || '') %>"
               target="_blank" class="opp-map-link">Voir sur Google Maps</a>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<%# Footer %>
<div class="opp-footer">
  <div class="opp-footer-inner">
    <%= link_to opportunities_path, class: "opp-btn-back" do %>
      <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      Retour
    <% end %>

    <div class="opp-spacer"></div>

    <button class="opp-btn-save">
      <svg style="width: 1rem; height: 1rem;" fill="currentColor" viewBox="0 0 24 24">
        <path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"/>
      </svg>
      Sauvegarder
    </button>

    <button onclick="shareOpportunity()" class="opp-btn-share">
      <span id="share-icon-footer">üì§</span>
      Partager
    </button>
  </div>
</div>

<script>
// Partage natif
function shareOpportunity() {
  const icon = document.getElementById('share-icon');
  const iconFooter = document.getElementById('share-icon-footer');
  if (navigator.share) {
    navigator.share({
      title: '<%= j(@opportunity.title) %>',
      text: 'D√©couvre cette opportunit√© sur D√©clic !',
      url: window.location.href
    })
    .then(() => {
      if(icon) { icon.textContent='‚úÖ'; setTimeout(()=>icon.textContent='üì§',2000); }
      if(iconFooter) { iconFooter.textContent='‚úÖ'; setTimeout(()=>iconFooter.textContent='üì§',2000); }
    });
  } else {
    navigator.clipboard.writeText(window.location.href).then(() => {
      if(icon) { icon.textContent='‚úÖ'; setTimeout(()=>icon.textContent='üì§',2000); }
      if(iconFooter) { iconFooter.textContent='‚úÖ'; setTimeout(()=>iconFooter.textContent='üì§',2000); }
      alert('Lien copi√© dans le presse-papier !');
    });
  }
}

// Partages r√©seaux sociaux
function shareToFacebook() {
  const url = encodeURIComponent(window.location.href);
  window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=600,height=400');
}

function shareToTwitter() {
  const url = encodeURIComponent(window.location.href);
  const text = encodeURIComponent('<%= j(@opportunity.title) %> sur D√©clic');
  window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank', 'width=600,height=400');
}

function shareToLinkedin() {
  const url = encodeURIComponent(window.location.href);
  window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank', 'width=600,height=400');
}
</script>

<% if @opportunity.latitude.present? && @opportunity.longitude.present? %>
<script>
function initOppMap() {
  var el = document.getElementById('opportunity-map');
  if (!el || el.dataset.mapInited === "1") return;
  var lat = parseFloat(el.dataset.lat), lon = parseFloat(el.dataset.lon);
  if (!lat || !lon) return;
  var map = L.map(el, { scrollWheelZoom: false, zoomControl: false }).setView([lat, lon], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png').addTo(map);
  var icon = L.icon({
    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41], iconAnchor: [12, 41]
  });
  L.marker([lat, lon], {icon: icon}).addTo(map);
  el.dataset.mapInited = "1";
  setTimeout(function() { map.invalidateSize(); }, 200);
}
document.addEventListener("turbo:load", initOppMap);
document.addEventListener("DOMContentLoaded", initOppMap);
</script>
<% end %>
