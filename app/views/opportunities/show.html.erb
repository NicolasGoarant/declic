<%# app/views/opportunities/show.html.erb %>
<% content_for :main_classes, "pt-0" %>

<%
# ---------- 1. CONFIGURATION DU TH√àME ----------
# On d√©finit les couleurs en fonction de la cat√©gorie
# "Ecologiser" a droit √† un traitement de faveur (Vert)
is_eco = @opportunity.category.to_s.downcase == 'ecologiser'

theme = if is_eco
  {
    badge: "bg-emerald-600 text-white",
    title: "text-emerald-700",
    prose_strong: "text-emerald-800",
    btn_gradient: "bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700",
    icon: "text-emerald-600",
    bg_light: "bg-emerald-50",
    border: "border-emerald-100"
  }
else
  # Th√®me par d√©faut (Indigo/Violet)
  {
    badge: "bg-indigo-600 text-white",
    title: "text-indigo-700",
    prose_strong: "text-indigo-800",
    btn_gradient: "bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700",
    icon: "text-indigo-600",
    bg_light: "bg-indigo-50",
    border: "border-indigo-50"
  }
end

# Image de couverture (Fallback)
hero_img = if @opportunity.image_url.present?
   (@opportunity.image_url =~ /\Ahttp/i) ? @opportunity.image_url : asset_path(@opportunity.image_url)
else
  case @opportunity.category.to_s.downcase
  when 'b√©n√©volat' then "https://images.unsplash.com/photo-1559027615-cd4628902d4a?q=80&w=1600&auto=format&fit=crop"
  when 'ecologiser' then "https://images.unsplash.com/photo-1542601906990-b4d3fb7d5fa5?q=80&w=1600&auto=format&fit=crop" # Nature / R√©paration
  when 'emploi/formation' then "https://images.unsplash.com/photo-1524178232363-1fb2b075b655?q=80&w=1600&auto=format&fit=crop"
  else "https://images.unsplash.com/photo-1522202176988-66273c2fd55f?q=80&w=1600&auto=format&fit=crop"
  end
end
%>

<div class="relative w-full h-72 md:h-96 overflow-hidden bg-slate-900">
  <div class="absolute inset-0 bg-cover bg-center opacity-70 transition-transform duration-700 hover:scale-105"
       style="background-image: url('<%= hero_img %>');">
  </div>
  <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/40 to-transparent"></div>

  <div class="absolute inset-0 flex flex-col justify-end pb-12">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl">
        <% if @opportunity.category.present? %>
          <span class="inline-block py-1.5 px-4 rounded-full text-sm font-bold uppercase tracking-wider shadow-sm mb-4 <%= theme[:badge] %>">
            <%= @opportunity.category %>
          </span>
        <% end %>

        <h1 class="text-3xl md:text-5xl font-extrabold text-white leading-tight drop-shadow-lg font-serif">
          <%= @opportunity.title %>
        </h1>

        <% if @opportunity.location.present? %>
          <div class="flex items-center text-white/90 mt-4 font-medium">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            <%= @opportunity.location %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="container mx-auto px-4 -mt-8 relative z-10 pb-24">
  <% if notice.present? %>
    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-8 rounded shadow-sm">
      <p class="font-bold">Succ√®s</p>
      <p><%= notice %></p>
    </div>
  <% end %>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    <div class="lg:col-span-2 space-y-8">
      <div class="bg-white rounded-3xl shadow-xl p-6 md:p-10">

        <h2 class="text-2xl font-bold text-slate-800 mb-6 font-serif flex items-center">
          <span class="text-3xl mr-3">üìÑ</span> De quoi s'agit-il ?
        </h2>

        <div class="prose prose-lg prose-slate max-w-none text-slate-700">
          <%
             raw_desc = @opportunity.description.to_s

             # 1. Suppression des images Markdown ![Alt](url)
             raw_desc = raw_desc.gsub(/!\[[^\]]*\]\([^)]+\)/, '')

             # 2. D√©coupage par titres '###'
             # On split sur le motif "### Titre"
             # Cela cr√©e un tableau : [Intro, Titre1, Contenu1, Titre2, Contenu2...]
             parts = raw_desc.split(/^###\s+(.+)$/)

             # Le premier √©l√©ment est l'intro (texte avant le premier titre)
             intro = parts.shift
          %>

          <%# Affichage de l'intro %>
          <% if intro.present? %>
            <%= simple_format(intro) %>
          <% end %>

          <%# Boucle sur les paires Titre / Contenu %>
          <% parts.each_slice(2) do |title, content| %>
            <div class="mt-8">
              <h3 class="text-xl font-bold mb-3 font-serif <%= theme[:title] %>">
                <%= title %>
              </h3>
              <%= simple_format(content) %>
            </div>
          <% end %>

          <% if raw_desc.blank? %>
            <p class="italic text-slate-400">Aucune description d√©taill√©e fournie.</p>
          <% end %>
        </div>
      </div>

      <div class="mt-8">
        <%= link_to opportunities_path, class: "inline-flex items-center font-semibold hover:underline transition #{theme[:title]}" do %>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path></svg>
          Retour aux opportunit√©s
        <% end %>
      </div>
    </div>

    <div class="lg:col-span-1 space-y-8">

      <div class="bg-white rounded-3xl shadow-lg p-6 border sticky top-24 z-20 <%= theme[:border] %>">
        <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
          üöÄ Passez √† l'action !
        </h3>
        <p class="text-slate-600 mb-6 text-sm">
          Cette opportunit√© vous int√©resse ? Ne la laissez pas passer.
        </p>

        <% if @opportunity.external_url.present? %>
          <%= link_to @opportunity.external_url, target: "_blank", rel: "noopener", class: "block w-full text-center text-white font-bold text-lg py-4 px-6 rounded-xl shadow-md hover:shadow-xl transition-all transform hover:-translate-y-1 #{theme[:btn_gradient]}" do %>
            Je participe ¬† ‚Üí
          <% end %>
          <p class="text-xs text-center text-slate-400 mt-3">
            Lien externe vers le site partenaire
          </p>
        <% else %>
          <div class="bg-slate-100 text-slate-500 p-4 rounded-xl text-center text-sm italic">
            Aucun lien d'inscription direct.
          </div>
        <% end %>
      </div>

      <% if @opportunity.latitude.present? && @opportunity.longitude.present? %>
        <div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-slate-100 z-10">
          <div class="p-5 border-b border-slate-50 bg-slate-50/50">
            <h3 class="font-bold text-slate-800 flex items-center gap-2">
              <span>üìç</span> C'est o√π ?
            </h3>
            <p class="text-sm text-slate-500 mt-1 break-words"><%= @opportunity.location %></p>
          </div>

          <div class="relative w-full bg-slate-100" style="height: 250px;">
            <div id="opportunity-map"
                 class="h-full w-full z-0"
                 data-lat="<%= @opportunity.latitude %>"
                 data-lon="<%= @opportunity.longitude %>">
            </div>
          </div>
           <a href="http://googleusercontent.com/maps.google.com/?q=<%= @opportunity.latitude %>,<%= @opportunity.longitude %>" target="_blank" class="block p-3 text-center bg-slate-50 text-sm font-medium hover:bg-slate-100 transition <%= theme[:title] %>">
            Ouvrir l'itin√©raire dans Google Maps
          </a>
        </div>
      <% end %>

    </div>
  </div>
</div>

<%# SCRIPT CARTE %>
<% if @opportunity.latitude.present? && @opportunity.longitude.present? %>
<script>
  function initOppMap() {
    var el = document.getElementById('opportunity-map');
    if (!el) return;
    if (el.dataset.mapInited === "1") return;

    var lat = parseFloat(el.dataset.lat);
    var lon = parseFloat(el.dataset.lon);

    if (!lat || !lon) return;

    var map = L.map(el, { scrollWheelZoom: false }).setView([lat, lon], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Marqueur : Couleur adapt√©e au th√®me si possible, sinon rouge par d√©faut
    // Ici on garde le rouge pour le contraste de l'action
    var redIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    L.marker([lat, lon], {icon: redIcon}).addTo(map)
      .bindPopup("<b><%= j(@opportunity.title) %></b>");

    el.dataset.mapInited = "1";

    setTimeout(function() { map.invalidateSize(); }, 200);
    requestAnimationFrame(function() { map.invalidateSize(); });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initOppMap);
  } else {
    initOppMap();
  }
  document.addEventListener("turbo:load", initOppMap);
  document.addEventListener("turbo:render", initOppMap);
</script>
<% end %>
