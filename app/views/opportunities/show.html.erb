<%# app/views/opportunities/show.html.erb ‚Äî v7 : UX am√©lior√©e, structure clarifi√©e %>
<% content_for :main_classes, "pt-0" %>

<%
# ---------- Helpers Ruby ----------

def safe_attr(obj, *names)
  names.each { |n| return obj.public_send(n) if obj.respond_to?(n) && obj.public_send(n).present? }
  nil
end

# Nettoie les artefacts Markdown simples pour usage en texte brut
def clean_markdown_artifacts(text)
  return "" if text.blank?
  text.to_s
      .gsub(/\*\*(.+?)\*\*/, '\1')  # **gras** ‚Üí gras
      .gsub(/\*(.+?)\*/, '\1')      # *italique* ‚Üí italique
      .gsub(/_(.+?)_/, '\1')        # _italique_ ‚Üí italique
      .strip
end

# Rendu Markdown l√©ger pour le corps de la fiche
def render_md_light(text)
  return "" if text.blank?
  t = text.to_s.gsub("\r\n", "\n")

  # 0) Supprime les images Markdown pour √©viter les URL brutes
  t = t.gsub(/!\[[^\]]*\]\([^)]+\)/, "")

  # 1) Titres de niveau 3
  t = t.lines.map { |l| l.sub(/^###\s*(.+)\s*$/, '<h3>\1</h3>') }.join

  # 2) Gras
  t = t.gsub(/\*\*(.+?)\*\*/, '<strong>\1</strong>')

  # 3) Italique
  t = t.gsub(/\*(.+?)\*/, '<em>\1</em>')
  t = t.gsub(/_(.+?)_/, '<em>\1</em>')

  # 4) Listes √† puces
  lines   = t.split("\n")
  in_list = false
  result  = []

  lines.each do |line|
    if line.strip.start_with?("‚Ä¢", "-", "*")
      result << "<ul>" unless in_list
      in_list = true
      item = line.strip.sub(/^[‚Ä¢\-\*]\s*/, '')
      result << "<li>#{item}</li>"
    else
      result << "</ul>" if in_list
      in_list = false
      result << line
    end
  end
  result << "</ul>" if in_list

  t = result.join("\n")

  # 5) Paragraphes
  html = simple_format(t, {}, wrapper_tag: "p")
  html = html.gsub(%r{<p>\s*(<h3>.*?</h3>)\s*</p>}m, '\1')
  html = html.gsub(%r{<p>\s*(<ul>.*?</ul>)\s*</p>}m, '\1')

  sanitize(html, tags: %w[p h3 br a ul ol li em strong], attributes: %w[href target rel])
end

def plainify(text)
  text.to_s
      .gsub(/!\[[^\]]*\]\([^)]+\)/, "")
      .gsub(/\[([^\]]+)\]\((.*?)\)/, '\1')
      .gsub(/[*_`>#]/, "")
      .gsub(/\n+/, " ").squeeze(" ").strip
end

# Extrait un lien "source" depuis le Markdown, en √©vitant Unsplash & les images
def extract_source_url(md)
  return nil if md.blank?
  text = md.to_s

  if (m = text.match(/En\s*savoir\s*plus\s*[:Ôºö]\s*(https?:\/\/\S+)/i))
    u = m[1]
    return u unless u =~ %r{(^|\.)unsplash\.com}i
  end

  text = text.gsub(/!$begin:math:display$\[\^$end:math:display$]*\]$begin:math:text$\[\^\)\]\+$end:math:text$/, " ")
  urls = text.scan(%r{https?://[^\s)]+})
  urls.reject! { |u| u =~ %r{(^|\.)unsplash\.com}i }
  urls.reject! { |u| u =~ /\.(?:jpe?g|png|webp|gif)(?:\?|#|$)/i }
  urls.first
end

# Rep√®re une ligne "Quand ?" dans le Markdown
def extract_when_line(md)
  return nil if md.blank?
  md.each_line do |line|
    s = line.strip
    if s.start_with?("üóìÔ∏è") || s =~ /\*\*Quand\s*\?\*\*/i || s =~ /Quand\s*\?/i
      cleaned = s.sub(/^üóìÔ∏è\s*/, "")
                 .sub(/\*\*Quand\s*\?\*\*\s*/i, "")
                 .sub(/Quand\s*\?\s*/i, "")
                 .strip
      return clean_markdown_artifacts(cleaned)
    end
  end

  match = md[/(\b(?:lundi|mardi|mercredi|jeudi|vendredi|samedi|dimanche)\b.*?\d{1,2}[:h]\d{2}.*?(?:[‚Äì-]\s*\d{1,2}[:h]\d{2})?)/i]
  match ? clean_markdown_artifacts(match.strip) : nil
end

def when_text_for(op, desc_md)
  from_md = extract_when_line(desc_md)
  return from_md if from_md.present?

  tc = safe_attr(op, :time_commitment).to_s.strip
  if tc =~ /(lundi|mardi|mercredi|jeudi|vendredi|samedi|dimanche|[0-2]?\d[:h][0-5]\d)/i
    return clean_markdown_artifacts("Prochain cr√©neau : #{tc}")
  end

  nil
end

# ---------- Donn√©es d‚Äôaffichage ----------

cat = safe_attr(@opportunity, :category).to_s
accent1, accent2 = case cat
  when "benevolat"    then ["#f43f5e", "#ec4899"]
  when "formation"    then ["#3b82f6", "#38bdf8"]
  when "rencontres"   then ["#10b981", "#06b6d4"]
  when "entreprendre" then ["#f59e0b", "#ef4444"]
  else                    ["#7e5bef", "#3b82f6"]
end

title = safe_attr(@opportunity, :title, :name) || "Opportunit√© locale"
org   = safe_attr(@opportunity, :organization, :organizer)
loc   = safe_attr(@opportunity, :location, :address, :place)
lat   = safe_attr(@opportunity, :latitude, :lat)
lon   = safe_attr(@opportunity, :longitude, :lon)

img = safe_attr(@opportunity, :image_url, :cover_url) ||
      "https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?q=80&w=1600&auto=format&fit=crop"

desc_md    = safe_attr(@opportunity, :description, :details) || ""
desc_plain = plainify(desc_md)

when_line    = when_text_for(@opportunity, desc_md)
when_display = when_line.presence || "Cr√©neaux r√©guliers ‚Äî voir la page de l‚Äôorganisateur"

source_url = extract_source_url(desc_md)
search_q   = [title, org, loc].compact.join(" ")
search_url = "https://www.google.com/search?q=#{ERB::Util.url_encode(search_q)}"

# Images contextuelles selon la cat√©gorie
contextual_img = case cat
  when "rencontres"
    "https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=1200&q=80&auto=format&fit=crop"
  when "formation"
    "https://images.unsplash.com/photo-1524178232363-1fb2b075b655?w=1200&q=80&auto=format&fit=crop"
  when "benevolat"
    "https://images.unsplash.com/photo-1559027615-cd4628902d4a?w=1200&q=80&auto=format&fit=crop"
  when "entreprendre"
    "https://images.unsplash.com/photo-1552664730-d307ca884978?w=1200&q=80&auto=format&fit=crop"
  else
    "https://images.unsplash.com/photo-1511632765486-a01980e01a18?w=1200&q=80&auto=format&fit=crop"
end
%>

<% content_for :title,       title %>
<% content_for :description, desc_plain.truncate(160) %>

<style>
  .op {
    --a1:<%= accent1 %>;
    --a2:<%= accent2 %>;
    color:#0f172a;
    font-family:"Inter",system-ui,sans-serif;
    background:#fafbfc;
  }
  .op .container {
    max-width:1140px;
    margin:0 auto;
    padding:0 28px;
  }

  /* Hero */
  .op-hero {
    position:relative;
    overflow:hidden;
    min-height:320px;
    background:linear-gradient(135deg,var(--a1) 0%,var(--a2) 100%);
  }
  .op-hero::before {
    content:"";
    position:absolute;
    inset:0;
    background:url('<%= img %>') center/cover no-repeat;
    filter:saturate(1.05) contrast(1.02) brightness(0.96);
    opacity:.32;
  }
  .op-hero-inner {
    position:relative;
    z-index:2;
    padding:clamp(70px,9vw,100px) 0 clamp(50px,6vw,70px);
  }
  .op-hero h1 {
    font-family:"Epilogue";
    font-weight:900;
    font-size:clamp(2.3rem,4.8vw,3.4rem);
    line-height:1.08;
    margin:.5rem 0 1rem;
    color:#fff;
    text-shadow:0 2px 18px rgba(0,0,0,.28);
  }
  .op-hero .chapo {
    font-weight:600;
    font-size:clamp(1.04rem,1.15vw,1.18rem);
    line-height:1.65;
    max-width:780px;
    color:rgba(255,255,255,.96);
    text-shadow:0 1px 6px rgba(0,0,0,.18);
    margin-bottom:1.8rem;
  }

  /* Chips & m√©ta */
  .chip {
    display:inline-flex;
    align-items:center;
    gap:.55rem;
    background:rgba(255,255,255,.93);
    color:#0f172a;
    padding:.7rem 1.15rem;
    border-radius:999px;
    font-weight:800;
    font-size:.92rem;
    margin:6px 8px 6px 0;
    line-height:1.25;
    box-shadow:0 5px 16px rgba(0,0,0,.14);
    border:1px solid rgba(255,255,255,.4);
  }
  .chip a {
    color:inherit;
    text-decoration:none;
  }
  .chip a:hover {
    text-decoration:underline;
  }

  .meta {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:18px;
    align-items:flex-start;
  }

  /* Retour */
  .back-link {
    color:var(--a1);
    font-weight:800;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    gap:.5rem;
    transition:gap .22s ease,color .22s ease;
    padding:16px 0 4px;
  }
  .back-link:hover {
    gap:.75rem;
    color:var(--a2);
  }

  /* Corps de page */
  .op-section {
    padding:clamp(2.6rem,5vw,3.6rem) 0 clamp(3rem,5.5vw,4rem);
  }
  .op-photo img {
    width:100%;
    border-radius:18px;
    border:1px solid #e5e7eb;
    box-shadow:0 14px 34px rgba(15,23,42,.12);
    margin-bottom:clamp(1.8rem,3.5vw,2.3rem);
    object-fit:cover;
  }

  .op-h2 {
    display:flex;
    align-items:center;
    gap:.55rem;
    font-family:"Epilogue";
    font-weight:900;
    font-size:clamp(2rem,3.1vw,2.6rem);
    margin:0 0 1rem;
    color:#0f172a;
  }
  .op-h2 span {
    font-size:1.4rem;
  }

  .op-prose {
    font:500 1.1rem/1.9 "Inter";
    color:#1f2937;
    max-width:780px;
  }
  .op-prose p {
    margin:0 0 1.15rem;
  }
  .op-prose h3 {
    font-family:"Epilogue";
    font-weight:800;
    font-size:1.1rem;
    margin:1.4rem 0 .4rem;
    color:#111827;
  }
  .op-prose ul {
    padding-left:1.1rem;
    margin:0 0 1rem;
  }
  .op-prose li::marker {
    color:var(--a1);
    font-weight:900;
  }

  .op-context-img img {
    width:100%;
    margin:clamp(2rem,4vw,3rem) 0 0;
    border-radius:18px;
    border:1px solid #e5e7eb;
    box-shadow:0 10px 26px rgba(15,23,42,.08);
    object-fit:cover;
  }

  /* Encadr√© infos pratiques */
  .op-infos {
    margin-top:clamp(2.2rem,4vw,3rem);
    padding:1.6rem 1.4rem 1.6rem;
    border-radius:18px;
    border:1px solid #e5e7eb;
    background:#fff;
    box-shadow:0 8px 26px rgba(15,23,42,.06);
  }
  .op-infos label {
    display:flex;
    align-items:center;
    gap:.4rem;
    font:800 .9rem/1 "Epilogue";
    text-transform:uppercase;
    color:#6b7280;
    letter-spacing:.06em;
    margin-top:1rem;
  }
  .op-infos label:first-of-type {
    margin-top:0;
  }
  .op-infos label span {
    font-size:1.1rem;
  }
  .op-infos .val {
    margin-top:.25rem;
    font:600 1.02rem/1.6 "Inter";
    color:#111827;
  }
  .op-infos .val a {
    color:#0b61ff;
    text-decoration:none;
    font-weight:700;
  }
  .op-infos .val a:hover {
    text-decoration:underline;
  }

  #map {
    height:380px;
    width:100%;
    border-radius:16px;
    margin-top:14px;
    box-shadow:0 14px 32px rgba(0,0,0,.12);
  }

  /* CTA final */
  .op-cta {
    background:linear-gradient(135deg,var(--a1),var(--a2));
    color:#fff;
    text-align:center;
    padding:clamp(2.6rem,5vw,3.6rem) 0;
  }
  .op-cta h2 {
    margin:0 0 .6rem;
    font:900 clamp(1.7rem,3vw,2.3rem)/1.1 "Epilogue";
    letter-spacing:-.01em;
  }
  .op-cta p {
    margin:0 0 1.3rem;
    font:600 1.08rem/1.7 "Inter";
  }
  .op-cta .btn {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.45rem;
    padding:.95rem 1.5rem;
    border-radius:999px;
    font:800 1rem/1 "Epilogue";
    text-decoration:none;
    background:#fff;
    color:var(--a1);
    box-shadow:0 8px 26px rgba(0,0,0,.16);
  }
  .op-cta .btn span {
    font-size:1.1rem;
  }

  @media (max-width:640px){
    .op .container { padding:0 18px; }
    .op-hero-inner { padding-top:64px; padding-bottom:52px; }
    .op-infos { padding:1.3rem 1.1rem; }
  }
</style>

<div class="op">
  <div class="container">
    <%= link_to opportunities_path, class: "back-link" do %>
      <span aria-hidden="true">‚Üê</span>
      <span>Retour aux opportunit√©s</span>
    <% end %>
  </div>

    <% if flash[:notice].present? %>
    <div class="container">
      <div class="mt-3 mb-4 rounded-xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-800">
        <%= flash[:notice] %>
      </div>
    </div>
  <% end %>


  <!-- HERO -->
  <header class="op-hero" role="banner">
    <div class="container op-hero-inner">
      <span class="chip"><%= cat.present? ? cat.capitalize : "Opportunit√©" %></span>

      <h1><%= title %></h1>

      <p class="chapo"><%= desc_plain.truncate(210) %></p>

      <div class="meta">
        <% if when_display.present? %>
          <span class="chip">üóìÔ∏è <%= when_display %></span>
        <% end %>

        <% if loc.present? %>
          <span class="chip">üìç <%= loc %></span>
        <% end %>

        <% if org.present? %>
          <span class="chip">üèõ <%= org %></span>
        <% end %>

        <% if source_url.present? %>
          <span class="chip">
            <a href="<%= source_url %>" target="_blank" rel="noreferrer">
              üëâ Voir les infos en ligne
            </a>
          </span>
        <% else %>
          <span class="chip">
            <a href="<%= search_url %>" target="_blank" rel="noreferrer">
              üîé Rechercher ¬´ <%= search_q %> ¬ª
            </a>
          </span>
        <% end %>
      </div>
    </div>
  </header>

  <!-- CONTENU PRINCIPAL -->
  <section class="op-section">
    <div class="container">
      <!-- Photo principale -->
      <div class="op-photo">
        <img src="<%= img %>" alt="<%= title %>" loading="lazy">
      </div>

      <!-- Le projet -->
      <h2 class="op-h2"><span>üìã</span> Le projet</h2>

      <div class="op-prose">
        <%= render_md_light(desc_md) %>
      </div>

      <!-- Illustration contextuelle -->
      <% if contextual_img.present? %>
        <div class="op-context-img">
          <img src="<%= contextual_img %>" alt="Illustration <%= cat.presence || 'opportunit√©' %>" loading="lazy">
        </div>
      <% end %>

      <!-- Infos pratiques -->
      <% if org.present? || loc.present? || (lat && lon) || when_display.present? || source_url.present? %>
        <div class="op-infos">
          <% if org.present? %>
            <label><span>üèõ</span> Organisation</label>
            <div class="val"><%= org %></div>
          <% end %>

          <% if loc.present? %>
            <label><span>üìç</span> Adresse</label>
            <div class="val"><%= loc %></div>
          <% end %>

          <% if when_display.present? %>
            <label><span>üóì</span> Date & horaires</label>
            <div class="val"><%= when_display %></div>
          <% end %>

          <% if source_url.present? || search_url.present? %>
            <label><span>üîó</span> Infos en ligne</label>
            <div class="val">
              <% if source_url.present? %>
                <a href="<%= source_url %>" target="_blank" rel="noreferrer">
                  <%= source_url.truncate(60) %>
                </a>
              <% else %>
                <a href="<%= search_url %>" target="_blank" rel="noreferrer">
                  Rechercher ¬´ <%= search_q %> ¬ª
                </a>
              <% end %>
            </div>
          <% end %>

          <% if lat && lon %>
            <label><span>üó∫Ô∏è</span> Localisation</label>
            <div id="map" data-lat="<%= lat %>" data-lon="<%= lon %>"></div>
          <% end %>
        </div>
      <% end %>
    </div>
  </section>

  <!-- CTA FINAL -->
  <section class="op-cta" aria-label="Passer √† l‚Äôaction">
    <div class="container">
      <h2>Envie de tenter cette opportunit√©&nbsp;?</h2>
      <p>Rapproche-toi de l‚Äôorganisateur pour t‚Äôinscrire, poser tes questions ou conna√Ætre les prochains cr√©neaux.</p>

      <% if source_url.present? %>
        <a href="<%= source_url %>" target="_blank" rel="noreferrer" class="btn">
          <span>üëâ</span><span>Voir la page de l‚Äô√©v√©nement</span>
        </a>
      <% else %>
        <a href="<%= search_url %>" target="_blank" rel="noreferrer" class="btn">
          <span>üîé</span><span>Rechercher plus d‚Äôinfos</span>
        </a>
      <% end %>
    </div>
  </section>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<% content_for :scripts do %>
  <script>
    document.addEventListener("turbo:load", initOppMap);
    document.addEventListener("DOMContentLoaded", initOppMap);

    function initOppMap() {
      const el = document.getElementById("map");
      if (!el || !window.L) return;

      const lat = parseFloat(el.dataset.lat);
      const lon = parseFloat(el.dataset.lon);
      if (isNaN(lat) || isNaN(lon)) return;

      const map = L.map(el, {
        zoomControl: false,
        attributionControl: false
      }).setView([lat, lon], 14);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
      }).addTo(map);

      const icon = L.divIcon({
        html:
          '<div style="width:36px;height:36px;border-radius:999px;border:3px solid #fff;background:<%= accent1 %>;display:flex;align-items:center;justify-content:center;color:#fff;box-shadow:0 6px 16px rgba(0,0,0,.32);font-size:18px;">üìç</div>',
        className: "",
        iconSize: [36, 40],
        iconAnchor: [18, 36]
      });

      L.marker([lat, lon], { icon }).addTo(map);
      setTimeout(() => map.invalidateSize(), 200);
    }
  </script>
<% end %>
