<%# app/views/opportunities/show.html.erb ‚Äî v5 : Photo au bon endroit + texte redondant supprim√© %>
<% content_for :main_classes, "pt-0" %>

<%
# --- Helpers Ruby ---
def safe_attr(obj, *names)
  names.each { |n| return obj.public_send(n) if obj.respond_to?(n) && obj.public_send(n).present? }
  nil
end

# Nettoie TOUS les artefacts Markdown d'une cha√Æne
def clean_markdown_artifacts(text)
  return "" if text.blank?
  text.to_s
      .gsub(/\*\*(.+?)\*\*/, '\1')  # **gras** ‚Üí gras
      .gsub(/\*(.+?)\*/, '\1')       # *italique* ‚Üí italique
      .gsub(/_(.+?)_/, '\1')         # _italique_ ‚Üí italique
      .strip
end

# ‚úÖ Rendu Markdown am√©lior√© - g√®re correctement le gras, italique, listes
def render_md_light(text)
  return "" if text.blank?
  t = text.to_s.gsub("\r\n", "\n")

  # 0) SUPPRIME les images Markdown pour √©viter l'URL brut (![‚Ä¶](‚Ä¶))
  t = t.gsub(/!\[[^\]]*\]\([^)]+\)/, "")

  # 1) Titres de niveau 3
  t = t.lines.map { |l| l.sub(/^###\s*(.+)\s*$/, '<h3>\1</h3>') }.join

  # 2) GRAS : **texte** ‚Üí <strong>texte</strong>
  t = t.gsub(/\*\*(.+?)\*\*/, '<strong>\1</strong>')

  # 3) ITALIQUE : *texte* ou _texte_ ‚Üí <em>texte</em>
  t = t.gsub(/\*(.+?)\*/, '<em>\1</em>')
  t = t.gsub(/_(.+?)_/, '<em>\1</em>')

  # 4) Listes √† puces
  lines = t.split("\n")
  in_list = false
  result = []

  lines.each do |line|
    if line.strip.start_with?("‚Ä¢", "-", "*")
      result << "<ul>" unless in_list
      in_list = true
      item = line.strip.sub(/^[‚Ä¢\-\*]\s*/, '')
      result << "<li>#{item}</li>"
    else
      result << "</ul>" if in_list
      in_list = false
      result << line
    end
  end
  result << "</ul>" if in_list

  t = result.join("\n")

  # 5) Paragraphes simples
  html = simple_format(t, {}, wrapper_tag: "p")
  html = html.gsub(%r{<p>\s*(<h3>.*?</h3>)\s*</p>}m, '\1')
  html = html.gsub(%r{<p>\s*(<ul>.*?</ul>)\s*</p>}m, '\1')

  sanitize(html, tags: %w[p h3 br a ul ol li em strong], attributes: %w[href target rel])
end

def plainify(text)
  text.to_s
      .gsub(/!\[[^\]]*\]\([^)]+\)/, "")
      .gsub(/\[([^\]]+)\]\((.*?)\)/, '\1')
      .gsub(/[*_`>#]/, "")
      .gsub(/\n+/, " ").squeeze(" ").strip
end

def extract_source_url(md)
  return nil if md.blank?
  text = md.to_s

  if (m = text.match(/En\s*savoir\s*plus\s*[:Ôºö]\s*(https?:\/\/\S+)/i))
    u = m[1]
    return u unless u =~ %r{(^|\.)unsplash\.com}i
  end

  text = text.gsub(/!\[[^\]]*\]\([^)]+\)/, " ")
  urls = text.scan(%r{https?://[^\s)]+})
  urls.reject! { |u| u =~ %r{(^|\.)unsplash\.com}i }
  urls.reject! { |u| u =~ /\.(?:jpe?g|png|webp|gif)(?:\?|#|$)/i }
  urls.first
end

def extract_when_line(md)
  return nil if md.blank?
  md.each_line do |line|
    s = line.strip
    if s.start_with?("üóìÔ∏è") || s =~ /\*\*Quand\s*\?\*\*/i || s =~ /Quand\s*\?/i
      cleaned = s.sub(/^üóìÔ∏è\s*/,"")
                 .sub(/\*\*Quand\s*\?\*\*\s*/i,"")
                 .sub(/Quand\s*\?\s*/i,"")
                 .strip
      return clean_markdown_artifacts(cleaned)
    end
  end

  match = md[/(\b(?:lundi|mardi|mercredi|jeudi|vendredi|samedi|dimanche)\b.*?\d{1,2}[:h]\d{2}.*?(?:[‚Äì-]\s*\d{1,2}[:h]\d{2})?)/i]
  match ? clean_markdown_artifacts(match.strip) : nil
end

def when_text_for(op, desc_md)
  from_md = extract_when_line(desc_md)
  return from_md if from_md.present?
  tc = safe_attr(op, :time_commitment).to_s.strip
  if tc =~ /(lundi|mardi|mercredi|jeudi|vendredi|samedi|dimanche|[0-2]?\d[:h][0-5]\d)/i
    return clean_markdown_artifacts("Prochain cr√©neau : #{tc}")
  end
  nil
end

# --- Donn√©es ---
cat = safe_attr(@opportunity, :category).to_s
accent1, accent2 = case cat
when "benevolat"   then ["#f43f5e","#ec4899"]
when "formation"   then ["#3b82f6","#38bdf8"]
when "rencontres"  then ["#10b981","#06b6d4"]
when "entreprendre"then ["#f59e0b","#ef4444"]
else                   ["#7e5bef","#3b82f6"]
end

title = safe_attr(@opportunity, :title, :name) || "Opportunit√© locale"
org   = safe_attr(@opportunity, :organization, :organizer)
loc   = safe_attr(@opportunity, :location, :address, :place)
lat   = safe_attr(@opportunity, :latitude, :lat)
lon   = safe_attr(@opportunity, :longitude, :lon)
img   = safe_attr(@opportunity, :image_url, :cover_url) ||
        "https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?q=80&w=1600&auto=format&fit=crop"
desc_md    = safe_attr(@opportunity, :description, :details) || ""
desc_plain = plainify(desc_md)
when_line  = when_text_for(@opportunity, desc_md)
source_url = extract_source_url(desc_md)
search_q   = [title, org, loc].compact.join(" ")
search_url = "https://www.google.com/search?q=#{ERB::Util.url_encode(search_q)}"
when_display = when_line.presence || "Cr√©neaux r√©guliers ‚Äî voir la page de l'organisateur"

# Images contextuelles selon la cat√©gorie
contextual_img = case cat
when "rencontres"
  "https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=1200&q=80&auto=format&fit=crop"
when "formation"
  "https://images.unsplash.com/photo-1524178232363-1fb2b075b655?w=1200&q=80&auto=format&fit=crop"
when "benevolat"
  "https://images.unsplash.com/photo-1559027615-cd4628902d4a?w=1200&q=80&auto=format&fit=crop"
when "entreprendre"
  "https://images.unsplash.com/photo-1552664730-d307ca884978?w=1200&q=80&auto=format&fit=crop"
else
  "https://images.unsplash.com/photo-1511632765486-a01980e01a18?w=1200&q=80&auto=format&fit=crop"
end

# Petit fallback descriptif si trop court
if desc_plain.length < 400
  desc_md += <<~MD

  ### √Ä quoi √ßa ressemble ?
  Un temps pratique et bienveillant pour apprendre en faisant, poser tes questions et repartir avec des outils concrets.

  ### Ce que tu feras
  ‚Ä¢ Exercices guid√©s pas √† pas
  ‚Ä¢ √âchanges entre pairs
  ‚Ä¢ Retours personnalis√©s

  Ambiance simple, mat√©riel fourni si besoin.

  ### Pour qui ?
  Curieux¬∑ses, d√©butant¬∑es ou profils en reconversion ‚Äî aucun pr√©requis technique, juste l'envie d'essayer.
  MD
end
%>

<% content_for :title, title %>
<% content_for :description, desc_plain.truncate(160) %>

<style>
.op{--a1:<%= accent1 %>;--a2:<%= accent2 %>;color:#0f172a;font-family:"Inter",system-ui,sans-serif;}
.op .container{max-width:1240px;margin:0 auto;padding:0 28px;}

/* HERO */
.op-hero{position:relative;overflow:hidden;min-height:280px;padding-bottom:80px;}
.op-hero::before{content:"";position:absolute;inset:0;background:url('<%= img %>') center/cover no-repeat;filter:saturate(1.05) contrast(1.02) brightness(1.02);opacity:.38;}
.op-hero::after{content:"";position:absolute;inset:0;background:linear-gradient(120deg,color-mix(in srgb,var(--a1) 35%,transparent) 0%,color-mix(in srgb,var(--a2) 35%,transparent) 100%);}
.op-hero-inner{position:relative;z-index:2;padding:clamp(60px, 8vw, 80px) 0 20px;}

/* Chips */
.chip{
  display:inline-flex;align-items:center;gap:.5rem;background:#fff;border:1px solid #e8e8ee;
  color:#0f172a;padding:.6rem 1rem;border-radius:999px;font-weight:700;font-size:.9rem;
  margin:6px 6px 6px 0;line-height:1.2;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.chip:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.12);}
.chip a{color:inherit;text-decoration:none;}

.meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:16px;margin-bottom:0;align-items:flex-start;}
@media (max-width:640px){.meta{gap:6px;}}

/* Image principale - AU-DESSUS DE "LE PROJET" */
.op-photo{max-width:1020px;margin:40px auto 32px;padding:0 28px;}
.op-photo img{width:100%;border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.12);display:block;}

/* Image contextuelle suppl√©mentaire */
.op-context-img{max-width:820px;margin:28px auto;}
.op-context-img img{width:100%;height:280px;object-fit:cover;border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.12);}

/* Sections */
.op-section{padding:0 0 48px;}
.op-h2{font-family:"Epilogue";font-weight:900;font-size:clamp(1.7rem,2.8vw,2.1rem);margin:0 0 1.2rem;color:#0f172a;}
.op-h2::before{content:attr(data-icon);margin-right:.5rem;}

/* Prose am√©lior√©e */
.op-prose{max-width:880px;font-size:1.05rem;line-height:1.75;color:#1e293b;}
.op-prose h3{font-family:"Epilogue";font-weight:900;font-size:1.35rem;margin:1.6rem 0 .7rem;color:#0f172a;}
.op-prose p{margin:.85rem 0;}
.op-prose strong{font-weight:800;color:#0f172a;}
.op-prose em{font-style:italic;color:#475569;}
.op-prose ul{margin:1rem 0;padding-left:1.5rem;}
.op-prose li{margin:.5rem 0;line-height:1.65;}

/* Infos */
.op-infos{
  background:linear-gradient(135deg,#f8f9fb 0%,#fafbfd 100%);
  border:1px solid #e6e8ee;border-radius:18px;padding:28px;
  box-shadow:0 16px 40px rgba(15,23,42,.08);margin-top:32px;
}
.op-infos label{display:block;font-weight:800;color:#64748b;text-transform:uppercase;font-size:.82rem;margin-bottom:.35rem;letter-spacing:.04em;}
.op-infos .val{font-weight:600;margin-bottom:1rem;color:#0f172a;font-size:1.02rem;}
.op-infos .val a{color:var(--a1);text-decoration:none;font-weight:700;}
.op-infos .val a:hover{text-decoration:underline;}

#map{height:360px;border-radius:14px;margin-top:16px;box-shadow:0 12px 28px rgba(0,0,0,.10);}

/* Retour */
.back-link{color:var(--a1);font-weight:800;text-decoration:none;display:inline-flex;align-items:center;gap:.4rem;transition:gap 0.2s ease;}
.back-link:hover{gap:.7rem;}
</style>

<div class="op">
  <div class="container" style="padding-top:14px;">
    <%= link_to opportunities_path, class:"back-link" do %>
      <span>‚Üê</span><span>Retour aux opportunit√©s</span>
    <% end %>
  </div>

  <header class="op-hero">
    <div class="container op-hero-inner">
      <span class="chip"><%= cat.present? ? cat.capitalize : "Opportunit√©" %></span>
      <h1 style="font-family:'Epilogue';font-weight:900;font-size:clamp(2.2rem,4.4vw,3.2rem);line-height:1.1;margin:.4rem 0 .6rem;"><%= title %></h1>
      <p class="chapo" style="font-weight:600;font-size:1.05rem;line-height:1.6;max-width:920px;margin-bottom:16px;"><%= desc_plain.truncate(200) %></p>

      <div class="meta">
        <span class="chip">üóìÔ∏è <%= when_display %></span>
        <% if extract_when_line(desc_md).blank? && safe_attr(@opportunity,:time_commitment).present? %>
          <span class="chip">‚è±Ô∏è <%= clean_markdown_artifacts(safe_attr(@opportunity,:time_commitment)) %></span>
        <% end %>
        <% if source_url.present? %>
          <span class="chip">
            <a href="<%= source_url %>" target="_blank" rel="noreferrer">üîó Page de l'organisateur</a>
          </span>
        <% else %>
          <span class="chip">
            <a href="<%= search_url %>" target="_blank" rel="noreferrer">üîé Rechercher l'info</a>
          </span>
        <% end %>
      </div>
    </div>
  </header>

  <section class="op-section">
    <div class="container">
      <!-- ‚úÖ PHOTO AU-DESSUS DE "LE PROJET" -->
      <div class="op-photo">
        <img src="<%= img %>" alt="<%= title %>" loading="lazy">
      </div>

      <h2 class="op-h2" data-icon="üìã">Le projet</h2>
      <div class="op-prose"><%= render_md_light(desc_md) %></div>

      <!-- Image contextuelle selon la cat√©gorie -->
      <div class="op-context-img">
        <img src="<%= contextual_img %>" alt="Illustration <%= cat %>" loading="lazy">
      </div>

      <% if org.present? || loc.present? || (lat && lon) %>
        <div class="op-infos">
          <% if org.present? %>
            <label>üèõ Organisation</label>
            <div class="val"><%= org %></div>
          <% end %>

          <% if loc.present? %>
            <label>üìç Adresse</label>
            <div class="val"><%= loc %></div>
          <% end %>

          <label>üóì Date & horaires</label>
          <div class="val"><%= when_display %></div>

          <label>üîó Lien</label>
          <div class="val">
            <% if source_url.present? %>
              <a href="<%= source_url %>" target="_blank" rel="noreferrer"><%= source_url %></a>
            <% else %>
              <a href="<%= search_url %>" target="_blank" rel="noreferrer">Chercher ¬´ <%= search_q %> ¬ª</a>
            <% end %>
          </div>

          <% if lat && lon %>
            <label>üó∫Ô∏è Localisation</label>
            <div id="map" data-lat="<%= lat %>" data-lon="<%= lon %>"></div>
          <% end %>
        </div>
      <% end %>
    </div>
  </section>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<% content_for :scripts do %>
<script>
document.addEventListener("turbo:load", initOppMap);
document.addEventListener("DOMContentLoaded", initOppMap);
function initOppMap(){
  const el=document.getElementById("map");
  if(!el||!window.L) return;
  const lat=parseFloat(el.dataset.lat), lon=parseFloat(el.dataset.lon);
  if(isNaN(lat)||isNaN(lon)) return;
  const map=L.map(el,{zoomControl:false,attributionControl:false}).setView([lat,lon],14);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
  const icon=L.divIcon({
    html:'<div style="width:32px;height:32px;border-radius:999px;border:3px solid #fff;background:<%= accent1 %>;display:flex;align-items:center;justify-content:center;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.3);font-size:16px;">üìç</div>',
    className:'', iconSize:[32,36], iconAnchor:[16,32]
  });
  L.marker([lat,lon],{icon}).addTo(map);
  setTimeout(()=>map.invalidateSize(),200);
}
</script>
<% end %>
