<%# app/views/opportunities/show.html.erb %>
<% content_for :main_classes, "pt-0" %>

<%
  is_eco = @opportunity.category.to_s.downcase == "ecologiser"

  theme =
    if is_eco
      {
        badge: "bg-emerald-600 text-white",
        btn:   "bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700",
        icon:  "text-emerald-600",
        border:"border-emerald-100",
        halo:  "from-emerald-500/20 via-teal-500/10 to-transparent"
      }
    else
      {
        badge: "bg-indigo-600 text-white",
        btn:   "bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700",
        icon:  "text-indigo-600",
        border:"border-indigo-100",
        halo:  "from-indigo-500/20 via-purple-500/10 to-transparent"
      }
    end

  opportunity_emoji = (defined?(emoji_for_category) ? emoji_for_category(@opportunity.category) : "‚ú®")

  hero_img =
    if @opportunity.respond_to?(:photo) && @opportunity.photo.attached?
      :attached
    elsif @opportunity.respond_to?(:image_url) && @opportunity.image_url.present?
      @opportunity.image_url
    else
      "https://images.unsplash.com/photo-1522202176988-66273c2fd55f?q=80&w=1600&auto=format&fit=crop"
    end
%>

<div class="relative overflow-hidden">
  <%# --- Fond moins ‚Äústatique / blanc‚Äù --- %>
  <div class="absolute inset-0 bg-gradient-to-br <%= theme[:halo] %>"></div>
  <div class="absolute inset-0 opacity-[0.32]"
       style="background-image: radial-gradient(circle at 1px 1px, rgba(15,23,42,0.10) 1px, transparent 0); background-size: 28px 28px;"></div>

  <%# ---------------- HERO ---------------- %>
  <header class="relative">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 pt-12 pb-10">
      <div class="flex flex-wrap items-center gap-3 text-sm">
        <span class="<%= theme[:badge] %> inline-flex items-center gap-2 px-3 py-1 rounded-full font-semibold shadow-sm">
          <span aria-hidden="true"><%= opportunity_emoji %></span>
          <span><%= @opportunity.category %></span>
        </span>

        <span class="text-slate-500">
          Publi√©e le <%= l(@opportunity.created_at, format: :long, locale: :fr) %>
        </span>
      </div>

      <h1 class="mt-4 text-3xl sm:text-4xl font-extrabold tracking-tight text-slate-900">
        <%= @opportunity.title %>
      </h1>

      <%# retour + chips r√©sum√© %>
      <div class="mt-6 flex flex-wrap items-center gap-3">
        <%= link_to "‚Üê Retour", opportunities_path,
          class: "inline-flex items-center rounded-full bg-white/80 px-4 py-2 text-sm font-semibold text-slate-700 ring-1 ring-slate-200 backdrop-blur hover:bg-white" %>

        <div class="flex flex-wrap gap-2">
          <% if @opportunity.location.present? %>
            <span class="dc-chip">üìç <%= @opportunity.location %></span>
          <% end %>

          <% if @opportunity.starts_at.present? %>
            <span class="dc-chip">
              üóìÔ∏è
              <% if @opportunity.ends_at.present? %>
                Du <%= l(@opportunity.starts_at, format: :short, locale: :fr) %> au <%= l(@opportunity.ends_at, format: :short, locale: :fr) %>
              <% else %>
                <%= l(@opportunity.starts_at, format: :short, locale: :fr) %>
              <% end %>
            </span>
          <% end %>
        </div>
      </div>

      <%# image (moins grosse sur desktop + centr√©e) %>
      <div class="mt-10">
        <div class="lg:max-w-5xl lg:mx-auto">
          <% if hero_img == :attached %>
            <%= cl_image_tag @opportunity.photo.key,
              width: 1600, height: 900, crop: :fill, gravity: :center,
              class: "w-full h-[220px] sm:h-[300px] lg:h-[320px] rounded-3xl shadow-2xl object-cover dc-raise" %>
          <% else %>
            <%= image_tag hero_img,
              class: "w-full h-[220px] sm:h-[300px] lg:h-[320px] rounded-3xl shadow-2xl object-cover dc-raise",
              alt: @opportunity.title %>
          <% end %>
        </div>
      </div>

      <%# s√©parateur doux (rythme) %>
      <div class="mt-12 h-px w-full bg-gradient-to-r from-transparent via-slate-200 to-transparent"></div>
    </div>
  </header>

  <%# ---------------- CONTENU ---------------- %>
  <main class="relative border-t <%= theme[:border] %> bg-gradient-to-b from-slate-50 via-slate-50 to-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-14 sm:py-16">
      <div class="lg:grid lg:grid-cols-3 lg:gap-10 lg:items-start">

        <%# -------- MAIN (2/3) -------- %>
        <section class="lg:col-span-2">
          <div class="dc-card p-7 sm:p-9">
            <div class="flex items-center justify-between gap-4">
              <h2 class="text-xl font-extrabold text-slate-900">
                En savoir plus sur l‚Äôopportunit√©
              </h2>

              <span class="inline-flex items-center gap-2 text-sm font-semibold text-slate-600">
                <span class="inline-block w-2.5 h-2.5 rounded-full <%= is_eco ? "bg-emerald-500" : "bg-indigo-500" %>"></span>
                D√©clic
              </span>
            </div>

            <div class="mt-6 markdown-content prose prose-lg prose-slate max-w-none text-slate-700 leading-relaxed">
              <%= md(@opportunity.description) %>
            </div>
          </div>

          <%# bloc ‚Äúrythme‚Äù (moins statique) %>
          <div class="mt-10 dc-card p-7 sm:p-9">
            <h3 class="text-lg font-extrabold text-slate-900 mb-4">
              √Ä quoi s‚Äôattendre
            </h3>

            <div class="grid sm:grid-cols-2 gap-4">
              <div class="rounded-2xl border border-slate-200 bg-white/70 p-5">
                <div class="text-sm font-extrabold text-slate-900">üéØ Objectif</div>
                <div class="mt-2 text-sm text-slate-600">
                  Comprendre rapidement ce que tu vas faire et pourquoi c‚Äôest utile.
                </div>
              </div>

              <div class="rounded-2xl border border-slate-200 bg-white/70 p-5">
                <div class="text-sm font-extrabold text-slate-900">‚è±Ô∏è Engagement</div>
                <div class="mt-2 text-sm text-slate-600">
                  Dur√©e / niveau d‚Äôimplication : √† pr√©ciser.
                </div>
              </div>
            </div>
          </div>
        </section>

        <%# -------- SIDEBAR (1/3) -------- %>
        <aside class="lg:col-span-1 mt-10 lg:mt-0">
          <div class="sticky top-12 space-y-8">

            <%# Card Map + CTA (script inchang√©; on force juste une hauteur robuste sur le conteneur) %>
            <div class="dc-card overflow-hidden">
              <% if @opportunity.location.present? && @opportunity.latitude.present? %>
                <div id="opportunity-map"
                     class="w-full"
                     style="height: 320px; min-height: 320px; background: #e5e7eb;"
                     data-lat="<%= @opportunity.latitude %>"
                     data-lon="<%= @opportunity.longitude %>"></div>
              <% else %>
                <div class="p-6 text-sm text-slate-600">
                  Carte indisponible (localisation manquante).
                </div>
              <% end %>

              <div class="p-6">
                <% if ext_url_for(@opportunity).present? %>
                  <a href="<%= ext_url_for(@opportunity) %>"
                     target="_blank" rel="noopener nofollow"
                     class="w-full inline-flex items-center justify-center gap-2 px-6 py-3 rounded-2xl text-white font-semibold <%= theme[:btn] %> shadow-lg dc-raise">
                    <span>Acc√©der √† l‚Äôopportunit√©</span>
                    <span aria-hidden="true">‚Üí</span>
                  </a>
                <% else %>
                  <div class="text-sm text-slate-600">
                    Lien externe indisponible pour cette opportunit√©.
                  </div>
                <% end %>
              </div>
            </div>

            <%# Infos pratiques %>
            <div class="dc-card p-6">
              <h2 class="text-base font-extrabold text-slate-900 tracking-tight mb-4">
                Informations pratiques
              </h2>

              <div class="space-y-5">
                <% if @opportunity.location.present? %>
                  <div class="flex items-start gap-3">
                    <div class="mt-0.5">
                      <svg class="w-6 h-6 <%= theme[:icon] %>" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M11.54 22.351l.07.04.03.015a.75.75 0 0 0 .72 0l.03-.015.07-.04c.565-.326 1.49-.926 2.43-1.81.94-.883 1.86-2.01 2.43-3.346.57-1.337.86-2.98.86-4.84a6 6 0 1 0-12 0c0 1.86.29 3.503.86 4.84.57 1.336 1.49 2.463 2.43 3.346.94.884 1.865 1.484 2.43 1.81ZM12 13.5a2.25 2.25 0 1 0 0-4.5 2.25 2.25 0 0 0 0 4.5Z" clip-rule="evenodd"/>
                      </svg>
                    </div>
                    <div>
                      <div class="text-sm font-semibold text-slate-900">Lieu</div>
                      <div class="text-sm text-slate-600"><%= @opportunity.location %></div>
                    </div>
                  </div>
                <% end %>

                <% if @opportunity.starts_at.present? %>
                  <div class="flex items-start gap-3">
                    <div class="mt-0.5">
                      <svg class="w-6 h-6 <%= theme[:icon] %>" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M6.75 2.25a.75.75 0 0 1 .75.75V4.5h9V3a.75.75 0 0 1 1.5 0v1.5h.75A2.25 2.25 0 0 1 21 6.75v12A2.25 2.25 0 0 1 18.75 21H5.25A2.25 2.25 0 0 1 3 18.75v-12A2.25 2.25 0 0 1 5.25 4.5H6V3a.75.75 0 0 1 .75-.75ZM4.5 9v9.75c0 .414.336.75.75.75h13.5a.75.75 0 0 0 .75-.75V9h-15Z" clip-rule="evenodd"/>
                      </svg>
                    </div>
                    <div>
                      <div class="text-sm font-semibold text-slate-900">Date</div>
                      <div class="text-sm text-slate-600">
                        <% if @opportunity.ends_at.present? %>
                          Du <%= l(@opportunity.starts_at, format: :short, locale: :fr) %> au <%= l(@opportunity.ends_at, format: :short, locale: :fr) %>
                        <% else %>
                          Le <%= l(@opportunity.starts_at, format: :long, locale: :fr) %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>

          </div>
        </aside>

      </div>
    </div>
  </main>
</div>

<%# ---------------- SCRIPT CARTE ---------------- %>
<% if @opportunity.latitude.present? && @opportunity.longitude.present? %>
  <script>
    function initOppMap() {
      var el = document.getElementById('opportunity-map');
      if (!el || el.dataset.mapInited === "1") return;

      var lat = parseFloat(el.dataset.lat);
      var lon = parseFloat(el.dataset.lon);
      if (!lat || !lon) return;

      var map = L.map(el, { scrollWheelZoom: false }).setView([lat, lon], 15);

      L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      var icon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      L.marker([lat, lon], {icon: icon}).addTo(map)
        .bindPopup("<b><%= j(@opportunity.title) %></b>");

      el.dataset.mapInited = "1";
      setTimeout(function() { map.invalidateSize(); }, 200);
    }

    document.addEventListener("turbo:load", initOppMap);
    document.addEventListener("turbo:render", initOppMap);
  </script>
<% end %>
