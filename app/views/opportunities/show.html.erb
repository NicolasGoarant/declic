<%# app/views/opportunities/show.html.erb ‚Äî robuste aux attributs manquants, style ‚Äústory‚Äù %>
<% content_for :main_classes, "pt-0" %>

<%
# ---------- Helpers robustes ----------
def pick_attr(record, *names)
  names.find { |n| record.respond_to?(n) && record.public_send(n).present? }&.then { |n| record.public_send(n) }
end

def pick_number(record, *names)
  names.find { |n| record.respond_to?(n) && !record.public_send(n).nil? }&.then { |n| record.public_send(n) }
end

category = @opportunity.respond_to?(:category) ? @opportunity.category.to_s : ""

# Couleurs d‚Äôaccent selon la cat√©gorie
case category
when "benevolat"    then accent1, accent2 = "#f43f5e", "#ec4899"   # rose
when "formation"    then accent1, accent2 = "#3b82f6", "#38bdf8"   # bleu
when "rencontres"   then accent1, accent2 = "#10b981", "#06b6d4"   # vert
when "entreprendre" then accent1, accent2 = "#f59e0b", "#ef4444"   # orange
else                    accent1, accent2 = "#7e5bef", "#3b82f6"    # violet d√©faut
end

title       = pick_attr(@opportunity, :title, :name, :label) || "Opportunit√©"
desc_full   = pick_attr(@opportunity, :description, :summary, :details) || ""
desc_chapo  = strip_tags(desc_full).presence || "Une opportunit√© concr√®te pour agir et s‚Äôimpliquer localement."

# Image de couverture ‚Äî essaye plusieurs colonnes possibles
img_src = pick_attr(@opportunity,
  :image_url, :cover_url, :photo_url, :banner_url, :image, :cover, :photo, :banner
)

img =
  if img_src.present?
    img_src.to_s =~ /\Ahttps?:\/\//i ? img_src : asset_path(img_src)
  else
    "https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?q=80&w=1600&auto=format&fit=crop"
  end

# Infos pratiques
website     = pick_attr(@opportunity, :website, :url, :link)
org         = pick_attr(@opportunity, :organization, :organizer, :org_name, :host, :owner)
location    = pick_attr(@opportunity, :location, :address, :place, :city)
email       = pick_attr(@opportunity, :contact_email, :email)
phone       = pick_attr(@opportunity, :contact_phone, :phone, :telephone, :mobile)
time_need   = pick_attr(@opportunity, :time_commitment, :time_needed, :time_per_week, :workload)

lat         = pick_number(@opportunity, :latitude, :lat)
lon         = pick_number(@opportunity, :longitude, :lon, :lng)

rating      = pick_number(@opportunity, :rating, :score)
org_line    = [org, (rating && "‚òÖ #{rating}")].compact.join(" ‚Ä¢ ")

%>

<% content_for :title, title %>
<% content_for :description, strip_tags(desc_chapo).truncate(160) %>

<style>
  .op-ms{
    --accent1:<%= accent1 %>;
    --accent2:<%= accent2 %>;
    color:#0f172a; background:#fff;
    font-family:"Inter",system-ui,sans-serif;
  }
  .op-ms .container{ max-width:1140px; margin:0 auto; padding:0 24px; }

  .ms-backline{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 0 10px;}
  .ms-back{color:var(--accent1);font-weight:800;text-decoration:none;}
  .ms-back:hover{text-decoration:underline;}
  .ms-pill{display:inline-flex;align-items:center;gap:8px;padding:.55rem .9rem;border-radius:999px;text-decoration:none;font-weight:700;border:1px solid #e5e7eb;background:#fff;color:#0f172a;}

  .ms-hero{position:relative;background:linear-gradient(160deg,var(--accent1),var(--accent2));color:#fff;overflow:hidden;}
  .ms-hero::before{content:"";position:absolute;inset:0;background:url('<%= img %>') center/cover no-repeat;opacity:.25;mix-blend:multiply;}
  .ms-hero-inner{position:relative;padding:clamp(88px,11vw,160px) 0 clamp(56px,8vw,100px);}
  .ms-kicker{display:inline-block;padding:.45rem .8rem;border-radius:999px;background:rgba(255,255,255,.22);font:700 .85rem/1 "Epilogue",Inter;}
  .ms-title{font-family:"Epilogue",Inter;font-weight:900;line-height:1.03;font-size:clamp(2.6rem,4.8vw,4rem);letter-spacing:-.02em;margin:.65rem 0 .45rem;text-wrap:balance;}
  .ms-chapo{max-width:900px;font:600 clamp(1.2rem,1.1vw + .85rem,1.55rem)/1.65 "Inter";opacity:.98;}

  .ms-slice{padding:clamp(3.2rem,6vw,5.4rem) 0;scroll-margin-top:96px;}
  .ms-slice.bg-muted{background:#f8f9fb;}
  .ms-slice h2{font-family:"Epilogue";font-weight:900;font-size:clamp(2rem,3.1vw,2.6rem);color:#0f172a;margin:0 0 .9rem;}
  .ms-slice h2::after{content:"";display:block;width:80px;height:6px;border-radius:999px;background:var(--accent1);margin:.6rem 0 .2rem;}
  .ms-prose{font:500 1.22rem/1.95 "Inter";color:#1f2937;}
  .ms-prose p{margin:0 0 1.25rem;}

  .ms-infos h3{margin:0 0 .8rem;font:900 1.15rem/1.2 "Epilogue";color:#0f172a;text-transform:uppercase;}
  .ms-meta{list-style:none;padding:0;margin:0 0 1.2rem;display:grid;gap:.65rem;}
  .ms-meta label{display:block;font:700 .9rem/1 "Epilogue";color:#64748b;text-transform:uppercase;}
  .ms-meta .val{font:600 1.08rem/1.6 "Inter";}
  .ms-meta .val a{color:var(--accent1);text-decoration:none;font-weight:700;}
  .ms-meta .val a:hover{text-decoration:underline;}
  #op-map{height:300px;border-radius:18px;border:1px solid #e6e8ee;overflow:hidden;box-shadow:0 6px 24px rgba(15,23,42,.06);}

  .ms-cta{background:linear-gradient(160deg,var(--accent1),var(--accent2));color:#fff;text-align:center;padding:clamp(3.2rem,7vw,5.4rem) 0;}
  .ms-cta h2{margin:0 0 .55rem;font:900 clamp(1.7rem,3.2vw,2.5rem)/1.1 "Epilogue";}
  .ms-cta p{margin:0 0 1.4rem;font:600 1.18rem/1.75 "Inter";}
  .ms-cta .btn{display:inline-block;border-radius:999px;padding:1.05rem 1.7rem;text-decoration:none;font:800 1.05rem/1 "Epilogue";margin:.35rem;}
  .ms-cta .btn.primary{background:#fff;color:var(--accent1);box-shadow:0 8px 28px rgba(0,0,0,.08);}
  .ms-cta .btn.secondary{background:transparent;border:2px solid #fff;color:#fff;}
</style>

<div class="op-ms">
  <div class="container">
    <div class="ms-backline">
      <%= link_to "‚Üê Retour aux opportunit√©s", (defined?(opportunities_path) ? opportunities_path : root_path), class: "ms-back" %>
      <% if website.present? %>
        <%= link_to "Source", website, class: "ms-pill", target: "_blank", rel: "noopener" %>
      <% end %>
    </div>
  </div>

  <!-- HERO -->
  <header class="ms-hero">
    <div class="ms-hero-inner">
      <div class="container">
        <span class="ms-kicker"><%= category.present? ? category.capitalize : "Opportunit√©" %></span>
        <h1 class="ms-title"><%= title %></h1>
        <p class="ms-chapo"><%= truncate(desc_chapo, length: 180) %></p>
        <% if org_line.present? %>
          <p class="ms-chapo" style="margin-top:.4rem;opacity:.9;font-weight:700;"><%= org_line %></p>
        <% end %>
      </div>
    </div>
  </header>

  <!-- Le projet -->
  <section class="ms-slice">
    <div class="container">
      <h2>üìã Le projet</h2>
      <div class="ms-prose">
        <% if desc_full.present? %>
          <%= simple_format(desc_full) %>
        <% else %>
          <p>Une exp√©rience concr√®te, encadr√©e et utile ‚Äî viens d√©couvrir, apprendre et contribuer pr√®s de chez toi.</p>
        <% end %>
      </div>
    </div>
  </section>

  <!-- Infos pratiques -->
  <% if [org, location, email, phone, time_need, lat && lon].any?(&:present?) %>
    <section class="ms-slice bg-muted ms-infos">
      <div class="container">
        <h3>Infos pratiques</h3>
        <ul class="ms-meta">
          <% if org.present? %>
            <li><label>üèõ Organisation</label><div class="val"><%= org %></div></li>
          <% end %>
          <% if location.present? %>
            <li><label>üìç Adresse</label><div class="val"><%= location %></div></li>
          <% end %>
          <% if email.present? %>
            <li><label>‚úâÔ∏è Contact</label><div class="val"><a href="mailto:<%= email %>"><%= email %></a></div></li>
          <% end %>
          <% if phone.present? %>
            <li><label>üìû T√©l√©phone</label><div class="val"><a href="tel:<%= phone %>"><%= phone %></a></div></li>
          <% end %>
          <% if time_need.present? %>
            <li><label>‚è± Temps √† pr√©voir</label><div class="val"><%= time_need %></div></li>
          <% end %>
        </ul>

        <% if lat && lon %>
          <div id="op-map" data-lat="<%= lat %>" data-lon="<%= lon %>"></div>
        <% end %>
      </div>
    </section>
  <% end %>

  <!-- CTA -->
  <section class="ms-cta">
    <div class="container">
      <h2>Envie d‚Äôagir √† ton tour ?</h2>
      <p>D√©couvre d‚Äôautres opportunit√©s pr√®s de chez toi ou partage ta propre histoire pour inspirer d‚Äôautres personnes.</p>
      <div>
        <%= link_to "Voir les actions locales", (defined?(opportunities_path) ? opportunities_path : root_path), class: "btn primary" %>
        <%= link_to "Partager mon histoire", (respond_to?(:new_story_path) ? new_story_path : (defined?(stories_path) ? stories_path : root_path)), class: "btn secondary" %>
      </div>
    </div>
  </section>
</div>

<% content_for :scripts do %>
<script>
(function () {
  function initOpMap() {
    var el = document.getElementById('op-map');
    if (!el || !window.L) return;
    if (el.dataset.mapInited === "1") return;

    var lat = parseFloat(el.dataset.lat), lon = parseFloat(el.dataset.lon);
    if (isNaN(lat) || isNaN(lon)) return;

    var map = L.map(el, { zoomControl:false, attributionControl:false }).setView([lat, lon], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19 }).addTo(map);

    var icon = L.divIcon({
      className:'',
      html:'<div style="width:26px;height:26px;border-radius:9999px;border:2px solid #fff;display:grid;place-items:center;color:#fff;font-size:14px;box-shadow:0 1px 4px rgba(0,0,0,.25);position:relative;background:<%= accent1 %>">üìç</div>',
      iconSize:[26,32], iconAnchor:[13,28], popupAnchor:[0,-26]
    });

    L.marker([lat, lon], {icon:icon}).addTo(map);
    setTimeout(() => map.invalidateSize(), 200);
    el.dataset.mapInited = "1";
  }
  document.addEventListener("DOMContentLoaded", initOpMap);
  document.addEventListener("turbo:load", initOpMap);
})();
</script>
<% end %>
