<%# app/views/opportunities/index.html.erb %>

<%
# Helpers visuels (Images par d√©faut selon cat√©gorie)
def thumb_for(o)
  return o.image_url if o.respond_to?(:image_url) && o.image_url.present?
  cat = (o.respond_to?(:category) ? o.category : '').to_s.downcase
  case cat
  when 'benevolat'    then 'https://images.unsplash.com/photo-1559027615-cd4628902d4a?w=600&q=80&fit=crop'
  when 'formation'    then 'https://images.unsplash.com/photo-1524178232363-1fb2b075b655?w=600&q=80&fit=crop'
  when 'rencontres'   then 'https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=600&q=80&fit=crop'
  when 'entreprendre' then 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=600&q=80&fit=crop'
  when 'ecologiser'   then 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=600&q=80&fit=crop'
  else                     'https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?w=600&q=80&fit=crop'
  end
end

def clean_desc(txt)
  (txt || "").to_s.gsub(/###|!\[.*?\]\(.*?\)/, "").gsub(/\*\*|__/, "").truncate(120)
end
%>

<div class="ops-ms">

  <header class="ops-hero">
    <div class="ops-hero-inner">
      <div class="container">

        <span class="ops-pill-head">Agir maintenant</span>
        <h1 class="ops-title">Les Opportunit√©s</h1>
        <p class="ops-chapo">
          B√©n√©volat, formations, rencontres, entrepreneuriat...<br>
          Trouvez l'action concr√®te qui vous correspond pr√®s de chez vous.
        </p>

        <div class="ops-actions">
          <%= link_to new_opportunity_path, class: "ops-btn-primary" do %>
            <span>‚ûï</span> Proposer une opportunit√©
          <% end %>
        </div>
      </div>
    </div>
  </header>

  <section class="ops-slice ops-map-section">
    <div class="container">

<% current_cat = params[:category].to_s.downcase.presence || 'toutes' %>
<div class="ops-filters">
  <button class="chip <%= 'is-active' if current_cat == 'toutes' %>" data-cat="toutes">üåç Toutes</button>
  <button class="chip <%= 'is-active' if current_cat == 'entreprendre' %>" data-cat="entreprendre">üöÄ Entreprendre</button>
  <button class="chip <%= 'is-active' if current_cat == 'benevolat' %>" data-cat="benevolat">‚ù§Ô∏è B√©n√©volat</button>
  <button class="chip <%= 'is-active' if current_cat == 'ecologiser' %>" data-cat="ecologiser">üå± √âcologiser</button>
  <button class="chip <%= 'is-active' if current_cat == 'formation' %>" data-cat="formation">üìò Formation</button>
  <button class="chip <%= 'is-active' if current_cat == 'rencontres' %>" data-cat="rencontres">ü§ù Rencontres</button>
</div>

      <div class="ops-mapwrap">
        <div id="map-ops" class="ops-map"></div>
        <button
        id="btn-locate-ops" class="ops-locate">
          <span>üìç</span> Me localiser
        </button>
      </div>
    </div>
  </section>

  <section class="ops-slice ops-grid-section bg-muted">
    <div class="container">
      <div class="ops-list-header">
        <h2 class="ops-h2">Derni√®res p√©pites</h2>
        <span class="ops-count"><%= @opportunities.count %> r√©sultats</span>
      </div>

      <div class="ops-grid" id="ops-grid-container">
        <% @opportunities.each do |op| %>
          <% cat_key = op.category.to_s.downcase %>
          <%= link_to opportunity_path(op), class: "ops-card op-item", data: { cat: cat_key } do %>
            <div class="ops-card-img" style="background-image: url('<%= thumb_for(op) %>');">
              <span class="ops-badge" data-cat="<%= cat_key %>">
                <%= op.category.to_s.capitalize %>
           </span>
            </div>

            <div class="ops-card-body">
              <h3 class="ops-card-title"><%= op.title %></h3>
              <div class="ops-card-meta">
                <span>üìç <%= op.location || "Nancy" %></span>
                <% if op.starts_at %>
                  <span>üóìÔ∏è <%= l(op.starts_at, format: :short) rescue "" %></span>
                <% end %>
              </div>
              <p class="ops-card-desc">
                <%= clean_desc(op.description) %>
              </p>
              <span class="ops-read-more">Voir le d√©tail ‚Üí</span>
            </div>
          <% end %>
        <% end %>
      </div>

      <% if @opportunities.empty? %>
        <div class="ops-empty">
          <p>Aucune opportunit√© pour le moment. Revenez vite !</p>
        </div>
      <% end %>
    </div>
  </section>
</div>

<style>
/* Base */
.ops-ms {
  --p: #4f46e5;
  /* Indigo principal */
  font-family: "Inter", system-ui, sans-serif;
  color: #0f172a;
  background: #fff;
}
.ops-ms .container { max-width: 1200px;
  margin: 0 auto; padding: 0 24px; }
.bg-muted { background: linear-gradient(180deg, #fff 0%, #f8fafc 100%);
}

/* Hero */
.ops-hero {
  position: relative;
  background: radial-gradient(circle at 10% 20%, #e0e7ff 0%, transparent 40%),
              linear-gradient(135deg, #fff 0%, #f1f5f9 100%);
  padding: 80px 0 60px;
  text-align: center;
}
.ops-pill-head {
  display: inline-block;
  background: #e0e7ff; color: var(--p);
  font-weight: 800; font-size: 0.75rem;
  text-transform: uppercase; letter-spacing: 0.05em;
  padding: 6px 14px; border-radius: 99px; margin-bottom: 16px;
}
.ops-title {
  font-family: "Epilogue", sans-serif; font-weight: 900;
  font-size: clamp(2.5rem, 5vw, 4rem);
  line-height: 1.1; margin: 0 0 16px;
  background: linear-gradient(135deg, #1e1b4b 0%, #3b82f6 50%, #06b6d4 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.ops-chapo {
  font-size: 1.15rem; color: #475569; max-width: 700px; margin: 0 auto 32px; line-height: 1.6;
}
.ops-btn-primary {
  display: inline-flex; align-items: center; gap: 8px;
  background: #0f172a; color: #fff;
  font-weight: 700; padding: 14px 32px; border-radius: 99px;
  text-decoration: none;
  box-shadow: 0 10px 25px rgba(15, 23, 42, 0.15);
  transition: transform 0.2s;
}
.ops-btn-primary:hover { transform: translateY(-2px); background: #1e293b;
}

/* Map & Filters */
.ops-slice { padding: 40px 0 60px; }
.ops-filters { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;
  margin-bottom: 24px; }
.chip {
  padding: 8px 18px; border-radius: 99px; background: #fff; border: 1px solid #e2e8f0;
  font-weight: 700; font-size: 0.9rem;
  color: #64748b; cursor: pointer; transition: 0.2s;
}
.chip:hover { background: #f8fafc; }
.chip.is-active { background: #0f172a; color: #fff; border-color: transparent;
  box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15); }

.ops-mapwrap { position: relative; height: 500px; border-radius: 24px; overflow: hidden;
  border: 1px solid #e2e8f0; box-shadow: 0 10px 40px rgba(0,0,0,0.08); }
.ops-map { width: 100%; height: 100%; z-index: 1;
}
.ops-locate {
  position: absolute; bottom: 20px; left: 20px; z-index: 500;
  background: #fff; border: 1px solid #cbd5e1;
  padding: 10px 20px;
  border-radius: 99px; font-weight: 700; cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: 0.2s;
}
.ops-locate:hover { transform: translateY(-2px);
}

/* Grid Cards */
.ops-list-header { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 24px; }
.ops-h2 { font-family: "Epilogue"; font-weight: 800;
  font-size: 1.8rem; margin: 0; }
.ops-count { font-weight: 600; color: #94a3b8; font-size: 0.9rem; }

.ops-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 32px; }
.ops-card {
  background: #fff; border-radius: 20px; overflow: hidden;
  text-decoration: none; color: inherit;
  border: 1px solid #e2e8f0;
  box-shadow: 0 4px 10px rgba(0,0,0,0.03);
  transition: transform 0.2s, box-shadow 0.2s;
  display: flex; flex-direction: column;
}
.ops-card:hover { transform: translateY(-5px);
  box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
.ops-card-img { height: 180px; background-size: cover; background-position: center; position: relative;
}

/* Badges couleurs */
.ops-badge {
  position: absolute; top: 12px; left: 12px;
  background: #fff; color: #0f172a;
  font-size: 0.7rem; font-weight: 800;
  text-transform: uppercase;
  padding: 5px 10px; border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.ops-badge[data-cat="benevolat"]   { color: #f43f5e;
}
.ops-badge[data-cat="entreprendre"]{ color: #f59e0b; }
.ops-badge[data-cat="ecologiser"]  { color: #16a34a; }
.ops-badge[data-cat="formation"]   { color: #3b82f6; }
.ops-badge[data-cat="rencontres"]  { color: #facc15;
}

.ops-card-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
.ops-card-title { font-family: "Epilogue"; font-weight: 800; font-size: 1.25rem;
  margin: 0 0 8px; line-height: 1.3; }
.ops-card-meta { font-size: 0.85rem; color: #94a3b8; font-weight: 600; margin-bottom: 12px; display: flex; gap: 12px;
}
.ops-card-desc { color: #475569; font-size: 0.95rem; line-height: 1.5; margin-bottom: 16px; flex-grow: 1; }
.ops-read-more { font-weight: 700; color: var(--p); font-size: 0.9rem;
}

/* POPUP STYLE (Uniformis√©) */
.dc-pop-card { font-family: "Inter", sans-serif; color: #0f172a; width: 260px; padding:0; margin:0; }
.dc-pop-hero { height: 120px;
  background-size: cover; background-position: center; position: relative; border-radius: 12px 12px 0 0; }
.dc-pop-badge {
  position: absolute; top: 8px; left: 8px;
  background: var(--cat-color, #4f46e5); color: white;
  font-size: 0.65rem; font-weight: 800; text-transform: uppercase;
  padding: 3px 8px; border-radius: 99px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.dc-pop-body { padding: 12px; }
.dc-pop-title { font-family: "Epilogue"; font-weight: 800; font-size: 1rem; line-height: 1.2;
  margin: 0 0 6px; }
.dc-pop-meta { font-size: 0.8rem; color: #64748b; margin-bottom: 10px; }
.dc-pop-btn {
  display: block; width: 100%;
  text-align: center;
  background: #0f172a; color: white !important; text-decoration: none !important;
  padding: 8px; border-radius: 6px; font-weight: 700; font-size: 0.85rem;
  transition: opacity 0.2s;
}
.dc-pop-btn:hover { opacity: 0.9; }

@media (max-width: 768px) {
  .ops-mapwrap { height: 350px;
  }
  .ops-grid { grid-template-columns: 1fr; }
}
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener('turbo:load', initOpsMap);
document.addEventListener('DOMContentLoaded', initOpsMap);
function initOpsMap() {
  const mapEl = document.getElementById('map-ops');
  if (!mapEl) return;
  if (mapEl.dataset.inited) return;
  mapEl.dataset.inited = "1";
// Init Map
  const map = L.map(mapEl).setView([48.6921, 6.1844], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '¬© OpenStreetMap'
  }).addTo(map);

  const layer = L.layerGroup().addTo(map);
// CONFIG ICONES & COULEURS
  const colors = {
    benevolat: '#f43f5e', ecologiser: '#16a34a', formation: '#3b82f6',
    rencontres: '#facc15', entreprendre:'#f59e0b', default: '#4f46e5'
  };
  const emojis = {
    benevolat: '‚ù§Ô∏è', ecologiser: 'üå±', formation: 'üìò',
    rencontres: 'ü§ù', entreprendre:'üöÄ', default: 'üìç'
  };
  const iconFor = (c) => {
    const cat = (c||'').toLowerCase().trim();
    const em = emojis[cat] || emojis.default;
    const bg = colors[cat] || colors.default;
    const style = `
      width:30px;height:30px;border-radius:50%;border:2px solid #fff;
      display:grid;place-items:center;color:#fff;font-size:16px;
      box-shadow:0 3px 8px rgba(0,0,0,.3); background:${bg};
    `;
    return L.divIcon({
      className: '',
      html: `<div style="${style}"><span>${em}</span></div>`,
      iconSize: [30, 30], iconAnchor: [15, 15], popupAnchor: [0, -12]
    });
  };

  // GENERATEUR POPUP
  function popupHtml(o) {
    const cKey = (o.category||'').toLowerCase();
    const conf = { color: colors[cKey] || colors.default, label: cKey.toUpperCase() };
    const url = `/opportunities/${o.slug || o.id}`;
    // Image
    let img = o.image_url;
    // Fallback simple si pas d'image
    if(!img) img = "https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?w=400";
    const safeTitle = (o.title || "").replace(/"/g, '&quot;');
    const location = o.location || "Nancy";

    return `
      <div class="dc-pop-card" style="--cat-color: ${conf.color}">
        <div class="dc-pop-hero" style="background-image: url('${img}')">
          <span class="dc-pop-badge">${conf.label}</span>
        </div>
        <div class="dc-pop-body">
          <h3 class="dc-pop-title">${safeTitle}</h3>
          <div class="dc-pop-meta">üìç ${location}</div>
         <a href="${url}" class="dc-pop-btn">Voir l'opportunit√© ‚Üí</a>
        </div>
      </div>
    `;
  }

// LOGIQUE DONNEES & FILTRES
  let dataset = [];

  function plot(items) {
    layer.clearLayers();
    const bounds = [];
    (items||[]).forEach(o => {
      if(!o.latitude || !o.longitude) return;
      const c = (o.category||'').toLowerCase();
      L.marker([o.latitude, o.longitude], { icon: iconFor(c) })
        .addTo(layer)
        .bindPopup(popupHtml(o));
      bounds.push([o.latitude, o.longitude]);
    });
    // On ne re-fit pas bounds √† chaque filtre pour √©viter l'effet "saut",
    // sauf au chargement initial si d√©sir√©.
  }

  // Fetch initial
  fetch('/api/v1/opportunities')
    .then(r => r.ok ? r.json() : [])
    .then(data => {
      dataset = data;
      plot(dataset);

      // CORRECTION DU BUG : ‚¨áÔ∏è D√©clenche le filtre correct apr√®s le chargement des donn√©es ‚¨áÔ∏è
      const currentActiveChip = document.querySelector('.ops-filters .chip.is-active');
      const cat = currentActiveChip ? currentActiveChip.dataset.cat : 'toutes';

      // Si le chip actif n'est pas "Toutes", on filtre la carte et la liste
      if (cat !== 'toutes') {
          // On simule un clic sur le chip actif pour appliquer les filtres (visuel + liste + carte)
          currentActiveChip.click();
      }
      // CORRECTION DU BUG : ‚¨ÜÔ∏è Fin du bloc d'initialisation du filtre ‚¨ÜÔ∏è
    });
// Gestion des Chips (Filtres)
  const chips = document.querySelectorAll('.chip');
  const cards = document.querySelectorAll('.op-item');

  chips.forEach(chip => {
    chip.addEventListener('click', () => {
      // 1. Visuel Chip
      chips.forEach(c => c.classList.remove('is-active'));
      chip.classList.add('is-active');

      const cat = chip.dataset.cat; // 'toutes', 'entreprendre', etc.

      // 2. Filtre Carte
      if(cat === 'toutes') {
        plot(dataset);
      } else {
        const filtered = dataset.filter(o => (o.category||'').toLowerCase() === cat);
        plot(filtered);
      }

      // 3. Filtre Liste Grille
      cards.forEach(card => {
        if(cat === 'toutes') {
          card.style.display = 'flex';
        } else {
          // Utiliser l'attribut data-cat pour filtrer la liste
          card.style.display = (card.dataset.cat === cat) ? 'flex' : 'none';
        }
      });

      // Update compteur (optionnel)
      const visibleCount = (cat === 'toutes') ? cards.length : document.querySelectorAll(`.op-item[data-cat="${cat}"]`).length;
      const countEl = document.querySelector('.ops-count');
      if(countEl) countEl.innerText = `${visibleCount} r√©sultats`;
    });
  });

// Bouton Geoloc
  const btn = document.getElementById('btn-locate-ops');
  if(btn){
    btn.onclick = function(){
      if(!navigator.geolocation) return alert("Pas de GPS");
      btn.innerHTML = "‚è≥ ...";
      navigator.geolocation.getCurrentPosition(p=>{
        map.setView([p.coords.latitude, p.coords.longitude], 14);
        L.marker([p.coords.latitude, p.coords.longitude]).addTo(map).bindPopup("Vous √™tes ici").openPopup();
        btn.innerHTML = "üìç Me localiser";
      });
    };
  }
} // <--- Fin de la fonction initOpsMap()
</script>
