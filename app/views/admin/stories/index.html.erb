<%# app/views/admin/stories/index.html.erb %>

<div class="admin-wrap">
  <div class="admin-header">
    <h1>Stories — Admin</h1>

    <%= link_to "➕ Nouvelle story",
                new_admin_story_path,
                class: "btn" %>
  </div>

  <div class="stats">
    <span>Total : <b><%= @counts[:total] %></b></span>
    <span>Sans coordonnées : <b><%= @counts[:missing_coords] %></b></span>
  </div>

  <%= form_with url: admin_stories_path, method: :get, local: true, class: "filters" do %>
    <input type="text"
           name="q"
           placeholder="Rechercher (titre, chapo, texte…)"
           value="<%= h @q %>">
    <label class="ck">
      <input type="checkbox"
             name="missing_coords"
             value="1"
             <%= "checked" if @missing %>>
      Manque de coordonnées
    </label>
    <button type="submit" class="btn small">Filtrer</button>
    <%= link_to "Réinitialiser", admin_stories_path, class: "btn-secondary" %>
  <% end %>

  <div class="toolbar">
    <%= button_to "Géocoder les fiches sans coords",
                  geocode_missing_admin_stories_path(request.query_parameters),
                  method: :post,
                  form: { data: { turbo_confirm: "Tenter le géocodage pour les stories sans coordonnées ?" } },
                  class: "btn small" %>
  </div>

  <%= form_with url: bulk_admin_stories_path(request.query_parameters), method: :post, local: true do %>
    <div class="bulkbar">
      <select name="bulk_action">
        <option value="">Action groupée…</option>
        <% if Story.column_names.include?("is_active") %>
          <option value="activate">Activer</option>
          <option value="deactivate">Désactiver</option>
        <% end %>
        <option value="destroy">Supprimer</option>
      </select>
      <button type="submit" class="btn small">Appliquer</button>
    </div>

    <table class="admin-table">
      <thead>
        <tr>
          <th><input type="checkbox" id="check_all"></th>
          <th>ID</th>
          <th>Titre</th>
          <th>Lieu</th>
          <th>Coords</th>
          <th>Source</th>
          <th>Mise à jour</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @stories.each do |s| %>
          <tr>
            <td><input type="checkbox" name="ids[]" value="<%= s.id %>"></td>
            <td><code><%= s.id %></code></td>
            <td class="td-title">
              <%= link_to s.title, edit_admin_story_path(s, request.query_parameters) %>
            </td>
            <td><%= s.location.presence || "—" %></td>
            <td>
              <% if s.latitude.present? && s.longitude.present? %>
                ✅
              <% else %>
                <span style="color:#b91c1c">—</span>
              <% end %>
            </td>
            <td>
              <% if s.source_url.present? %>
                <a href="<%= s.source_url %>" target="_blank" rel="noopener">Lien</a>
              <% else %>—<% end %>
            </td>
            <td><%= l(s.updated_at, format: :short) rescue s.updated_at.to_s(:short) %></td>
            <td class="td-actions">
              <%= link_to "Voir", story_path(s), class: "btn small", target: "_blank" %>
              <%= link_to "Éditer", edit_admin_story_path(s, request.query_parameters), class: "btn small" %>
              <a href="#"
                 class="btn small danger delete-story-btn"
                 data-story-id="<%= s.id %>"
                 data-story-title="<%= h s.title %>"
                 data-delete-url="<%= admin_story_path(s, request.query_parameters) %>">
                Supprimer
              </a>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>
</div>

<script>
  // coche/décoche tout
  document.addEventListener('DOMContentLoaded', function(){
    var all = document.getElementById('check_all');
    if(!all) return;
    all.addEventListener('change', function(){
      document.querySelectorAll('input[name="ids[]"]').forEach(cb => cb.checked = all.checked);
    });

    // Gestion suppression individuelle (HORS du formulaire bulk)
    document.querySelectorAll('.delete-story-btn').forEach(btn => {
      btn.addEventListener('click', function(e){
        e.preventDefault();
        e.stopPropagation();

        const storyTitle = this.dataset.storyTitle;
        const deleteUrl = this.dataset.deleteUrl;

        if (confirm(`Confirmer la suppression de « ${storyTitle} » ?`)) {
          // Créer un formulaire temporaire HORS du bulk form
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = deleteUrl;

          // Token CSRF
          const csrfToken = document.querySelector('meta[name="csrf-token"]');
          if (csrfToken) {
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = 'authenticity_token';
            tokenInput.value = csrfToken.content;
            form.appendChild(tokenInput);
          }

          // Method DELETE
          const methodInput = document.createElement('input');
          methodInput.type = 'hidden';
          methodInput.name = '_method';
          methodInput.value = 'delete';
          form.appendChild(methodInput);

          // Ajouter au body et soumettre
          document.body.appendChild(form);
          form.submit();
        }
      });
    });
  });
</script>

<style>
.admin-wrap{font-family:Inter,system-ui,sans-serif;color:#0f172a;}
.admin-header{display:flex;align-items:center;justify-content:space-between;margin:0 0 .5rem;}
.stats{display:flex;gap:12px;margin:8px 0 12px;}
.filters{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px;}
.filters input[type="text"]{padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px;min-width:280px;}
.filters .ck{display:inline-flex;gap:6px;align-items:center}
.btn,
.btn-secondary{display:inline-block;padding:.5rem .8rem;border-radius:8px;text-decoration:none;font-weight:800;border:1px solid #cbd5e1;background:#fff;color:#0f172a;}
.btn.small{padding:.4rem .6rem;font-size:.92rem}
.btn.danger{border-color:#ef4444;color:#b91c1c}
.btn-secondary{background:#f8fafc}
.bulkbar{display:flex;gap:8px;align-items:center;margin:6px 0 10px}
.admin-table{width:100%;border-collapse:separate;border-spacing:0 6px}
.admin-table thead th{font:800 .85rem/1 "Epilogue",Inter;color:#64748b;text-transform:uppercase;letter-spacing:.04em;text-align:left}
.admin-table tbody tr{background:#fff;border:1px solid #e5e7eb}
.admin-table td,.admin-table th{padding:10px 12px;vertical-align:top}
.td-title a{font-weight:800}
.td-actions{white-space:nowrap;display:flex;gap:6px}
</style>
