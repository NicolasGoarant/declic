<%# frozen_string_literal: true %>
<%# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    Stories#show ‚Äî version "magazine d‚Äôimpact" (tol√©rante : pas de Story#category,
    pas de Story#quote requis)
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ %>

<%
# Accent par cat√©gorie (si disponible), sinon couleur par d√©faut
cat = @story.respond_to?(:category) && @story.category.present? ? @story.category.to_s : ""
accent =
  case cat
  when "benevolat"    then "#2E8B57"  # vert
  when "formation"    then "#0069D9"  # bleu
  when "rencontres"   then "#FF6F61"  # corail
  when "entreprendre" then "#F6A623"  # orange
  else "#4B5563"                     # fallback neutre
  end

# Image h√©ros (HTTP absolu ou asset pipeline)
img =
  if @story.image_url.present?
    (@story.image_url =~ /\Ahttp/i) ? @story.image_url : asset_path(@story.image_url)
  else
    "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=1600&auto=format&fit=crop"
  end
%>

<div class="story-page" style="--accent:<%= accent %>">
  <div class="container narrow">

    <div class="backline">
      <%= link_to "‚Üê Retour aux belles histoires", stories_path, class: "backlink" %>
      <div class="actions">
        <% if @story.source_url.present? %>
          <%= link_to "Article (PDF)", @story.source_url, class: "pill", target: "_blank", rel: "noopener" %>
        <% end %>
        <%= link_to "Partager", request.original_url, class: "pill" %>
      </div>
    </div>

    <div class="story-hero" style="background-image:url('<%= img %>')">
      <div class="overlay"></div>
      <div class="inner">
        <div class="kicker">Belle histoire</div>
        <h1 class="title"><%= @story.title %></h1>
      </div>
    </div>

    <div class="layout">
      <!-- Colonne principale -->
      <main class="main">

        <% if @story.chapo.present? %>
          <div class="chapo card soft">
            <p><%= @story.chapo %></p>
          </div>
        <% end %>

        <%# D√©coupe du body en sections √† partir de "### " %>
        <% raw_body = @story.body.to_s.strip %>
        <% sections = raw_body.split(/^###\s+/).reject(&:blank?) %>

        <% sections.each do |bloc| %>
          <% lines = bloc.lines %>
          <% heading = lines.first.to_s.strip %>
          <% content_md = lines.drop(1).join.strip %>

          <section class="story-section card reveal">
            <h3 class="h3"><%= heading %></h3>

            <% if respond_to?(:markdown) %>
              <div class="prose"><%= markdown(content_md) %></div>
            <% else %>
              <div class="prose"><%= simple_format(content_md) %></div>
            <% end %>
          </section>
        <% end %>

        <%# Bloc citation : uniquement si l‚Äôattribut existe ET non vide %>
        <% if @story.respond_to?(:quote) && @story.quote.present? %>
          <figure class="quote card">
            <blockquote>¬´ <%= @story.quote %> ¬ª</blockquote>
          </figure>
        <% end %>

        <div class="story-cta">
          <p class="cta-title">Envie d‚Äôagir √† ton tour ?</p>
          <p class="cta-sub">D√©couvre des opportunit√©s concr√®tes pr√®s de chez toi.</p>
          <%= link_to "Voir les actions autour de moi", opportunities_path, class: "btn-cta" %>
        </div>
      </main>

      <!-- Colonne lat√©rale -->
      <aside class="side">
        <div class="card sidecard">
          <h4 class="side-title">Infos pratiques</h4>
          <ul class="meta">
            <% if @story.location.present? %>
              <li>
                <span class="meta-label">üìç Adresse</span>
                <span class="meta-value"><%= @story.location %></span>
              </li>
            <% end %>
            <% if @story.source_name.present? %>
              <li>
                <span class="meta-label">üì∞ Source</span>
                <% if @story.source_url.present? %>
                  <span class="meta-value"><%= link_to @story.source_name, @story.source_url, target: "_blank", rel: "noopener" %></span>
                <% else %>
                  <span class="meta-value"><%= @story.source_name %></span>
                <% end %>
              </li>
            <% end %>
          </ul>

          <%# Carte : conteneur + data lat/lon (affich√©e si coords pr√©sentes) %>
          <% if @story.latitude.present? && @story.longitude.present? %>
            <div id="story-map"
                 class="mini-map"
                 data-lat="<%= @story.latitude %>"
                 data-lon="<%= @story.longitude %>"
                 style="margin-top:10px;height:180px;border-radius:12px;overflow:hidden;">
              <div class="mini-map-fallback">Carte √† venir</div>
            </div>
          <% end %>
        </div>

        <% if @story.description.present? %>
          <div class="card sidecard muted">
            <p><%= @story.description %></p>
          </div>
        <% end %>
      </aside>
    </div>
  </div>
</div>

<%# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    Script carte (Leaflet). N√©cessite leaflet.css/js dans le layout.
    Compatible DOMContentLoaded + Turbo Drive.
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ %>
<% content_for :scripts do %>
  <script>
    (function () {
      function bootStoryMap() {
        var el = document.getElementById('story-map');
        if (!el || !window.L) return;

        var lat = parseFloat(el.dataset.lat);
        var lon = parseFloat(el.dataset.lon);
        if (isNaN(lat) || isNaN(lon)) return;

        // (r√©)initialisation
        var map = L.map(el, { zoomControl: false, attributionControl: false })
                   .setView([lat, lon], 14);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
        L.marker([lat, lon]).addTo(map);

        // Ajuste la taille une fois le bloc visible
        setTimeout(function(){ map.invalidateSize(); }, 120);
      }

      document.addEventListener('DOMContentLoaded', bootStoryMap);
      window.addEventListener('turbo:load', bootStoryMap);
    })();
  </script>
<% end %>
