<%# Stories#show ‚Äî mise en page makesense avec d√©grad√© violet/mauve D√©clic + image + carte r√©siliente %>
<% content_for :main_classes, "pt-0" %>

<%
# Couleurs d‚Äôaccent ‚Äî violets D√©clic (uniformise avec la home)
accent1 = "#7e5bef" # violet
accent2 = "#3b82f6" # mauve/bleu

# Image h√©ro + illustration principale
img =
  if @story.image_url.present?
    (@story.image_url =~ /\Ahttp/i) ? @story.image_url : asset_path(@story.image_url)
  else
    # fallback simple (ne d√©finit pas de constantes pour √©viter Zeitwerk)
    hay = [@story.title, @story.chapo, @story.description].compact.join(" ").downcase
    if hay =~ /(b√©n√©vol|solidar|entraide|don|maraude)/
      "https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?q=80&w=1600&auto=format&fit=crop"
    elsif hay =~ /(formation|atelier|apprendre|certificat|cours)/
      "https://images.unsplash.com/photo-1513258496099-48168024aec0?q=80&w=1600&auto=format&fit=crop"
    elsif hay =~ /(rencontre|communaut√©|club|ap√©ro|tiers-lieu)/
      "https://images.unsplash.com/photo-1558222217-0d77a6d3b3d1?q=80&w=1600&auto=format&fit=crop"
    elsif hay =~ /(entrepreneur|commerce|projet|incubateur)/
      "https://images.unsplash.com/photo-1556157382-97eda2d62296?q=80&w=1600&auto=format&fit=crop"
    else
      "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=1600&auto=format&fit=crop"
    end
  end

# Chapo (fallback sur description)
chapo_text = @story.chapo.presence || @story.description.presence || "Une histoire d‚Äôengagement local qui donne envie d‚Äôagir."
%>

<%# SEO %>
<% content_for :title, @story.title %>
<% content_for :description, strip_tags(chapo_text).truncate(160) %>

<style>
.story-ms{
  --accent1:<%= accent1 %>;
  --accent2:<%= accent2 %>;
  color:#0f172a; background:#fff;
  font-family:"Inter",system-ui,sans-serif;
}
.story-ms .container{ max-width:1140px; margin:0 auto; padding:0 24px; }

/* Backline */
.ms-backline{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 0 10px;}
.ms-back{color:var(--accent1);font-weight:800;text-decoration:none;}
.ms-back:hover{text-decoration:underline;}
.ms-actions{display:flex;gap:10px;flex-wrap:wrap;}
.ms-pill{display:inline-flex;align-items:center;gap:8px;padding:.55rem .9rem;border-radius:999px;text-decoration:none;font-weight:700;border:1px solid #e5e7eb;background:#fff;color:#0f172a;}

/* HERO */
.ms-hero{position:relative;background:linear-gradient(160deg,var(--accent1),var(--accent2));color:#fff;overflow:hidden;}
.ms-hero::before{content:"";position:absolute;inset:0;background:url('<%= img %>') center/cover no-repeat;opacity:.25;mix-blend:multiply;}
.ms-hero-inner{position:relative;padding:clamp(88px,11vw,160px) 0 clamp(56px,8vw,100px);}
.ms-kicker{display:inline-block;padding:.45rem .8rem;border-radius:999px;background:rgba(255,255,255,.22);font:700 .85rem/1 "Epilogue",Inter;}
.ms-title{font-family:"Epilogue",Inter; font-weight:900; line-height:1.03;
  font-size:clamp(2.6rem,4.8vw,4rem); letter-spacing:-.02em; margin:.65rem 0 .45rem; text-wrap:balance;}
.ms-chapo{max-width:900px; font:600 clamp(1.2rem,1.1vw + .85rem,1.55rem)/1.65 "Inter"; opacity:.98;}

/* Illustration sous la banni√®re */
.ms-illustration{padding:clamp(16px,3vw,24px) 0 0;}
.ms-illustration figure{margin:0;}
.ms-illustration img{width:100%; aspect-ratio:16/9; object-fit:cover; border-radius:18px; border:1px solid #e6e8ee; box-shadow:0 10px 28px rgba(15,23,42,.10);}
.ms-illustration figcaption{font-weight:600; font-size:.9rem; color:#64748b; margin-top:.5rem;}

/* Sections */
.ms-slice{padding:clamp(3.2rem,6vw,5.4rem) 0; scroll-margin-top:96px;}
.ms-slice.bg-muted{background:#f8f9fb;}
.ms-slice h2{font-family:"Epilogue"; font-weight:900; font-size:clamp(2rem,3.1vw,2.6rem); color:#0f172a; margin:0 0 .9rem;}
.ms-slice h2::after{content:"";display:block;width:80px;height:6px;border-radius:999px;background:var(--accent1);margin:.6rem 0 .2rem;}
.ms-prose{font:500 1.22rem/1.95 "Inter"; color:#1f2937;}
.ms-prose p{margin:0 0 1.25rem;}
.ms-prose strong{font-weight:800; color:#0b1220;}
.ms-prose li::marker{color:var(--accent1); font-weight:900;}

/* Citation (affich√©e seulement si pr√©sente) */
.ms-quote{background:color-mix(in srgb,var(--accent1) 10%,#fff); padding:clamp(2.6rem,6vw,3.6rem) 0; text-align:center;}
.ms-quote blockquote{margin:0 auto; max-width:920px; font:800 clamp(1.35rem,2.6vw,2rem)/1.32 "Epilogue"; color:#0f172a;}

/* Infos pratiques + carte */
.ms-infos h3{margin:0 0 .8rem; font:900 1.15rem/1.2 "Epilogue"; color:#0f172a; letter-spacing:.02em; text-transform:uppercase;}
.ms-meta{list-style:none; padding:0; margin:0 0 1.2rem; display:grid; gap:.65rem;}
.ms-meta label{display:block; font:700 .9rem/1 "Epilogue"; color:#64748b; text-transform:uppercase;}
.ms-meta .val{font:600 1.08rem/1.6 "Inter";}
.ms-meta .val a{color:#0b61ff; text-decoration:none; font-weight:700;}
.ms-meta .val a:hover{ text-decoration:underline; }
#story-map{
  height:300px;
  border-radius:18px; border:1px solid #e6e8ee; overflow:hidden; box-shadow:0 6px 24px rgba(15,23,42,.06);
  background:#fff; /* fond clair qui dispara√Ætra au 1er chargement de tuile */
}

/* CTA */
.ms-cta{background:linear-gradient(160deg,var(--accent1),var(--accent2)); color:#fff; text-align:center; padding:clamp(3.2rem,7vw,5.4rem) 0;}
.ms-cta h2{margin:0 0 .55rem; font:900 clamp(1.7rem,3.2vw,2.5rem)/1.1 "Epilogue"; letter-spacing:-.01em;}
.ms-cta p{margin:0 0 1.4rem; font:600 1.18rem/1.75 "Inter";}
.ms-cta .btn{display:inline-block; border-radius:999px; padding:1.05rem 1.7rem; text-decoration:none; font:800 1.05rem/1 "Epilogue"; margin:.35rem;}
.ms-cta .btn.primary{background:#fff; color:var(--accent1); box-shadow:0 8px 28px rgba(0,0,0,.08);}
.ms-cta .btn.secondary{background:transparent; border:2px solid #fff; color:#fff;}
</style>

<div class="story-ms">
  <div class="container">
    <div class="ms-backline">
      <%= link_to "‚Üê Retour aux belles histoires", stories_path, class: "ms-back" %>
      <div class="ms-actions">
        <% if @story.source_url.present? %>
          <%= link_to "Source", @story.source_url, class: "ms-pill", target: "_blank", rel: "noopener" %>
        <% end %>
        <%= link_to "Partager", request.original_url, class: "ms-pill", aria: { label: "Partager cette histoire" } %>
      </div>
    </div>
  </div>

  <!-- HERO -->
  <header class="ms-hero" role="banner">
    <div class="ms-hero-inner">
      <div class="container">
        <span class="ms-kicker">Belle histoire</span>
        <h1 class="ms-title"><%= @story.title %></h1>
        <p class="ms-chapo"><%= chapo_text %></p>
      </div>
    </div>
  </header>

  <!-- Illustration principale sous la banni√®re -->
  <section class="ms-illustration">
    <div class="container">
      <figure>
        <img src="<%= img %>" alt="<%= @story.title %> ‚Äî illustration">
        <% if @story.source_name.present? %>
          <figcaption>Cr√©dit : <%= @story.source_name %></figcaption>
        <% end %>
      </figure>
    </div>
  </section>

  <% raw_body = @story.body.to_s.strip %>
  <% sections = raw_body.present? ? raw_body.split(/^###\s+/).reject(&:blank?) : [] %>

  <% sections.each_with_index do |bloc, i| %>
    <% lines = bloc.lines %>
    <% heading = lines.first.to_s.strip %>
    <% content_md = lines.drop(1).join.strip %>
    <section class="ms-slice <%= i.odd? ? 'bg-muted' : '' %>">
      <div class="container">
        <h2><%= heading %></h2>
        <% if respond_to?(:markdown) %>
          <div class="ms-prose"><%= markdown(content_md) %></div>
        <% else %>
          <div class="ms-prose"><%= simple_format(content_md) %></div>
        <% end %>
      </div>
    </section>
  <% end %>

  <% if @story.respond_to?(:quote) && @story.quote.present? %>
    <section class="ms-quote"><div class="container"><blockquote>¬´ <%= @story.quote %> ¬ª</blockquote></div></section>
  <% end %>

  <% if @story.location.present? || (@story.latitude.present? && @story.longitude.present?) || @story.source_name.present? %>
    <section class="ms-slice ms-infos bg-muted">
      <div class="container">
        <h3>Infos pratiques</h3>
        <ul class="ms-meta">
          <% if @story.location.present? %>
            <li><label>üìç Adresse</label><div class="val"><%= @story.location %></div></li>
          <% end %>
          <% if @story.source_name.present? %>
            <li><label>üì∞ Source</label>
              <div class="val">
                <% if @story.source_url.present? %>
                  <%= link_to @story.source_name, @story.source_url, target: "_blank", rel: "noopener" %>
                <% else %><%= @story.source_name %><% end %>
              </div>
            </li>
          <% end %>
        </ul>
        <% if @story.latitude.present? && @story.longitude.present? %>
          <div id="story-map" data-lat="<%= @story.latitude %>" data-lon="<%= @story.longitude %>"></div>
        <% end %>
      </div>
    </section>
  <% end %>

  <!-- CTA -->
  <section class="ms-cta">
    <div class="container">
      <h2>Envie d‚Äôagir √† ton tour ?</h2>
      <p>D√©couvre des opportunit√©s pr√®s de chez toi ou partage ta propre histoire pour inspirer d‚Äôautres personnes.</p>
      <div>
        <%= link_to "Voir les actions locales", opportunities_path, class: "btn primary" %>
        <%= link_to "Partager mon histoire", (respond_to?(:new_story_path) ? new_story_path : stories_path), class: "btn secondary" %>
      </div>
    </div>
  </section>
</div>

<!-- Leaflet CDN -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<script>
(function () {
  function initStoryMap() {
    var el = document.getElementById('story-map');
    if (!el || !window.L) return;               // pas de conteneur ou Leaflet non charg√©
    if (el.dataset.mapInited === "1") return;   // √©vite double init

    var lat = parseFloat(el.dataset.lat), lon = parseFloat(el.dataset.lon);
    if (isNaN(lat) || isNaN(lon)) return;       // coords manquantes

    // Assure une hauteur visible (au cas o√π du CSS externe l‚Äô√©crase)
    if (el.clientHeight < 120) el.style.height = (el.dataset.height || 300) + "px";

    var map = L.map(el, { zoomControl:false, attributionControl:false }).setView([lat, lon], 14);

    // --- FOND DE CARTE R√âSILIENT (multi-fournisseurs) ---------------------
    var tileCandidates = [
      {
        name: "OSM",
        url: "[https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png]https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        opts: { maxZoom: 19, crossOrigin: true }
      },
      {
        name: "Carto Light",
        url: "[https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png]https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png",
        opts: { maxZoom: 19, subdomains: "abcd", crossOrigin: true }
      },
      {
        name: "Stadia Alidade",
        url: "https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}.png",
        opts: { maxZoom: 19, crossOrigin: true }
      },
      {
        name: "OSM France",
        url: "[https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png]https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png",
        opts: { maxZoom: 19, crossOrigin: true }
      }
    ];

    var baseLayer = null;
    var tried = 0;

    function onTileError() {
      tryNextTileLayer();
    }
    function onTileLoad() {
      // retire le fond d√®s la 1re tuile charg√©e
      el.style.background = "transparent";
      var cont = baseLayer.getContainer && baseLayer.getContainer();
      if (cont) cont.style.opacity = "1";
    }
    function tryNextTileLayer() {
      if (baseLayer) {
        baseLayer.off("tileerror", onTileError);
        baseLayer.off("load", onTileLoad);
        map.removeLayer(baseLayer);
      }
      if (tried >= tileCandidates.length) return;

      var cand = tileCandidates[tried++];
      baseLayer = L.tileLayer(cand.url, cand.opts).addTo(map);
      baseLayer.on("tileerror", onTileError);
      baseLayer.on("load", onTileLoad);
    }
    tryNextTileLayer();
    // ---------------------------------------------------------------------

    var marker = L.marker([lat, lon]).addTo(map);
    marker.bindPopup("<b><%= j(@story.title) %></b><br><%= j(@story.location.to_s) %>");

    // corrige les cartes ‚Äúblanches‚Äù (dimensions recalcul√©es)
    requestAnimationFrame(function(){ map.invalidateSize(); });
    setTimeout(function(){ map.invalidateSize(); }, 250);

    el.dataset.mapInited = "1";
    document.addEventListener('turbo:render', function(){ map.invalidateSize(); });
    window.addEventListener('pageshow', function(e){ if (e.persisted) map.invalidateSize(); });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initStoryMap, { once: true });
  } else {
    initStoryMap();
  }
})();
</script>
