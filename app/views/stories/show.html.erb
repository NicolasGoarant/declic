<%# app/views/stories/show.html.erb - VERSION FINALE RESPONSIVE + PHOTOS INLINE INTELLIGENTES %>

<%
# Configuration th√®me - D√©tection plus stricte
story_haystack = @story.title.to_s.downcase
story_body = @story.body.to_s.downcase[0..500] # Premiers 500 chars du body

# Comptage de mots-cl√©s par th√®me
eco_score = 0
eco_score += 1 if story_haystack.include?('jardin') && (story_haystack.include?('urbain') || story_haystack.include?('cultiv') || story_haystack.include?('permaculture'))
eco_score += 1 if story_haystack.include?('√©colog')
eco_score += 1 if story_haystack.include?('bio') || story_haystack.include?('durable')
eco_score += 1 if story_body.include?('environnement') || story_body.include?('permaculture')

social_score = 0
social_score += 1 if story_haystack.include?('rencontr') || story_haystack.include?('caf√©')
social_score += 1 if story_haystack.include?('lien') && story_haystack.include?('social')
social_score += 1 if story_body.include?('partage') || story_body.include?('convivial')

entreprendre_score = 0
entreprendre_score += 1 if story_haystack.include?('entreprise') || story_haystack.include?('fromag') || story_haystack.include?('commerce')
entreprendre_score += 1 if story_haystack.include?('cr√©er') || story_haystack.include?('lancer')
entreprendre_score += 1 if story_body.include?('boutique') || story_body.include?('startup')

# Th√®me gagnant (minimum 2 points pour √™tre s√©lectionn√©)
theme = if eco_score >= 2
  { name: "√âcologiser", color: "emerald", gradient: "from-emerald-500 to-teal-500", bg: "bg-emerald-50", icon: "üå±" }
elsif social_score >= 2
  { name: "Rencontres", color: "amber", gradient: "from-amber-500 to-orange-500", bg: "bg-amber-50", icon: "‚òï" }
elsif entreprendre_score >= 2
  { name: "Entreprendre", color: "orange", gradient: "from-orange-500 to-red-500", bg: "bg-orange-50", icon: "üöÄ" }
else
  # Fallback : Belle Histoire (par d√©faut)
  { name: "Belle Histoire", color: "purple", gradient: "from-purple-500 to-pink-500", bg: "bg-purple-50", icon: "‚ú®" }
end

story_emoji = defined?(emoji_for) ? emoji_for(@story.title) : "üëç"

# Format date fran√ßais
date_fr = if @story.happened_on.present?
  day_names = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi']
  month_names = ['', 'janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin',
                 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre']
  "#{day_names[@story.happened_on.wday].capitalize} #{@story.happened_on.day.to_s.rjust(2, '0')} #{month_names[@story.happened_on.month]} #{@story.happened_on.year}"
else
  ""
end
%>

<style>
/* Styles inline pour √©viter les conflits */
.story-hero-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
.story-spacing-1 { height: 40px; }
.story-spacing-2 { height: 30px; }
.story-spacing-3 { height: 25px; }
.story-separator {
  height: 1px;
  background: linear-gradient(90deg, transparent, #cbd5e1, transparent);
  margin: 30px 0;
}

/* PHOTOS INLINE DANS LE R√âCIT - MODE FLOAT (textes longs) */
.inline-photo-left {
  float: left;
  width: 45%;
  margin: 8px 24px 16px 0;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.inline-photo-right {
  float: right;
  width: 45%;
  margin: 8px 0 16px 24px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.inline-photo-full {
  width: 100%;
  margin: 32px 0;
  clear: both;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* MODE STACK (textes courts) */
.inline-photo-stack {
  width: 100%;
  margin: 32px 0;
  clear: both;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.inline-photo-left img,
.inline-photo-right img,
.inline-photo-full img,
.inline-photo-stack img {
  width: 100%;
  height: auto;
  display: block;
}

.inline-photo-caption {
  background: #f8fafc;
  padding: 12px 16px;
  font-size: 14px;
  color: #64748b;
  font-style: italic;
  border-top: 1px solid #e2e8f0;
}

/* Clearfix apr√®s le body */
.markdown-content::after {
  content: "";
  display: table;
  clear: both;
}

/* RESPONSIVE FIXES */
@media (max-width: 1024px) {
  .story-grid {
    grid-template-columns: 1fr !important;
  }
  .story-sidebar {
    position: static !important;
  }
}

@media (max-width: 640px) {
  .story-hero-title {
    font-size: 28px !important;
  }
  .story-hero-emoji {
    font-size: 36px !important;
  }
  .story-quote-text {
    font-size: 18px !important;
  }
  .story-section-title {
    font-size: 20px !important;
  }
  .story-chiffres {
    grid-template-columns: 1fr !important;
  }
  .story-cta-title {
    font-size: 24px !important;
  }

  /* Mobile : photos inline en pleine largeur */
  .inline-photo-left,
  .inline-photo-right {
    float: none;
    width: 100%;
    margin: 16px 0;
  }
}
</style>

<div style="background: white; min-height: 100vh;">

  <%# ========== H√âROS AVEC PHOTO ========== %>
  <div style="position: relative; height: 500px; overflow: hidden; background: #1e293b;">

    <%# Photo hero %>
    <% if @story.image_url.present? %>
      <img src="<%= @story.image_url %>" class="story-hero-image" alt="<%= @story.title %>" style="position: absolute; top: 0; left: 0;" />
      <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.5), rgba(0,0,0,0.7));"></div>
    <% else %>
      <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #7e22ce, #c026d3);"></div>
    <% end %>

    <%# Contenu hero %>
    <div style="position: relative; z-index: 10; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; padding: 48px 24px; max-width: 1200px; margin: 0 auto;">
      <div style="display: inline-block; align-self: flex-start; background: linear-gradient(135deg, #a855f7, #ec4899); padding: 8px 20px; border-radius: 999px; font-size: 13px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(168,85,247,0.3);">
        <%= theme[:icon] %> <%= theme[:name] %>
      </div>
      <h1 class="story-hero-title" style="font-size: 52px; font-weight: 800; color: white; margin: 0 0 16px 0; line-height: 1.1; text-shadow: 0 4px 20px rgba(0,0,0,0.5); word-wrap: break-word;">
        <%= @story.title %>
      </h1>
      <div style="display: flex; flex-wrap: wrap; gap: 20px; color: rgba(255,255,255,0.9); font-size: 15px; font-weight: 600;">
        <% if date_fr.present? %>
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 18px;">üìÖ</span>
            <span><%= date_fr %></span>
          </div>
        <% end %>
        <% if @story.source_name.present? %>
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 18px;">üìç</span>
            <span>Source : <%= @story.source_name %></span>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%# ESPACEMENT 1 %>
  <div class="story-spacing-1"></div>

  <%# ========== CONTENU PRINCIPAL ========== %>
  <div style="max-width: 1400px; margin: 0 auto; padding: 0 24px;">

    <div class="story-grid" style="display: grid; grid-template-columns: 1fr 380px; gap: 48px; align-items: start;">

      <%# COLONNE PRINCIPALE %>
      <div style="min-width: 0;">

        <%# Chapo %>
        <% if @story.chapo.present? %>
          <div style="background: linear-gradient(135deg, #faf5ff, #f3e8ff); border-left: 6px solid #a855f7; padding: 28px 32px; border-radius: 16px; margin-bottom: 40px; box-shadow: 0 4px 20px rgba(168,85,247,0.15);">
            <p style="font-size: 22px; line-height: 1.6; color: #1e293b; font-weight: 600; margin: 0; font-style: italic; word-wrap: break-word;">
              <%= @story.chapo %>
            </p>
          </div>
        <% end %>

        <%# Le r√©cit de l'action avec PHOTOS INLINE INTELLIGENTES %>
        <div style="background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); border: 2px solid #f1f5f9; margin-bottom: 32px;">
          <h2 class="story-section-title" style="font-size: 28px; font-weight: 700; color: #1e293b; margin: 0 0 24px 0; display: flex; align-items: center; gap: 12px; word-wrap: break-word;">
            <span style="font-size: 32px;">üëâ</span>
            Le r√©cit de l'action
          </h2>

          <div class="markdown-content" style="font-size: 18px; line-height: 1.8; color: #1e293b; word-wrap: break-word;">
            <%
              # Collecter les photos inline attach√©es
              inline_photos = []
              if @story.respond_to?(:inline_image_1) && @story.inline_image_1.attached?
                inline_photos << {
                  url: url_for(@story.inline_image_1),
                  caption: @story.respond_to?(:inline_caption_1) ? @story.inline_caption_1 : nil,
                  position: 'left'
                }
              end
              if @story.respond_to?(:inline_image_2) && @story.inline_image_2.attached?
                inline_photos << {
                  url: url_for(@story.inline_image_2),
                  caption: @story.respond_to?(:inline_caption_2) ? @story.inline_caption_2 : nil,
                  position: 'right'
                }
              end
              if @story.respond_to?(:inline_image_3) && @story.inline_image_3.attached?
                inline_photos << {
                  url: url_for(@story.inline_image_3),
                  caption: @story.respond_to?(:inline_caption_3) ? @story.inline_caption_3 : nil,
                  position: 'full'
                }
              end

              # D√©tecter si le texte est court (moins de 500 caract√®res sans les marqueurs)
              text_length = @story.body.to_s.gsub(/<!--.*?-->/, '').strip.length
              is_short_text = text_length < 500

              # Rendu du body avec injection des photos
              rendered_body = @story.body.to_s

              inline_photos.each_with_index do |photo, index|
                marker = "<!-- IMAGE_#{index + 1} -->"

                if is_short_text
                  # MODE STACK : Photos pleine largeur pour textes courts
                  photo_html = %Q{
                    <figure class="inline-photo-stack">
                      <img src="#{photo[:url]}" alt="Photo #{index + 1}" loading="lazy" />
                      #{"<figcaption class=\"inline-photo-caption\">#{photo[:caption]}</figcaption>" if photo[:caption].present?}
                    </figure>
                  }.html_safe
                else
                  # MODE FLOAT : Layout magazine pour textes longs
                  case photo[:position]
                  when 'left'
                    photo_html = %Q{
                      <figure class="inline-photo-left">
                        <img src="#{photo[:url]}" alt="Photo #{index + 1}" loading="lazy" />
                        #{"<figcaption class=\"inline-photo-caption\">#{photo[:caption]}</figcaption>" if photo[:caption].present?}
                      </figure>
                    }.html_safe
                  when 'right'
                    photo_html = %Q{
                      <figure class="inline-photo-right">
                        <img src="#{photo[:url]}" alt="Photo #{index + 1}" loading="lazy" />
                        #{"<figcaption class=\"inline-photo-caption\">#{photo[:caption]}</figcaption>" if photo[:caption].present?}
                      </figure>
                    }.html_safe
                  else # 'full'
                    photo_html = %Q{
                      <figure class="inline-photo-full">
                        <img src="#{photo[:url]}" alt="Photo #{index + 1}" loading="lazy" />
                        #{"<figcaption class=\"inline-photo-caption\">#{photo[:caption]}</figcaption>" if photo[:caption].present?}
                      </figure>
                    }.html_safe
                  end
                end

                rendered_body = rendered_body.sub(marker, photo_html)
              end
            %>

            <%= raw(Kramdown::Document.new(rendered_body).to_html) %>
          </div>
        </div>

        <%# Points cl√©s / Highlights %>
        <% if @story.highlights_title.present? || @story.highlights_text.present? || @story.highlights_items.present? %>
          <div style="background: linear-gradient(135deg, #fefce8, #fef3c7); border-left: 6px solid #f59e0b; padding: 32px; border-radius: 20px; margin-bottom: 32px; box-shadow: 0 8px 30px rgba(245,158,11,0.2);">
            <h3 style="font-size: 24px; font-weight: 700; color: #1e293b; margin: 0 0 20px 0; display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 28px;">‚ö°</span>
              <%= @story.highlights_title.presence || "Points cl√©s" %>
            </h3>
            <% if @story.highlights_text.present? %>
              <p style="font-size: 18px; line-height: 1.7; color: #1e293b; margin: 0 0 16px 0; word-wrap: break-word;">
                <%= simple_format(@story.highlights_text) %>
              </p>
            <% end %>
            <% if @story.highlights_items.present? %>
              <ul style="margin: 0; padding-left: 24px; font-size: 17px; line-height: 1.8; color: #1e293b;">
                <% @story.highlights_items.split("\n").each do |item| %>
                  <li style="margin-bottom: 8px; word-wrap: break-word;"><%= item.strip %></li>
                <% end %>
              </ul>
            <% end %>
          </div>
        <% end %>

        <%# CTA Opportunit√©s %>
        <div style="background: linear-gradient(135deg, #a855f7, #ec4899); border-radius: 24px; padding: 48px; text-align: center; box-shadow: 0 20px 60px rgba(168,85,247,0.4); margin-bottom: 32px;">
          <div style="font-size: 56px; margin-bottom: 20px;">‚ú®</div>
          <h2 class="story-cta-title" style="font-size: 32px; font-weight: 700; color: white; margin: 0 0 16px 0; word-wrap: break-word;">
            Et moi, comment je peux avoir le D√©clic ?
          </h2>
          <p style="font-size: 19px; color: rgba(255,255,255,0.95); margin: 0 auto 28px; max-width: 600px; line-height: 1.6; word-wrap: break-word;">
            Cette histoire vous inspire ? Des dizaines d'opportunit√©s similaires vous attendent pr√®s de chez vous pour entreprendre, vous former ou vous engager.
          </p>
          <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 16px;">
            <a href="/opportunities" style="display: inline-flex; align-items: center; gap: 10px; background: white; color: #a855f7; padding: 18px 36px; border-radius: 999px; font-weight: 700; font-size: 17px; text-decoration: none; box-shadow: 0 8px 20px rgba(0,0,0,0.2); white-space: nowrap;">
              <span>üîç Partager un t√©moignage</span>
            </a>
            <a href="/opportunities" style="display: inline-flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white; padding: 18px 36px; border-radius: 999px; font-weight: 700; font-size: 17px; text-decoration: none; border: 2px solid rgba(255,255,255,0.3); white-space: nowrap;">
              <span>‚ûï Proposer une opportunit√©</span>
            </a>
          </div>
        </div>

      </div>

      <%# SIDEBAR %>
      <div class="story-sidebar" style="position: sticky; top: 32px; align-self: start; min-width: 0;">

        <%# Carte %>
        <% if @story.location.present? && @story.latitude.present? %>
          <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 2px solid #e9d5ff; margin-bottom: 24px;">
            <div id="story-map" style="height: 240px;" data-lat="<%= @story.latitude %>" data-lon="<%= @story.longitude %>"></div>
            <div style="padding: 16px; background: #fafafa;">
              <p style="color: #475569; font-weight: 600; margin: 0; font-size: 14px; display: flex; align-items: start; gap: 8px; word-wrap: break-word; overflow-wrap: break-word;">
                <svg style="width: 18px; height: 18px; flex-shrink: 0; color: #a855f7; margin-top: 2px;" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path>
                </svg>
                <%= @story.location %>
              </p>
            </div>
          </div>
        <% end %>

        <%# Infos cl√©s %>
        <div style="background: white; border-radius: 20px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 2px solid #e9d5ff; margin-bottom: 24px;">
          <h3 style="font-weight: 700; font-size: 18px; color: #1e293b; margin: 0 0 20px 0; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 20px;">‚ÑπÔ∏è</span>
            Informations cl√©s
          </h3>

          <% if date_fr.present? %>
            <div style="display: flex; align-items: start; gap: 12px; padding: 16px; background: #faf5ff; border-radius: 12px; margin-bottom: 16px;">
              <div style="flex-shrink: 0; width: 44px; height: 44px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <span style="font-size: 20px;">üìÖ</span>
              </div>
              <div style="min-width: 0;">
                <div style="font-size: 11px; font-weight: 700; color: #7e22ce; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Date</div>
                <div style="font-weight: 700; color: #1e293b; font-size: 14px; line-height: 1.4; word-wrap: break-word;"><%= date_fr %></div>
              </div>
            </div>
          <% end %>

          <% if @story.location.present? %>
            <div style="display: flex; align-items: start; gap: 12px; padding: 16px; background: #faf5ff; border-radius: 12px; margin-bottom: 16px;">
              <div style="flex-shrink: 0; width: 44px; height: 44px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <span style="font-size: 20px;">üè™</span>
              </div>
              <div style="min-width: 0;">
                <div style="font-size: 11px; font-weight: 700; color: #7e22ce; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Lieu</div>
                <div style="font-weight: 700; color: #1e293b; font-size: 14px; line-height: 1.4; word-wrap: break-word; overflow-wrap: break-word;"><%= @story.location %></div>
              </div>
            </div>
          <% end %>

          <%# Lien vers l'article source %>
          <% if @story.source_url.present? %>
            <div style="display: flex; align-items: start; gap: 12px; padding: 16px; background: #faf5ff; border-radius: 12px; margin-bottom: 16px;">
              <div style="flex-shrink: 0; width: 44px; height: 44px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <span style="font-size: 20px;">üì∞</span>
              </div>
              <div style="min-width: 0;">
                <div style="font-size: 11px; font-weight: 700; color: #7e22ce; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Source de l'histoire</div>
                <a href="<%= @story.source_url %>" target="_blank" rel="noopener" style="font-weight: 700; color: #3b82f6; font-size: 14px; line-height: 1.4; word-wrap: break-word; overflow-wrap: break-word; text-decoration: none; display: block;">
                  <%= @story.source_name.presence || "Lien vers l'article" %> ‚Üí
                </a>
              </div>
            </div>
          <% end %>

          <%# Informations de contact %>
          <% if @story.respond_to?(:contact_info) && @story.contact_info.present? %>
            <div style="display: flex; align-items: start; gap: 12px; padding: 16px; background: #faf5ff; border-radius: 12px;">
              <div style="flex-shrink: 0; width: 44px; height: 44px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <span style="font-size: 20px;">üìß</span>
              </div>
              <div style="min-width: 0;">
                <div style="font-size: 11px; font-weight: 700; color: #7e22ce; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Contact</div>
                <div style="font-weight: 600; color: #1e293b; font-size: 14px; line-height: 1.4; word-wrap: break-word; overflow-wrap: break-word;"><%= @story.contact_info %></div>
              </div>
            </div>
          <% end %>
        </div>

        <%# Partage %>
        <div style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: 20px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 2px solid #cbd5e1; margin-bottom: 24px;">
          <h3 style="font-weight: 700; color: #1e293b; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px; font-size: 16px;">
            <span style="font-size: 20px;">üì¢</span>
            Partagez
          </h3>
          <div style="display: flex; gap: 12px;">
            <a href="https://www.facebook.com/sharer/sharer.php?u=<%= request.original_url rescue '' %>" target="_blank" rel="noopener" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; background: #3b82f6; color: white; padding: 12px; border-radius: 12px; text-decoration: none; font-weight: 700; font-size: 13px; min-width: 0;">
              <svg style="width: 18px; height: 18px; flex-shrink: 0;" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
              <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Facebook</span>
            </a>
            <a href="https://twitter.com/intent/tweet?url=<%= request.original_url rescue '' %>" target="_blank" rel="noopener" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; background: #1e293b; color: white; padding: 12px; border-radius: 12px; text-decoration: none; font-weight: 700; font-size: 13px; min-width: 0;">
              <svg style="width: 18px; height: 18px; flex-shrink: 0;" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
              <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">X</span>
            </a>
          </div>
        </div>

      </div>

    </div>
  </div>

  <%# ESPACEMENT 3 %>
  <div class="story-spacing-1"></div>

  <%# ========== D√âCOUVERTE ========== %>
  <div style="border-top: 2px solid #e2e8f0;">
    <div style="background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); padding: 80px 24px;">
      <div style="max-width: 900px; margin: 0 auto; text-align: center;">
        <div style="font-size: 64px; margin-bottom: 20px;">üåü</div>
        <h2 style="color: white; font-size: 38px; font-weight: 700; margin: 0 0 16px 0; word-wrap: break-word;">
          D√©couvrez d'autres histoires inspirantes
        </h2>
        <p style="color: #cbd5e1; font-size: 19px; margin: 0 auto 32px; max-width: 600px; line-height: 1.6; word-wrap: break-word;">
          Des centaines de personnes ont d√©j√† trouv√© leur D√©clic. √Ä votre tour de vous lancer dans l'aventure !
        </p>
        <a href="/stories" style="display: inline-flex; align-items: center; gap: 12px; background: linear-gradient(135deg, #a855f7, #ec4899); color: white; padding: 20px 48px; border-radius: 999px; font-weight: 700; font-size: 18px; text-decoration: none; box-shadow: 0 10px 40px rgba(168,85,247,0.4); white-space: nowrap;">
          <span>Toutes les Belles Histoires</span>
          <svg style="width: 22px; height: 22px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
          </svg>
        </a>
      </div>
    </div>
  </div>

</div>

<%# CARTE LEAFLET %>
<% if @story.latitude.present? && @story.longitude.present? %>
<script>
function initStoryMap() {
  var el = document.getElementById('story-map');
  if (!el || el.dataset.mapInited === "1") return;
  var lat = parseFloat(el.dataset.lat);
  var lon = parseFloat(el.dataset.lon);
  if (!lat || !lon) return;
  var map = L.map(el, { scrollWheelZoom: false, zoomControl: true }).setView([lat, lon], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap' }).addTo(map);
  var marker = L.marker([lat, lon]).addTo(map);
  marker.bindPopup("<div style='text-align:center;padding:12px;'><div style='font-size:24px;margin-bottom:8px;'>‚ú®</div><strong style='font-size:16px;'><%= @story.title.to_s.gsub("'", "\\'") rescue '' %></strong><br><span style='color:#64748b;'><%= @story.location.to_s.gsub("'", "\\'") rescue '' %></span></div>");
  el.dataset.mapInited = "1";
  setTimeout(() => map.invalidateSize(), 100);
}
if (document.readyState === "loading") { document.addEventListener("DOMContentLoaded", initStoryMap); } else { initStoryMap(); }
document.addEventListener("turbo:load", initStoryMap);
document.addEventListener("turbo:render", initStoryMap);
</script>
<% end %>
