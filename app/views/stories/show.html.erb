<%# app/views/stories/show.html.erb - Style aligné sur Opportunities (Final) %>
<% content_for :main_classes, "pt-0" %>

<%
# ---------- 1. CONFIGURATION DU THÈME (Basé sur le modèle Opportunity) ----------

# Le modèle Story n'a pas de colonne 'category'. On utilise le titre pour la thématisation.
story_haystack = @story.title.to_s.downcase

is_eco = story_haystack.include?('jardin') || story_haystack.include?('laiterie') || story_haystack.include?('écologie')

theme = if is_eco
  {
    badge: "bg-emerald-600 text-white",
    title: "text-emerald-700",
    btn_gradient: "bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700",
    icon: "text-emerald-600",
    bg_light: "bg-emerald-50",
    border: "border-emerald-100"
  }
else
  # Thème par défaut (Indigo/Violet)
  {
    badge: "bg-indigo-600 text-white",
    title: "text-indigo-700",
    btn_gradient: "bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700",
    icon: "text-indigo-600",
    bg_light: "bg-indigo-50",
    border: "border-indigo-100"
  }
end
%>

<%# Définir l'émoji basé sur le Helper des Stories %>
<% story_emoji = emoji_for(@story.title) %>


<div class="relative pb-16 bg-white overflow-hidden">

  <%# ---------------------------------------------------- %>
  <%# 2. EN-TÊTE (TITRE ET INTRO) - SANS GRILLE %>
  <%# ---------------------------------------------------- %>
  <div class="relative pt-6 pb-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="relative bg-white lg:max-w-7xl lg:mx-auto">

        <p class="inline-flex items-center space-x-2 text-sm">
          <%# Affiche "Belle Histoire" car il n'y a pas de champ category %>
          <span class="<%= theme[:badge] %> inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium">
            Belle Histoire
          </span>
          <span class="text-slate-500">
            <%= l @story.happened_on, format: :long %>
          </span>
        </p>

        <h1 class="text-4xl tracking-tight font-extrabold text-slate-900 mt-4 sm:text-5xl md:text-6xl">
          <%# Affichage de l'émoji dans le titre %>
          <span class="mr-3"><%= story_emoji %></span>
          <%= @story.title %>
        </h1>

        <%# AFFICHAGE DE L'IMAGE D'ILLUSTRATION %>
        <%# Note: Les Stories utilisent image_url %>
        <% if @story.image_url.present? %>
          <div class="mt-6">
            <%= image_tag(@story.image_url,
              class: "rounded-xl shadow-lg w-full object-cover aspect-video",
              alt: @story.title) %>
          </div>
        <% end %>

        <%# Introduction/Chapo: Utilise le champ chapo ou extrait du body %>
        <% chapo_text = @story.chapo.presence || @story.body.to_s.split("\n\n").first.strip %>
        <% if chapo_text.present? %>
          <div class="markdown-content prose prose-lg prose-slate max-w-none text-slate-700 leading-relaxed">
            <%= md(chapo_text) %>
          </p>
        <% end %>

      </div>
    </div>
  </div>

  <%# ---------------------------------------------------- %>
  <%# 3. CORPS ET INFORMATIONS SECONDAIRES (GRILLE INVERSÉE 1/3 - 2/3) %>
  <%# ---------------------------------------------------- %>
  <div class="relative bg-slate-50 <%= theme[:border] %> border-t py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:grid lg:grid-cols-3 lg:gap-8">

      <%# Colonne de gauche (Carte et Infos) - span 1 %>
      <div class="lg:col-span-1 pt-12 lg:pt-0">
        <div class="sticky top-12 space-y-8">

          <%# Carte %>
          <% if @story.location.present? && @story.latitude.present? %>
            <div id="story-map"
                 class="w-full aspect-video rounded-xl shadow-lg border-2 <%= theme[:border] %> z-0"
                 data-lat="<%= @story.latitude %>"
                 data-lon="<%= @story.longitude %>">
            </div>
          <% end %>

          <%# Bouton de contact %>
          <% if @story.source_name.present? %>
            <a href="#"
               class="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white <%= theme[:btn_gradient] %> shadow-lg shadow-<%= is_eco ? 'emerald' : 'indigo' %>-500/50 transform transition duration-200 hover:scale-[1.01]">
              Découvrir la source : <%= @story.source_name %>
            </a>
          <% end %>

          <%# Infos pratiques %>
          <div class="space-y-4 pt-4">
            <h2 class="text-lg font-bold text-slate-700 border-b pb-2">Informations clés</h2>

            <%# Lieu %>
            <% if @story.location.present? %>
              <div class="flex items-start gap-3">
                <svg class="w-6 h-6 flex-shrink-0 <%= theme[:icon] %>" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M11.54 22.351A8.257 8.257 0 0 1 12 22.5c2.21 0 4.218-.813 5.759-2.008m-11.518 0C6.182 21.687 8.19 22.5 10.5 22.5h1.5a8.257 8.257 0 0 0-3.99-1.399l-.02.007a49.102 49.102 0 0 1-.502-.275C6.734 20.306 6 19.492 6 18.5V9a6 6 0 0 1 6-6 6 6 0 0 1 6 6v9.5c0 .992-.734 1.806-1.666 2.302-.132.072-.265.143-.4.214-.02.01-.04.02-.06.03l-.02.01c-.13.065-.262.13-.393.193a.75.75 0 0 0-.15.062 8.286 8.286 0 0 1-.365.176h-1.5c.046 0 .092 0 .138-.002m-1.442-2.122A8.25 8.25 0 0 0 12 21.75a8.25 8.25 0 0 0 3.702-1.293L12 16.5l-3.702 3.136ZM18 9a4.5 4.5 0 0 0-9 0v9.5c0 .034.004.067.012.1A6.75 6.75 0 0 0 12 20.25a6.75 6.75 0 0 0 4.988-1.574A.75.75 0 0 0 17 18.5V9Z" clip-rule="evenodd" /></svg>
                <div class="text-slate-700">
                  <span class="font-semibold block">Lieu de l'action :</span>
                  <%= @story.location %>
                </div>
              </div>
            <% end %>

            <%# Date %>
            <% if @story.happened_on.present? %>
              <div class="flex items-start gap-3">
                <svg class="w-6 h-6 flex-shrink-0 <%= theme[:icon] %>" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6.75c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" /></svg>
                <div class="text-slate-700">
                  <span class="font-semibold block">Date de l'événement :</span>
                  <%= l @story.happened_on, format: :long %>
                </div>
              </div>
            <% end %>
          </div>

        </div>
      </div>

      <%# Colonne de droite (Contenu Principal) - span 2 %>
      <div class="lg:col-span-2 pt-12 lg:pt-0">
        <h2 class="text-xl font-extrabold text-slate-900 border-b pb-4 mb-8">
          Le récit de l'action
        </h2>

        <%# Rendu du Contenu : Utilise le helper render_story_body pour la mise en page spécifique des Stories %>
        <div class="flow-root">
          <div class="prose prose-lg prose-slate max-w-none text-slate-700 leading-relaxed">
            <%= render_story_body(@story.body) %>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>




<%# SCRIPT CARTE %>
<% if @story.latitude.present? && @story.longitude.present? %>
<script>
  function initStoryMap() {
    var el = document.getElementById('story-map');
    if (!el) return;

    if (el.dataset.mapInited === "1") return;

    var lat = parseFloat(el.dataset.lat);
    var lon = parseFloat(el.dataset.lon);

    if (!lat || !lon) return;

    var map = L.map(el, { scrollWheelZoom: false }).setView([lat, lon], 14);

    var osmUrl = 'https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png';
    L.tileLayer(osmUrl, {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    var marker = L.marker([lat, lon]).addTo(map);
    marker.bindPopup("<b><%= j(@story.title) %></b><br><%= j(@story.location.to_s) %>");

    el.dataset.mapInited = "1";

    setTimeout(function() { map.invalidateSize(); }, 100);
    requestAnimationFrame(function() { map.invalidateSize(); });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initStoryMap);
  } else {
    initStoryMap();
  }

  document.addEventListener("turbo:load", initStoryMap);
  document.addEventListener("turbo:render", initStoryMap);
</script>
<% end %>
