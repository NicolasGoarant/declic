<%# app/views/stories/show.html.erb %>
<% content_for :main_classes, "pt-0" %>

<%
# ---------- 1. CONFIGURATION (Couleurs & Images) ----------
accent1 = "#7e5bef" # violet
accent2 = "#3b82f6" # mauve/bleu

# Image h√©ro : fallback intelligent
img =
  if @story.image_url.present?
    (@story.image_url =~ /\Ahttp/i) ? @story.image_url : asset_path(@story.image_url)
  else
    hay = [@story.title, @story.chapo].compact.join(" ").downcase
    if hay =~ /(b√©n√©vol|solidar|entraide|don)/
      "https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?q=80&w=1600&auto=format&fit=crop"
    elsif hay =~ /(formation|atelier|apprendre)/
      "https://images.unsplash.com/photo-1513258496099-48168024aec0?q=80&w=1600&auto=format&fit=crop"
    elsif hay =~ /(rencontre|communaut√©|f√™te)/
      "https://images.unsplash.com/photo-1529156069898-49953e39b3ac?q=80&w=1600&auto=format&fit=crop"
    else
      "https://images.unsplash.com/photo-1497366216548-37526070297c?q=80&w=1600&auto=format&fit=crop"
    end
  end
%>

<div class="relative w-full h-64 md:h-80 overflow-hidden bg-slate-900">
  <div class="absolute inset-0 bg-cover bg-center opacity-60 transition-transform duration-700 hover:scale-105"
       style="background-image: url('<%= img %>');">
  </div>
  <div class="absolute inset-0 bg-gradient-to-r from-slate-900 via-slate-900/60 to-transparent"></div>

  <div class="absolute inset-0 flex items-center">
    <div class="container mx-auto px-4">
      <div class="max-w-3xl">
        <span class="inline-block py-1 px-3 rounded-full text-xs font-bold uppercase tracking-wider text-white mb-4 shadow-sm backdrop-blur-md bg-white/20 border border-white/30">
          Belle Histoire
        </span>
        <h1 class="text-3xl md:text-5xl font-extrabold text-white leading-tight drop-shadow-md font-serif">
          <%= @story.title %>
        </h1>
      </div>
    </div>
  </div>
</div>

<div class="container mx-auto px-4 -mt-16 relative z-10 pb-24">
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

    <div class="lg:col-span-8">
      <div class="bg-white rounded-3xl shadow-xl p-6 md:p-10 mb-8">

        <div class="flex flex-wrap items-center gap-4 text-sm text-slate-500 mb-8 border-b border-slate-100 pb-6">
          <% if @story.source_name.present? %>
            <div class="flex items-center gap-2">
              <span class="px-2 py-0.5 rounded bg-slate-100 text-slate-600 font-semibold text-xs border border-slate-200">
                Source : <%= @story.source_name %>
              </span>
            </div>
          <% end %>
          <div class="ml-auto text-slate-400">
            Publi√© le <%= l((@story.happened_on || @story.created_at).to_date, format: :long) %>
          </div>
        </div>

        <% if @story.chapo.present? %>
          <div class="text-xl leading-relaxed text-slate-600 mb-6 font-serif italic pl-4 border-l-4 border-[color:var(--accent1)]" style="--accent1: <%= accent1 %>">
            <%= @story.chapo %>
          </div>
        <% end %>

        <div class="space-y-6">
          <%
             # D√©coupage du texte brut bas√© sur les titres Markdown "###"
             raw_body = @story.body.to_s
             sections = raw_body.split(/^###\s+/)
             sections.shift if sections.first.blank?
          %>

          <% if sections.any? %>
            <% sections.each do |section_text| %>
              <%
                 lines = section_text.lines
                 heading = lines.shift.to_s.strip
                 content = lines.join.strip
                 is_action_block = heading.downcase.include?("retenir") || heading.downcase.include?("faire comme")
              %>

              <% if is_action_block %>
                <div class="bg-blue-50 border border-blue-100 rounded-2xl p-6 md:p-8 my-6">
                  <h3 class="text-xl md:text-2xl font-bold text-blue-800 mb-4 flex items-center gap-3 font-serif">
                    <span class="text-2xl">üí°</span> <%= heading.gsub(/^#+\s*/, '') %>
                  </h3>
                  <div class="prose prose-lg prose-blue max-w-none text-slate-700">
                    <%= simple_format(content) %>
                  </div>
                </div>
              <% else %>
                <div class="prose prose-lg prose-slate max-w-none text-slate-700">
                  <% if heading.present? %>
                    <h3 class="text-2xl font-bold text-slate-800 mb-3 mt-2 font-serif text-[color:var(--accent1)]" style="--accent1: <%= accent1 %>">
                      <%= heading.gsub(/^#+\s*/, '') %>
                    </h3>
                  <% end %>
                  <%= simple_format(content) %>
                </div>
              <% end %>
            <% end %>
          <% else %>
            <div class="prose prose-lg prose-slate max-w-none text-slate-700">
              <%= simple_format(@story.body) %>
            </div>
          <% end %>
        </div>

      </div>

      <div class="text-center md:text-left">
        <%= link_to stories_path, class: "inline-flex items-center font-semibold hover:underline text-[color:var(--accent2)]", style: "--accent2: #{accent2}" do %>
          <span>‚Üê</span> <span class="ml-2">Retour aux belles histoires</span>
        <% end %>
      </div>
    </div>

    <div class="lg:col-span-4 space-y-8">

      <% if @story.latitude.present? && @story.longitude.present? %>
        <div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-slate-100 sticky top-24">
          <div class="p-5 border-b border-slate-50 bg-slate-50/50">
            <h3 class="font-bold text-slate-800 flex items-center gap-2">
              <span>üìç</span> C'est o√π ?
            </h3>
            <% if @story.location.present? %>
              <p class="text-sm text-slate-500 mt-1"><%= @story.location %></p>
            <% end %>
          </div>

          <div class="relative w-full bg-slate-100" style="height: 300px;">
            <div id="story-map"
                 class="h-full w-full z-0"
                 data-lat="<%= @story.latitude %>"
                 data-lon="<%= @story.longitude %>">
            </div>
          </div>

          <div class="p-4 bg-slate-50 text-xs text-center text-slate-400">
            Cliquez sur la carte pour explorer les alentours
          </div>
        </div>
      <% end %>

    </div>
  </div>
</div>

<%# SCRIPT CARTE %>
<% if @story.latitude.present? && @story.longitude.present? %>
<script>
  function initStoryMap() {
    var el = document.getElementById('story-map');
    if (!el) return;

    if (el.dataset.mapInited === "1") return;

    var lat = parseFloat(el.dataset.lat);
    var lon = parseFloat(el.dataset.lon);

    if (!lat || !lon) return;

    var map = L.map(el, { scrollWheelZoom: false }).setView([lat, lon], 14);

    var osmUrl = 'https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png';
    L.tileLayer(osmUrl, {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    var marker = L.marker([lat, lon]).addTo(map);
    marker.bindPopup("<b><%= j(@story.title) %></b><br><%= j(@story.location.to_s) %>");

    el.dataset.mapInited = "1";

    setTimeout(function() { map.invalidateSize(); }, 100);
    requestAnimationFrame(function() { map.invalidateSize(); });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initStoryMap);
  } else {
    initStoryMap();
  }

  document.addEventListener("turbo:load", initStoryMap);
  document.addEventListener("turbo:render", initStoryMap);
</script>
<% end %>
