<%# app/views/stories/show.html.erb ‚Äî hero ajust√©, Sommaire ‚Üí Chap√¥ ‚Üí Article %>
<% raw_body = (@story.body.presence || @story.description).to_s %>

<%# Titres H3 pour le sommaire %>
<% headings = raw_body.scan(/^\s*#{'#'*3}\s+(.+?)\s*$/) %>

<%# Chap√¥ : @story.chapo sinon extrait court %>
<%
def chapo_from(text)
  para = text.to_s.split(/\n{2,}/).find { |blk| blk.strip.present? && blk !~ /^\s*###/ }.to_s
  para = para.gsub(/\*\*([^*]+)\*\*/, '\1').gsub(/\*([^*]+)\*/, '\1') # on retire le markdown
  para = para.gsub(/\[([^\]]+)\]\([^)]+\)/, '\1')
  para = para.gsub(/\s+/, ' ').strip
  para.size > 300 ? para[0,300].rstrip + '‚Ä¶' : para
end
chapo_text = @story.chapo.presence || chapo_from(raw_body)
%>

<div class="story-wrap">
  <div class="story-hero" style="height:clamp(260px,32vh,380px)">
    <% img = if @story.image_url.present?
               @story.image_url =~ /\Ahttp/i ? @story.image_url : asset_path(@story.image_url)
             else
               "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=1600&auto=format&fit=crop"
             end %>
    <img src="<%= img %>" alt="<%= @story.title %>">
    <div class="overlay"></div>

    <div class="actions">
      <% if @story.source_url.present? %>
        <% src   = @story.source_url.to_s
           href  = (src =~ /\Ahttps?:\/\//i) ? src : (src.start_with?("/") ? src : (asset_path(src) rescue "/#{src}"))
           ispdf = href.downcase.end_with?(".pdf")
           label = ispdf ? "Article (PDF)" : (@story.source_name.presence || "Source / plus d‚Äôinfos") %>
        <a href="<%= href %>" <%= ispdf ? '' : 'target="_blank" rel="noopener"' %> data-turbo="false">üîó <%= label %></a>
      <% end %>
      <a href="mailto:?subject=<%= CGI.escape(@story.title) %>&body=<%= CGI.escape(request.original_url) %>">‚úâÔ∏è Partager</a>
    </div>

    <div class="story-title">
      <span class="badge">üìñ Belle histoire</span>
      <h1><%= @story.title %></h1>
    </div>
  </div>

  <div class="story-breadcrumb">
    <%= link_to "‚Üê Retour aux belles histoires", stories_path, class: "crumb" %>
  </div>

  <div class="story-grid">
    <section>
      <%# Sommaire %>
      <% if headings.any? %>
        <div class="card card--toc">
          <h3 class="card-title">Sommaire</h3>
          <ul class="toc">
            <% headings.each do |(h)| id = h.parameterize %>
              <li><a href="#<%= id %>"><%= h %></a></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <%# Chap√¥ (apr√®s le sommaire) %>
      <% if chapo_text.present? %>
        <div class="card chapo-card">
          <p><%= chapo_text %></p>
        </div>
      <% end %>

      <%# Article %>
      <article class="card">
        <% html = render_story_body(raw_body) %>

        <%# Ajout d'id sur les h3 sans toucher au contenu (donc on garde les √©mojis) %>
        <% html = html.gsub(/<h3([^>]*)>(.*?)<\/h3>/) do
             attrs   = Regexp.last_match(1)
             content = Regexp.last_match(2)
             text    = content.gsub(/<[^>]+>/, '')
             %Q(<h3#{attrs} id="#{text.parameterize}">#{content}</h3>)
           end %>

        <div class="prose"><%= html.html_safe %></div>
      </article>
    </section>

    <aside class="side">
      <div class="card">
        <h3 class="card-title">Infos pratiques</h3>
        <ul class="info-list">
          <% if @story.location.present? %>
            <li>üìç <span><%= @story.location %></span></li>
          <% end %>
          <% if @story.source_url.present? %>
            <% src  = @story.source_url.to_s
               href = (src =~ /\Ahttps?:\/\//i) ? src : (src.start_with?("/") ? src : (asset_path(src) rescue "/#{src}")) %>
            <li>üì∞ <%= link_to (@story.source_name.presence || "Site / article"), href, target: "_blank", rel: "noopener" %></li>
          <% end %>
        </ul>

        <% if @story.latitude && @story.longitude %>
          <div class="mini-map" id="mini-map"></div>
        <% end %>
      </div>
    </aside>
  </div>
</div>

<%# Styles locaux (chap√¥, sommaire, figure) %>
<style>
  .story-breadcrumb{margin:12px 0 8px}
  .crumb{color:#667085;text-decoration:none;font-size:.9rem}
  .card--toc .toc{display:flex;flex-wrap:wrap;gap:10px;margin:0;padding:0;list-style:none}
  .card--toc .toc a{color:#4338ca;text-decoration:none;padding:4px 8px;border:1px solid #eceaf8;border-radius:999px;background:#f7f6ff}
  .chapo-card{border-left:4px solid #8b5cf6;background:linear-gradient(0deg,#faf8ff,#fff);font-size:1.02rem}
  .chapo-card p{margin:0;color:#3a3a44;line-height:1.7}
  .prose .story-img{margin:18px 0;border-radius:14px;overflow:hidden;border:1px solid #eef1f6}
  .prose .story-img img{width:100%;height:auto;display:block}
</style>

<% if @story.latitude && @story.longitude %>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    document.addEventListener("turbo:load", initMap);
    document.addEventListener("DOMContentLoaded", initMap);
    function initMap(){
      var el = document.getElementById('mini-map'); if(!el || el.dataset.ready) return;
      var map = L.map(el, { zoomControl:true, scrollWheelZoom:false })
                 .setView([<%= @story.latitude.to_f %>, <%= @story.longitude.to_f %>], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap' }).addTo(map);
      L.marker([<%= @story.latitude.to_f %>, <%= @story.longitude.to_f %>]).addTo(map);
      el.dataset.ready = "1";
    }
  </script>
<% end %>














