<%# frozen_string_literal: true %>
<%# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    Stories#show ‚Äî ‚Äúmagazine d‚Äôengagement‚Äù + carte Leaflet int√©gr√©e localement
    - On embarque Leaflet CSS/JS ici pour √©viter les disparitions li√©es au chargement
    - Tol√©rant si Story#category / Story#quote n‚Äôexistent pas
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ %>

<%# ‚Äî‚Äî Leaflet (CSS + JS) : inclus localement pour fiabiliser l‚Äôaffichage ‚Äî‚Äî %>
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-o9N1j7kGStb6m6qN2k3Z5U9G2VqE3zFE1f2l1hGg54Q="
      crossorigin="anonymous">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-o8U9mQnQZkq1mYz5qJvZcXzWcQ2n6M0F6w8Z8R2D4nE="
        crossorigin="anonymous"></script>

<%
# Accent par cat√©gorie si dispo
cat = @story.respond_to?(:category) && @story.category.present? ? @story.category.to_s : ""
accent =
  case cat
  when "benevolat"    then "#2E8B57"  # vert
  when "formation"    then "#0069D9"  # bleu
  when "rencontres"   then "#FF6F61"  # corail
  when "entreprendre" then "#F6A623"  # orange
  else "#4B5563"                     # neutre
  end

# Image h√©ros (HTTP absolu ou asset pipeline)
img =
  if @story.image_url.present?
    (@story.image_url =~ /\Ahttp/i) ? @story.image_url : asset_path(@story.image_url)
  else
    "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=1600&auto=format&fit=crop"
  end
%>

<style>
  /* ============ Look & feel magazine d‚Äôengagement ============ */
  .story-page { --accent:<%= accent %>; background:#fafafa; color:#1e1e1e; }
  .story-page .container { max-width:1120px; margin:0 auto; padding:0 18px; }
  .story-page .container.narrow { max-width:1100px; }

  /* Hero */
  .story-hero{
    height:clamp(320px,40vh,460px);
    background-image:url('<%= img %>');
    background-size:cover; background-position:center;
    border-radius:0 0 2rem 2rem; position:relative; overflow:hidden;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
  }
  .story-hero .overlay{ position:absolute; inset:0;
    background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15)); }
  .story-hero .inner{ position:absolute; bottom:0; padding:2rem; }
  .story-hero .kicker{
    display:inline-block; padding:.3rem .75rem; border-radius:999px;
    background: color-mix(in oklab, var(--accent) 85%, black); color:#fff;
    font-weight:600; font-size:.75rem; letter-spacing:.4px;
  }
  .story-hero .title{
    margin:.35rem 0 0; color:#fff; font-weight:800;
    font-size: clamp(1.8rem, 3vw, 2.8rem);
    font-family: "Newsreader", Georgia, serif;
    text-shadow: 0 1px 10px rgba(0,0,0,.25);
  }

  /* Top actions */
  .backline{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:16px 0 12px; }
  .backlink{ color:#374151; text-decoration:none; font-weight:600; }
  .backlink:hover{ text-decoration:underline; }
  .actions .pill{
    display:inline-block; margin-left:8px; padding:.45rem .8rem; border-radius:999px;
    background:#eef2ff; color:#1f2937; text-decoration:none; font-weight:600;
  }

  /* Grille */
  .layout{ display:grid; grid-template-columns: 1fr; gap:18px; margin-bottom:42px; }
  @media (min-width: 980px){
    .layout{ grid-template-columns: minmax(0, 680px) 360px; align-items:start; }
  }

  /* Carte lat√©rale (hauteur fix√©e !) */
  .side .sidecard{ background:#fff; border-radius:1rem; box-shadow:0 8px 22px rgba(0,0,0,.06); padding:1rem; }
  .side-title{ margin:.25rem 0 8px; font-weight:800; color:#111827; }
  .meta{ list-style:none; padding:0; margin:0 0 .5rem; }
  .meta li{ display:flex; gap:.5rem; margin:.35rem 0; }
  .meta .meta-label{ min-width:84px; color:#6b7280; font-size:.9rem; }
  #story-map{ height:220px; border-radius:.8rem; overflow:hidden; margin:.5rem 0 .25rem; }

  /* Corps */
  .main .chapo.card{
    margin-top:-28px; background:#fff; border-radius:1rem;
    box-shadow:0 12px 26px rgba(0,0,0,.06); padding:1rem 1.25rem;
  }
  .card{ background:#fff; border-radius:1rem; box-shadow:0 8px 22px rgba(0,0,0,.06); padding:1.25rem 1.35rem; }
  .card.soft{ box-shadow:0 6px 14px rgba(0,0,0,.05); }
  .story-section{ margin:12px 0; opacity:1; }
  .story-section h3{
    font-family:"Newsreader", Georgia, serif;
    color:var(--accent); font-size:1.35rem; margin:.25rem 0 .5rem;
  }
  .prose p{ line-height:1.7; margin:0 0 .9rem; }

  /* Citation (affich√©e seulement si pr√©sente) */
  .quote.card{ background: color-mix(in oklab, var(--accent) 9%, white); text-align:center; }
  .quote blockquote{ margin:0; font-family:"Newsreader", Georgia, serif; font-size:1.2rem; color:#111827; }

  /* CTA */
  .story-cta{ margin-top:26px; text-align:center; }
  .story-cta .cta-title{ margin:0; font-weight:800; font-size:1.15rem; color:#111827; }
  .story-cta .cta-sub{ margin:.1rem 0 .8rem; color:#6b7280; }
  .btn-cta{
    background:var(--accent); color:#fff; text-decoration:none; font-weight:800;
    padding:.85rem 1.35rem; border-radius:999px; display:inline-block;
    box-shadow:0 8px 18px color-mix(in oklab, var(--accent) 25%, transparent);
    transition: transform .08s ease, background .2s ease;
  }
  .btn-cta:hover{ transform: translateY(-1px); background: color-mix(in oklab, var(--accent) 85%, black); }

  .muted{ color:#4b5563; font-size:.95rem; }
</style>

<div class="story-page">
  <div class="container narrow">

    <div class="backline">
      <%= link_to "‚Üê Retour aux belles histoires", stories_path, class: "backlink" %>
      <div class="actions">
        <% if @story.source_url.present? %>
          <%= link_to "Article (PDF)", @story.source_url, class: "pill", target: "_blank", rel: "noopener" %>
        <% end %>
        <%= link_to "Partager", request.original_url, class: "pill" %>
      </div>
    </div>

    <!-- HERO -->
    <div class="story-hero">
      <div class="overlay"></div>
      <div class="inner">
        <div class="kicker">Belle histoire</div>
        <h1 class="title"><%= @story.title %></h1>
      </div>
    </div>

    <div class="layout">
      <!-- Colonne principale -->
      <main class="main">
        <% if @story.chapo.present? %>
          <div class="chapo card soft">
            <p><%= @story.chapo %></p>
          </div>
        <% end %>

        <%# D√©coupe du body en sections √† partir de "### " %>
        <% raw_body = @story.body.to_s.strip %>
        <% sections = raw_body.split(/^###\s+/).reject(&:blank?) %>

        <% sections.each do |bloc| %>
          <% lines = bloc.lines %>
          <% heading = lines.first.to_s.strip %>
          <% content_md = lines.drop(1).join.strip %>
          <section class="story-section card">
            <h3><%= heading %></h3>
            <% if respond_to?(:markdown) %>
              <div class="prose"><%= markdown(content_md) %></div>
            <% else %>
              <div class="prose"><%= simple_format(content_md) %></div>
            <% end %>
          </section>
        <% end %>

        <% if @story.respond_to?(:quote) && @story.quote.present? %>
          <figure class="quote card">
            <blockquote>¬´ <%= @story.quote %> ¬ª</blockquote>
          </figure>
        <% end %>

        <div class="story-cta">
          <p class="cta-title">Envie d‚Äôagir √† ton tour ?</p>
          <p class="cta-sub">D√©couvre des opportunit√©s concr√®tes pr√®s de chez toi.</p>
          <%= link_to "Voir les actions autour de moi", opportunities_path, class: "btn-cta" %>
        </div>
      </main>

      <!-- Colonne lat√©rale (carte conserv√©e) -->
      <aside class="side">
        <div class="card sidecard">
          <h4 class="side-title">Infos pratiques</h4>
          <ul class="meta">
            <% if @story.location.present? %>
              <li>
                <span class="meta-label">üìç Adresse</span>
                <span class="meta-value"><%= @story.location %></span>
              </li>
            <% end %>
            <% if @story.source_name.present? %>
              <li>
                <span class="meta-label">üì∞ Source</span>
                <% if @story.source_url.present? %>
                  <span class="meta-value"><%= link_to @story.source_name, @story.source_url, target: "_blank", rel: "noopener" %></span>
                <% else %>
                  <span class="meta-value"><%= @story.source_name %></span>
                <% end %>
              </li>
            <% end %>
          </ul>

          <% if @story.latitude.present? && @story.longitude.present? %>
            <div id="story-map"
                 data-lat="<%= @story.latitude %>"
                 data-lon="<%= @story.longitude %>"></div>
          <% end %>

          <% if @story.description.present? %>
            <div class="muted"><%= @story.description %></div>
          <% end %>
        </div>
      </aside>
    </div>
  </div>
</div>

<script>
  // Apparition des sections
  document.querySelectorAll('.story-section').forEach((el, i) => {
    el.style.opacity = 0; el.style.transform = "translateY(6px)";
    setTimeout(() => {
      el.style.transition = "opacity .5s ease, transform .5s ease";
      el.style.opacity = 1; el.style.transform = "translateY(0)";
    }, 120 + i * 100);
  });

  // Initialisation carte ‚Äî robuste (DOMContentLoaded + Turbo)
  function initStoryMap(){
    var mapEl = document.getElementById('story-map');
    if(!mapEl || !window.L) return;

    var lat = parseFloat(mapEl.dataset.lat), lon = parseFloat(mapEl.dataset.lon);
    if(isNaN(lat) || isNaN(lon)) return;

    // √©vite double init si navigation Turbo
    if(mapEl.dataset.mapInited === "1") return;

    var map = L.map(mapEl, { zoomControl: false, attributionControl: false })
               .setView([lat, lon], 14);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);
    L.marker([lat, lon]).addTo(map);

    mapEl.dataset.mapInited = "1";
  }

  document.addEventListener('DOMContentLoaded', initStoryMap);
  document.addEventListener('turbo:load', initStoryMap);
</script>
