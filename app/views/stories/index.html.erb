<%# app/views/stories/index.html.erb ‚Äî v2 : coh√©rence avec la home D√©clic (fond, map, cartes) %>

<div class="stories-ms">
  <header class="st-hero">
    <div class="container">
      <h1 class="st-title">Belles histoires</h1>
      <p class="st-chapo">Des parcours inspirants de reconversion et de prise de risque.</p>
    </div>
  </header>

  <!-- Carte -->
  <section class="st-map-section">
    <div class="container">
      <div class="st-mapwrap">
        <div id="map-stories" class="st-map"></div>
        <button id="btn-locate-stories" class="st-btn-locate"><span>üìç</span> <span>Me localiser</span></button>
        <button id="btn-fixloc-stories" class="st-btn-fix"><span>üó∫Ô∏è</span> <span>D√©finir ma position</span></button>
      </div>
    </div>
  </section>

  <div class="max-w-5xl mx-auto py-10">
  <div class="flex items-center justify-between gap-4 mb-6">
    <h1 class="text-2xl font-semibold">T√©moignages</h1>

<div class="mt-4">
  <%= link_to "üí¨ Partager mon t√©moignage",
      new_story_path,
      class: "inline-flex items-center gap-2 rounded-full bg-violet-600 px-4 py-2 text-sm font-semibold text-white hover:bg-violet-700" %>
</div>

  <!-- ici ta liste de stories -->
</div>


  <!-- Grille d‚Äôhistoires -->
  <section class="st-list">
    <div class="container">
      <div class="st-grid">
        <% @stories.each do |s| %>
          <article class="st-card">
            <img src="<%= s.image_url.presence || 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=1200&auto=format&fit=crop' %>"
                 alt="<%= s.title %>" class="st-thumb" loading="lazy">

            <div class="st-card-body">
              <span class="st-badge">Belle histoire</span>
              <h2 class="st-card-title"><%= s.title %></h2>
              <p class="st-card-text"><%= (s.try(:chapo).presence || s.try(:description)).to_s %></p>

              <div class="st-card-footer">
                <% if s.location.present? %><span class="st-loc">üìç <%= s.location %></span><% end %>
                <%= link_to "Lire", story_path(s.respond_to?(:slug) && s.slug.present? ? s.slug : s.id),
                            class: "st-btn" %>
              </div>
            </div>
          </article>
        <% end %>
      </div>
    </div>
  </section>
</div>

<style>
  .stories-ms {
    --violet:#7e5bef;
    --muted:#f6f3ff;
    background: radial-gradient(1200px 700px at 10% -10%, #efe8ff 0%, transparent 60%) no-repeat,
                linear-gradient(180deg,#fbfaff 0%,#f6f3ff 60%,#f3f1ff 100%);
    font-family:"Inter",system-ui,sans-serif;
    color:#0f172a;
    min-height:100vh;
  }
  .container{ max-width:1280px; margin:0 auto; padding:0 24px; }

  /* HERO */
  .st-hero{ text-align:left; padding:clamp(2rem,5vw,3.5rem) 0 1rem; }
  .st-title{ font:900 clamp(2.2rem,4vw,3rem)/1.1 "Epilogue"; margin:0; }
  .st-chapo{ margin-top:.5rem; font:500 1.15rem/1.6 "Inter"; color:#475569; }

  /* MAP */
  .st-map-section{ padding-bottom:2.5rem; }
  .st-mapwrap{ position:relative; border-radius:20px; overflow:hidden; box-shadow:0 12px 28px rgba(15,23,42,.08); }
  .st-map{ width:100%; height:420px; }
  .st-btn-locate,.st-btn-fix{
    position:absolute; right:12px; z-index:20; display:inline-flex; gap:8px; align-items:center;
    padding:.7rem 1rem; border-radius:12px; background:#fff; border:1px solid #e6e8ee;
    box-shadow:0 6px 16px rgba(15,23,42,.08); font:600 .9rem/1 "Inter"; color:#0f172a;
  }
  .st-btn-locate{ top:12px; }
  .st-btn-fix{ top:60px; }

  /* GRID */
  .st-list{ padding-bottom:4rem; }
  .st-grid{
    display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
    gap:28px; margin-top:1.5rem;
  }

  /* CARD */
  .st-card{
    background:#fff; border-radius:20px; overflow:hidden;
    border:1px solid #e6e8ee; box-shadow:0 10px 26px rgba(15,23,42,.08);
    display:flex; flex-direction:column; transition:transform .2s ease, box-shadow .2s ease;
  }
  .st-card:hover{ transform:translateY(-4px); box-shadow:0 16px 38px rgba(15,23,42,.12); }
  .st-thumb{ width:100%; height:180px; object-fit:cover; display:block; }
  .st-card-body{ padding:20px; flex:1; display:flex; flex-direction:column; }
  .st-badge{
    align-self:flex-start; font:700 .75rem/1 "Inter"; background:#ede9fe; color:#6d28d9;
    padding:.35rem .7rem; border-radius:999px;
  }
  .st-card-title{ margin:.6rem 0 .3rem; font:800 1.1rem/1.3 "Epilogue"; }
  .st-card-text{
    flex:1; font:500 .98rem/1.55 "Inter"; color:#475569;
    display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
  }
  .st-card-footer{
    display:flex; align-items:center; justify-content:space-between;
    margin-top:1rem; font:.9rem/1.4 "Inter"; color:#475569;
  }
  .st-loc{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .st-btn{
    background:var(--violet); color:#fff; text-decoration:none; font:700 .9rem/1 "Epilogue";
    padding:.6rem 1rem; border-radius:10px; box-shadow:0 8px 20px rgba(126,91,239,.25);
  }
  .st-btn:hover{ background:#6d28d9; }

    @keyframes gradientShift {
    0%   { background-position: 0%   50%; }
    50%  { background-position: 100% 50%; }
    100% { background-position: 0%   50%; }
  }

  @media(max-width:560px){
    .st-map{ height:320px; }
    .st-card-text{ -webkit-line-clamp:2; }
  }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<% content_for :scripts do %>
<script>
document.addEventListener('turbo:load', bootStories, { once:true });
document.addEventListener('DOMContentLoaded', bootStories, { once:true });

function bootStories(){
  const el=document.getElementById('map-stories');
  if(!el||!window.L) return;
  if(el.dataset.mapInited==="1") return;
  const map=L.map(el,{zoomControl:true,attributionControl:false}).setView([46.6,2.2],6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  const layer = L.layerGroup().addTo(map);

const icon = () => L.divIcon({
  className: '',
  html: `<div style="
    width:26px;
    height:26px;
    border-radius:9999px;
    border:2px solid #fff;
    display:grid;
    place-items:center;
    color:#fff;
    font-size:14px;
    box-shadow:0 1px 4px rgba(0,0,0,.25);
    position:relative;
    background:linear-gradient(135deg,#f97316,#ec4899,#3b82f6,#22c55e,#f59e0b);
    background-size:320% 320%;
    animation:gradientShift 8s ease infinite;
  "><span>üìñ</span></div>`,
  iconSize: [26, 32],
  iconAnchor: [13, 28],
  popupAnchor: [0, -26]
});

  const bounds=[];
  fetch('/api/v1/stories').then(r=>r.ok?r.json():[]).then(data=>{
    (data||[]).forEach(s=>{
      if(!s.latitude||!s.longitude)return;
      const m=L.marker([s.latitude,s.longitude],{icon:icon()}).addTo(layer);
      const url=`/stories/${s.slug||s.id}`;
      m.bindPopup(`<strong>${s.title||''}</strong><p style="margin:.4rem 0">${(s.description||s.chapo||'').slice(0,90)}${((s.description||s.chapo||'').length>90)?'‚Ä¶':''}</p><a href="${url}" class="text-indigo-600 underline text-sm">Lire l‚Äôhistoire</a>`);
      bounds.push([s.latitude,s.longitude]);
    });
    if(bounds.length) map.fitBounds(bounds,{padding:[24,24]});
  });
  el.dataset.mapInited="1";

  // Localisation simple
  document.getElementById('btn-locate-stories')?.addEventListener('click',()=>{
    if(!('geolocation'in navigator))return alert("G√©olocalisation non support√©e");
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude,longitude}=pos.coords;
      map.flyTo([latitude,longitude],12,{duration:.8});
      L.circleMarker([latitude,longitude],{radius:6,color:'#6366f1',fillColor:'#6366f1',fillOpacity:.9}).addTo(layer);
    });
  });
}
</script>
<% end %>
