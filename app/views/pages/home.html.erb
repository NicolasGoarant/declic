<!-- ========================= HERO ========================= -->
<section class="relative">
  <div class="absolute inset-0">
    <img src="https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?q=80&w=1920&auto=format&fit=crop"
         alt="" class="w-full h-full object-cover" />
  </div>
  <div class="absolute inset-0 bg-gradient-to-r from-fuchsia-800/70 via-purple-700/65 to-emerald-600/60 mix-blend-multiply"></div>

  <div class="relative z-10 mx-auto px-2 sm:px-4 pt-28 md:pt-32 lg:pt-36 pb-12 md:pb-16"
       style="max-width: min(96vw, 1840px);">
    <div class="max-w-3xl">
      <h1 class="text-white text-4xl sm:text-5xl lg:text-6xl font-extrabold leading-tight">
        Trouvez votre prochaine<br/>
        <span class="text-yellow-300">opportunit√© de changement</span>
      </h1>

      <p class="mt-4 text-[15px] sm:text-lg text-white/95 max-w-2xl">
        B√©n√©volat, formations, rencontres, reconversion‚Ä¶ D√©couvrez des milliers d‚Äôopportunit√©s pr√®s de chez vous.
      </p>

      <div class="mt-6 flex flex-col sm:flex-row gap-3">
        <a href="#explorer" class="inline-flex items-center justify-center px-4 py-2.5 rounded-lg bg-white text-gray-900 font-semibold hover:bg-gray-50">
          <span class="mr-2">üó∫Ô∏è</span> Explorer la carte
        </a>
        <form action="#explorer" class="flex-1 min-w-0">
          <div class="flex items-center bg-white/95 rounded-lg overflow-hidden shadow-sm">
            <span class="pl-3">
              <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-4.35-4.35M17 10a7 7 0 1 1-14 0 7 7 0 0 1 14 0z"/>
              </svg>
            </span>
            <input type="text" placeholder="Ville, th√®me, organisation‚Ä¶" class="w-full px-3 py-2.5 bg-transparent focus:outline-none" />
            <button class="px-4 py-2.5 bg-indigo-600 text-white font-medium hover:bg-indigo-700">Rechercher</button>
          </div>
        </form>
      </div>

      <!-- Puces un peu plus grandes -->
      <ul class="mt-9 sm:mt-10 flex flex-col sm:flex-row gap-3 sm:gap-6 text-white/95 text-[17px] sm:text-xl md:text-[22px]">
        <li class="flex items-center"><span class="mr-2">‚úÖ</span><span><strong>15 000+</strong> opportunit√©s r√©f√©renc√©es</span></li>
        <li class="flex items-center"><span class="mr-2">üó∫Ô∏è</span><span><strong>Toute la France</strong> couverte</span></li>
        <li class="flex items-center"><span class="mr-2">üíú</span><span><strong>Gratuit</strong> et accessible √† tous</span></li>
      </ul>
    </div>
  </div>
</section>

<!-- ========================= CONTENU ========================= -->
<main class="flex-1">
  <div class="mx-auto px-2 sm:px-3 py-10" style="max-width: min(96vw, 1840px);">
    <!-- Grille 3 colonnes : (gros boutons) ‚Äî (carte) ‚Äî (quelques opps) -->
    <div class="grid grid-cols-1 lg:[grid-template-columns:minmax(360px,420px)_minmax(980px,1fr)_minmax(320px,380px)] gap-8 xl:gap-12 items-start">

      <!-- === Colonne gauche ‚Äî Gros boutons (uniformes + responsive) === -->
      <div class="lg:pr-6 xl:pr-10">
        <!-- mobile: 1 col ; md: 2 cols ; lg: pile verticale avec gap -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 gap-4 md:gap-5 lg:gap-5">
          <%# Helpers r√©utilisables %>
          <% card_base = "group block w-full rounded-2xl text-white shadow-md transition hover:shadow-lg overflow-hidden" %>
          <% inner = "h-full flex items-start md:items-center gap-4 px-6 md:px-6 lg:px-8 py-4" %>
          <% icon  = "shrink-0 w-12 h-12 rounded-xl bg-white/15 grid place-content-center text-2xl" %>
          <% ttl   = "font-bold leading-snug text-[20px] md:text-[21px] lg:text-[24px]" %>
          <% txt   = "mt-1.5 text-[15px] md:text-[16px] leading-snug text-white/90 md:line-clamp-2" %>

          <%= link_to parcours_path(category: :entreprendre),
              class: "#{card_base} min-h-[142px] md:min-h-[148px] lg:h-[160px]",
              style: "background:linear-gradient(135deg,#f97316,#ef4444);" do %>
            <div class="<%= inner %>">
              <div class="<%= icon %>">‚ú®</div>
              <div class="min-w-0">
                <div class="<%= ttl %>">Je veux entreprendre</div>
                <div class="<%= txt %>">Lance ton projet avec le soutien d‚Äôentrepreneur¬∑e¬∑s exp√©riment√©s</div>
              </div>
            </div>
          <% end %>

          <%= link_to parcours_path(category: :formation),
              class: "#{card_base} min-h-[142px] md:min-h-[148px] lg:h-[160px]",
              style: "background:linear-gradient(135deg,#3b82f6,#6366f1);" do %>
            <div class="<%= inner %>">
              <div class="<%= icon %>">üìò</div>
              <div class="min-w-0">
                <div class="<%= ttl %>">Je veux me former</div>
                <div class="<%= txt %>">D√©couvre des formations pour d√©velopper tes comp√©tences</div>
              </div>
            </div>
          <% end %>

          <%= link_to parcours_path(category: :benevolat),
              class: "#{card_base} min-h-[142px] md:min-h-[148px] lg:h-[160px]",
              style: "background:linear-gradient(135deg,#ef4444,#ec4899);" do %>
            <div class="<%= inner %>">
              <div class="<%= icon %>">‚ù§Ô∏è</div>
              <div class="min-w-0">
                <div class="<%= ttl %>">Je veux aider</div>
                <div class="<%= txt %>">Trouve des missions de b√©n√©volat qui correspondent √† tes valeurs</div>
              </div>
            </div>
          <% end %>

          <%= link_to parcours_path(category: :rencontres),
              class: "#{card_base} min-h-[142px] md:min-h-[148px] lg:h-[160px]",
              style: "background:linear-gradient(135deg,#10b981,#06b6d4);" do %>
            <div class="<%= inner %>">
              <div class="<%= icon %>">ü§ù</div>
              <div class="min-w-0">
                <div class="<%= ttl %>">Je veux rencontrer</div>
                <div class="<%= txt %>">Rejoins des communaut√©s et cr√©e des liens authentiques</div>
              </div>
            </div>
          <% end %>

          <%= link_to stories_path,
              class: "#{card_base} min-h-[142px] md:min-h-[148px] lg:h-[160px]",
              style: "background:linear-gradient(135deg,#8b5cf6,#ec4899);" do %>
            <div class="<%= inner %>">
              <div class="<%= icon %>">üìñ</div>
              <div class="min-w-0">
                <div class="<%= ttl %>">"Belles histoires !"</div>
                <div class="<%= txt %>">D√©couvrez des reconversions et des ‚Äúd√©clics‚Äù inspirants</div>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- === Carte (colonne centrale) === -->
      <section id="explorer" class="lg:mx-2 xl:mx-4">
        <div class="text-center mb-3">
          <h2 class="text-2xl sm:text-3xl font-extrabold">Explorez les opportunit√©s</h2>
          <p class="text-gray-600 mt-1">D√©couvrez sur la carte toutes les possibilit√©s d‚Äôengagement pr√®s de chez vous</p>
        </div>

        <div class="mt-4 flex flex-wrap justify-center gap-2 text-sm">
          <button data-cat="toutes"       class="chip px-3 py-1 rounded-full bg-gray-200 text-gray-800 is-active">Toutes</button>
          <button data-cat="benevolat"    class="chip px-3 py-1 rounded-full bg-rose-100 text-rose-700">B√©n√©volat</button>
          <button data-cat="formation"    class="chip px-3 py-1 rounded-full bg-blue-100 text-blue-700">Formation</button>
          <button data-cat="rencontres"   class="chip px-3 py-1 rounded-full bg-green-100 text-green-700">Rencontres</button>
          <button data-cat="entreprendre" class="chip px-3 py-1 rounded-full bg-orange-100 text-orange-700">Entreprendre</button>
          <button data-cat="histoires"    class="chip px-3 py-1 rounded-full bg-violet-100 text-violet-700">Belles histoires</button>
        </div>

        <div class="mt-5 bg-white rounded-2xl shadow overflow-hidden">
          <div id="home-map" class="w-full h-[680px] lg:h-[720px] xl:h-[740px]"></div>
        </div>
      </section>

      <!-- === Quelques opportunit√©s (colonne droite) === -->
      <section class="lg:pl-6 xl:pl-10">
        <h2 class="text-2xl sm:text-3xl font-extrabold">Quelques opportunit√©s</h2>
        <p class="text-gray-600 mt-2">Les derni√®res missions et √©v√©nements pr√®s de chez vous</p>

        <div class="mt-5 space-y-3">
          <% Array(@opportunities).first(4).to_a.each do |o| %>
            <article class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md transition">
              <div class="flex items-center gap-2 mb-2">
                <% badge = case o.category
                  when 'benevolat' then 'bg-rose-100 text-rose-700'
                  when 'formation' then 'bg-blue-100 text-blue-700'
                  when 'rencontres' then 'bg-green-100 text-green-700'
                  else 'bg-orange-100 text-orange-700'
                end %>
                <span class="text-xs font-semibold px-2 py-1 rounded-full <%= badge %>">
                  <%= o.category.to_s.capitalize %>
                </span>
              </div>
              <h3 class="font-semibold text-gray-900 truncate"><%= o.title %></h3>
              <p class="text-sm text-gray-600"><%= o.organization %></p>
              <p class="text-sm text-gray-700 mt-2"><%= o.description.to_s.truncate(110) %></p>
              <div class="mt-3 flex items-center justify-between">
                <div class="flex items-center gap-3 text-xs text-gray-500">
                  <% if o.location.present? %><span>üìç <%= o.location %></span><% end %>
                  <% if o.time_commitment.present? %><span>‚è± <%= o.time_commitment %></span><% end %>
                </div>
                <a href="/opportunities/<%= o.respond_to?(:slug) && o.slug.present? ? o.slug : o.id %>"
                   class="inline-flex items-center px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-700">
                  En savoir plus
                </a>
              </div>
            </article>
          <% end %>
        </div>
      </section>
    </div>
  </div>

  <!-- ========================= T√âMOIGNAGES ========================= -->
  <section id="temoignages" class="bg-white py-14">
    <div class="mx-auto px-2 sm:px-4" style="max-width: min(96vw, 1840px);">
      <div class="text-center mb-10">
        <h2 class="text-2xl sm:text-3xl font-extrabold">Ils ont chang√© leur vie</h2>
        <p class="text-gray-600 mt-2">Histoires vraies de personnes qui ont trouv√© leur D√©clic</p>
      </div>
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <% Array(@testimonials).first(4).to_a.each do |t| %>
          <article class="bg-gray-50 rounded-xl border border-gray-100 shadow-sm p-6">
            <div class="flex items-center gap-3 mb-4">
              <% if t.image_url.present? %>
                <%= image_tag t.image_url, alt: t.name, class: "w-12 h-12 rounded-full object-cover" %>
              <% else %>
                <div class="w-12 h-12 rounded-full bg-gray-200 grid place-content-center">
                  <span class="font-semibold text-gray-700"><%= t.name.to_s.first %></span>
                </div>
              <% end %>
              <div class="min-w-0">
                <h3 class="font-semibold truncate"><%= t.name %></h3>
                <p class="text-xs text-gray-500"><%= t.role %> ‚Äî <%= t.age %> ans</p>
              </div>
            </div>
            <p class="text-gray-700 text-sm leading-relaxed"><%= t.story %></p>
          </article>
        <% end %>
      </div>
    </div>
  </section>

  <!-- ========================= √Ä PROPOS (DARK) ========================= -->
  <section id="a-propos" class="bg-gradient-to-r from-slate-900 via-indigo-950 to-fuchsia-950 py-14">
    <div class="mx-auto px-2 sm:px-4" style="max-width: min(96vw, 1840px);">
      <div class="grid lg:grid-cols-12 gap-8 text-slate-100">
        <div class="lg:col-span-5">
          <h2 class="text-2xl sm:text-3xl font-extrabold text-white">√Ä propos de D√©clic</h2>
          <p class="mt-3 text-slate-200/90 leading-relaxed">
            D√©clic facilite l‚Äôengagement pr√®s de chez vous : b√©n√©volat, formations, rencontres, reconversion ou cr√©ation d‚Äôactivit√© √† impact.
            Notre mission : rendre l‚Äôaction locale simple, concr√®te et accessible √† tous.
          </p>
          <p class="mt-3 text-slate-200/90 leading-relaxed">
            Les opportunit√©s sont propos√©es par des associations, des √©coles, des collectifs citoyens et des entrepreneurs engag√©s.
          </p>
        </div>

        <div class="lg:col-span-7 grid sm:grid-cols-2 gap-6">
          <div class="rounded-xl border border-white/10 bg-white/5 backdrop-blur p-6">
            <h3 class="font-semibold text-white">Informations</h3>
            <ul class="mt-3 space-y-2 text-slate-200 text-sm">
              <li>üìç France enti√®re</li>
              <li>üìû <a class="text-indigo-300 hover:underline" href="tel:+33667063179">+33 6 67 06 31 79</a></li>
              <li>üí¨ Courriel : <a class="text-indigo-300 hover:underline" href="mailto:nicolas.goarant@hotmail.fr">nicolas.goarant@hotmail.fr</a></li>
              <li>üîé Donn√©es & cookies : anonymis√©es, pas de revente, conformit√© RGPD</li>
            </ul>
          </div>

          <div class="rounded-xl border border-white/10 bg-white/5 backdrop-blur p-6">
            <h3 class="font-semibold text-white">Ressources</h3>
            <ul class="mt-3 space-y-2 text-slate-200 text-sm">
              <li><%= link_to "Mentions l√©gales", mentions_legales_path, class: "text-indigo-300 hover:underline" %></li>
              <li><%= link_to "Confidentialit√© / CGU", confidentialite_path, class: "text-indigo-300 hover:underline" %></li>
              <li><%= link_to "Presse & kit m√©dia", presse_path, class: "text-indigo-300 hover:underline" %></li>
              <li><%= link_to "FAQ", faq_path, class: "text-indigo-300 hover:underline" %></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<% content_for :scripts do %>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    .chip{transition:.15s}
    .chip.is-active{background:#111827;color:#fff}
    .picon{width:26px;height:26px;border-radius:9999px;border:2px solid #fff;display:grid;place-items:center;color:#fff;font-size:14px;box-shadow:0 1px 4px rgba(0,0,0,.25);position:relative;background:var(--c,#6366f1)}
    .picon::after{content:"";position:absolute;left:50%;bottom:-6px;transform:translateX(-50%);border:6px solid transparent;border-top-color:var(--c,#6366f1)}
  </style>

  <script>
    (function(){
      function onReady(fn){ document.addEventListener('turbo:load',fn); document.addEventListener('DOMContentLoaded',fn); }

      onReady(function(){
        var el = document.getElementById('home-map');
        if(!el || el.dataset._init) return;

        function waitForLeaflet(tries){
          if (window.L) return init();
          if ((tries||0) > 30) return;
          setTimeout(function(){ waitForLeaflet((tries||0)+1); }, 100);
        }

        function init(){
          el.dataset._init = '1';
          var map = L.map(el,{zoomControl:true,scrollWheelZoom:true}).setView([46.6,2.2],6);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);

          var colors={benevolat:'#ef4444',formation:'#3b82f6',rencontres:'#10b981',entreprendre:'#f59e0b',histoires:'#8b5cf6',default:'#6366f1'};
          var emojis={benevolat:'‚ù§Ô∏è',formation:'üìò',rencontres:'üë•',entreprendre:'üíº',histoires:'üìñ',default:'‚≠ê'};
          function iconFor(cat){ var c=colors[cat]||colors.default, e=emojis[cat]||emojis.default;
            return L.divIcon({className:'', html:'<div class="picon" style="--c:'+c+'"><span>'+e+'</span></div>', iconSize:[26,32], iconAnchor:[13,28], popupAnchor:[0,-26]});
          }

          var layer=L.layerGroup().addTo(map), lastPopup=null;
          function addMarker(o){
            if(!o||!o.latitude||!o.longitude) return;
            var m=L.marker([o.latitude,o.longitude],{icon:iconFor((o.category||'').toLowerCase())}).addTo(layer);
            var url = o.kind==='story' ? ('/stories/'+(o.slug||o.id)) : ('/opportunities/'+(o.slug||o.id));
            var badge={'benevolat':'#fee2e2','formation':'#dbeafe','rencontres':'#d1fae5','entreprendre':'#ffedd5','histoires':'#ede9fe'}[(o.category||'').toLowerCase()]||'#eef2ff';
            var catLabel=(o.category||'').charAt(0).toUpperCase()+(o.category||'').slice(1);
            m.bindPopup(
              '<div style="min-width:240px">'
              +'<div style="margin-bottom:6px"><span style="font-size:11px;padding:2px 6px;border-radius:9999px;background:'+badge+';color:#111;">'+catLabel+'</span></div>'
              +'<strong>'+(o.title||'')+'</strong>'+(o.organization?'<br/><small>'+o.organization+'</small>':'')
              +'<p style="margin:.5rem 0">'+((o.description||'').slice(0,110))+(((o.description||'').length>110)?'‚Ä¶':'')+'</p>'
              +'<a class="text-indigo-600 underline text-sm" data-turbo="false" href="'+url+'">Voir la fiche</a>'
              +'</div>'
            );
            m.on('popupopen',function(e){ if(lastPopup && lastPopup!==e.popup) lastPopup.close(); lastPopup=e.popup; });
            return m;
          }

          var fallbackOpps=<%= raw(Array(@opportunities).map{|o|{
            id:o.id, slug:(o.respond_to?(:slug) ? o.slug : nil),
            title:o.title, description:o.description, category:o.category,
            organization:o.organization, location:o.location,
            latitude:(o.latitude ? o.latitude.to_f : nil),
            longitude:(o.longitude ? o.longitude.to_f : nil),
            kind:'opp'
          }}.to_json) %>;

          var fallbackStories=<%=
            begin
              raw(Story.select(:id,:slug,:title,:chapo,:description,:latitude,:longitude,:location)
                   .map{|s|{
                     id:s.id, slug:s.slug,
                     title:s.title, description:(s.chapo.presence || s.description),
                     category:'histoires', organization:nil, location:s.location,
                     latitude:(s.latitude ? s.latitude.to_f : nil),
                     longitude:(s.longitude ? s.longitude.to_f : nil),
                     kind:'story'
                   }}.to_json)
            rescue
              '[]'.html_safe
            end
          %>;

          function plot(items){
            layer.clearLayers();
            var bounds=[];
            (items||[]).forEach(function(o){ var mk=addMarker(o); if(mk) bounds.push([o.latitude,o.longitude]); });
            if(bounds.length) map.fitBounds(bounds,{padding:[22,22]});
          }

          var dataset=[];
          Promise.all([
            fetch('/api/v1/opportunities').then(r=>r.ok?r.json():Promise.reject()).catch(()=>fallbackOpps),
            fetch('/api/v1/stories').then(r=>r.ok?r.json():Promise.reject()).catch(()=>fallbackStories)
          ]).then(function(results){
            var opps = Array.isArray(results[0]) ? results[0].map(function(o){
              return { id:o.id, slug:o.slug, title:o.title, description:o.description, category:o.category,
                       organization:o.organization, location:o.location,
                       latitude:parseFloat(o.latitude), longitude:parseFloat(o.longitude), kind:'opp' };
            }) : [];
            var stories = Array.isArray(results[1]) ? results[1].map(function(s){
              return { id:s.id, slug:s.slug, title:s.title, description:(s.chapo||s.description||''), category:'histoires',
                       organization:null, location:s.location,
                       latitude:parseFloat(s.latitude), longitude:parseFloat(s.longitude), kind:'story' };
            }) : [];
            dataset = opps.concat(stories);
            plot(dataset);
          });

          Array.from(document.querySelectorAll('.chip')).forEach(function(chip){
            chip.addEventListener('click',function(){
              Array.from(document.querySelectorAll('.chip')).forEach(c=>c.classList.remove('is-active'));
              chip.classList.add('is-active');
              var cat=chip.dataset.cat, all=(cat==='toutes');
              var filtered = all ? dataset : (dataset||[]).filter(o => (o.category||'').toLowerCase()===cat);
              plot(filtered);
            });
          });
        }

        waitForLeaflet();
      });
    })();
  </script>
<% end %>








