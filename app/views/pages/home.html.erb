<%# app/views/pages/home.html.erb ‚Äî v7.2 : center last row cards + fix stats overflow mobile %>

<div class="home-ms">
  <!-- HERO -->
  <header class="hm-hero" role="banner">
    <div class="hm-hero-inner">
      <div class="container">
        <h1 class="hm-title">
          Change ta vie, <span class="grad">en quelques clics</span>
        </h1>
        <p class="hm-chapo">
          D√©clic agr√®ge les mille et une opportunit√©s locales : entreprendre, se former, rencontrer,
          aider ‚Äî et d√©couvrir des <strong>‚Äúbelles histoires‚Äù</strong> qui inspirent.
        </p>

        <dl class="hm-stats">
          <div><dt>Opportunit√©s</dt><dd>15&nbsp;000+</dd></div>
          <div><dt>Villes</dt><dd>300+</dd></div>
          <div><dt>Communaut√©</dt><dd>10k</dd></div>
        </dl>
      </div>
    </div>

    <% hero_src = (asset_path('hero_home.jpg') rescue nil)
       hero_src ||= "https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?q=80&w=2400&auto=format&fit=crop" %>
    <div class="hm-hero-img" style="--hero:url('<%= hero_src %>')"></div>
  </header>

  <!-- PARCOURS -->
  <section id="parcours" class="hm-slice alt">
    <div class="container">
      <h2 class="hm-h2">Choisis ton parcours</h2>

      <div class="hm-grid-cards">
        <% btn_base = "hm-card" %>

        <%= link_to parcours_path(category: "entreprendre"), class: "#{btn_base} -entreprendre" do %>
          <span class="hm-emoji">üöÄ</span>
          <div class="hm-card-txt">
            <p class="t1">Je veux entreprendre</p>
            <p class="t2">Lance ton projet avec des mentors</p>
          </div>
        <% end %>

        <%= link_to parcours_path(category: "formation"), class: "#{btn_base} -formation" do %>
          <span class="hm-emoji">üìò</span>
          <div class="hm-card-txt">
            <p class="t1">Je veux me former</p>
            <p class="t2">Des formations pour progresser</p>
          </div>
        <% end %>

        <%= link_to parcours_path(category: "benevolat"), class: "#{btn_base} -benevolat" do %>
          <span class="hm-emoji">‚ù§Ô∏è</span>
          <div class="hm-card-txt">
            <p class="t1">Je veux aider</p>
            <p class="t2">Des missions utiles et humaines</p>
          </div>
        <% end %>

        <%= link_to parcours_path(category: "rencontres"), class: "#{btn_base} -rencontres" do %>
          <span class="hm-emoji">ü§ù</span>
          <div class="hm-card-txt">
            <p class="t1">Je veux rencontrer</p>
            <p class="t2">Des communaut√©s pr√®s de chez toi</p>
          </div>
        <% end %>

        <%= link_to stories_path, class: "#{btn_base} -histoires" do %>
          <span class="hm-emoji">üìñ</span>
          <div class="hm-card-txt">
            <p class="t1">‚ÄúBelles histoires !‚Äù</p>
            <p class="t2">D√©clics, reconversions, prises de risque</p>
          </div>
        <% end %>
      </div>
    </div>
  </section>

  <!-- CARTE -->
  <section id="explorer" class="hm-slice bg-muted grad-behind-map">
    <div class="container">
      <h2 class="hm-h2">Explorez les opportunit√©s</h2>
      <p class="hm-sub">D√©couvre sur la carte toutes les possibilit√©s d‚Äôengagement pr√®s de chez toi.</p>

    <div class="hm-filterbar">
        <button class="chip is-active" data-cat="toutes">üåç Toutes</button>
        <button class="chip" data-cat="benevolat">‚ù§Ô∏è B√©n√©volat</button>
        <button class="chip" data-cat="formation">üìò Formation</button>
        <button class="chip" data-cat="rencontres">üë• Rencontres</button>
        <button class="chip" data-cat="entreprendre">üíº Entreprendre</button>
        <button class="chip" data-cat="histoires">üìñ Belles histoires</button>
      </div>

      <div class="hm-mapwrap">
        <div id="map" class="hm-map"></div>
        <button id="btn-locate" class="hm-locate"><span>üìç</span> <span>Me localiser</span></button>
      </div>
    </div>
  </section>

  <!-- QUELQUES OPPORTUNIT√âS -->
  <section class="hm-slice grad-soft">
    <div class="container">
      <h2 class="hm-h2">Quelques opportunit√©s</h2>
      <div class="hm-cards">
        <% (@opportunities || []).first(6).each do |o| %>
          <%= link_to opportunity_path(o), class: "hm-card-op" do %>
            <p class="k"><%= o.category.to_s.capitalize %></p>
            <p class="t"><%= o.title %></p>
            <p class="d"><%= o.description %></p>
            <p class="l">üìç <%= o.location %></p>
          <% end %>
        <% end %>
      </div>
    </div>
  </section>

  <!-- T√âMOIGNAGES -->
  <section id="temoignages" class="hm-slice bg-muted grad-behind-testis">
    <div class="container">
      <h2 class="hm-h2">Ils/elles ont trouv√© leur d√©clic</h2>

      <% fallback = [
        "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=360&q=80&auto=format&fit=crop",
        "https://images.unsplash.com/photo-1502685104226-ee32379fefbe?w=360&q=80&auto=format&fit=crop",
        "https://images.unsplash.com/photo-1547425260-76bcadfb4f2c?w=360&q=80&auto=format&fit=crop",
        "https://images.unsplash.com/photo-1545558014-8692077e86b6?w=360&q=80&auto=format&fit=crop",
        "https://images.unsplash.com/photo-1527980965255-d3b416303d12?w=360&q=80&auto=format&fit=crop",
        "https://images.unsplash.com/photo-1552053831-71594a27632d?w=360&q=80&auto=format&fit=crop",
        "https://images.unsplash.com/photo-1541216970279-affbfdd55aa8?w=360&q=80&auto=format&fit=crop",
        "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=360&q=80&auto=format&fit=crop"
      ] %>

      <div class="hm-testis">
        <% (@testimonials || []).each_with_index do |t, idx| %>
          <% img =
            if t.image_url.present?
              if t.image_url.starts_with?('/assets/')
                logical = t.image_url.sub(%r{\A/assets/}, '')
                logical = logical.sub(/-[0-9a-f]{32,64}(?=\.)/, '')
                asset_path(logical)
              elsif t.image_url =~ %r{\A(https?:)?//}
                t.image_url
              else
                asset_path(t.image_url)
              end
            else
              fallback[idx % fallback.size]
            end
          %>

          <div class="hm-testi">
            <div class="who">
              <img src="<%= img %>" alt="<%= t.name %>" class="hm-avatar" loading="lazy" referrerpolicy="no-referrer"
                   onerror="this.src='<%= fallback[idx % fallback.size] %>'">
              <div>
                <p class="name"><%= t.name %></p>
                <p class="role"><%= t.role %></p>
              </div>
            </div>
            <p class="story"><%= t.story %></p>
          </div>
        <% end %>
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="hm-cta">
    <div class="container">
      <h2>Envie d‚Äôagir √† ton tour ?</h2>
      <p>D√©couvre des opportunit√©s pr√®s de chez toi ou partage ta propre histoire pour inspirer d‚Äôautres personnes.</p>
      <div class="buttons">
        <%= link_to "Voir les actions locales", (url_for(controller: :opportunities, action: :index, category: 'toutes') rescue root_path(anchor:"explorer")), class: "btn primary" %>
        <%= link_to "Partager mon histoire", (respond_to?(:new_story_path) ? new_story_path : stories_path), class: "btn secondary" %>
      </div>
    </div>
  </section>
</div>

<style>
  /* ====== Th√®me global ====== */
  .home-ms{ --a1:#7e5bef; --a2:#3b82f6; --muted:#f4f2fb; color:#0f172a; font-family:"Inter",system-ui,sans-serif;
    background: radial-gradient(1400px 800px at 10% -10%, #efe8ff 0%, transparent 60%) no-repeat,
               linear-gradient(180deg, #fbfaff 0%, #f6f3ff 60%, #f3f1ff 100%); }
  .home-ms .container{ max-width:1280px; margin:0 auto; padding:0 24px; }
  [id]{ scroll-margin-top:96px; }

  /* ====== HERO ====== */
  .hm-hero{ position:relative; color:#fff; overflow:hidden; background:linear-gradient(160deg,var(--a1),var(--a2)); }
  /* padding-top r√©duit pour √©viter l‚Äôespace sous la navbar fixe */
  .hm-hero-inner{ position:relative; padding-top:clamp(72px,8vw,120px); padding-bottom:clamp(44px,6.5vw,84px); z-index:10; }
  .hm-hero::after{ content:""; position:absolute; inset:0; background:linear-gradient(180deg,rgba(7,9,22,.62),rgba(7,9,22,.62)); mix-blend:multiply; z-index:2; }
  .hm-hero-img{ position:absolute; inset:0; background:var(--hero,none) center/cover no-repeat; filter:blur(2px) saturate(1.05) brightness(0.9); opacity:.85; z-index:1; }
  .hm-title{ font-family:"Epilogue",Inter; font-weight:900; letter-spacing:-.02em; line-height:1.03; font-size:clamp(2.8rem,5vw,4.6rem); margin:.2rem 0 .5rem; text-shadow:0 2px 16px rgba(0,0,0,.25); }
  .hm-title .grad{ background:linear-gradient(90deg,#f472b6,#a855f7,#6366f1); -webkit-background-clip:text; background-clip:text; color:transparent; }
  .hm-chapo{ max-width:980px; font:600 clamp(1.12rem,1.05vw + .9rem,1.5rem)/1.65 "Inter"; text-shadow:0 1px 8px rgba(0,0,0,.18); }

  .hm-stats{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:16px; margin-top:18px; }
  .hm-stats>div{ background:rgba(255,255,255,.92); backdrop-filter: blur(6px); border:1px solid #e6e8ee; border-radius:18px; padding:16px 18px; box-shadow:0 12px 34px rgba(15,23,42,.18); color:#0f172a; text-align:center; }
  .hm-stats dt{ font:700 .82rem/1 "Inter"; color:#6b7280; text-transform:uppercase; letter-spacing:.04em; }
  .hm-stats dd{ margin:.25rem 0 0; font:900 1.8rem/1 "Epilogue"; }
  /* Mobile : pile en colonne, tailles plus petites, pas de d√©bordement */
  @media (max-width:640px){
    .hm-stats{ grid-template-columns:1fr; gap:10px; }
    .hm-stats>div{ padding:12px 14px; }
    .hm-stats dt{ font-size:.78rem; }
    .hm-stats dd{ font-size:1.4rem; }
  }

  /* ====== Slices ====== */
  .hm-slice{ padding:clamp(2rem,4.8vw,4rem) 0; }
  .hm-slice.alt{ background: radial-gradient(920px 440px at 8% -12%, #efe8ff 0%, transparent 60%) no-repeat,
                              linear-gradient(180deg,#f6f2ff 0%, #ede9fe 100%); }
  .bg-muted{ background:var(--muted); }
  .grad-soft{ background: radial-gradient(900px 420px at 85% -10%, #eee7ff 0%, transparent 66%),
                         linear-gradient(180deg,#f9f7ff 0%, #f3f1ff 100%); }
  .grad-behind-map{ background: radial-gradient(980px 460px at 50% -14%, #e9e2ff 0%, transparent 70%), var(--muted); }
  .grad-behind-testis{ background: radial-gradient(820px 380px at 12% 118%, #ece6ff 0%, transparent 66%), var(--muted); }

  .hm-h2{ font-family:"Epilogue"; font-weight:900; font-size:clamp(2.1rem,3.2vw,2.7rem); color:#0f172a; margin:0 0 1rem; }
  .hm-h2::after{ content:""; display:block; width:100px; height:6px; border-radius:999px; background:var(--a1); margin:.55rem 0 .1rem; }
  .hm-sub{ margin:.2rem 0 1rem; color:#475569; font-size:1.05rem; }

  /* ====== GROS BOUTONS (plus larges + centrage derni√®re ligne) ====== */
  .hm-grid-cards{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(min(100%, 380px), 1fr));
    gap:28px;
    justify-items:stretch;
    justify-content:center;          /* centre la ligne incompl√®te */
    max-width:1220px;                /* √©vite que les cartes s‚Äô√©cartent trop */
    margin-inline:auto;
  }
  .hm-card{
    display:grid; grid-template-columns:110px 1fr; gap:22px; align-items:center;
    padding:36px 30px; border-radius:30px; color:#fff; text-decoration:none;
    box-shadow:0 18px 44px rgba(0,0,0,.16);
    min-height:240px; box-sizing:border-box; overflow:hidden;
    transition:transform .15s ease, box-shadow .15s ease;
  }
  .hm-card:hover{ transform:translateY(-6px); box-shadow:0 22px 62px rgba(0,0,0,.20); }
  .hm-emoji{ width:100px; height:100px; border-radius:24px; background:rgba(255,255,255,.22); font-size:50px; display:grid; place-items:center; }
  .hm-card-txt{ min-width:0; }
  .hm-card-txt .t1{ font:900 clamp(1.2rem,1vw + 1rem,1.6rem)/1.15 "Epilogue"; letter-spacing:-.006em; margin:0; word-break:normal; }
  .hm-card-txt .t2{ margin-top:.45rem; font:700 clamp(1rem,.7vw + .7rem,1.22rem)/1.45 "Inter"; opacity:.98; }
  .hm-card.-entreprendre{ background:linear-gradient(135deg,#f59e0b,#ef4444,#fb7185); }
  .hm-card.-formation{   background:linear-gradient(135deg,#6366f1,#38bdf8); }
  .hm-card.-benevolat{   background:linear-gradient(135deg,#f43f5e,#ec4899); }
  .hm-card.-rencontres{  background:linear-gradient(135deg,#10b981,#06b6d4); }
  .hm-card.-histoires{   background:linear-gradient(135deg,#6d28d9,#a855f7,#d946ef); }

  /* Mobile compact, 2 lignes max, pas de d√©bordement */
  @media (max-width:560px){
    .hm-card{ grid-template-columns:80px 1fr; padding:22px 18px; min-height:192px; border-radius:22px; }
    .hm-emoji{ width:72px; height:72px; border-radius:18px; font-size:36px; }
    .hm-card-txt .t1{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .hm-card-txt .t2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  }

  /* ====== Carte & filtres ====== */
  .hm-filterbar{ display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px; }
  .chip{ display:inline-flex; align-items:center; justify-content:center; flex-wrap:wrap;
         padding:.6rem 1rem; border-radius:999px; background:#fff; border:1px solid #e6e8ee;
         font:800 .95rem/1.1 "Inter"; white-space:normal; word-break:break-word; }
  .chip.is-active{ background:var(--a1); color:#fff; border-color:transparent; }
  .hm-mapwrap{ position:relative; }
  .hm-map{ height:560px; width:100%; border-radius:20px; border:1px solid #e6e8ee; overflow:hidden; box-shadow:0 10px 30px rgba(15,23,42,.10); }
  .hm-locate{ position:absolute; right:12px; top:12px; z-index:20; display:inline-flex; gap:8px; align-items:center; padding:.7rem 1rem; border-radius:12px; background:#fff; border:1px solid #e6e8ee; box-shadow:0 8px 22px rgba(15,23,42,.10); }

  /* ====== Cards opportunit√©s ====== */
  .hm-cards{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:18px; }
  @media (max-width:980px){ .hm-cards{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
  @media (max-width:640px){ .hm-cards{ grid-template-columns:1fr; } }
  .hm-card-op{ display:block; padding:18px; border-radius:20px; background:#fff; border:1px solid #e6e8ee; box-shadow:0 10px 26px rgba(15,23,42,.08); text-decoration:none; color:#0f172a; }
  .hm-card-op .k{ color:#64748b; font-size:.82rem; margin:0 0 .4rem; }
  .hm-card-op .t{ font:900 1.16rem/1.2 "Epilogue"; margin:0; }
  .hm-card-op .d{ font:1rem/1.55 "Inter"; color:#475569; margin:.4rem 0 .35rem; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .hm-card-op .l{ font:1rem/1.4 "Inter"; color:#1f2937; margin:0; }

  /* ====== T√©moignages ====== */
  .hm-testis{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:18px; }
  @media (max-width:980px){ .hm-testis{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
  @media (max-width:640px){ .hm-testis{ grid-template-columns:1fr; } }
  .hm-testi{ background:#fff; border:1px solid #e6e8ee; border-radius:20px; padding:18px; box-shadow:0 10px 26px rgba(15,23,42,.08); }
  .hm-testi .who{ display:flex; gap:14px; align-items:center; }
  .hm-avatar{ width:56px; height:56px; border-radius:999px; object-fit:cover; display:block; background:none !important; }
  .hm-testi .name{ font:900 1.06rem/1.1 "Epilogue"; margin:0; }
  .hm-testi .role{ font:.8rem/1 "Inter"; color:#94a3b8; margin:0; }
  .hm-testi .story{ margin:.8rem 0 0; color:#334155; font:1rem/1.58 "Inter"; }

  /* ====== CTA ====== */
  .hm-cta{ background:linear-gradient(160deg,var(--a1),var(--a2)); color:#fff; text-align:center; padding:clamp(2.6rem,5.5vw,4.8rem) 0; }
  .hm-cta h2{ margin:0 0 .8rem; font:900 clamp(1.8rem,3.2vw,2.6rem)/1.1 "Epilogue"; }
  .hm-cta p{ margin:0 0 1.35rem; font:800 1.1rem/1.6 "Inter"; opacity:.98; }
  .hm-cta .buttons{ display:flex; gap:14px; justify-content:center; flex-wrap:wrap; }
  .hm-cta .btn{ display:inline-block; border-radius:999px; padding:1rem 1.5rem; text-decoration:none; font:900 1.06rem/1 "Epilogue"; }
  .hm-cta .btn.primary{ background:#fff; color:var(--a1); box-shadow:0 12px 34px rgba(0,0,0,.10); }
  .hm-cta .btn.secondary{ background:transparent; border:2px solid #fff; color:#fff; }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<% content_for :scripts do %>
<script>
document.addEventListener('turbo:load', bootHome, { once:true });
document.addEventListener('DOMContentLoaded', bootHome, { once:true });

function bootHome(){
  const mapEl = document.getElementById('map');
  if(!mapEl || !window.L) return;
  if (mapEl.dataset.mapInited === "1") return;

  const map = L.map(mapEl, { zoomControl:true, attributionControl:false }).setView([46.6, 2.2], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom: 19 }).addTo(map);
  requestAnimationFrame(()=> map.invalidateSize());
  setTimeout(()=> map.invalidateSize(), 250);
  mapEl.dataset.mapInited = "1";

  const colors={benevolat:'#ef4444',formation:'#3b82f6',rencontres:'#10b981',entreprendre:'#f59e0b',histoires:'#a855f7',default:'#6366f1'};
  const emojis={benevolat:'‚ù§Ô∏è',formation:'üìò',rencontres:'üë•',entreprendre:'üíº',histoires:'üìñ',default:'‚≠ê'};
  const iconFor = (c)=> L.divIcon({className:'',html:`<div style="width:26px;height:26px;border-radius:9999px;border:2px solid #fff;display:grid;place-items:center;color:#fff;font-size:14px;box-shadow:0 1px 4px rgba(0,0,0,.25);position:relative;background:${colors[c]||colors.default}"><span>${emojis[c]||emojis.default}</span></div>`,iconSize:[26,32],iconAnchor:[13,28],popupAnchor:[0,-26]});
  const layer = L.layerGroup().addTo(map);

  function parseDate(x){ if(!x) return null; const d=new Date(x); return isNaN(d)?null:d; }
  function frLongDate(d){ return d?d.toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'}):''; }
  function frHM(d){ return d?d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}):''; }
  function thumbFor(o){
    if(o.image_url) return o.image_url;
    const cat=(o.category||'').toLowerCase();
    if(cat==='benevolat') return 'https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?q=80&w=300&auto=format&fit=crop';
    if(cat==='formation') return 'https://images.unsplash.com/photo-1555949963-ff9fe0c870eb?q=80&w=300&auto=format&fit=crop';
    if(cat==='rencontres') return 'https://images.unsplash.com/photo-1511632765486-a01980e01a18?q=80&w=300&auto=format&fit=crop';
    if(cat==='entreprendre') return 'https://images.unsplash.com/photo-1556157382-97eda2d62296?q=80&w=300&auto=format&fit=crop';
    if(cat==='histoires') return 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=300&auto=format&fit=crop';
    return 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=300&auto=format&fit=crop';
  }
  function popupHtml(o){
    const cat=(o.category||'');
    const base=(cat.toLowerCase()==='histoires')?'/stories':'/opportunities';
    const url=`${base}/${o.slug||o.id}`;
    const st=parseDate(o.starts_at||o.start_at||o.start_time||o.date||o.scheduled_on);
    const en=parseDate(o.ends_at||o.end_at||o.end_time);
    const when = st ? `üìÖ ${frLongDate(st)}${en?` ‚Äî ${frHM(st)}‚Äì${frHM(en)}`:` ‚Äî ${frHM(st)}`}` : (o.schedule_text||'');
    const loc = o.location ? `üìç ${o.location}` : '';
    const img = thumbFor(o);
    return `
      <div style="display:grid;grid-template-columns:72px 1fr;gap:10px;min-width:260px;align-items:start">
        <img src="${img}" alt="" style="width:72px;height:72px;border-radius:10px;object-fit:cover;box-shadow:0 1px 4px rgba(0,0,0,.2)" />
        <div>
          <h4 style="margin:0;font-weight:700;font-size:14px;line-height:1.2">${o.title||''}</h4>
          ${o.organization?`<div style="color:#475569;font-size:12px">${o.organization}</div>`:''}
          ${when?`<div style="color:#475569;font-size:12px">${when}</div>`:''}
          ${loc?`<div style="color:#475569;font-size:12px">${loc}</div>`:''}
          <div style="margin-top:6px"><a href="${url}" class="text-indigo-600 underline text-sm">Voir la fiche</a></div>
        </div>
      </div>`;
  }

  let dataset = [];
  function plot(items){
    layer.clearLayers();
    const bounds=[];
    (items||[]).forEach(o=>{
      if(!o.latitude || !o.longitude) return;
      L.marker([o.latitude,o.longitude],{icon:iconFor((o.category||'').toLowerCase())})
        .addTo(layer).bindPopup(popupHtml(o));
      bounds.push([o.latitude,o.longitude]);
    });
    if(bounds.length){ map.fitBounds(bounds,{padding:[30,30]}); }
  }

  Promise.all([
    fetch('/api/v1/opportunities').then(r=>r.ok?r.json():[]).catch(()=>[]),
    fetch('/api/v1/stories').then(r=>r.ok?r.json():[]).catch(()=>[])
  ]).then(([opps, stories])=>{
    (stories||[]).forEach(s=> s.category='histoires');
    dataset = ([]).concat(opps||[], stories||[]);
    plot(dataset);
  });

  // Filtres
  const chips=[...document.querySelectorAll('.chip')];
  chips.forEach(chip=>chip.addEventListener('click',()=>{
    chips.forEach(c=>c.classList.remove('is-active')); chip.classList.add('is-active');
    const cat=chip.dataset.cat;
    if(cat==='toutes'){ plot(dataset); return; }
    plot((dataset||[]).filter(o=> (o.category||'').toLowerCase()===cat));
  }));

  // Me localiser
  document.getElementById('btn-locate')?.addEventListener('click', ()=>{
    if (window.DeclicGeo && window.DeclicGeo.setFollow) window.DeclicGeo.setFollow(true);
  });
}
</script>
<% end %>
