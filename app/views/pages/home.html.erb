<%# app/views/pages/home.html.erb %>

<div class="relative isolate">
  <!-- d√©cor -->
  <div class="pointer-events-none absolute inset-0 -z-10 bg-gradient-to-br from-violet-50 via-white to-indigo-50"></div>
  <div class="pointer-events-none absolute inset-0 -z-10 opacity-[.35] bg-[radial-gradient(circle_at_20%_20%,rgba(99,102,241,.08)_1px,transparent_1px)] [background-size:18px_18px]"></div>

  <%# ================================ HERO ================================ %>
  <section class="pt-24 lg:pt-28">
    <div class="mx-auto max-w-[90rem] px-5 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,1fr)] gap-8 items-center">
        <div>
          <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold tracking-tight text-slate-900">
            Donne du sens √† tes projets, <span class="bg-gradient-to-r from-fuchsia-600 to-indigo-600 bg-clip-text text-transparent">proche de chez toi</span>
          </h1>
          <p class="mt-4 text-lg text-slate-700 max-w-2xl">
            D√©clic agr√®ge les opportunit√©s locales : entreprendre, se former, rencontrer, aider ‚Äî et d√©couvrir des <em>belles histoires</em> qui inspirent.
          </p>

          <dl class="mt-6 grid grid-cols-2 sm:grid-cols-3 gap-4">
            <div class="rounded-xl bg-white/90 backdrop-blur border border-gray-100 p-4 shadow">
              <dt class="text-xs text-gray-500">Opportunit√©s</dt>
              <dd class="text-2xl font-bold">15&nbsp;000+</dd>
            </div>
            <div class="rounded-xl bg-white/90 backdrop-blur border border-gray-100 p-4 shadow">
              <dt class="text-xs text-gray-500">Villes</dt>
              <dd class="text-2xl font-bold">300+</dd>
            </div>
            <div class="rounded-xl bg-white/90 backdrop-blur border border-gray-100 p-4 shadow">
              <dt class="text-xs text-gray-500">Communaut√©</dt>
              <dd class="text-2xl font-bold">10k</dd>
            </div>
          </dl>
        </div>

        <!-- visuel : image locale si dispo, sinon placeholder -->
        <% hero_src = (begin asset_path('hero.jpg') rescue nil end) %>
        <% if hero_src.present? %>
          <img src="<%= hero_src %>" alt="D√©clic"
               class="w-full h-64 sm:h-80 lg:h-[22rem] object-cover rounded-2xl shadow ring-1 ring-black/5">
        <% else %>
          <div class="w-full h-64 sm:h-80 lg:h-[22rem] rounded-2xl shadow ring-1 ring-black/5
                      bg-gradient-to-br from-indigo-600 via-fuchsia-500 to-rose-500 relative overflow-hidden">
            <div class="absolute inset-0 opacity-20 bg-[radial-gradient(circle_at_30%_20%,white_2px,transparent_2px)] [background-size:18px_18px]"></div>
            <div class="absolute bottom-0 inset-x-0 h-20 bg-gradient-to-t from-black/30 to-transparent"></div>
          </div>
        <% end %>
      </div>
    </div>
  </section>

  <%# ======================== PARCOURS (GROS BOUTONS) ===================== %>
  <section id="parcours" class="mt-10">
    <div class="mx-auto max-w-[90rem] px-5 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4">
        <% btn_base = "group block rounded-2xl p-6 lg:p-7 text-white shadow-md transition hover:shadow-lg grid content-start min-h-[148px] sm:min-h-[160px] xl:min-h-[180px]" %>
        <% icon_wrap = "inline-flex h-12 w-12 lg:h-16 lg:w-16 items-center justify-center rounded-xl bg-white/20 text-2xl lg:text-3xl" %>
        <% title_txt = "font-semibold text-lg lg:text-xl" %>
        <% desc_txt  = "text-white/90 text-[15px] lg:text-base leading-snug mt-1" %>

        <%= link_to parcours_path(category: "entreprendre"), class: btn_base, style: "background:linear-gradient(135deg,#f59e0b 0%,#ef4444 50%,#fb7185 100%);" do %>
          <div class="flex items-start gap-4 lg:gap-5">
            <span class="<%= icon_wrap %>">üöÄ</span>
            <div class="min-w-0">
              <p class="<%= title_txt %>">Je veux entreprendre</p>
              <p class="<%= desc_txt %>">Lance ton projet avec des mentors</p>
            </div>
          </div>
        <% end %>

        <%= link_to parcours_path(category: "formation"), class: btn_base, style: "background:linear-gradient(135deg,#6366f1 0%,#38bdf8 100%);" do %>
          <div class="flex items-start gap-4 lg:gap-5">
            <span class="<%= icon_wrap %>">üìò</span>
            <div class="min-w-0">
              <p class="<%= title_txt %>">Je veux me former</p>
              <p class="<%= desc_txt %>">Des formations pour progresser</p>
            </div>
          </div>
        <% end %>

        <%= link_to parcours_path(category: "benevolat"), class: btn_base, style: "background:linear-gradient(135deg,#f43f5e 0%,#ec4899 100%);" do %>
          <div class="flex items-start gap-4 lg:gap-5">
            <span class="<%= icon_wrap %>">‚ù§Ô∏è</span>
            <div class="min-w-0">
              <p class="<%= title_txt %>">Je veux aider</p>
              <p class="<%= desc_txt %>">Des missions utiles et humaines</p>
            </div>
          </div>
        <% end %>

        <%= link_to parcours_path(category: "rencontres"), class: btn_base, style: "background:linear-gradient(135deg,#10b981 0%,#06b6d4 100%);" do %>
          <div class="flex items-start gap-4 lg:gap-5">
            <span class="<%= icon_wrap %>">ü§ù</span>
            <div class="min-w-0">
              <p class="<%= title_txt %>">Je veux rencontrer</p>
              <p class="<%= desc_txt %>">Des communaut√©s pr√®s de chez toi</p>
            </div>
          </div>
        <% end %>

        <%= link_to stories_path, class: btn_base, style: "background:linear-gradient(135deg,#6d28d9 0%,#a855f7 50%,#d946ef 100%);" do %>
          <div class="flex items-start gap-4 lg:gap-5">
            <span class="<%= icon_wrap %>">üìñ</span>
            <div class="min-w-0">
              <p class="<%= title_txt %>">Belles histoires</p>
              <p class="<%= desc_txt %>">D√©clics, reconversions, prises de risque</p>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </section>

  <%# ============================== CARTE ================================ %>
  <section id="explorer" class="mt-12">
    <div class="mx-auto max-w-[90rem] px-5 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2 class="text-2xl sm:text-3xl font-bold text-slate-900">Explorez les opportunit√©s</h2>
        <p class="mt-2 text-[17px] sm:text-lg text-slate-600">
          D√©couvrez sur la carte toutes les possibilit√©s d‚Äôengagement pr√®s de chez vous.
        </p>
      </div>

      <div class="mt-6 grid grid-cols-12 gap-6">
        <div class="hidden xl:block xl:col-span-1"></div>

        <div class="col-span-12 xl:col-span-10">
          <div class="mb-3 flex flex-wrap gap-2 justify-center">
            <button class="chip is-active" data-cat="toutes">üåç Toutes</button>
            <button class="chip" data-cat="benevolat">‚ù§Ô∏è B√©n√©volat</button>
            <button class="chip" data-cat="formation">üìò Formation</button>
            <button class="chip" data-cat="rencontres">üë• Rencontres</button>
            <button class="chip" data-cat="entreprendre">üíº Entreprendre</button>
            <button class="chip" data-cat="histoires">üìñ Belles histoires</button>
          </div>

          <div class="relative">
            <div id="map" class="h-[480px] lg:h-[520px] w-full rounded-2xl overflow-hidden border border-gray-200 shadow"></div>

            <!-- Bouton flottant : me localiser -->
            <button id="btn-locate"
                    class="absolute right-3 top-3 z-20 inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-white/95 ring-1 ring-gray-200 shadow hover:bg-white">
              <span>üìç</span><span class="text-sm font-medium">Me localiser</span>
            </button>
          </div>
        </div>

        <div class="hidden xl:block xl:col-span-1"></div>
      </div>
    </div>
  </section>

  <%# ========================== QUELQUES OPPS =========================== %>
  <section class="mt-10">
    <div class="mx-auto max-w-[90rem] px-5 sm:px-6 lg:px-8">
      <h3 class="text-xl font-semibold text-slate-900">Quelques opportunit√©s</h3>
      <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <% (@opportunities || []).first(6).each do |o| %>
          <%= link_to opportunity_path(o), class: "block rounded-xl bg-white p-4 ring-1 ring-gray-200 hover:shadow" do %>
            <p class="text-xs text-gray-500 mb-1"><%= o.category.to_s.capitalize %></p>
            <p class="font-semibold"><%= o.title %></p>
            <p class="text-sm text-gray-600 line-clamp-2 mt-1"><%= o.description %></p>
            <p class="text-sm text-gray-700 mt-2">üìç <%= o.location %></p>
          <% end %>
        <% end %>
      </div>
    </div>
  </section>

  <%# ============================ T√âMOIGNAGES =========================== %>
  <section id="temoignages" class="mt-14">
    <div class="mx-auto max-w-[90rem] px-5 sm:px-6 lg:px-8">
      <h3 class="text-xl font-semibold text-slate-900">Ils/elles ont trouv√© leur d√©clic</h3>
      <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <% (@testimonials || []).each do |t| %>
          <div class="rounded-xl bg-white p-5 ring-1 ring-gray-200">
            <div class="flex items-center gap-3">
              <img src="<%= t.image_url %>" class="w-12 h-12 rounded-full object-cover" alt="">
              <div>
                <p class="font-semibold"><%= t.name %></p>
                <p class="text-xs text-gray-500"><%= t.role %></p>
              </div>
            </div>
            <p class="text-[15px] text-gray-700 mt-3"><%= t.story %></p>
          </div>
        <% end %>
      </div>
    </div>
  </section>

  <%# ============================== √Ä PROPOS ============================ %>
  <section class="mt-14">
    <div class="mx-auto max-w-[90rem] px-5 sm:px-6 lg:px-8">
      <div class="rounded-2xl bg-slate-900 text-slate-100 p-6 ring-1 ring-black/10">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <h3 class="text-lg font-semibold">√Ä propos de D√©clic</h3>
            <p class="mt-2 text-slate-300">
              Un projet citoyen pour connecter les personnes √† des actions concr√®tes, des formations, des communaut√©s locales
              et des histoires inspirantes. Les donn√©es proviennent d‚Äôacteurs de terrain et de sources publiques.
            </p>
          </div>
          <div>
            <h4 class="text-sm font-semibold text-slate-200">Contact</h4>
            <ul class="mt-2 space-y-1 text-slate-300 text-sm">
              <li>üìû +33&nbsp;6&nbsp;67&nbsp;06&nbsp;31&nbsp;79</li>
              <li>‚úâÔ∏è <a href="mailto:nicolas.goarant@hotmail.fr" class="underline">nicolas.goarant@hotmail.fr</a></li>
            </ul>
          </div>
          <div>
            <h4 class="text-sm font-semibold text-slate-200">Ressources</h4>
            <ul class="mt-2 space-y-1 text-slate-300 text-sm">
              <li><a class="underline" href="/mentions-legales">Mentions l√©gales</a></li>
              <li><a class="underline" href="/confidentialite">Politique de confidentialit√©</a></li>
              <li><a class="underline" href="/presse">Presse & m√©dia</a></li>
              <li><a class="underline" href="/faq">FAQ</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<style>
  .chip{ @apply inline-flex items-center rounded-full px-3 py-1.5 text-sm bg-white ring-1 ring-gray-200 hover:bg-gray-50; }
  .chip.is-active{ @apply bg-indigo-600 text-white ring-0; }
  .picon{
    width:26px;height:26px;border-radius:9999px;border:2px solid #fff;display:grid;place-items:center;
    color:#fff;font-size:14px;box-shadow:0 1px 4px rgba(0,0,0,.25);position:relative;background:var(--c,#6366f1);
  }
  .picon::after{ content:"";position:absolute;left:50%;bottom:-6px;transform:translateX(-50%);
    border:6px solid transparent;border-top-color:var(--c,#6366f1); }
  .leaflet-container{ font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"; }
  .myloc-btn{ width:34px;height:34px;background:#fff;border:none;cursor:pointer; }
</style>

<!-- Modal consentement g√©oloc -->
<div id="geo-consent" class="fixed inset-0 z-[500] hidden">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="absolute inset-0 grid place-items-center p-4">
    <div class="w-full max-w-md rounded-2xl bg-white shadow-xl ring-1 ring-black/10 p-6">
      <h3 class="text-lg font-semibold">Activer la g√©olocalisation&nbsp;?</h3>
      <p class="mt-1 text-sm text-gray-600">Nous l‚Äôutilisons uniquement pour centrer la carte autour de votre position. Aucune donn√©e n‚Äôest stock√©e c√¥t√© serveur.</p>
      <div class="mt-4 flex gap-3">
        <button id="geo-accept" class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Oui, me localiser</button>
        <button id="geo-decline" class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200">Plus tard</button>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<% content_for :scripts do %>
<script>
(function(){
  const mapEl = document.getElementById('map');
  if(!mapEl || !window.L) return;

  // --- Carte
  const map = L.map('map',{ zoomControl:true, scrollWheelZoom:true }).setView([46.6, 2.2], 6);
  mapEl._leaflet_map = map;
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap' }).addTo(map);

  const colors={benevolat:'#ef4444',formation:'#3b82f6',rencontres:'#10b981',entreprendre:'#f59e0b',histoires:'#a855f7',default:'#6366f1'};
  const emojis={benevolat:'‚ù§Ô∏è',formation:'üìò',rencontres:'üë•',entreprendre:'üíº',histoires:'üìñ',default:'‚≠ê'};
  const iconFor = (cat)=> L.divIcon({className:'',html:`<div class="picon" style="--c:${colors[cat]||colors.default}"><span>${emojis[cat]||emojis.default}</span></div>`,iconSize:[26,32],iconAnchor:[13,28],popupAnchor:[0,-26]});

  const layer = L.layerGroup().addTo(map);
  const userLayer = L.layerGroup().addTo(map);
  let dataset = [];
  let userCentred = false; // ne recentre plus sur les bornes des markers apr√®s la g√©oloc
  let clickToSet = false;  // mode "d√©finir ma position"
  let watchId = null;

  // -----> (1) Charger une position enregistr√©e au chargement
  try {
    const saved = localStorage.getItem('declic_user_pos');
    if (saved) {
      const p = JSON.parse(saved);
      if (p && typeof p.lat === 'number' && typeof p.lng === 'number') {
        userCentred = true;
        centerUser(p.lat, p.lng, 50, 'manual-cache');
      }
    }
  } catch {}

  function popupHtml(o){
    const badgeBg={benevolat:'#fee2e2',formation:'#dbeafe',rencontres:'#d1fae5',entreprendre:'#ffedd5',histoires:'#f3e8ff'}[(o.category||'').toLowerCase()]||'#eef2ff';
    const cat=(o.category||'').charAt(0).toUpperCase()+(o.category||'').slice(1);
    const base=(o.category||'').toLowerCase()==='histoires'?'/stories':'/opportunities';
    const url=`${base}/${o.slug||o.id}`;
    const org=o.organization || '';
    const desc=(o.description||'').slice(0,120)+(((o.description||'').length>120)?'‚Ä¶':'');
    return `<div style="min-width:230px">
      <div style="margin-bottom:6px"><span style="font-size:11px;padding:2px 6px;border-radius:9999px;background:${badgeBg};color:#111">${cat}</span></div>
      <strong>${o.title||''}</strong>${org?`<br/><small>${org}</small>`:''}
      <p style="margin:.5rem 0">${desc}</p>
      <a href="${url}" class="text-indigo-600 underline text-sm">Voir la fiche</a>
    </div>`;
  }

  function plot(items){
    layer.clearLayers();
    const bounds=[];
    (items||[]).forEach(o=>{
      if(!o.latitude || !o.longitude) return;
      L.marker([o.latitude,o.longitude],{icon:iconFor((o.category||'').toLowerCase())})
        .addTo(layer).bindPopup(popupHtml(o));
      bounds.push([o.latitude,o.longitude]);
    });
    if(bounds.length && !userCentred){
      map.fitBounds(bounds,{padding:[30,30]});
    }
  }

  Promise.all([
    fetch('/api/v1/opportunities').then(r=>r.ok?r.json():[]).catch(()=>[]),
    fetch('/api/v1/stories').then(r=>r.ok?r.json():[]).catch(()=>[])
  ]).then(([opps, stories])=>{
    (stories||[]).forEach(s=> s.category='histoires');
    dataset = ([]).concat(opps||[], stories||[]);
    window.__DATASET = dataset;
    plot(dataset);
  });

  // Filtres
  const chips=[...document.querySelectorAll('.chip')];
  chips.forEach(chip=>chip.addEventListener('click',()=>{
    chips.forEach(c=>c.classList.remove('is-active')); chip.classList.add('is-active');
    const cat=chip.dataset.cat;
    if(cat==='toutes'){ plot(dataset); return; }
    plot((dataset||[]).filter(o=> (o.category||'').toLowerCase()===cat));
  }));

  // --------------------- G√âOLOCALISATION ROBUSTE ----------------------
  const GOOD_ACC = 500;   // 500 m : tr√®s bien
  const OK_ACC   = 5000;  // 5 km  : acceptable
  const IMP_ACC  = 20000; // 20 km : trop impr√©cis ‚Üí on tente d'am√©liorer

  // -----> (2) centerUser enregistre la position quand fiable / manuelle
  function centerUser(lat, lon, accuracy, source='auto'){
    userCentred = true;
    userLayer.clearLayers();
    const icon=L.divIcon({className:'',html:`<div class="picon" style="--c:#2563eb"><span>üìç</span></div>`,iconSize:[26,32],iconAnchor:[13,28]});
    L.marker([lat, lon], {icon}).addTo(userLayer)
      .bindPopup(`<strong>Vous √™tes ici</strong>${accuracy?`<br><small>Pr√©cision ~${Math.round(accuracy)} m</small>`:''}`);
    if(accuracy && accuracy<2000){
      L.circle([lat, lon], { radius: accuracy, color:'#2563eb', fillColor:'#3b82f6', fillOpacity:.12, weight:1 }).addTo(userLayer);
    }
    map.flyTo([lat, lon], Math.max(map.getZoom(), 13), { duration:.8 });

    if ((accuracy && accuracy <= 5000) || String(source).startsWith('manual')) {
      try { localStorage.setItem('declic_user_pos', JSON.stringify({ lat, lng: lon })); } catch {}
    }
  }

  function tryImproveFix(onBetter, onEnd){
    if(!('geolocation' in navigator)) return onEnd?.();
    const started = Date.now();
    watchId = navigator.geolocation.watchPosition(
      (pos)=>{
        const c = pos.coords;
        if(c.accuracy <= OK_ACC){
          onBetter(c);
          stopWatch();
        }else if(Date.now() - started > 30000){
          onEnd?.();
          stopWatch();
        }
      },
      ()=>{ onEnd?.(); stopWatch(); },
      { enableHighAccuracy:true, maximumAge:0, timeout:30000 }
    );
    function stopWatch(){ if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; } }
  }

  function doLocate(){
    if(!('geolocation' in navigator)) return;
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        const c = pos.coords;
        if(c.accuracy <= OK_ACC){
          centerUser(c.latitude, c.longitude, c.accuracy);
          localStorage.setItem('declic_geo_pref','granted');
        }else{
          tryImproveFix(
            (better)=>{ centerUser(better.latitude, better.longitude, better.accuracy); localStorage.setItem('declic_geo_pref','granted'); },
            ()=>{ centerUser(c.latitude, c.longitude, c.accuracy); toast("Localisation approximative. Cliquez ¬´ D√©finir ma position ¬ª puis un point sur la carte pour corriger."); }
          );
        }
      },
      ()=>{
        localStorage.setItem('declic_geo_pref','denied');
        toast("G√©olocalisation refus√©e. Vous pouvez la r√©activer via le bouton ¬´ Me localiser ¬ª.");
      },
      { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
    );
  }

  // Petit toast simple
  function toast(msg){
    try{
      const t=document.createElement('div');
      t.textContent=msg;
      t.className="fixed bottom-4 left-1/2 -translate-x-1/2 z-[600] px-4 py-2 rounded-lg bg-slate-900 text-white shadow";
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 4500);
    }catch{ alert(msg); }
  }

  // Boutons flottants
  document.getElementById('btn-locate')?.addEventListener('click', doLocate);

  // Ajout bouton ‚ÄúD√©finir ma position‚Äù
  (function addFixBtn(){
    const btn=document.createElement('button');
    btn.id='btn-fixloc';
    btn.className='absolute right-3 top-14 z-20 inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-white/95 ring-1 ring-gray-200 shadow hover:bg-white';
    btn.innerHTML='<span>üó∫Ô∏è</span><span class="text-sm font-medium">D√©finir ma position</span>';
    mapEl.parentElement.appendChild(btn);
    btn.addEventListener('click',()=>{
      clickToSet = !clickToSet;
      btn.style.background = clickToSet ? '#eef2ff' : 'rgba(255,255,255,.95)';
      toast(clickToSet ? "Cliquez sur la carte pour d√©finir votre position." : "Mode d√©sactiv√©.");
    });
  })();

  // -----> (3) Clic carte = position manuelle + sauvegarde
  map.on('click', (e)=>{
    if(!clickToSet) return;
    const {lat, lng} = e.latlng;
    centerUser(lat, lng, 20, 'manual-click');
    localStorage.setItem('declic_geo_pref','granted');
    clickToSet = false;
  });

  // Contr√¥le Leaflet ‚Äúüìç‚Äù
  const LocateCtl = L.Control.extend({
    options:{ position:'topleft' },
    onAdd(){ const wrap=L.DomUtil.create('div','leaflet-bar'); const b=L.DomUtil.create('button','myloc-btn',wrap);
      b.type='button'; b.title='Me localiser'; b.innerHTML='üìç'; L.DomEvent.disableClickPropagation(b); b.addEventListener('click',doLocate); return wrap; }
  });
  map.addControl(new LocateCtl());

  // Consentement (modal)
  const modal=document.getElementById('geo-consent'), accept=document.getElementById('geo-accept'), decline=document.getElementById('geo-decline');
  const openModal=()=>modal?.classList.remove('hidden'); const closeModal=()=>modal?.classList.add('hidden');

  accept?.addEventListener('click', ()=>{ closeModal(); doLocate(); });
  decline?.addEventListener('click', ()=>{ closeModal(); localStorage.setItem('declic_geo_pref','denied'); });

  async function askConsentIfNeeded(){
    const pref=localStorage.getItem('declic_geo_pref');
    if(pref==='granted'){ doLocate(); return; }
    if(pref==='denied'){ return; }
    try{
      if(navigator.permissions?.query){
        const st=await navigator.permissions.query({ name:'geolocation' });
        if(st.state==='granted'){ localStorage.setItem('declic_geo_pref','granted'); doLocate(); return; }
        if(st.state==='denied'){  localStorage.setItem('declic_geo_pref','denied'); return; }
        openModal();
      }else{ openModal(); }
    }catch{ openModal(); }
  }
  document.addEventListener('turbo:load', askConsentIfNeeded, { once:true });
  document.addEventListener('DOMContentLoaded', askConsentIfNeeded, { once:true });
})();
</script>
<% end %>







