<%# app/views/pages/home.html.erb %>

<%
# Helper de nettoyage (Markdown -> Texte brut)
def strip_unsplash_md(txt)
  s = txt.to_s.dup
  s.gsub!(/###\s*√Ä quoi √ßa ressemble\s*\?/i, '')
  s.gsub!(/√Ä quoi √ßa ressemble\s*\?/i, '')
  s.gsub!(/üí°|üóìÔ∏è|üëâ|üîó/, '')
  s.gsub!(/!\[[^\]]*\]\([^)]+\)/, " ")
  s.gsub!(/\[([^\]]+)\]\([^\)]+\)/, '\1')
  s.gsub!(%r{https?://\S+}, ' ')
  s.gsub!(/^\#{1,6}\s+/, '')
  s.gsub!(/\s\#{1,6}\s+/, ' ')
  s.gsub!(/\*\*([^\*]+)\*\*/, '\1') # Enl√®ve le gras **
  s.gsub!(/\*([^\*]+)\*/, '\1')    # Enl√®ve l'italique *
  s.gsub!(/__([^_]+)__/, '\1')
  s.gsub!(/_([^_]+)_/, '\1')
  s.gsub!(/`([^`]+)`/, '\1')
  s.gsub!(/[>\-\+]{1,}\s*/, '')
  s.gsub!(/\s+/, ' ')
  s.strip
end

def thumb_for(o)
  # 1. Priorit√© √† l'upload Active Storage
  if o.respond_to?(:image) && o.image.attached?
    return url_for(o.image) rescue nil
  end

  # 2. Sinon, URL externe
  return o.image_url if o.respond_to?(:image_url) && o.image_url.present?

  # 3. Fallback par cat√©gorie
  cat = (o.respond_to?(:category) ? o.category : '').to_s.downcase
  case cat
  when 'benevolat'
    'https://images.unsplash.com/photo-1559027615-cd4628902d4a?w=400&q=80&auto=format&fit=crop'
  when 'formation'
    'https://images.unsplash.com/photo-1524178232363-1fb2b075b655?w=400&q=80&auto=format&fit=crop'
  when 'rencontres'
    'https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=400&q=80&auto=format&fit=crop'
  when 'entreprendre'
    'https://images.unsplash.com/photo-1552664730-d307ca884978?w=400&q=80&auto=format&fit=crop'
  when 'histoires'
    'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&q=80&auto=format&fit=crop'
  when 'ecologiser'
    'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=400&q=80&auto=format&fit=crop'
  else
    'https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?w=400&q=80&auto=format&fit=crop'
  end
end

def hero_fallback(obj)
  # 1. Priorit√© √† l'upload Active Storage
  if obj.respond_to?(:image) && obj.image.attached?
    return url_for(obj.image) rescue nil
  end

  # 2. Sinon, URL externe
  return obj.image_url if obj.respond_to?(:image_url) && obj.image_url.present?

  # 3. Fallback
  thumb_for(obj)
end
%>

<div class="home-ms">
  <header class="hm-hero" role="banner">
    <%= link_to "‚ö°Ô∏è Pourquoi D√©clic ?", philosophie_path, class: "hm-badge", aria: { label: "Pourquoi D√©clic ?" } %>

    <div class="hm-hero-inner">
      <div class="container">
        <h1 class="hm-title">
          Change ta vie, <span class="grad">en quelques clics</span>
        </h1>
        <p class="hm-chapo">
          D√©clic agr√®ge les mille et une opportunit√©s locales pour entreprendre, √©cologiser, se former, rencontrer,
          aider ‚Äî et pour d√©couvrir des <strong>‚Äúbelles histoires‚Äù</strong> qui inspirent.
        </p>

        <dl class="hm-stats">
          <div><dt>Opportunit√©s</dt><dd>15&nbsp;000+</dd></div>
          <div><dt>Villes</dt><dd>300+</dd></div>
          <div><dt>Communaut√©</dt><dd>10k</dd></div>
        </dl>
      </div>
    </div>

    <% hero_src = (asset_path('hero_home.jpg') rescue nil)
       hero_src ||= "https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?q=80&w=2400&auto=format&fit=crop" %>
    <div class="hm-hero-img" style="--hero:url('<%= hero_src %>')"></div>
  </header>

  <%# ========== SECTION CARTE (MAINTENANT EN PREMIER !) ========== %>
  <section id="explorer" class="hm-slice hm-map-hero">
    <%# Grille sortie du container pour pleine largeur %>
    <div class="hm-explore-grid">
        <div class="hm-explore-left">
          <%# Filtres : chips sur desktop, select sur mobile %>
          <div class="hm-filter-wrapper">
            <%# Select mobile (visible uniquement sur mobile) %>
            <select class="hm-select-mobile" id="category-select">
              <option value="toutes">üåç Toutes les cat√©gories</option>
              <option value="benevolat">‚ù§Ô∏è B√©n√©volat</option>
              <option value="ecologiser">üå± √âcologiser</option>
              <option value="formation">üìò Formation</option>
              <option value="rencontres">üë• Rencontres</option>
              <option value="entreprendre">üöÄ Entreprendre</option>
              <option value="histoires">‚ú® Belles histoires</option>
            </select>

            <%# Chips desktop (cach√©s sur mobile) %>
            <div class="hm-filterbar">
              <button class="chip is-active" data-cat="toutes">üåç Toutes</button>
              <button class="chip" data-cat="benevolat">‚ù§Ô∏è B√©n√©volat</button>
              <button class="chip" data-cat="ecologiser">üå± √âcologiser</button>
              <button class="chip" data-cat="formation">üìò Formation</button>
              <button class="chip" data-cat="rencontres">üë• Rencontres</button>
              <button class="chip" data-cat="entreprendre">üöÄ Entreprendre</button>
              <button class="chip" data-cat="histoires">‚ú® Belles histoires</button>
            </div>
          </div>

          <div class="hm-map-sticky">
            <div class="hm-mapwrap">
              <div id="map" class="hm-map"></div>
              <button id="btn-locate" class="hm-locate hm-locate-enhanced">
                <span class="locate-icon">üìç</span>
                <span class="locate-text">Me localiser</span>
              </button>
            </div>
          </div>
        </div>

        <div class="hm-explore-right">
          <div class="hm-explore-header">
            <h3 class="hm-h3">Derni√®res p√©pites</h3>
            <%= link_to opportunities_path, class: "hm-explore-more" do %>
              Voir tout ‚Üí
            <% end %>
          </div>

          <div class="hm-cards">
            <% (@opportunities || []).first(3).each do |o| %>
              <%= link_to opportunity_path(o), class: "hm-card-op" do %>
                <div class="op-img" style="background-image:url('<%= thumb_for(o) %>')"></div>
                <div class="op-content">
                  <p class="k"><%= o.category.to_s.capitalize %></p>
                  <p class="t"><%= strip_unsplash_md(o.title) %></p>
                  <p class="d"><%= strip_unsplash_md(o.description) %></p>
                  <p class="l">üìç <%= o.location %></p>
                </div>
              <% end %>
            <% end %>

            <% if (@opportunities || []).empty? %>
              <div class="hm-empty">
                Aucune opportunit√© pour le moment‚Ä¶ Revenez vite !
              </div>
            <% end %>
          </div>
        </div>
      </div>
  </section>

  <%# ========== SECTION "CHOISIS TON D√âCLIC" (MAINTENANT EN 2√àME) ========== %>
  <section id="parcours" class="hm-slice alt">
    <div class="container">
      <div class="hm-grid-cards">
        <% btn_base = "hm-card" %>

        <%= link_to opportunities_path(category: "entreprendre"), # <<< Lien Corrig√©
                    class: "#{btn_base} -entreprendre" do %>
          <span class="hm-emoji">üöÄ</span>
          <div class="hm-card-txt">
            <p class="t1">Je veux entreprendre</p>
            <p class="t2">Lance ton projet avec des mentors</p>
          </div>
        <% end %>

        <%= link_to opportunities_path(category: "ecologiser"), # <<< Lien Corrig√©
                    class: "#{btn_base} -ecologiser" do %>
          <span class="hm-emoji">üå±</span>
          <div class="hm-card-txt">
            <p class="t1">Je veux √©cologiser</p>
            <p class="t2">Des actions pour la plan√®te</p>
          </div>
        <% end %>

        <%= link_to opportunities_path(category: "formation"), # <<< Lien Corrig√©
                    class: "#{btn_base} -formation" do %>
          <span class="hm-emoji">üìò</span>
          <div class="hm-card-txt">
            <p class="t1">Je veux me former</p>
            <p class="t2">Des formations pour progresser</p>
          </div>
        <% end %>

        <%= link_to opportunities_path(category: "benevolat"), # <<< Lien Corrig√©
                    class: "#{btn_base} -benevolat" do %>
          <span class="hm-emoji">‚ù§Ô∏è</span>
          <div class="hm-card-txt">
            <p class="t1">Je veux aider</p>
            <p class="t2">Des missions utiles et humaines</p>
          </div>
        <% end %>

        <%= link_to opportunities_path(category: "rencontres"), # <<< Lien Corrig√©
                    class: "#{btn_base} -rencontres" do %>
          <span class="hm-emoji">ü§ù</span>
          <div class="hm-card-txt">
            <p class="t1">Je veux rencontrer</p>
            <p class="t2">Des communaut√©s pr√®s de chez toi</p>
          </div>
        <% end %>

        <%= link_to stories_path, class: "#{btn_base} -histoires" do %>
          <span class="hm-emoji">‚ú®</span>
          <div class="hm-card-txt">
            <p class="t1">‚ÄúBelles histoires !‚Äù</p>
            <p class="t2">D√©clics, reconversions, prises de risque</p>
          </div>
        <% end %>
      </div>
    </div>
  </section>


  <section id="stories" class="hm-slice hm-stories">
    <div class="container">
      <div class="hm-stories-head">
        <span class="hm-tag">Inspiration</span>
        <h2 class="hm-h2">Les Belles Histoires</h2>
        <p class="hm-sub">
          Ils ont os√© franchir le pas.
          D√©couvre les parcours de celles et ceux qui font bouger les lignes pr√®s de chez toi.
        </p>
      </div>

      <div class="hm-stories-grid">
        <% stories_collection = (@latest_stories || Story.where(is_active: true).order(happened_on: :desc).limit(3)) %>
        <% stories_collection.each do |story| %>
          <%= link_to story_path(story), class: "hm-story-card" do %>
            <div class="hm-story-img" style="background-image:url('<%= hero_fallback(story) %>')"></div>
            <div class="hm-story-overlay">
              <span class="hm-story-pill">T√©moignage</span>
              <h3 class="hm-story-title"><%= strip_unsplash_md(story.title) %></h3>
              <% if story.chapo.present? %>
                <p class="hm-story-chapo"><%= story.chapo %></p>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>

      <div class="hm-stories-footer">
        <%= link_to "Lire toutes les histoires", stories_path, class: "hm-story-more" %>
      </div>
    </div>
  </section>


  <section id="temoignages" class="hm-slice bg-muted grad-behind-testis">
    <div class="container">
      <h2 class="hm-h2">Ils/elles ont trouv√© leur d√©clic</h2>

      <% testimonials = [
        {
          name: "Nathalie",
          role: "Charg√©e de communication ‚Äî Nancy",
          avatar: "avatars/nathalie.jpeg",
          story: "Je cherchais un engagement local sans trop savoir par o√π commencer. Gr√¢ce √† D√©clic, j‚Äôai trouv√© une mission de b√©n√©volat dans une √©picerie solidaire √† 10 minutes de chez moi. √áa m‚Äôa donn√© l‚Äô√©lan dont j‚Äôavais besoin."
        },
        {
          name: "Matthieu",
          role: "En reconversion ‚Äî Saint-Max",
          avatar: "avatars/matthieu.jpeg",
          story: "Je regardais les offres d‚Äôemploi sans trop savoir ce qui me correspondait. Avec D√©clic, j‚Äôai trouv√© un atelier de bilan de comp√©tences anim√© localement. √áa a totalement r√©orient√© ma trajectoire."
        },
        {
          name: "Karim",
          role: "D√©veloppeur junior ‚Äî Laxou",
          avatar: "avatars/karim.jpeg",
          story: "Je voulais entreprendre mais je ne savais pas par o√π commencer. Sur D√©clic, j‚Äôai particip√© √† un afterwork d‚Äôentrepreneurs. J‚Äôy ai pitch√© mon projet pour la premi√®re fois et d√©croch√© un vrai coup de pouce."
        },
        {
          name: "Emma",
          role: "Jeune dipl√¥m√©e ‚Äî Vand≈ìuvre",
          avatar: "avatars/emma.jpeg",
          story: "Apr√®s mes √©tudes, je me sentais un peu perdue. En explorant D√©clic, j‚Äôai d√©couvert un atelier d‚Äôaccompagnement pour jeunes actifs. J‚Äôy ai rencontr√© d‚Äôautres personnes motiv√©es et retrouv√© de la confiance."
        }
      ] %>

      <div class="hm-testis">
        <% testimonials.each do |t| %>
          <article class="hm-testi">
            <div class="who">
              <img src="<%= image_path(t[:avatar]) %>" alt="" class="hm-avatar">
              <div>
                <p class="name"><%= t[:name] %></p>
                <p class="role"><%= t[:role] %></p>
              </div>
            </div>
            <p class="story"><%= t[:story] %></p>
          </article>
        <% end %>
      </div>
    </div>
  </section>

  <section class="hm-cta">
    <div class="container">
      <h2>Envie d‚Äôagir √† ton tour ?</h2>
      <p>D√©couvre des opportunit√©s pr√®s de chez toi ou partage ta propre histoire pour inspirer d‚Äôautres personnes.</p>
      <div class="buttons">
        <%= link_to "Voir les actions locales",
                    (url_for(controller: :opportunities, action: :index, category: 'toutes') rescue root_path(anchor: "explorer")),
                    class: "btn primary" %>
        <%= link_to "Partager mon histoire",
                    (respond_to?(:new_story_path) ? new_story_path : stories_path),
                    class: "btn secondary" %>
      </div>
    </div>
  </section>
</div>

<style>
/* ====== Th√®me global ====== */
.home-ms{
  --a1:#7e5bef;
  --a2:#3b82f6; --muted:#f4f2fb;
  color:#0f172a; font-family:"Inter",system-ui,sans-serif;
  background:
    radial-gradient(1400px 800px at 10% -10%, #efe8ff 0%, transparent 60%) no-repeat,
    linear-gradient(180deg, #fbfaff 0%, #f6f3ff 60%, #f3f1ff 100%);
}
.home-ms .container{ max-width:1280px; margin:0 auto; padding:0 24px; }
[id]{ scroll-margin-top:96px; }

/* ====== HERO ====== */
/* Hero full-screen avec animations */
.hm-hero{
  position:relative;
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  color:#fff;
  overflow:hidden;
  background:linear-gradient(160deg,var(--a1),var(--a2));
}

.hm-hero-inner{
  position:relative;
  padding: 2rem 0;
  z-index:10;
  animation: fadeInUp 1s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}


.hm-hero{
  position:relative;
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  color:#fff;
  overflow:hidden;
  background:linear-gradient(160deg,var(--a1),var(--a2));
}

.hm-hero-inner{
  position:relative;
  padding: 2rem 0;
  z-index:10;
  animation: fadeInUp 1s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (max-width: 768px) {
  .hm-hero {
    min-height: 80vh;
  }
}

@media (max-width: 640px) {
  .hm-hero {
    min-height: 70vh;
  }
}



.hm-hero::after{ content:""; position:absolute; inset:0; background:linear-gradient(180deg,rgba(7,9,22,.62),rgba(7,9,22,.62)); mix-blend:multiply; z-index:2; }
.hm-hero-img{ position:absolute; inset:0; background:var(--hero,none) center/cover no-repeat; filter:blur(2px) saturate(1.05) brightness(0.9); opacity:.85; z-index:1; }

/* Badge - En haut √† droite sur desktop ET mobile */
.hm-badge{
  position:absolute; top:14px; right:calc(18px + env(safe-area-inset-right)); z-index:30;
  display:inline-flex;
  align-items:center;
  gap:.55rem;
  padding:.75rem 1.25rem;
  border-radius:999px;
  font:900 1.05rem/1 "Epilogue";
  color:#1e1b4b;
  background:linear-gradient(135deg,#fef3c7,#fde68a,#fcd34d);
  box-shadow:0 8px 20px rgba(0,0,0,.25), 0 0 0 3px rgba(254, 243, 199, 0.3);
  border:2px solid rgba(251, 191, 36, 0.4);
  text-decoration:none;
  transition: all 0.3s ease;
  animation: badge-pulse 3s ease-in-out infinite;
}

@keyframes badge-pulse {
  0%, 100% {
    box-shadow: 0 8px 20px rgba(0,0,0,.25), 0 0 0 3px rgba(254, 243, 199, 0.3);
  }
  50% {
    box-shadow: 0 8px 20px rgba(0,0,0,.25), 0 0 0 6px rgba(254, 243, 199, 0.5);
  }
}

@media (min-width:1024px){
  .hm-badge{
    padding:.85rem 1.4rem;
    font-size:1.1rem;
  }
  .hm-badge:hover{
    transform:translateY(-2px) scale(1.05);
    transition:transform .12s ease;
    box-shadow: 0 12px 28px rgba(0,0,0,.3), 0 0 0 6px rgba(254, 243, 199, 0.5);
  }
}

@media (max-width:1023px){
  .hm-badge{
    font-size:.92rem;
    padding:.55rem .85rem;
  }
}

@media (max-width:480px){
  .hm-badge{
    top:10px;
    right:10px;
  }
}

/* Badge CTA - masqu√© maintenant qu'on a remis l'original */
.hm-badge-cta {
  display:none;
}


.hm-title{
  font-family:"Epilogue",Inter; font-weight:900;
  letter-spacing:-.02em; line-height:1.03;
  font-size:clamp(2.8rem,5vw,4.6rem);
  margin:.2rem 0 .5rem; text-shadow:0 2px 16px rgba(0,0,0,.25);
}

/* Texte dor√© simple et √©l√©gant */
.hm-title .grad{
  background:linear-gradient(90deg,#f472b6,#a855f7,#6366f1);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
}


.hm-chapo{
  max-width:980px;
  font:600 clamp(1.12rem,1.05vw + .9rem,1.5rem)/1.65 "Inter";
  text-shadow:0 1px 8px rgba(0,0,0,.18);
}

.hm-stats{
  display:grid; grid-template-columns:repeat(3,minmax(0,1fr));
  gap:16px; margin-top:18px;
}
.hm-stats>div{
  background:rgba(255,255,255,.92); backdrop-filter: blur(6px);
  border:1px solid #e6e8ee; border-radius:18px;
  padding:16px 18px;
  box-shadow:0 12px 34px rgba(15,23,42,.18);
  color:#0f172a; text-align:center;
}
.hm-stats dt{
  font:700 .82rem/1 "Inter"; color:#6b7280;
  text-transform:uppercase;
  letter-spacing:.04em;
}
.hm-stats dd{ margin:.25rem 0 0; font:900 1.8rem/1 "Epilogue"; }
@media (max-width:640px){
  .hm-stats{ grid-template-columns:1fr; gap:10px; }
  .hm-stats>div{ padding:12px 14px; }
  .hm-stats dd{ font-size:1.4rem; }
}

/* ====== Slices ====== */
.hm-slice{ padding:clamp(2rem,4.8vw,4rem) 0; }
.hm-slice.alt{
  background:
    radial-gradient(920px 440px at 8% -12%, #efe8ff 0%, transparent 60%) no-repeat,
    linear-gradient(180deg,#f6f2ff 0%, #ede9fe 100%);
}
.bg-muted{ background:var(--muted); }
.grad-soft{
  background:
    radial-gradient(900px 420px at 85% -10%, #eee7ff 0%, transparent 66%),
    linear-gradient(180deg,#f9f7ff 0%, #f3f1ff 100%);
}
.grad-behind-map{
  background:
    radial-gradient(980px 460px at 50% -14%, #e9e2ff 0%, transparent 70%),
    var(--muted);
}
.grad-behind-testis{
  background:
    radial-gradient(820px 380px at 12% 118%, #ece6ff 0%, transparent 66%),
    var(--muted);
}

.hm-h2{
  font-family:"Epilogue"; font-weight:900;
  font-size:clamp(2.1rem,3.2vw,2.7rem);
  color:#0f172a; margin:0 0 1rem;
}
.hm-h2::after{
  content:""; display:block; width:100px; height:6px;
  border-radius:999px; background:var(--a1);
  margin:.55rem 0 .1rem;
}
.hm-sub{ margin:.2rem 0 1rem; color:#475569; font-size:1.05rem; }

/* ====== h3 utilis√© pour "Derni√®res p√©pites" ====== */
.hm-h3{
  font-family:"Epilogue"; font-weight:800;
  font-size:1.4rem;
  color:#0f172a;
  margin:0;
}

/* ====== GROS BOUTONS (Am√©lior√©s) ====== */
.hm-grid-cards{
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr));
  gap:28px;
  max-width:1220px;
  margin-inline:auto;
}
.hm-card{
  display:grid;
  grid-template-columns:110px 1fr;
  gap:22px;
  align-items:center;
  padding:36px 30px;
  border-radius:30px;
  color:#fff;
  text-decoration:none;
  box-shadow:0 18px 44px rgba(0,0,0,.16);
  min-height:240px;
  width:100%;
  max-width:400px;
  transition:transform .15s ease, box-shadow .15s ease;
  justify-self:center;
  /* Nouveau : pour l'effet shine */
  position: relative;
  overflow: hidden;
  z-index: 1;
}
.hm-card:hover{ transform:translateY(-6px); box-shadow:0 22px 62px rgba(0,0,0,.20); }

/* Interaction Emoji au survol */
.hm-card:hover .hm-emoji {
  transform: scale(1.1) rotate(6deg);
  background: rgba(255,255,255,0.4);
}

.hm-emoji{
  width:100px; height:100px;
  border-radius:24px;
  background:rgba(255,255,255,.22);
  font-size:50px; display:grid; place-items:center;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.hm-card-txt .t1{
  font:900 clamp(1.2rem,1vw + 1rem,1.6rem)/1.15 "Epilogue"; margin:0;
}
.hm-card-txt .t2{
  margin-top:.45rem;
  font:700 clamp(1rem,.7vw + .7rem,1.22rem)/1.45 "Inter";
  opacity:.98;
}
.hm-card.-entreprendre{ background:linear-gradient(135deg,#f59e0b,#ef4444,#fb7185); }
.hm-card.-ecologiser{  background:linear-gradient(135deg,#16a34a,#22c55e,#4ade80); }
.hm-card.-formation{   background:linear-gradient(135deg,#6366f1,#38bdf8); }
.hm-card.-benevolat{   background:linear-gradient(135deg,#f43f5e,#ec4899); }
.hm-card.-rencontres{  background:linear-gradient(135deg,#facc15,#f97316,#fb923c); }

/* Nouveau style "Histoires" avec effet Shimmer */
.hm-card.-histoires{
  background:linear-gradient(135deg, #f59e0b, #ec4899, #7e5bef);
}
.hm-card.-histoires::after {
  content: "";
  position: absolute;
  top: 0; left: -150%;
  width: 100%; height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.4),
    transparent
  );
  transform: skewX(-20deg);
  animation: shine 6s infinite;
  pointer-events: none;
}
@keyframes shine {
  0% { left: -150%; }
  10% { left: 150%; }
  100% { left: 150%; }
}

@media (max-width:900px){
  .hm-grid-cards{ grid-template-columns:repeat(2,minmax(0,1fr)); }
}
@media (max-width:560px){
  .hm-grid-cards{
    grid-template-columns:1fr !important;
    gap: 16px !important;
    padding: 0 !important; /* Pas de padding interne, on g√®re avec container */
  }
  .hm-card{
    grid-template-columns:80px 1fr;
    padding:22px 18px;
    min-height:192px;
    border-radius:22px;
    max-width: none !important; /* CRITIQUE: pas de limite de largeur */
    width: 100% !important; /* CRITIQUE: prendre toute la largeur disponible */
    justify-self: stretch !important; /* CRITIQUE: s'√©tirer dans la grid */
  }
  .hm-emoji{
    width:72px; height:72px;
    border-radius:18px;
    font-size:36px;
  }

  /* FIX CRITIQUE: R√©duire le padding du container sur mobile */
  #parcours .container,
  .hm-slice .container {
    padding: 0 12px !important; /* Encore plus petit pour √™tre s√ªr */
  }

  /* FIX: Ajouter de l'espace au-dessus de la section parcours sur mobile */
  #parcours {
    margin-top: 20px !important;
    padding-top: 20px !important;
  }
}

/* ====== Filtres : Select mobile + Chips desktop ====== */

/* Wrapper des filtres */
.hm-filter-wrapper{
  margin-bottom:18px;
}

/* Select mobile (cach√© sur desktop) */
.hm-select-mobile{
  display:none;
  width:100%;
  padding:.75rem 1rem;
  font:700 .95rem/1.2 "Inter";
  color:#475569;
  background:rgba(255, 255, 255, 0.9);
  backdrop-filter:blur(10px);
  border:2px solid rgba(203, 213, 225, 0.6);
  border-radius:14px;
  cursor:pointer;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23475569' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 1rem center;
  padding-right:3rem;
  box-shadow:0 4px 12px rgba(15, 23, 42, 0.08);
  transition:all 0.3s ease;
}
.hm-select-mobile:focus{
  outline:none;
  border-color:rgba(126, 91, 239, 0.5);
  box-shadow:0 6px 20px rgba(126, 91, 239, 0.15);
}

/* Chips desktop */
.hm-filterbar{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.chip{
  --chip-bg-soft:rgba(255, 255, 255, 0.85);
  --chip-border:rgba(203, 213, 225, 0.4);
  --chip-text:#475569;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:.55rem .8rem;
  border-radius:12px;
  background:var(--chip-bg-soft);
  backdrop-filter:blur(10px);
  border:1px solid var(--chip-border);
  font:700 .8rem/1.1 "Inter";
  color:var(--chip-text);
  cursor:pointer;
  transition:all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow:0 2px 8px rgba(15, 23, 42, 0.04);
  white-space:nowrap;
}
.chip:hover {
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(15, 23, 42, 0.08);
  background:rgba(255, 255, 255, 0.95);
}

/* Desktop : chips plus compacts pour tenir sur 1 ligne */
@media (min-width:1280px){
  .chip{
    padding:.5rem .75rem;
    font-size:.78rem;
  }
  .hm-filterbar{
    gap:7px;
  }
}

/* Mobile : afficher select, cacher chips */
@media (max-width:768px){
  .hm-select-mobile{
    display:block;
  }
  .hm-filterbar{
    display:none;
  }
}

/* Variantes de couleurs subtiles */
.chip[data-cat="benevolat"]{--chip-bg-soft:rgba(255, 241, 242, 0.7);--chip-border:rgba(254, 205, 211, 0.4);--chip-text:#be123c;}
.chip[data-cat="ecologiser"]{--chip-bg-soft:rgba(236, 253, 243, 0.7);--chip-border:rgba(187, 247, 208, 0.4);--chip-text:#166534;}
.chip[data-cat="formation"]{--chip-bg-soft:rgba(239, 246, 255, 0.7);--chip-border:rgba(191, 219, 254, 0.4);--chip-text:#1d4ed8;}
.chip[data-cat="rencontres"]{--chip-bg-soft:rgba(254, 252, 232, 0.7);--chip-border:rgba(254, 243, 199, 0.4);--chip-text:#92400e;}
.chip[data-cat="entreprendre"]{--chip-bg-soft:rgba(255, 247, 237, 0.7);--chip-border:rgba(254, 215, 170, 0.4);--chip-text:#c2410c;}
.chip[data-cat="histoires"]{--chip-bg-soft:rgba(245, 243, 255, 0.7);--chip-border:rgba(221, 214, 254, 0.4);--chip-text:#5b21b6;}

/* √âtat actif - Plus marqu√© mais √©l√©gant */
.chip.is-active{
  background:var(--chip-text);
  color:#fff;
  border-color:transparent;
  box-shadow:0 4px 16px rgba(0, 0, 0, 0.15);
  transform:translateY(0);
}
.chip[data-cat="histoires"].is-active{
  background:linear-gradient(135deg,#a855f7,#7e5bef,#6366f1);
  background-size:200% 200%;
  animation:gradientShift 8s ease infinite;
  color:#fff;
  border-color:transparent;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

/* ====== SECTION CARTE HERO (MAINTENANT EN PREMIER !) ====== */
.hm-map-hero {
  background: linear-gradient(180deg, #f8f9fc 0%, #eef2f7 100%);
  padding-top: 3rem;
  padding-bottom: 4rem;
}

/* R√©duire l'espace sur mobile */
@media (max-width: 768px) {
  .hm-map-hero {
    padding-top: 1.5rem;
    padding-bottom: 2.5rem;
  }
}

.hm-map-intro {
  text-align: center;
  max-width: 880px;
  margin: 0 auto 2.5rem;
}

.hm-map-title {
  font-size: clamp(2rem, 4vw, 3.2rem);
  font-weight: 900;
  line-height: 1.1;
  margin: 0 0 1rem;
  background: linear-gradient(135deg, #7e5bef 0%, #3b82f6 50%, #10b981 100%);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}

.hm-map-subtitle {
  font-size: clamp(1.05rem, 1.5vw, 1.3rem);
  color: #475569;
  font-weight: 600;
  margin: 0;
}

/* Bouton "Me localiser" am√©lior√© */
/* Bouton "Me localiser" - Version discr√®te avec glassmorphism */
.hm-locate-enhanced {
  background: rgba(255, 255, 255, 0.9) !important;
  backdrop-filter: blur(10px) !important;
  padding: 0.65rem 1.2rem !important;
  font-size: 0.95rem !important;
  font-weight: 700 !important;
  color: #475569 !important;
  border: 1px solid rgba(203, 213, 225, 0.8) !important;
  border-radius: 999px !important;
  box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08) !important;
  transition: all 0.3s ease !important;
}

.hm-locate-enhanced:hover {
  background: rgba(255, 255, 255, 1) !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 6px 20px rgba(15, 23, 42, 0.12) !important;
  border-color: rgba(126, 91, 239, 0.3) !important;
}

.hm-locate-enhanced .locate-icon {
  font-size: 1.1em;
  margin-right: 0.4rem;
}

/* layout carte + cards */

.hm-explore-grid{
  display:grid;
  grid-template-columns:minmax(0,1.3fr) minmax(0,1fr);
  gap:22px;
  /* IMPORTANT : align-items start pour permettre au sticky de fonctionner */
  align-items: start;
  margin-top:18px;
  /* Pleine largeur sur desktop */
  max-width:1650px;
  margin-left:auto;
  margin-right:auto;
  padding:0 2rem;
  /* Hauteur maximale pour que le sticky s'arr√™te avant la section parcours */
  /* Cette hauteur = hauteur viewport * 1.5 pour donner de l'espace de scroll */

}

@media (max-width:960px){
  .hm-explore-grid{
    grid-template-columns:1fr;
  }
}

/* R√©duire les marges sur mobile */
@media (max-width:768px){
  .hm-explore-grid{
    margin-top:0;
    padding:0 1rem;
  }
}

.hm-explore-left{
  min-width:0;
}
.hm-explore-right{ min-width:0; }
.hm-explore-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}
.hm-explore-more{
  font:700 .95rem/1 "Inter";
  color:#4f46e5;
  text-decoration:none;
}
.hm-explore-more:hover{ text-decoration:underline; }

/* Carte - Design am√©lior√© et plus grande */
.hm-mapwrap{
  position:relative;
}
.hm-map{
  height:560px;
  width:100%;
  border-radius:24px;
  border:2px solid #cbd5e1;
  overflow:hidden;
  box-shadow:0 20px 50px rgba(15,23,42,.15), 0 0 0 1px rgba(99,102,241,0.1);
  transition:box-shadow 0.3s ease;
}
.hm-map:hover{
  box-shadow:0 25px 60px rgba(15,23,42,.2), 0 0 0 2px rgba(99,102,241,0.2);
}

/* Ajout d'un cadre d√©coratif autour de la carte */
.hm-mapwrap::before {
  content:"";
  position:absolute;
  inset:-6px;
  border-radius:28px;
  background:linear-gradient(135deg,
    rgba(99,102,241,0.1) 0%,
    rgba(139,92,246,0.1) 50%,
    rgba(236,72,153,0.1) 100%);
  z-index:-1;
  opacity:0;
  transition:opacity 0.3s ease;
}
.hm-mapwrap:hover::before {
  opacity:1;
}

@media (min-width:1280px){
  .hm-explore-grid{
    grid-template-columns:1.8fr 1fr;
    gap:48px;
  }
  .hm-map{
    height:900px; /* IMMENSE sur desktop ! */
  }
}

/* Responsive : hauteurs r√©duites sur tablette et mobile */
@media (max-width:1279px){
  .hm-map{
    height:420px; /* R√©duit sur laptop/tablette */
  }
}

@media (max-width:768px){
  .hm-map{
    height:320px; /* Plus petit sur tablette */
  }
}

@media (max-width:520px){
  .hm-map{
    height:280px; /* Compact sur mobile */
  }
}

.hm-map-sticky {
  position: sticky;
  top: 80px;
  z-index: 10;
}
@media (max-width:960px){
  .hm-map-sticky {
    position: static;
    top: auto;
  }
}

@media (max-width:768px){
  .hm-map{ overflow:visible; }
}

/* ====== POPUP CARTE MODERNE ====== */
/* Styles pour remplacer le popup par d√©faut blanc */

.leaflet-popup-content-wrapper {
  padding: 0;
  overflow: hidden;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}
.leaflet-popup-content {
  margin: 0 !important;
  width: 280px !important;
}
.leaflet-popup-tip {
  background: white;
}
.leaflet-container a.leaflet-popup-close-button {
  top: 8px; right: 8px;
  color: white;
  background: rgba(0,0,0,0.3);
  border-radius: 50%;
  width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
  font: 16px/14px Tahoma, Verdana, sans-serif;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  border: none;
}
.leaflet-container a.leaflet-popup-close-button:hover {
  background: rgba(0,0,0,0.6);
  color: white;
}

/* Contenu de la carte popup */
.dc-pop-card {
  font-family: "Inter", sans-serif;
  color: #0f172a;
}
.dc-pop-hero {
  height: 140px;
  background-size: cover;
  background-position: center;
  position: relative;
}
.dc-pop-badge {
  position: absolute;
  top: 12px; left: 12px;
  background: var(--cat-color, #7e5bef);
  color: white;
  font-size: 0.65rem;
  font-weight: 800;
  text-transform: uppercase;
  padding: 4px 8px;
  border-radius: 99px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  letter-spacing: 0.05em;
}
.dc-pop-body {
  padding: 16px;
}
.dc-pop-title {
  margin: 0 0 6px 0;
  font-family: "Epilogue", sans-serif;
  font-weight: 800;
  font-size: 1rem;
  line-height: 1.3;
  color: #0f172a;
}
.dc-pop-meta {
  display: flex;
  flex-direction: column;
  gap: 4px;
  margin-bottom: 12px;
  font-size: 0.8rem;
  color: #64748b;
  font-weight: 500;
}
.dc-pop-meta span {
  display: flex; align-items: center; gap: 6px;
}
.dc-pop-btn {
  display: block; width: 100%;
  text-align: center;
  background: #0f172a;
  color: white !important;
  text-decoration: none !important;
  padding: 10px 0;
  border-radius: 8px;
  font-weight: 700;
  font-size: 0.85rem;
  transition: transform 0.1s, background 0.2s;
}
.dc-pop-btn:hover {
  background: #7e5bef;
  transform: translateY(-1px);
}

/* ====== FIX POPUP MOBILE - COMPACT ====== */

/* Limiter la hauteur du popup sur mobile */
@media (max-width: 768px) {
  .leaflet-popup-content-wrapper {
    max-height: 60vh !important;
    overflow: hidden !important;
  }

  .dc-pop-card {
    max-height: 60vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* R√©duire la taille de l'image hero */
  .dc-pop-hero {
    height: 100px !important;
  }

  /* R√©duire le padding du body */
  .dc-pop-body {
    padding: 12px !important;
  }

  /* Titre plus compact */
  .dc-pop-title {
    font-size: 0.9rem !important;
    margin: 0 0 8px 0 !important;
    line-height: 1.2 !important;
  }

  /* Meta plus compact */
  .dc-pop-meta {
    font-size: 0.75rem !important;
    gap: 2px !important;
    margin-bottom: 10px !important;
  }

  /* Bouton plus petit */
  .dc-pop-btn {
    padding: 8px 0 !important;
    font-size: 0.8rem !important;
  }
}

/* ====== Cards opportunit√©s ====== */
.hm-cards{
  display:grid;
  grid-template-columns:1fr;
  gap:18px;
}
@media (max-width:980px){
  .hm-cards{ grid-template-columns:1fr; }
}
.hm-card-op{
  display:block;
  border-radius:20px;
  background:#fff;
  border:1px solid #e6e8ee;
  box-shadow:0 10px 26px rgba(15,23,42,.08);
  text-decoration:none;
  color:#0f172a;
  overflow:hidden;
  transition:transform .15s ease, box-shadow .15s ease;
}
.hm-card-op:hover{
  transform:translateY(-4px);
  box-shadow:0 16px 38px rgba(15,23,42,.14);
}
.hm-card-op .op-img{
  width:100%;
  height:180px;
  background:#f1f5f9 center/cover no-repeat;
  border-bottom:1px solid #e6e8ee;
}
.hm-card-op .op-content{ padding:16px 18px; }
.hm-card-op .k{
  color:#64748b; font-size:.82rem;
  margin:0 0 .4rem;
  font-weight:700; text-transform:uppercase;
  letter-spacing:.04em;
}
.hm-card-op .t{
  font:900 1.16rem/1.2 "Epilogue"; margin:0 0 .3rem;
}
.hm-card-op .d{
  font:1rem/1.55 "Inter"; color:#475569;
  margin:.3rem 0 .5rem;
  display:-webkit-box;
  -webkit-line-clamp:2; -webkit-box-orient:vertical;
  overflow:hidden;
}
.hm-card-op .l{
  font:1rem/1.4 "Inter"; color:#1f2937; margin:0;
}
.hm-empty{
  grid-column:1 / -1;
  padding:18px;
  border-radius:14px;
  border:1px dashed #e5e7eb;
  background:#f9fafb;
  text-align:center;
  color:#6b7280;
}

/* ====== T√âMOIGNAGES ====== */
.hm-testis{
  display:grid;
  grid-template-columns:repeat(4, minmax(0,1fr));
  gap:18px;
}
@media (max-width:1100px){
  .hm-testis{ grid-template-columns:repeat(3, minmax(0,1fr)); }
}
@media (max-width:820px){
  .hm-testis{ grid-template-columns:repeat(2, minmax(0,1fr)); }
}
@media (max-width:520px){
  .hm-testis{ grid-template-columns:1fr; }
}
.hm-testi{
  background:#fff;
  border:1px solid #e6e8ee;
  border-radius:18px;
  padding:16px;
  box-shadow:0 10px 26px rgba(15,23,42,.08);
}
.hm-testi .who{
  display:flex; align-items:center; gap:12px; margin-bottom:8px;
}
.hm-avatar{
  width:64px;
  height:64px;
  border-radius:50%;
  object-fit:cover;
  object-position:50% 8%;
  background:#fff;
  flex:0 0 64px;
  border:2px solid #fff;
  box-shadow:0 2px 10px rgba(15,23,42,.12);
}
.hm-avatar[src*="nathalie"]{
  object-position:50% 18%;
}
.hm-testi .name{
  margin:0;
  font:900 1.05rem/1.1 "Epilogue"; color:#0f172a;
}
.hm-testi .role{
  margin:.15rem 0 0; font:700 .9rem/1.2 "Inter"; color:#64748b;
}
.hm-testi .story{
  margin:.4rem 0 0;
  color:#334155;
  font:500 .95rem/1.45 "Inter";
}

/* ====== Belles histoires ====== */
.hm-stories{
  background:#eef2ff;
}
.hm-stories-head{
  text-align:center;
  max-width:720px;
  margin:0 auto 24px;
}
.hm-tag{
  display:inline-block;
  padding:.3rem .8rem;
  border-radius:999px;
  font:700 .75rem/1 "Inter";
  letter-spacing:.14em;
  text-transform:uppercase;
  color:#4f46e5;
  background:#e0e7ff;
  margin-bottom:.4rem;
}
.hm-stories-grid{
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr));
  gap:20px;
}
@media (max-width:960px){
  .hm-stories-grid{ grid-template-columns:repeat(2,minmax(0,1fr)); }
}
@media (max-width:640px){
  .hm-stories-grid{ grid-template-columns:1fr; }
}

.hm-story-card{
  position:relative;
  display:block;
  border-radius:24px;
  overflow:hidden;
  text-decoration:none;
  min-height:500px;
  box-shadow:0 16px 40px rgba(15,23,42,.26);
}

.hm-story-img{
  position:absolute;
  inset:0;
  background:#020617 center/cover no-repeat;
  transform:scale(1.03);
  transition:transform .7s ease;
}
.hm-story-overlay{
  position:absolute;
  inset:0;
  padding:18px 18px 20px;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
  background:linear-gradient(180deg,rgba(15,23,42,.05),rgba(15,23,42,.86));
}
.hm-story-card:hover .hm-story-img{
  transform:scale(1.09);
}
.hm-story-pill{
  align-self:flex-start;
  padding:.25rem .7rem;
  border-radius:999px;
  border:1px solid rgba(248,250,252,.8);
  background:rgba(15,23,42,.55);
  color:#e5e7eb;
  font:700 .7rem/1 "Inter";
  text-transform:uppercase;
  letter-spacing:.18em;
  margin-bottom:.55rem;
}
.hm-story-title{
  margin:0 0 .25rem;
  font:800 1.3rem/1.2 "Epilogue";
  color:#f9fafb;
}
.hm-story-chapo{
  margin:0;
  font:500 .9rem/1.4 "Inter";
  color:#e5e7eb;
}
.hm-stories-footer{
  text-align:center;
  margin-top:18px;
}
.hm-story-more{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:.8rem 1.5rem;
  border-radius:999px;
  border:2px solid #111827;
  font:800 .95rem/1 "Epilogue";
  text-decoration:none;
  color:#111827;
  background:#fff;
}
.hm-story-more:hover{
  background:#111827;
  color:#fff;
}

/* ====== CTA ====== */
.hm-cta{
  text-align:center;
  color:#fff;
  background: linear-gradient(160deg, var(--a1), color-mix(in oklab, var(--a1), var(--a2) 40%));
  padding:clamp(2.4rem,5vw,4.2rem) 0;
}
.hm-cta h2{
  margin:0 0 .6rem;
  font:900 clamp(1.6rem,3vw,2.2rem)/1.1 "Epilogue";
}
.hm-cta p{
  margin:0 0 1rem;
  font:700 1rem/1.6 "Inter";
  opacity:.98;
}
.hm-cta .buttons{
  display:flex; gap:12px; justify-content:center; flex-wrap:wrap;
}
.hm-cta .btn{
  display:inline-block;
  border-radius:999px;
  padding:.9rem 1.3rem;
  text-decoration:none;
  font:900 1rem/1 "Epilogue";
}
.hm-cta .btn.primary{
  background:#fff; color:#111827;
  box-shadow:0 10px 26px rgba(0,0,0,.12);
}
.hm-cta .btn.secondary{
  background:transparent;
  border:2px solid #fff;
  color:#fff;
}

/* R√©duction de l'espace avant les gros boutons */
#parcours {
  padding-top: clamp(1.2rem, 2.5vw, 2.2rem);
}

@media (max-width: 768px) {
  #parcours {
    padding-top: 1rem;
  }
}

</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<% content_for :scripts do %>
<script>
window.DeclicCleanMd = function(md){
  return (md || "")
    .replace(/!\[[^\]]*\]\([^\)]+\)/g, "")
    .replace(/\[([^\]]+)\]\((.*?)\)/g, "$1")
    .replace(/[*_`>#]/g, "")
    .replace(/\s+/g, " ")
    .trim();
};
</script>

<script>
document.addEventListener('turbo:load', bootHome);
document.addEventListener('DOMContentLoaded', bootHome);

function bootHome(){
  const mapEl = document.getElementById('map');
  if (!mapEl || !window.L) return;

  let map = window._declicMap;
  if (!map) {
    map = L.map(mapEl, { zoomControl:true, attributionControl:false }).setView([46.6, 2.2], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      detectRetina: true,
      crossOrigin: true
    }).addTo(map);
    window._declicMap = map;
  } else {
    requestAnimationFrame(()=> map.invalidateSize());
  }

  map.on('click', () => map.closePopup());

  if (!window._declicDataInit) {

    const colors = {
      benevolat:   '#f43f5e',
      ecologiser:  '#16a34a',
      formation:   '#3b82f6',
      rencontres:  '#facc15',
      entreprendre:'#f59e0b',
      histoires:   '#a855f7',
      default:     '#7e5bef'
    };
    const emojis = {
      benevolat:   '‚ù§Ô∏è',
      ecologiser:  'üå±',
      formation:   'üìò',
      rencontres:  'ü§ù',
      entreprendre:'üöÄ',
      histoires:   '‚ú®',
      default:     'üìç'
    };

    const iconFor = (c) => {
      const em = emojis[c] || emojis.default;
      const baseStyle =
        "width:26px;height:26px;border-radius:9999px;border:2px solid #fff;" +
        "display:grid;place-items:center;color:#fff;font-size:14px;" +
        "box-shadow:0 1px 4px rgba(0,0,0,.25);";
      let extraStyle;
      if (c === 'histoires') {
        extraStyle =
          "background:linear-gradient(135deg,#f97316,#ec4899,#3b82f6,#22c55e,#f59e0b);" +
          "background-size:320% 320%;animation:gradientShift 8s ease infinite;";
      } else {
        const bg = colors[c] || colors.default;
        extraStyle = `background:${bg};`;
      }

      return L.divIcon({
        className: '',
        html: `<div style="${baseStyle}${extraStyle}"><span>${em}</span></div>`,
        iconSize: [26, 32],
        iconAnchor: [13, 28],
        popupAnchor: [0, -16]
      });
    };

    const esc = s => (s || '').toString()
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');

    function mdPlain(s){
      return (s||'')
        .replace(/### √Ä quoi √ßa ressemble \?/gi, '')
        .replace(/üí°/g, '')
        .replace(/!\[[^\]]*\]\([^\)]+\)/g,' ')
        .replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'$1')
        .replace(/https?:\/\/\S+/g,' ')
        .replace(/[\*_`>#]/g,'')
        .replace(/\s+/g,' ')
        .trim();
    }

    // Nouvelle fonction POPUP MODERNIS√âE
    function popupHtml(o){
      const cats = {
        benevolat:    { color: '#f43f5e', label: 'B√©n√©volat' },
        ecologiser:   { color: '#16a34a', label: '√âcologie' },
        formation:    { color: '#3b82f6', label: 'Formation' },
        rencontres:   { color: '#facc15', label: 'Rencontres' },
        entreprendre: { color: '#f59e0b', label: 'Entreprise' },
        histoires:    { color: '#a855f7', label: 'T√©moignage' },
        default:      { color: '#7e5bef', label: 'Initiative' }
      };

      const cKey = (o.category||'').toLowerCase();
      const conf = cats[cKey] || cats.default;

      const base = (cKey==='histoires') ? '/stories' : '/opportunities';
      const url = `${base}/${o.slug||o.id}`;

      let dateStr = "";
      if(o.starts_at || o.date) {
        const d = new Date(o.starts_at || o.date);
        dateStr = d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
      }

      const img = (function thumbForJs(obj){
        if(obj.image_url) return obj.image_url;
        if(cKey==='benevolat') return 'https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?w=400&q=80&fit=crop';
        if(cKey==='formation') return 'https://images.unsplash.com/photo-1555949963-ff9fe0c870eb?w=400&q=80&fit=crop';
        if(cKey==='rencontres') return 'https://images.unsplash.com/photo-1511632765486-a01980e01a18?w=400&q=80&fit=crop';
        return 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&q=80&fit=crop';
      })(o);

      const safeTitle = esc(mdPlain(o.title||''));
      const safeLoc = esc(o.location || '');
      const safeOrg = esc(o.organization || '');

      return `
        <div class="dc-pop-card" style="--cat-color: ${conf.color}">
          <div class="dc-pop-hero" style="background-image: url('${img}')">
            <span class="dc-pop-badge">${conf.label}</span>
          </div>

          <div class="dc-pop-body">
            <h3 class="dc-pop-title">${safeTitle}</h3>

            <div class="dc-pop-meta">
              ${safeOrg ? `<span>üè¢ ${safeOrg}</span>` : ''}
              ${dateStr ? `<span>üóìÔ∏è ${dateStr}</span>` : ''}
              ${safeLoc ? `<span>üìç ${safeLoc}</span>` : ''}
            </div>

            <a href="${url}" class="dc-pop-btn">
              Voir le d√©clic ‚Üí
            </a>
          </div>
        </div>
      `;
    }

    const dataLayer = L.layerGroup().addTo(map);
    window._declicDataLayer = dataLayer;
    let dataset = [];

// La fonction plot(items) g√®re le dessin des marqueurs sur la carte
function plot(items){
  dataLayer.clearLayers();
  const bounds=[];
  (items||[]).forEach(o=>{

    // FIX D√âCISIF: Convertir la latitude et la longitude en nombre.
    const lat = Number(o.latitude);
    const lng = Number(o.longitude);

    if(!lat || !lng) return; // Si la conversion √©choue (lat ou lng vaut 0 ou NaN), on saute

// Le reste du code reste le m√™me, mais utilise lat et lng (variables locales)
    const marker = L.marker([lat, lng], { icon:iconFor((o.category||'').toLowerCase()) })
      .addTo(dataLayer)
      .bindPopup(popupHtml(o), {
        autoPan: false,
        maxWidth: 300,
        minWidth: 280,
        maxHeight: window.innerHeight * 0.65,
        closeButton: true,
        autoClose: true,
        offset: [0, 0]
      });

    // FIX: Centrer le popup avec padding pour navbar
    marker.on('popupopen', function(e) {
      const popup = e.popup;

      setTimeout(function() {
        const popupEl = popup._container;
        if (!popupEl) return;

        // 1. R√©cup√©rer les dimensions
        const popupHeight = popupEl.offsetHeight;
        const mapSize = map.getSize();

        // 2. Calculer l'espace disponible (navbar + padding)
        const navbarHeight = window.innerWidth <= 640 ? 64 : 72;
        const topPadding = 20;
        const totalTopSpace = navbarHeight + topPadding;

        // 3. Centre de la zone visible
        const visibleHeight = mapSize.y - totalTopSpace;
        const mapCenterX = mapSize.x / 2;
        const mapCenterY = totalTopSpace + (visibleHeight / 2);

        // 4. Position actuelle du popup
        const markerPoint = map.latLngToContainerPoint(marker.getLatLng());
        const popupCenterY = markerPoint.y - (popupHeight / 2);
        const popupCenterX = markerPoint.x;

        // 5. Calculer le d√©calage n√©cessaire
        const offsetX = mapCenterX - popupCenterX;
        const offsetY = mapCenterY - popupCenterY;

        // 6. Pan pour centrer
        map.panBy([-offsetX, -offsetY], {
          animate: true,
          duration: 0.3
        });

        // 7. D√©sactiver autoPan apr√®s animation
        setTimeout(function() {
          popup.options.autoPan = false;
        }, 400);

        // 8. Style du bouton de fermeture
        const closeBtn = popup._closeButton;
        if (closeBtn) {
          closeBtn.style.width = '44px';
          closeBtn.style.height = '44px';
          closeBtn.style.fontSize = '28px';
          closeBtn.style.lineHeight = '44px';
          closeBtn.style.display = 'flex';
          closeBtn.style.alignItems = 'center';
          closeBtn.style.justifyContent = 'center';
          closeBtn.style.cursor = 'pointer';
          closeBtn.style.touchAction = 'manipulation';
          closeBtn.style.zIndex = '10001';
          closeBtn.style.position = 'absolute';
          closeBtn.style.top = '8px';
          closeBtn.style.right = '8px';
          closeBtn.style.background = 'rgba(0, 0, 0, 0.7)';
          closeBtn.style.borderRadius = '50%';
          closeBtn.style.color = 'white';

          // √âv√©nements tactiles
          closeBtn.addEventListener('touchstart', function(event) {
            event.stopPropagation();
            event.preventDefault();
            map.closePopup();
          }, { passive: false });

          closeBtn.addEventListener('click', function(event) {
            event.stopPropagation();
            event.preventDefault();
            map.closePopup();
          });
        }
      }, 100);
    });

    bounds.push([lat, lng]);
  });

  // Recentrage de la carte si des points existent
  if(bounds.length){ map.fitBounds(bounds,{padding:[30,30]}); }
}

    Promise.all([
      fetch('/api/v1/opportunities').then(r=>r.ok?r.json():[]).catch(()=>[]),
      fetch('/api/v1/stories').then(r=>r.ok?r.json():[]).catch(()=>[])
    ]).then(([opps, stories])=>{
      (stories||[]).forEach(s=> s.category='histoires');
      dataset = ([]).concat(opps||[], stories||[]);
      plot(dataset);
    });

    document.querySelectorAll('.chip').forEach(ch=>{
      if (ch.dataset.bound === '1') return;
      ch.dataset.bound = '1';
      ch.addEventListener('click', ()=>{
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('is-active'));
        ch.classList.add('is-active');
        const cat=ch.dataset.cat;
        // Sync avec le select mobile
        const sel = document.getElementById('category-select');
        if (sel) sel.value = cat;
        if(cat==='toutes'){ plot(dataset); return; }
        plot((dataset||[]).filter(o=> (o.category||'').toLowerCase()===cat));
      });
    });

    // G√©rer le select mobile
    const sel = document.getElementById('category-select');
    if (sel && !sel.dataset.bound) {
      sel.dataset.bound = '1';
      sel.addEventListener('change', ()=>{
        const cat = sel.value;
        // Sync avec les chips (au cas o√π on passe de mobile √† desktop)
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('is-active'));
        const activeChip = document.querySelector(`.chip[data-cat="${cat}"]`);
        if (activeChip) activeChip.classList.add('is-active');
        if(cat==='toutes'){ plot(dataset); return; }
        plot((dataset||[]).filter(o=> (o.category||'').toLowerCase()===cat));
      });
    }

    window._declicDataInit = true;
    window._declicPlot = plot;
  }

  if (!window._declicMeLayer) window._declicMeLayer = L.layerGroup().addTo(map);
  window._declicMeLayer.clearLayers();

  let meDot=null, meHalo=null, meAcc=null;

  function updateMe(lat, lng, acc){
    const p=[lat,lng];

    if (!meHalo) {
      meHalo = L.circleMarker(p, { radius:12, color:'#ffffff', opacity:0.9, weight:3, fill:true, fillOpacity:.15 })
        .addTo(window._declicMeLayer);
    } else { meHalo.setLatLng(p); }

    if (!meDot) {
      meDot = L.circleMarker(p, { radius:7, color:'#2563eb', weight:2, fill:true, fillOpacity:1 })
        .addTo(window._declicMeLayer);
    } else { meDot.setLatLng(p); }

    const r = (acc && isFinite(acc)) ? Math.min(Math.max(acc, 80), 1200) : 0;
    if (r) {
      if (!meAcc) meAcc = L.circle(p, { radius:r, color:'#60a5fa', weight:1, fill:true, fillOpacity:.12 })
        .addTo(window._declicMeLayer);
      meAcc.setLatLng(p); meAcc.setRadius(r);
    }
  }

  // --- RESTAURATION DE LA GEOLOCALISATION AUTOMATIQUE ---
  // Ce bloc a √©t√© supprim√© par erreur, il relance la recherche d√®s le chargement
  if ('geolocation' in navigator) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        updateMe(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy);
        // Si on trouve, on centre la carte (optionnel, sinon √ßa reste vue d'ensemble)
        // const map = window._declicMap;
        // if(map) map.panTo([pos.coords.latitude, pos.coords.longitude], { animate:true });
      },
      err => {}, // Pas d'alerte au chargement automatique
      { enableHighAccuracy:true, timeout:8000, maximumAge:60000 }
    );
  }

  const btnEl = document.getElementById('btn-locate');
  function bindLocateButton(){
    if (!btnEl) return;
    const btn = btnEl.cloneNode(true); btnEl.replaceWith(btn);
    btn.addEventListener('click', ()=> (window._declicWatchId ? stopFollow() : startFollow()));
    window._declicButton = btn;
  }
  bindLocateButton();

  function startFollow(){
    if (!('geolocation' in navigator)) {
      alert("La g√©olocalisation n'est pas disponible sur cet appareil.");
      return;
    }
    if (window._declicWatchId) return;

    // Feedback imm√©diat
    if (window._declicButton) window._declicButton.innerHTML = '<span>‚è≥</span> <span>Recherche...</span>';

    const geoOptions = { enableHighAccuracy:true, timeout:15000, maximumAge:0 };

    navigator.geolocation.getCurrentPosition(
      p => {
        updateMe(p.coords.latitude, p.coords.longitude, p.coords.accuracy);
        // Si on trouve, on change le bouton
        if (window._declicButton) window._declicButton.innerHTML = '<span>üõë</span> <span>Arr√™ter le suivi</span>';
        // On recentre la carte sur l'utilisateur
        const map = window._declicMap;
        if(map) map.panTo([p.coords.latitude, p.coords.longitude], { animate:true });
      },
      e => {
        console.warn('[geo] getCurrentPosition ERR', e);
        if(e.code === 1) alert("Vous devez autoriser la g√©olocalisation pour que cela fonctionne.");
        else if(e.code === 3) alert("Le d√©lai d'attente GPS est d√©pass√©. R√©essayez dehors ou avec une meilleure connexion.");
        stopFollow();
      },
      geoOptions
    );

    window._declicWatchId = navigator.geolocation.watchPosition(
      p => updateMe(p.coords.latitude, p.coords.longitude, p.coords.accuracy),
      e => console.warn('[geo] watch ERR', e),
      geoOptions
    );
  }

  function stopFollow(){
    if (window._declicWatchId) { navigator.geolocation.clearWatch(window._declicWatchId); window._declicWatchId=null; }
    if (window._declicButton) window._declicButton.innerHTML = '<span>üìç</span> <span>Me localiser</span>';
  }

  // ========== STICKY CARTE AVEC TRANSFORM (CORRIG√â MOBILE + DESKTOP) ==========
  (function() {
    const mapSticky = document.querySelector('.hm-map-sticky');
    const rightColumn = document.querySelector('.hm-explore-right');
    const parcoursSection = document.getElementById('parcours');

    // V√©rifier la largeur √† chaque appel pour g√©rer le resize
    function isDesktop() {
      return window.innerWidth > 960;
    }

    if (!mapSticky || !rightColumn) return;

    const stickyTop = 80;

    function handleScroll() {
      // Ne rien faire sur mobile
      if (!isDesktop()) {
        mapSticky.style.transform = '';
        mapSticky.style.willChange = '';
        return;
      }

      const scrollY = window.pageYOffset;
      const mapRect = mapSticky.getBoundingClientRect();
const mapBox = document.querySelector(".hm-map");
const mapHeight = (mapBox ? mapBox.getBoundingClientRect().height : mapRect.height);

      const rightColumnRect = rightColumn.getBoundingClientRect();

      // Position initiale de la carte (sans transform)
      const currentTransform = parseFloat(mapSticky.style.transform?.match(/translateY\((.+?)px\)/)?.[1] || 0);
      const mapOriginalTop = mapRect.top + scrollY - currentTransform;

      // Point d'arr√™t : s'aligne avec le bas de la colonne de droite
      const rightColumnBottom = rightColumnRect.top + scrollY + rightColumnRect.height;
      const stopPoint = rightColumnBottom - mapHeight;

      // Calculer le translateY pour que la carte reste √† stickyTop du viewport
      let translateY = scrollY - mapOriginalTop + stickyTop;

      // Limiter pour ne pas d√©passer le bas de la colonne de droite
      const maxY = stopPoint - mapOriginalTop;
      if (translateY > maxY) {
        translateY = maxY;
      }

      // Ne pas descendre en dessous de 0
      if (translateY < 0) {
        translateY = 0;
      }

      // Appliquer le transform
      if (translateY > 0) {
        mapSticky.style.transform = `translateY(${translateY}px)`;
        mapSticky.style.willChange = 'transform';
      } else {
        mapSticky.style.transform = '';
        mapSticky.style.willChange = '';
      }
    }

    window.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('resize', () => {
      // Reset au resize puis recalculer
      mapSticky.style.transform = '';
      setTimeout(handleScroll, 100);
    });

    // Premier check
    setTimeout(handleScroll, 100);
  })();
}
</script>
<% end %>
