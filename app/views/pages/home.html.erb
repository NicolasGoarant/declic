<%# app/views/pages/home.html.erb %>

<div class="relative isolate">
  <!-- d√©cor -->
  <div class="pointer-events-none absolute inset-0 -z-10 bg-gradient-to-br from-violet-50 via-white to-indigo-50"></div>
  <div class="pointer-events-none absolute inset-0 -z-10 opacity-[.35] bg-[radial-gradient(circle_at_20%_20%,rgba(99,102,241,.08)_1px,transparent_1px)] [background-size:18px_18px]"></div>

  <%# ================================ HERO ================================ %>
  <section class="pt-24 lg:pt-28">
    <div class="mx-auto max-w-[90rem] px-5 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,1fr)] gap-8 items-center">
        <div>
          <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold tracking-tight text-slate-900">
            Change ta vie, <span class="bg-gradient-to-r from-fuchsia-600 to-indigo-600 bg-clip-text text-transparent">en quelques clics</span>
          </h1>
          <p class="mt-4 text-lg text-slate-700 max-w-2xl">
            D√©clic agr√®ge les mille et une opportunit√©s locales : entreprendre, se former, rencontrer, aider ‚Äî et d√©couvrir des <em>belles histoires</em> qui inspirent.
          </p>

          <dl class="mt-6 grid grid-cols-2 sm:grid-cols-3 gap-4">
            <div class="rounded-xl bg-white/90 backdrop-blur border border-gray-100 p-4 shadow">
              <dt class="text-xs text-gray-500">Opportunit√©s</dt>
              <dd class="text-2xl font-bold">15&nbsp;000+</dd>
            </div>
            <div class="rounded-xl bg-white/90 backdrop-blur border border-gray-100 p-4 shadow">
              <dt class="text-xs text-gray-500">Villes</dt>
              <dd class="text-2xl font-bold">300+</dd>
            </div>
            <div class="rounded-xl bg-white/90 backdrop-blur border border-gray-100 p-4 shadow">
              <dt class="text-xs text-gray-500">Communaut√©</dt>
              <dd class="text-2xl font-bold">10k</dd>
            </div>
          </dl>
        </div>

        <%# visuel : image locale si dispo, sinon photo par d√©faut %>
        <%
          hero_src = begin
            asset_path('hero.jpg')
          rescue
            nil
          end
          hero_src ||= "https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=1600&auto=format&fit=crop"
        %>
        <img src="<%= hero_src %>" alt="D√©clic ‚Äî projets pr√®s de chez vous"
             class="w-full h-64 sm:h-80 lg:h-[22rem] object-cover rounded-2xl shadow ring-1 ring-black/5">
      </div>
    </div>
  </section>

  <%# ======================== PARCOURS (GROS BOUTONS) ===================== %>
  <section id="parcours" class="mt-10">
    <div class="mx-auto max-w-[90rem] px-5 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4">
        <% btn_base = "group block rounded-2xl p-6 lg:p-7 text-white shadow-md transition hover:shadow-lg grid content-start min-h-[148px] sm:min-h-[160px] xl:min-h-[180px]" %>
        <% icon_wrap = "inline-flex h-12 w-12 lg:h-16 lg:w-16 items-center justify-center rounded-xl bg-white/20 text-2xl lg:text-3xl" %>
        <% title_txt = "font-semibold text-lg lg:text-xl" %>
        <% desc_txt = "text-white/95 text-[16px] sm:text-[17px] lg:text-base leading-snug mt-1" %>

        <%= link_to parcours_path(category: "entreprendre"), class: btn_base, style: "background:linear-gradient(135deg,#f59e0b 0%,#ef4444 50%,#fb7185 100%);" do %>
          <div class="flex items-start gap-4 lg:gap-5">
            <span class="<%= icon_wrap %>">üöÄ</span>
            <div class="min-w-0">
              <p class="<%= title_txt %>">Je veux entreprendre</p>
              <p class="<%= desc_txt %>">Lance ton projet avec des mentors</p>
            </div>
          </div>
        <% end %>

        <%= link_to parcours_path(category: "formation"), class: btn_base, style: "background:linear-gradient(135deg,#6366f1 0%,#38bdf8 100%);" do %>
          <div class="flex items-start gap-4 lg:gap-5">
            <span class="<%= icon_wrap %>">üìò</span>
            <div class="min-w-0">
              <p class="<%= title_txt %>">Je veux me former</p>
              <p class="<%= desc_txt %>">Des formations pour progresser</p>
            </div>
          </div>
        <% end %>

        <%= link_to parcours_path(category: "benevolat"), class: btn_base, style: "background:linear-gradient(135deg,#f43f5e 0%,#ec4899 100%);" do %>
          <div class="flex items-start gap-4 lg:gap-5">
            <span class="<%= icon_wrap %>">‚ù§Ô∏è</span>
            <div class="min-w-0">
              <p class="<%= title_txt %>">Je veux aider</p>
              <p class="<%= desc_txt %>">Des missions utiles et humaines</p>
            </div>
          </div>
        <% end %>

        <%= link_to parcours_path(category: "rencontres"), class: btn_base, style: "background:linear-gradient(135deg,#10b981 0%,#06b6d4 100%);" do %>
          <div class="flex items-start gap-4 lg:gap-5">
            <span class="<%= icon_wrap %>">ü§ù</span>
            <div class="min-w-0">
              <p class="<%= title_txt %>">Je veux rencontrer</p>
              <p class="<%= desc_txt %>">Des communaut√©s pr√®s de chez toi</p>
            </div>
          </div>
        <% end %>

        <%= link_to stories_path, class: btn_base, style: "background:linear-gradient(135deg,#6d28d9 0%,#a855f7 50%,#d946ef 100%);" do %>
          <div class="flex items-start gap-4 lg:gap-5">
            <span class="<%= icon_wrap %>">üìñ</span>
            <div class="min-w-0">
              <p class="<%= title_txt %>">"Belles histoires !"</p>
              <p class="<%= desc_txt %>">D√©clics, reconversions, prises de risque</p>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </section>

  <%# ============================== CARTE ================================ %>
  <section id="explorer" class="mt-12">
    <div class="mx-auto max-w-[90rem] px-5 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2 class="text-2xl sm:text-3xl font-bold text-slate-900">Explorez les opportunit√©s</h2>
        <p class="mt-2 text-[17px] sm:text-lg text-slate-600">
          D√©couvrez sur la carte toutes les possibilit√©s d‚Äôengagement pr√®s de chez vous.
        </p>
      </div>

      <div class="mt-6 grid grid-cols-12 gap-6">
        <div class="hidden xl:block xl:col-span-1"></div>

        <div class="col-span-12 xl:col-span-10">
          <div class="mb-3 flex flex-wrap gap-2 justify-center">
            <button class="chip is-active" data-cat="toutes">üåç Toutes</button>
            <button class="chip" data-cat="benevolat">‚ù§Ô∏è B√©n√©volat</button>
            <button class="chip" data-cat="formation">üìò Formation</button>
            <button class="chip" data-cat="rencontres">üë• Rencontres</button>
            <button class="chip" data-cat="entreprendre">üíº Entreprendre</button>
            <button class="chip" data-cat="histoires">üìñ Belles histoires</button>
          </div>

          <div class="relative">
            <div id="map" class="h-[480px] lg:h-[520px] w-full rounded-2xl overflow-hidden border border-gray-200 shadow"></div>

            <!-- Bouton flottant : me localiser / recoller -->
            <button id="btn-locate"
              class="absolute right-3 top-3 z-20 inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-white/95 ring-1 ring-gray-200 shadow hover:bg-white">
              <span>üìç</span><span class="text-sm font-medium">Me localiser</span>
            </button>
          </div>
        </div>

        <div class="hidden xl:block xl:col-span-1"></div>
      </div>
    </div>
  </section>

  <%# ========================== QUELQUES OPPS =========================== %>
  <section class="mt-10">
    <div class="mx-auto max-w-[90rem] px-5 sm:px-6 lg:px-8">
      <h3 class="text-xl font-semibold text-slate-900">Quelques opportunit√©s</h3>
      <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <% (@opportunities || []).first(6).each do |o| %>
          <%= link_to opportunity_path(o), class: "block rounded-xl bg-white p-4 ring-1 ring-gray-200 hover:shadow" do %>
            <p class="text-xs text-gray-500 mb-1"><%= o.category.to_s.capitalize %></p>
            <p class="font-semibold"><%= o.title %></p>
            <p class="text-sm text-gray-600 line-clamp-2 mt-1"><%= o.description %></p>
            <p class="text-sm text-gray-700 mt-2">üìç <%= o.location %></p>
          <% end %>
        <% end %>
      </div>
    </div>
  </section>

  <%# ============================ T√âMOIGNAGES =========================== %>
  <section id="temoignages" class="mt-14">
    <div class="mx-auto max-w-[90rem] px-5 sm:px-6 lg:px-8">
      <h3 class="text-xl font-semibold text-slate-900">Ils/elles ont trouv√© leur d√©clic</h3>
      <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <% (@testimonials || []).each do |t| %>
          <div class="rounded-xl bg-white p-5 ring-1 ring-gray-200">
            <div class="flex items-center gap-3">
              <img src="<%= t.image_url %>" class="w-12 h-12 rounded-full object-cover" alt="">
              <div>
                <p class="font-semibold"><%= t.name %></p>
                <p class="text-xs text-gray-500"><%= t.role %></p>
              </div>
            </div>
            <p class="text-[15px] text-gray-700 mt-3"><%= t.story %></p>
          </div>
        <% end %>
      </div>
    </div>
  </section>

  <%# ============================== √Ä PROPOS ============================ %>
  <section class="mt-14">
    <div class="mx-auto max-w-[90rem] px-5 sm:px-6 lg:px-8">
      <div class="rounded-2xl bg-slate-900 text-slate-100 p-6 ring-1 ring-black/10">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <h3 class="text-lg font-semibold">√Ä propos de D√©clic</h3>
            <p class="mt-2 text-slate-300">
              Un projet citoyen pour connecter les personnes √† des actions concr√®tes, des formations, des communaut√©s locales
              et des histoires inspirantes. Les donn√©es proviennent d‚Äôacteurs de terrain et de sources publiques.
            </p>
          </div>
          <div>
            <h4 class="text-sm font-semibold text-slate-200">Contact</h4>
            <ul class="mt-2 space-y-1 text-slate-300 text-sm">
              <li>üìû +33&nbsp;6&nbsp;67&nbsp;06&nbsp;31&nbsp;79</li>
              <li>‚úâÔ∏è <a href="mailto:nicolas.goarant@hotmail.fr" class="underline">nicolas.goarant@hotmail.fr</a></li>
            </ul>
          </div>
          <div>
            <h4 class="text-sm font-semibold text-slate-200">Ressources</h4>
            <ul class="mt-2 space-y-1 text-slate-300 text-sm">
              <li><a class="underline" href="/mentions-legales">Mentions l√©gales</a></li>
              <li><a class="underline" href="/confidentialite">Politique de confidentialit√©</a></li>
              <li><a class="underline" href="/presse">Presse & m√©dia</a></li>
              <li><a class="underline" href="/faq">FAQ</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<style>
  .chip{ @apply inline-flex items-center rounded-full px-3 py-1.5 text-sm bg-white ring-1 ring-gray-200 hover:bg-gray-50; }
  .chip.is-active{ @apply bg-indigo-600 text-white ring-0; }
  .picon{
    width:26px;height:26px;border-radius:9999px;border:2px solid #fff;display:grid;place-items:center;
    color:#fff;font-size:14px;box-shadow:0 1px 4px rgba(0,0,0,.25);position:relative;background:var(--c,#6366f1);
  }
  .picon::after{ content:"";position:absolute;left:50%;bottom:-6px;transform:translateX(-50%);
    border:6px solid transparent;border-top-color:var(--c,#6366f1); }
  .leaflet-container{ font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"; }
</style>

<!-- Modal consentement g√©oloc (n‚Äôappara√Æt qu‚Äôune fois si l‚Äô√©tat est ‚Äúprompt‚Äù) -->
<div id="geo-consent" class="fixed inset-0 z-[500] hidden">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="absolute inset-0 grid place-items-center p-4">
    <div class="w-full max-w-md rounded-2xl bg-white shadow-xl ring-1 ring-black/10 p-6">
      <h3 class="text-lg font-semibold">Activer la g√©olocalisation&nbsp;?</h3>
      <p class="mt-1 text-sm text-gray-600">On s‚Äôen sert uniquement pour te centrer sur la carte. Rien n‚Äôest stock√© c√¥t√© serveur.</p>
      <div class="mt-4 flex gap-3">
        <button id="geo-accept" class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Oui, me localiser</button>
        <button id="geo-decline" class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200">Plus tard</button>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<% content_for :scripts do %>
<script>
document.addEventListener('turbo:load', bootHome, { once:true });
document.addEventListener('DOMContentLoaded', bootHome, { once:true });

function bootHome(){
  const mapEl = document.getElementById('map');
  if(!mapEl || !window.L) return;

  // ==================== CARTE ====================
  const map = L.map('map',{ zoomControl:true, scrollWheelZoom:true }).setView([46.6, 2.2], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap' }).addTo(map);
  mapEl._leaflet_map = map;

  // ==================== COULEURS / ICONES ====================
  const colors={benevolat:'#ef4444',formation:'#3b82f6',rencontres:'#10b981',entreprendre:'#f59e0b',histoires:'#a855f7',default:'#6366f1'};
  const emojis={benevolat:'‚ù§Ô∏è',formation:'üìò',rencontres:'üë•',entreprendre:'üíº',histoires:'üìñ',default:'‚≠ê'};
  const iconFor = (cat)=> L.divIcon({
    className:'',
    html:`<div class="picon" style="--c:${colors[cat]||colors.default}"><span>${emojis[cat]||emojis.default}</span></div>`,
    iconSize:[26,32],iconAnchor:[13,28],popupAnchor:[0,-26]
  });

  const layer = L.layerGroup().addTo(map);
  const userLayer = L.layerGroup().addTo(map);
  const userDot = L.circleMarker([0,0],{ radius:7, weight:2, fillOpacity:.9, color:'#2563eb' }).addTo(userLayer);

  // ==================== POPUP RICHE ====================
  function thumbFor(o){
    if(o.image_url) return o.image_url;
    const cat=(o.category||'').toLowerCase();
    if(cat==='benevolat') return 'https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?q=80&w=300&auto=format&fit=crop';
    if(cat==='formation') return 'https://images.unsplash.com/photo-1555949963-ff9fe0c870eb?q=80&w=300&auto=format&fit=crop';
    if(cat==='rencontres') return 'https://images.unsplash.com/photo-1511632765486-a01980e01a18?q=80&w=300&auto=format&fit=crop';
    if(cat==='entreprendre') return 'https://images.unsplash.com/photo-1556157382-97eda2d62296?q=80&w=300&auto=format&fit=crop';
    if(cat==='histoires') return 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=300&auto=format&fit=crop';
    return 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=300&auto=format&fit=crop';
  }
  function esc(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function popupHtml(o){
    const cat=(o.category||'').toLowerCase();
    const isStory = cat==='histoires';
    const base = isStory ? '/stories' : '/opportunities';
    const url  = `${base}/${o.slug||o.id}`;
    const img  = thumbFor(o);
    const desc = (o.description||'').slice(0,160);
    const tags = o.tags ? `<div class="mt-1 text-[12px] text-gray-500">${esc(o.tags)}</div>` : '';
    return `
      <div style="display:grid;grid-template-columns:72px 1fr;gap:10px;min-width:260px;align-items:start">
        <img src="${img}" alt="" style="width:72px;height:72px;border-radius:10px;object-fit:cover;box-shadow:0 1px 4px rgba(0,0,0,.2)" />
        <div>
          <h4 style="margin:0;font-weight:700;font-size:14px;line-height:1.2">${esc(o.title||'')}</h4>
          ${o.organization?`<div class="text-[12px] text-gray-600">${esc(o.organization)}</div>`:''}
          ${o.location?`<div class="text-[12px] text-gray-600">üìç ${esc(o.location)}</div>`:''}
          ${desc?`<p class="mt-1 text-[12px] text-gray-700">${esc(desc)}${(o.description||'').length>160?'‚Ä¶':''}</p>`:''}
          ${tags}
          <div class="mt-2"><a href="${url}" class="text-indigo-600 underline text-sm">Voir la fiche</a></div>
        </div>
      </div>`;
  }

  // ==================== CHARGEMENT DONN√âES ====================
  let DATA = [];
  function plot(items){
    layer.clearLayers();
    const bounds=[];
    (items||[]).forEach(o=>{
      if(!Number.isFinite(o.latitude)||!Number.isFinite(o.longitude)) return;
      L.marker([o.latitude,o.longitude],{ icon:iconFor((o.category||'').toLowerCase()) })
        .addTo(layer)
        .bindPopup(popupHtml(o));
      bounds.push([o.latitude,o.longitude]);
    });
    if(bounds.length){
      // si pas encore centr√© sur l'utilisateur, on ajuste aux donn√©es
      const stored = getStoredPos();
      if(!stored) map.fitBounds(L.latLngBounds(bounds), { padding:[30,30] });
    }
  }

  Promise.all([
    fetch('/api/v1/opportunities').then(r=>r.ok?r.json():[]).catch(()=>[]),
    fetch('/api/v1/stories').then(r=>r.ok?r.json():[]).catch(()=>[])
  ]).then(([opps, stories])=>{
    (stories||[]).forEach(s=> s.category='histoires');
    DATA = ([]).concat(opps||[], stories||[]);
    window.__DATASET = DATA;
    plot(DATA);
  });

  // ==================== FILTRES (chips) ====================
  const chips=[...document.querySelectorAll('.chip')];
  chips.forEach(chip=>chip.addEventListener('click',()=>{
    chips.forEach(c=>c.classList.remove('is-active'));
    chip.classList.add('is-active');
    const cat=chip.dataset.cat;
    if(cat==='toutes'){ plot(DATA); return; }
    plot((DATA||[]).filter(o=> (o.category||'').toLowerCase()===cat));
  }));

  // ==================== G√âOLOC AVEC M√âMOIRE ====================
  let watchId = null;
  const PREF_KEY = 'declic_geo_pref';        // 'granted' | 'denied'
  const POS_KEY  = 'declic_user_pos';        // { lat, lng, t }
  const MODAL_ONCE = 'declic_geo_modal_shown';

  function getStoredPos(){
    try{ const p=JSON.parse(localStorage.getItem(POS_KEY)||'null');
         if(p && Number.isFinite(p.lat)&&Number.isFinite(p.lng)) return p; }catch{}
    return null;
  }
  function savePos(lat,lng,accuracy){
    if(accuracy && accuracy>8000) return; // on √©vite d‚Äôenregistrer un fix trop approximatif
    try{ localStorage.setItem(POS_KEY, JSON.stringify({ lat, lng, t: Date.now() })); }catch{}
  }
  function centerUser(lat,lng,accuracy){
    userDot.setLatLng([lat,lng]);
    const cur = map.getCenter();
    const dist = map.distance(cur, L.latLng(lat,lng));
    if(dist>200 || map.getZoom()<12) map.flyTo([lat,lng], Math.max(map.getZoom(), 13), { duration:.6 });
    savePos(lat,lng,accuracy);
  }
  function startWatch(){
    if(watchId!=null || !('geolocation' in navigator)) return;
    watchId = navigator.geolocation.watchPosition(
      p=>centerUser(p.coords.latitude,p.coords.longitude,p.coords.accuracy),
      _=>{}, { enableHighAccuracy:true, maximumAge:0, timeout:20000 }
    );
  }

  // ‚Äî au premier chargement : si on a d√©j√† un fix stock√©, on centre imm√©diatement
  const cached = getStoredPos();
  if(cached){ userDot.setLatLng([cached.lat,cached.lng]); map.setView([cached.lat,cached.lng], 13); }

  // ‚Äî strat√©gie de consentement : ne pas re-demander √† chaque retour
  (async function initGeo(){
    const pref = localStorage.getItem(PREF_KEY); // 'granted' | 'denied' | null
    if(pref==='granted'){ startWatch(); return; }
    if(pref==='denied'){ return; }

    try{
      if(navigator.permissions?.query){
        const st = await navigator.permissions.query({ name:'geolocation' });
        if(st.state==='granted'){ localStorage.setItem(PREF_KEY,'granted'); startWatch(); return; }
        if(st.state==='denied'){  localStorage.setItem(PREF_KEY,'denied');  return; }
        // state === 'prompt' -> on affiche la modale UNE SEULE FOIS par session
        if(!sessionStorage.getItem(MODAL_ONCE)){
          sessionStorage.setItem(MODAL_ONCE,'1'); openGeoModal();
        }
      } else {
        if(!sessionStorage.getItem(MODAL_ONCE)){
          sessionStorage.setItem(MODAL_ONCE,'1'); openGeoModal();
        }
      }
    }catch{
      if(!sessionStorage.getItem(MODAL_ONCE)){
        sessionStorage.setItem(MODAL_ONCE,'1'); openGeoModal();
      }
    }
  })();

  // ==================== MODALE GEO ====================
  const modal   = document.getElementById('geo-consent');
  const accept  = document.getElementById('geo-accept');
  const decline = document.getElementById('geo-decline');
  function openGeoModal(){ modal?.classList.remove('hidden'); }
  function closeGeoModal(){ modal?.classList.add('hidden'); }

  accept?.addEventListener('click', ()=>{
    closeGeoModal();
    if(!('geolocation' in navigator)) return;
    navigator.geolocation.getCurrentPosition(
      p=>{ localStorage.setItem(PREF_KEY,'granted'); centerUser(p.coords.latitude,p.coords.longitude,p.coords.accuracy); startWatch(); },
      _=>{ localStorage.setItem(PREF_KEY,'denied'); },
      { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
    );
  });
  decline?.addEventListener('click', ()=>{
    closeGeoModal(); localStorage.setItem(PREF_KEY,'denied');
  });
}
</script>
<% end %>











