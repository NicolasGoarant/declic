<%# app/views/pages/home.html.erb %>

<%
# Helper de nettoyage (Markdown -> Texte brut)
def strip_unsplash_md(txt)
  s = txt.to_s.dup
  s.gsub!(/###\s*√Ä quoi √ßa ressemble\s*\?/i, '')
  s.gsub!(/√Ä quoi √ßa ressemble\s*\?/i, '')
  s.gsub!(/üí°|üóìÔ∏è|üëâ|üîó/, '')
  s.gsub!(/!\[[^\]]*\]\([^)]+\)/, " ")
  s.gsub!(/\[([^\]]+)\]\([^\)]+\)/, '\1')
  s.gsub!(%r{https?://\S+}, ' ')
  s.gsub!(/^\#{1,6}\s+/, '')
  s.gsub!(/\s\#{1,6}\s+/, ' ')
  s.gsub!(/\*\*([^\*]+)\*\*/, '\1') # Enl√®ve le gras **
  s.gsub!(/\*([^\*]+)\*/, '\1')    # Enl√®ve l'italique *
  s.gsub!(/__([^_]+)__/, '\1')
  s.gsub!(/_([^_]+)_/, '\1')
  s.gsub!(/`([^`]+)`/, '\1')
  s.gsub!(/[>\-\+]{1,}\s*/, '')
  s.gsub!(/\s+/, ' ')
  s.strip
end

def thumb_for(o)
  return o.image_url if o.respond_to?(:image_url) && o.image_url.present?
  cat = (o.respond_to?(:category) ? o.category : '').to_s.downcase
  case cat
  when 'benevolat'
    'https://images.unsplash.com/photo-1559027615-cd4628902d4a?w=400&q=80&auto=format&fit=crop'
  when 'formation'
    'https://images.unsplash.com/photo-1524178232363-1fb2b075b655?w=400&q=80&auto=format&fit=crop'
  when 'rencontres'
    'https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=400&q=80&auto=format&fit=crop'
  when 'entreprendre'
    'https://images.unsplash.com/photo-1552664730-d307ca884978?w=400&q=80&auto=format&fit=crop'
  when 'histoires'
    'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&q=80&auto=format&fit=crop'
  when 'ecologiser'
    'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=400&q=80&auto=format&fit=crop'
  else
    'https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?w=400&q=80&auto=format&fit=crop'
  end
end

def hero_fallback(obj)
  return obj.image_url if obj.respond_to?(:image_url) && obj.image_url.present?
  thumb_for(obj)
end
%>

<div class="home-ms">
  <header class="hm-hero" role="banner">
    <%= link_to "‚ö°Ô∏è Pourquoi D√©clic ?", philosophie_path, class: "hm-badge", aria: { label: "Pourquoi D√©clic ?" } %>

    <div class="hm-hero-inner">
      <div class="container">
        <h1 class="hm-title">
          Change ta vie, <span class="grad">en quelques clics</span>
        </h1>
        <p class="hm-chapo">
          D√©clic agr√®ge les mille et une opportunit√©s locales pour entreprendre, se former, rencontrer,
          aider ‚Äî et pour d√©couvrir des <strong>‚Äúbelles histoires‚Äù</strong> qui inspirent.
        </p>

        <dl class="hm-stats">
          <div><dt>Opportunit√©s</dt><dd>15&nbsp;000+</dd></div>
          <div><dt>Villes</dt><dd>300+</dd></div>
          <div><dt>Communaut√©</dt><dd>10k</dd></div>
        </dl>
      </div>
    </div>

    <% hero_src = (asset_path('hero_home.jpg') rescue nil)
       hero_src ||= "https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?q=80&w=2400&auto=format&fit=crop" %>
    <div class="hm-hero-img" style="--hero:url('<%= hero_src %>')"></div>
  </header>

  <section id="parcours" class="hm-slice alt">
    <div class="container">
      <h2 class="hm-h2">Choisis ton D√©clic</h2>

      <div class="hm-grid-cards">
        <% btn_base = "hm-card" %>

        <%= link_to opportunities_path(category: "entreprendre"),
                    class: "#{btn_base} -entreprendre" do %>
          <span class="hm-emoji">üöÄ</span>
          <div class="hm-card-txt">
            <p class="t1">Je veux entreprendre</p>
            <p class="t2">Lance ton projet avec des mentors</p>
          </div>
        <% end %>

        <%= link_to opportunities_path(category: "ecologiser"),
                    class: "#{btn_base} -ecologiser" do %>
          <span class="hm-emoji">üå±</span>
          <div class="hm-card-txt">
            <p class="t1">Je veux √©cologiser</p>
            <p class="t2">Des actions pour la plan√®te</p>
          </div>
        <% end %>

        <%= link_to opportunities_path(category: "formation"),
                    class: "#{btn_base} -formation" do %>
          <span class="hm-emoji">üìò</span>
          <div class="hm-card-txt">
            <p class="t1">Je veux me former</p>
            <p class="t2">Des formations pour progresser</p>
          </div>
        <% end %>

        <%= link_to opportunities_path(category: "benevolat"),
                    class: "#{btn_base} -benevolat" do %>
          <span class="hm-emoji">‚ù§Ô∏è</span>
          <div class="hm-card-txt">
            <p class="t1">Je veux aider</p>
            <p class="t2">Des missions utiles et humaines</p>
          </div>
        <% end %>

        <%= link_to opportunities_path(category: "rencontres"),
                    class: "#{btn_base} -rencontres" do %>
          <span class="hm-emoji">ü§ù</span>
          <div class="hm-card-txt">
            <p class="t1">Je veux rencontrer</p>
            <p class="t2">Des communaut√©s pr√®s de chez toi</p>
          </div>
        <% end %>

        <%= link_to stories_path, class: "#{btn_base} -histoires" do %>
          <span class="hm-emoji">üìñ</span>
          <div class="hm-card-txt">
            <p class="t1">‚ÄúBelles histoires !‚Äù</p>
            <p class="t2">D√©clics, reconversions, prises de risque</p>
          </div>
        <% end %>
      </div>
    </div>
  </section>

  <section id="explorer" class="hm-slice bg-muted grad-behind-map">
    <div class="container">
      <h2 class="hm-h2">Explorez les opportunit√©s</h2>
      <p class="hm-sub">D√©couvre sur la carte toutes les possibilit√©s d‚Äôengagement pr√®s de chez toi.</p>

      <div class="hm-filterbar">
        <button class="chip is-active" data-cat="toutes">üåç Toutes</button>
        <button class="chip" data-cat="benevolat">‚ù§Ô∏è B√©n√©volat</button>
        <button class="chip" data-cat="ecologiser">üå± √âcologiser</button>
        <button class="chip" data-cat="formation">üìò Formation</button>
        <button class="chip" data-cat="rencontres">üë• Rencontres</button>
        <button class="chip" data-cat="entreprendre">üíº Entreprendre</button>
        <button class="chip" data-cat="histoires">üìñ Belles histoires</button>
      </div>

      <div class="hm-explore-grid">
        <div class="hm-explore-left">
          <div class="hm-map-sticky">
            <div class="hm-mapwrap">
              <div id="map" class="hm-map"></div>
              <button id="btn-locate" class="hm-locate">
                <span>üìç</span><span>Me localiser</span>
              </button>
            </div>
          </div>
        </div>

        <div class="hm-explore-right">
          <div class="hm-explore-header">
            <h3 class="hm-h3">Derni√®res p√©pites</h3>
            <%= link_to opportunities_path, class: "hm-explore-more" do %>
              Voir tout ‚Üí
            <% end %>
          </div>

          <div class="hm-cards">
            <% (@opportunities || []).first(6).each do |o| %>
              <%= link_to opportunity_path(o), class: "hm-card-op" do %>
                <div class="op-img" style="background-image:url('<%= thumb_for(o) %>')"></div>
                <div class="op-content">
                  <p class="k"><%= o.category.to_s.capitalize %></p>
                  <p class="t"><%= strip_unsplash_md(o.title) %></p>
                  <p class="d"><%= strip_unsplash_md(o.description) %></p>
                  <p class="l">üìç <%= o.location %></p>
                </div>
              <% end %>
            <% end %>

            <% if (@opportunities || []).empty? %>
              <div class="hm-empty">
                Aucune opportunit√© pour le moment‚Ä¶ Revenez vite !
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="stories" class="hm-slice hm-stories">
    <div class="container">
      <div class="hm-stories-head">
        <span class="hm-tag">Inspiration</span>
        <h2 class="hm-h2">Les Belles Histoires</h2>
        <p class="hm-sub">
          Ils ont os√© franchir le pas.
          D√©couvre les parcours de celles et ceux qui font bouger les lignes pr√®s de chez toi.
        </p>
      </div>

      <div class="hm-stories-grid">
        <% stories_collection = (@latest_stories || Story.order(happened_on: :desc).limit(6)) %>
        <% stories_collection.each do |story| %>
          <%= link_to story_path(story), class: "hm-story-card" do %>
            <div class="hm-story-img" style="background-image:url('<%= hero_fallback(story) %>')"></div>
            <div class="hm-story-overlay">
              <span class="hm-story-pill">T√©moignage</span>
              <h3 class="hm-story-title"><%= strip_unsplash_md(story.title) %></h3>
              <% if story.chapo.present? %>
                <p class="hm-story-chapo"><%= story.chapo %></p>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>

      <div class="hm-stories-footer">
        <%= link_to "Lire toutes les histoires", stories_path, class: "hm-story-more" %>
      </div>
    </div>
  </section>


  <section id="temoignages" class="hm-slice bg-muted grad-behind-testis">
    <div class="container">
      <h2 class="hm-h2">Ils/elles ont trouv√© leur d√©clic</h2>

      <% testimonials = [
        {
          name: "Nathalie",
          role: "Charg√©e de communication ‚Äî Nancy",
          avatar: "avatars/nathalie.jpeg",
          story: "Je cherchais un engagement local sans trop savoir par o√π commencer. Gr√¢ce √† D√©clic, j‚Äôai trouv√© une mission de b√©n√©volat dans une √©picerie solidaire √† 10 minutes de chez moi. √áa m‚Äôa donn√© l‚Äô√©lan dont j‚Äôavais besoin."
        },
        {
          name: "Matthieu",
          role: "En reconversion ‚Äî Saint-Max",
          avatar: "avatars/matthieu.jpeg",
          story: "Je regardais les offres d‚Äôemploi sans trop savoir ce qui me correspondait. Avec D√©clic, j‚Äôai trouv√© un atelier de bilan de comp√©tences anim√© localement. √áa a totalement r√©orient√© ma trajectoire."
        },
        {
          name: "Karim",
          role: "D√©veloppeur junior ‚Äî Laxou",
          avatar: "avatars/karim.jpeg",
          story: "Je voulais entreprendre mais je ne savais pas par o√π commencer. Sur D√©clic, j‚Äôai particip√© √† un afterwork d‚Äôentrepreneurs. J‚Äôy ai pitch√© mon projet pour la premi√®re fois et d√©croch√© un vrai coup de pouce."
        },
        {
          name: "Emma",
          role: "Jeune dipl√¥m√©e ‚Äî Vand≈ìuvre",
          avatar: "avatars/emma.jpeg",
          story: "Apr√®s mes √©tudes, je me sentais un peu perdue. En explorant D√©clic, j‚Äôai d√©couvert un atelier d‚Äôaccompagnement pour jeunes actifs. J‚Äôy ai rencontr√© d‚Äôautres personnes motiv√©es et retrouv√© de la confiance."
        }
      ] %>

      <div class="hm-testis">
        <% testimonials.each do |t| %>
          <article class="hm-testi">
            <div class="who">
              <img src="<%= image_path(t[:avatar]) %>" alt="" class="hm-avatar">
              <div>
                <p class="name"><%= t[:name] %></p>
                <p class="role"><%= t[:role] %></p>
              </div>
            </div>
            <p class="story"><%= t[:story] %></p>
          </article>
        <% end %>
      </div>
    </div>
  </section>

  <section class="hm-cta">
    <div class="container">
      <h2>Envie d‚Äôagir √† ton tour ?</h2>
      <p>D√©couvre des opportunit√©s pr√®s de chez toi ou partage ta propre histoire pour inspirer d‚Äôautres personnes.</p>
      <div class="buttons">
        <%= link_to "Voir les actions locales",
                    (url_for(controller: :opportunities, action: :index, category: 'toutes') rescue root_path(anchor: "explorer")),
                    class: "btn primary" %>
        <%= link_to "Partager mon histoire",
                    (respond_to?(:new_story_path) ? new_story_path : stories_path),
                    class: "btn secondary" %>
      </div>
    </div>
  </section>
</div>

<style>
/* ====== Th√®me global ====== */
.home-ms{
  --a1:#7e5bef;
  --a2:#3b82f6; --muted:#f4f2fb;
  color:#0f172a; font-family:"Inter",system-ui,sans-serif;
  background:
    radial-gradient(1400px 800px at 10% -10%, #efe8ff 0%, transparent 60%) no-repeat,
    linear-gradient(180deg, #fbfaff 0%, #f6f3ff 60%, #f3f1ff 100%);
}
.home-ms .container{ max-width:1280px; margin:0 auto; padding:0 24px; }
[id]{ scroll-margin-top:96px; }

/* ====== HERO ====== */
.hm-hero{ position:relative; color:#fff; overflow:hidden; background:linear-gradient(160deg,var(--a1),var(--a2)); }
.hm-hero-inner{ position:relative;
  padding-top:clamp(72px,8vw,120px); padding-bottom:clamp(44px,6.5vw,84px); z-index:10; }
.hm-hero::after{ content:""; position:absolute; inset:0; background:linear-gradient(180deg,rgba(7,9,22,.62),rgba(7,9,22,.62)); mix-blend:multiply; z-index:2; }
.hm-hero-img{ position:absolute; inset:0; background:var(--hero,none) center/cover no-repeat; filter:blur(2px) saturate(1.05) brightness(0.9); opacity:.85; z-index:1; }

/* Badge */
.hm-badge{
  position:absolute; top:14px; right:calc(18px + env(safe-area-inset-right)); z-index:30;
  display:inline-flex; align-items:center; gap:.55rem; padding:.55rem .9rem; border-radius:999px;
  font:900 .95rem/1 "Epilogue";
  color:#1e1b4b;
  background:linear-gradient(135deg,#fef3c7,#fde68a,#fcd34d);
  box-shadow:0 8px 20px rgba(0,0,0,.12); border:1px solid rgba(17,24,39,.06); text-decoration:none;
}
@media (min-width:1024px){
  .hm-badge{ padding:.7rem 1.1rem; font-size:1.05rem; }
  .hm-badge:hover{ transform:translateY(-1px); transition:transform .12s ease; }
}
@media (max-width:480px){
  .hm-badge{ top:10px; right:10px; font-size:.88rem; padding:.45rem .7rem; }
}

.hm-title{
  font-family:"Epilogue",Inter; font-weight:900;
  letter-spacing:-.02em; line-height:1.03;
  font-size:clamp(2.8rem,5vw,4.6rem);
  margin:.2rem 0 .5rem; text-shadow:0 2px 16px rgba(0,0,0,.25);
}
.hm-title .grad{
  background:linear-gradient(90deg,#f472b6,#a855f7,#6366f1);
  -webkit-background-clip:text; background-clip:text; color:transparent;
}
.hm-chapo{
  max-width:980px;
  font:600 clamp(1.12rem,1.05vw + .9rem,1.5rem)/1.65 "Inter";
  text-shadow:0 1px 8px rgba(0,0,0,.18);
}

.hm-stats{
  display:grid; grid-template-columns:repeat(3,minmax(0,1fr));
  gap:16px; margin-top:18px;
}
.hm-stats>div{
  background:rgba(255,255,255,.92); backdrop-filter: blur(6px);
  border:1px solid #e6e8ee; border-radius:18px;
  padding:16px 18px;
  box-shadow:0 12px 34px rgba(15,23,42,.18);
  color:#0f172a; text-align:center;
}
.hm-stats dt{
  font:700 .82rem/1 "Inter"; color:#6b7280;
  text-transform:uppercase;
  letter-spacing:.04em;
}
.hm-stats dd{ margin:.25rem 0 0; font:900 1.8rem/1 "Epilogue"; }
@media (max-width:640px){
  .hm-stats{ grid-template-columns:1fr; gap:10px; }
  .hm-stats>div{ padding:12px 14px; }
  .hm-stats dd{ font-size:1.4rem; }
}

/* ====== Slices ====== */
.hm-slice{ padding:clamp(2rem,4.8vw,4rem) 0; }
.hm-slice.alt{
  background:
    radial-gradient(920px 440px at 8% -12%, #efe8ff 0%, transparent 60%) no-repeat,
    linear-gradient(180deg,#f6f2ff 0%, #ede9fe 100%);
}
.bg-muted{ background:var(--muted); }
.grad-soft{
  background:
    radial-gradient(900px 420px at 85% -10%, #eee7ff 0%, transparent 66%),
    linear-gradient(180deg,#f9f7ff 0%, #f3f1ff 100%);
}
.grad-behind-map{
  background:
    radial-gradient(980px 460px at 50% -14%, #e9e2ff 0%, transparent 70%),
    var(--muted);
}
.grad-behind-testis{
  background:
    radial-gradient(820px 380px at 12% 118%, #ece6ff 0%, transparent 66%),
    var(--muted);
}

.hm-h2{
  font-family:"Epilogue"; font-weight:900;
  font-size:clamp(2.1rem,3.2vw,2.7rem);
  color:#0f172a; margin:0 0 1rem;
}
.hm-h2::after{
  content:""; display:block; width:100px; height:6px;
  border-radius:999px; background:var(--a1);
  margin:.55rem 0 .1rem;
}
.hm-sub{ margin:.2rem 0 1rem; color:#475569; font-size:1.05rem; }

/* ====== h3 utilis√© pour "Derni√®res p√©pites" ====== */
.hm-h3{
  font-family:"Epilogue"; font-weight:800;
  font-size:1.4rem;
  color:#0f172a;
  margin:0;
}

/* ====== GROS BOUTONS (Am√©lior√©s) ====== */
.hm-grid-cards{
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr));
  gap:28px;
  max-width:1220px;
  margin-inline:auto;
}
.hm-card{
  display:grid;
  grid-template-columns:110px 1fr;
  gap:22px;
  align-items:center;
  padding:36px 30px;
  border-radius:30px;
  color:#fff;
  text-decoration:none;
  box-shadow:0 18px 44px rgba(0,0,0,.16);
  min-height:240px;
  width:100%;
  max-width:400px;
  transition:transform .15s ease, box-shadow .15s ease;
  justify-self:center;
  /* Nouveau : pour l'effet shine */
  position: relative;
  overflow: hidden;
  z-index: 1;
}
.hm-card:hover{ transform:translateY(-6px); box-shadow:0 22px 62px rgba(0,0,0,.20); }

/* Interaction Emoji au survol */
.hm-card:hover .hm-emoji {
  transform: scale(1.1) rotate(6deg);
  background: rgba(255,255,255,0.4);
}

.hm-emoji{
  width:100px; height:100px;
  border-radius:24px;
  background:rgba(255,255,255,.22);
  font-size:50px; display:grid; place-items:center;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.hm-card-txt .t1{
  font:900 clamp(1.2rem,1vw + 1rem,1.6rem)/1.15 "Epilogue"; margin:0;
}
.hm-card-txt .t2{
  margin-top:.45rem;
  font:700 clamp(1rem,.7vw + .7rem,1.22rem)/1.45 "Inter";
  opacity:.98;
}
.hm-card.-entreprendre{ background:linear-gradient(135deg,#f59e0b,#ef4444,#fb7185); }
.hm-card.-ecologiser{  background:linear-gradient(135deg,#16a34a,#22c55e,#4ade80); }
.hm-card.-formation{   background:linear-gradient(135deg,#6366f1,#38bdf8); }
.hm-card.-benevolat{   background:linear-gradient(135deg,#f43f5e,#ec4899); }
.hm-card.-rencontres{  background:linear-gradient(135deg,#facc15,#f97316,#fb923c); }

/* Nouveau style "Histoires" avec effet Shimmer */
.hm-card.-histoires{
  background:linear-gradient(135deg, #f59e0b, #ec4899, #7e5bef);
}
.hm-card.-histoires::after {
  content: "";
  position: absolute;
  top: 0; left: -150%;
  width: 100%; height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.4),
    transparent
  );
  transform: skewX(-20deg);
  animation: shine 6s infinite;
  pointer-events: none;
}
@keyframes shine {
  0% { left: -150%; }
  10% { left: 150%; }
  100% { left: 150%; }
}

@media (max-width:900px){
  .hm-grid-cards{ grid-template-columns:repeat(2,minmax(0,1fr)); }
}
@media (max-width:560px){
  .hm-grid-cards{ grid-template-columns:1fr; }
  .hm-card{
    grid-template-columns:80px 1fr;
    padding:22px 18px;
    min-height:192px;
    border-radius:22px;
  }
  .hm-emoji{
    width:72px; height:72px;
    border-radius:18px;
    font-size:36px;
  }
}

/* ====== Carte & filtres ====== */
.hm-filterbar{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:12px;
}
.chip{
  --chip-bg-soft:#ffffff;
  --chip-border:#e6e8ee;
  --chip-text:#111827;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:.6rem 1rem;
  border-radius:999px;
  background:var(--chip-bg-soft);
  border:1px solid var(--chip-border);
  font:800 .95rem/1.1 "Inter";
  color:var(--chip-text);
  cursor:pointer;
}
.chip[data-cat="benevolat"]{--chip-bg-soft:#fff1f2;--chip-border:#fecdd3;--chip-text:#be123c;}
.chip[data-cat="ecologiser"]{--chip-bg-soft:#ecfdf3;--chip-border:#bbf7d0;--chip-text:#166534;}
.chip[data-cat="formation"]{--chip-bg-soft:#eff6ff;--chip-border:#bfdbfe;--chip-text:#1d4ed8;}
.chip[data-cat="rencontres"]{--chip-bg-soft:#fefce8;--chip-border:#fef3c7;--chip-text:#92400e;}
.chip[data-cat="entreprendre"]{--chip-bg-soft:#fff7ed;--chip-border:#fed7aa;--chip-text:#c2410c;}
.chip[data-cat="histoires"]{--chip-bg-soft:#f5f3ff;--chip-border:#ddd6fe;--chip-text:#5b21b6;}
.chip.is-active{
  background:var(--chip-text);
  color:#fff;
  border-color:transparent;
}
.chip[data-cat="histoires"].is-active{
  background:linear-gradient(135deg,#ef4444,#3b82f6,#f59e0b,#10b981,#fb7185,#22c55e);
  background-size:350% 350%;
  animation:gradientShift 12s ease infinite;
  color:#fff;border-color:transparent;
}

/* layout carte + cards */

.hm-explore-grid{
  display:grid;
  grid-template-columns:minmax(0,1.3fr) minmax(0,1fr);
  gap:22px;
  /* Correction Sticky : pas de align-items flex-start ici */
  margin-top:18px;
}

.hm-explore-left{ min-width:0; }
.hm-explore-right{ min-width:0; }
.hm-explore-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}
.hm-explore-more{
  font:700 .95rem/1 "Inter";
  color:#4f46e5;
  text-decoration:none;
}
.hm-explore-more:hover{ text-decoration:underline; }

@media (max-width:960px){
  .hm-explore-grid{
    grid-template-columns:1fr;
  }
}

/* Carte */
.hm-mapwrap{ position:relative; }
.hm-map{
  height:560px;
  width:100%;
  border-radius:20px;
  border:1px solid #e6e8ee;
  overflow:hidden;
  box-shadow:0 10px 30px rgba(15,23,42,.10);
}

.hm-map-sticky {
  position: sticky;
  top: 110px; /* Un peu d'air sous le header */
  z-index: 10;
}
@media (max-width:960px){
  .hm-map-sticky {
    position: static;
    top: auto;
  }
}

@media (max-width:768px){
  .hm-map{ overflow:visible; }
}

/* ====== POPUP CARTE MODERNE ====== */
/* Styles pour remplacer le popup par d√©faut blanc */

.leaflet-popup-content-wrapper {
  padding: 0;
  overflow: hidden;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}
.leaflet-popup-content {
  margin: 0 !important;
  width: 280px !important;
}
.leaflet-popup-tip {
  background: white;
}
.leaflet-container a.leaflet-popup-close-button {
  top: 8px; right: 8px;
  color: white;
  background: rgba(0,0,0,0.3);
  border-radius: 50%;
  width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
  font: 16px/14px Tahoma, Verdana, sans-serif;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  border: none;
}
.leaflet-container a.leaflet-popup-close-button:hover {
  background: rgba(0,0,0,0.6);
  color: white;
}

/* Contenu de la carte popup */
.dc-pop-card {
  font-family: "Inter", sans-serif;
  color: #0f172a;
}
.dc-pop-hero {
  height: 140px;
  background-size: cover;
  background-position: center;
  position: relative;
}
.dc-pop-badge {
  position: absolute;
  top: 12px; left: 12px;
  background: var(--cat-color, #7e5bef);
  color: white;
  font-size: 0.65rem;
  font-weight: 800;
  text-transform: uppercase;
  padding: 4px 8px;
  border-radius: 99px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  letter-spacing: 0.05em;
}
.dc-pop-body {
  padding: 16px;
}
.dc-pop-title {
  margin: 0 0 6px 0;
  font-family: "Epilogue", sans-serif;
  font-weight: 800;
  font-size: 1rem;
  line-height: 1.3;
  color: #0f172a;
}
.dc-pop-meta {
  display: flex;
  flex-direction: column;
  gap: 4px;
  margin-bottom: 12px;
  font-size: 0.8rem;
  color: #64748b;
  font-weight: 500;
}
.dc-pop-meta span {
  display: flex; align-items: center; gap: 6px;
}
.dc-pop-btn {
  display: block; width: 100%;
  text-align: center;
  background: #0f172a;
  color: white !important;
  text-decoration: none !important;
  padding: 10px 0;
  border-radius: 8px;
  font-weight: 700;
  font-size: 0.85rem;
  transition: transform 0.1s, background 0.2s;
}
.dc-pop-btn:hover {
  background: #7e5bef;
  transform: translateY(-1px);
}

/* ====== Cards opportunit√©s ====== */
.hm-cards{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:18px;
}
@media (max-width:980px){
  .hm-cards{ grid-template-columns:1fr; }
}
.hm-card-op{
  display:block;
  border-radius:20px;
  background:#fff;
  border:1px solid #e6e8ee;
  box-shadow:0 10px 26px rgba(15,23,42,.08);
  text-decoration:none;
  color:#0f172a;
  overflow:hidden;
  transition:transform .15s ease, box-shadow .15s ease;
}
.hm-card-op:hover{
  transform:translateY(-4px);
  box-shadow:0 16px 38px rgba(15,23,42,.14);
}
.hm-card-op .op-img{
  width:100%;
  height:180px;
  background:#f1f5f9 center/cover no-repeat;
  border-bottom:1px solid #e6e8ee;
}
.hm-card-op .op-content{ padding:16px 18px; }
.hm-card-op .k{
  color:#64748b; font-size:.82rem;
  margin:0 0 .4rem;
  font-weight:700; text-transform:uppercase;
  letter-spacing:.04em;
}
.hm-card-op .t{
  font:900 1.16rem/1.2 "Epilogue"; margin:0 0 .3rem;
}
.hm-card-op .d{
  font:1rem/1.55 "Inter"; color:#475569;
  margin:.3rem 0 .5rem;
  display:-webkit-box;
  -webkit-line-clamp:2; -webkit-box-orient:vertical;
  overflow:hidden;
}
.hm-card-op .l{
  font:1rem/1.4 "Inter"; color:#1f2937; margin:0;
}
.hm-empty{
  grid-column:1 / -1;
  padding:18px;
  border-radius:14px;
  border:1px dashed #e5e7eb;
  background:#f9fafb;
  text-align:center;
  color:#6b7280;
}

/* ====== T√âMOIGNAGES ====== */
.hm-testis{
  display:grid;
  grid-template-columns:repeat(4, minmax(0,1fr));
  gap:18px;
}
@media (max-width:1100px){
  .hm-testis{ grid-template-columns:repeat(3, minmax(0,1fr)); }
}
@media (max-width:820px){
  .hm-testis{ grid-template-columns:repeat(2, minmax(0,1fr)); }
}
@media (max-width:520px){
  .hm-testis{ grid-template-columns:1fr; }
}
.hm-testi{
  background:#fff;
  border:1px solid #e6e8ee;
  border-radius:18px;
  padding:16px;
  box-shadow:0 10px 26px rgba(15,23,42,.08);
}
.hm-testi .who{
  display:flex; align-items:center; gap:12px; margin-bottom:8px;
}
.hm-avatar{
  width:64px;
  height:64px;
  border-radius:50%;
  object-fit:cover;
  object-position:50% 8%;
  background:#fff;
  flex:0 0 64px;
  border:2px solid #fff;
  box-shadow:0 2px 10px rgba(15,23,42,.12);
}
.hm-avatar[src*="nathalie"]{
  object-position:50% 18%;
}
.hm-testi .name{
  margin:0;
  font:900 1.05rem/1.1 "Epilogue"; color:#0f172a;
}
.hm-testi .role{
  margin:.15rem 0 0; font:700 .9rem/1.2 "Inter"; color:#64748b;
}
.hm-testi .story{
  margin:.4rem 0 0;
  color:#334155;
  font:500 .95rem/1.45 "Inter";
}

/* ====== Belles histoires ====== */
.hm-stories{
  background:#eef2ff;
}
.hm-stories-head{
  text-align:center;
  max-width:720px;
  margin:0 auto 24px;
}
.hm-tag{
  display:inline-block;
  padding:.3rem .8rem;
  border-radius:999px;
  font:700 .75rem/1 "Inter";
  letter-spacing:.14em;
  text-transform:uppercase;
  color:#4f46e5;
  background:#e0e7ff;
  margin-bottom:.4rem;
}
.hm-stories-grid{
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr));
  gap:20px;
}
@media (max-width:960px){
  .hm-stories-grid{ grid-template-columns:repeat(2,minmax(0,1fr)); }
}
@media (max-width:640px){
  .hm-stories-grid{ grid-template-columns:1fr; }
}

.hm-story-card{
  position:relative;
  display:block;
  border-radius:24px;
  overflow:hidden;
  text-decoration:none;
  min-height:500px;
  box-shadow:0 16px 40px rgba(15,23,42,.26);
}

.hm-story-img{
  position:absolute;
  inset:0;
  background:#020617 center/cover no-repeat;
  transform:scale(1.03);
  transition:transform .7s ease;
}
.hm-story-overlay{
  position:absolute;
  inset:0;
  padding:18px 18px 20px;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
  background:linear-gradient(180deg,rgba(15,23,42,.05),rgba(15,23,42,.86));
}
.hm-story-card:hover .hm-story-img{
  transform:scale(1.09);
}
.hm-story-pill{
  align-self:flex-start;
  padding:.25rem .7rem;
  border-radius:999px;
  border:1px solid rgba(248,250,252,.8);
  background:rgba(15,23,42,.55);
  color:#e5e7eb;
  font:700 .7rem/1 "Inter";
  text-transform:uppercase;
  letter-spacing:.18em;
  margin-bottom:.55rem;
}
.hm-story-title{
  margin:0 0 .25rem;
  font:800 1.3rem/1.2 "Epilogue";
  color:#f9fafb;
}
.hm-story-chapo{
  margin:0;
  font:500 .9rem/1.4 "Inter";
  color:#e5e7eb;
}
.hm-stories-footer{
  text-align:center;
  margin-top:18px;
}
.hm-story-more{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:.8rem 1.5rem;
  border-radius:999px;
  border:2px solid #111827;
  font:800 .95rem/1 "Epilogue";
  text-decoration:none;
  color:#111827;
  background:#fff;
}
.hm-story-more:hover{
  background:#111827;
  color:#fff;
}

/* ====== CTA ====== */
.hm-cta{
  text-align:center;
  color:#fff;
  background: linear-gradient(160deg, var(--a1), color-mix(in oklab, var(--a1), var(--a2) 40%));
  padding:clamp(2.4rem,5vw,4.2rem) 0;
}
.hm-cta h2{
  margin:0 0 .6rem;
  font:900 clamp(1.6rem,3vw,2.2rem)/1.1 "Epilogue";
}
.hm-cta p{
  margin:0 0 1rem;
  font:700 1rem/1.6 "Inter";
  opacity:.98;
}
.hm-cta .buttons{
  display:flex; gap:12px; justify-content:center; flex-wrap:wrap;
}
.hm-cta .btn{
  display:inline-block;
  border-radius:999px;
  padding:.9rem 1.3rem;
  text-decoration:none;
  font:900 1rem/1 "Epilogue";
}
.hm-cta .btn.primary{
  background:#fff; color:#111827;
  box-shadow:0 10px 26px rgba(0,0,0,.12);
}
.hm-cta .btn.secondary{
  background:transparent;
  border:2px solid #fff;
  color:#fff;
}
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<% content_for :scripts do %>
<script>
window.DeclicCleanMd = function(md){
  return (md || "")
    .replace(/!\[[^\]]*\]\([^\)]+\)/g, "")
    .replace(/\[([^\]]+)\]\((.*?)\)/g, "$1")
    .replace(/[*_`>#]/g, "")
    .replace(/\s+/g, " ")
    .trim();
};
</script>

<script>
document.addEventListener('turbo:load', bootHome);
document.addEventListener('DOMContentLoaded', bootHome);

function bootHome(){
  const mapEl = document.getElementById('map');
  if (!mapEl || !window.L) return;

  let map = window._declicMap;
  if (!map) {
    map = L.map(mapEl, { zoomControl:true, attributionControl:false }).setView([46.6, 2.2], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      detectRetina: true,
      crossOrigin: true
    }).addTo(map);
    window._declicMap = map;
  } else {
    requestAnimationFrame(()=> map.invalidateSize());
  }

  map.on('click', () => map.closePopup());

  if (!window._declicDataInit) {

    const colors = {
      benevolat:   '#f43f5e',
      ecologiser:  '#16a34a',
      formation:   '#3b82f6',
      rencontres:  '#facc15',
      entreprendre:'#f59e0b',
      histoires:   '#a855f7',
      default:     '#7e5bef'
    };
    const emojis = {
      benevolat:   '‚ù§Ô∏è',
      ecologiser:  'üå±',
      formation:   'üìò',
      rencontres:  'ü§ù',
      entreprendre:'üöÄ',
      histoires:   'üìñ',
      default:     'üìç'
    };

    const iconFor = (c) => {
      const em = emojis[c] || emojis.default;
      const baseStyle =
        "width:26px;height:26px;border-radius:9999px;border:2px solid #fff;" +
        "display:grid;place-items:center;color:#fff;font-size:14px;" +
        "box-shadow:0 1px 4px rgba(0,0,0,.25);";
      let extraStyle;
      if (c === 'histoires') {
        extraStyle =
          "background:linear-gradient(135deg,#f97316,#ec4899,#3b82f6,#22c55e,#f59e0b);" +
          "background-size:320% 320%;animation:gradientShift 8s ease infinite;";
      } else {
        const bg = colors[c] || colors.default;
        extraStyle = `background:${bg};`;
      }

      return L.divIcon({
        className: '',
        html: `<div style="${baseStyle}${extraStyle}"><span>${em}</span></div>`,
        iconSize: [26, 32],
        iconAnchor: [13, 28],
        popupAnchor: [0, -16]
      });
    };

    const esc = s => (s || '').toString()
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');

    function mdPlain(s){
      return (s||'')
        .replace(/### √Ä quoi √ßa ressemble \?/gi, '')
        .replace(/üí°/g, '')
        .replace(/!\[[^\]]*\]\([^\)]+\)/g,' ')
        .replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'$1')
        .replace(/https?:\/\/\S+/g,' ')
        .replace(/[\*_`>#]/g,'')
        .replace(/\s+/g,' ')
        .trim();
    }

    // Nouvelle fonction POPUP MODERNIS√âE
    function popupHtml(o){
      const cats = {
        benevolat:    { color: '#f43f5e', label: 'B√©n√©volat' },
        ecologiser:   { color: '#16a34a', label: '√âcologie' },
        formation:    { color: '#3b82f6', label: 'Formation' },
        rencontres:   { color: '#facc15', label: 'Rencontres' },
        entreprendre: { color: '#f59e0b', label: 'Entreprise' },
        histoires:    { color: '#a855f7', label: 'T√©moignage' },
        default:      { color: '#7e5bef', label: 'Initiative' }
      };

      const cKey = (o.category||'').toLowerCase();
      const conf = cats[cKey] || cats.default;

      const base = (cKey==='histoires') ? '/stories' : '/opportunities';
      const url = `${base}/${o.slug||o.id}`;

      let dateStr = "";
      if(o.starts_at || o.date) {
        const d = new Date(o.starts_at || o.date);
        dateStr = d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
      }

      const img = (function thumbForJs(obj){
        if(obj.image_url) return obj.image_url;
        if(cKey==='benevolat') return 'https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?w=400&q=80&fit=crop';
        if(cKey==='formation') return 'https://images.unsplash.com/photo-1555949963-ff9fe0c870eb?w=400&q=80&fit=crop';
        if(cKey==='rencontres') return 'https://images.unsplash.com/photo-1511632765486-a01980e01a18?w=400&q=80&fit=crop';
        return 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&q=80&fit=crop';
      })(o);

      const safeTitle = esc(mdPlain(o.title||''));
      const safeLoc = esc(o.location || '');
      const safeOrg = esc(o.organization || '');

      return `
        <div class="dc-pop-card" style="--cat-color: ${conf.color}">
          <div class="dc-pop-hero" style="background-image: url('${img}')">
            <span class="dc-pop-badge">${conf.label}</span>
          </div>

          <div class="dc-pop-body">
            <h3 class="dc-pop-title">${safeTitle}</h3>

            <div class="dc-pop-meta">
              ${safeOrg ? `<span>üè¢ ${safeOrg}</span>` : ''}
              ${dateStr ? `<span>üóìÔ∏è ${dateStr}</span>` : ''}
              ${safeLoc ? `<span>üìç ${safeLoc}</span>` : ''}
            </div>

            <a href="${url}" class="dc-pop-btn">
              Voir le d√©clic ‚Üí
            </a>
          </div>
        </div>
      `;
    }

    const dataLayer = L.layerGroup().addTo(map);
    window._declicDataLayer = dataLayer;
    let dataset = [];

    function plot(items){
      dataLayer.clearLayers();
      const bounds=[];
      (items||[]).forEach(o=>{
        if(!o.latitude || !o.longitude) return;
        const marker = L.marker([o.latitude,o.longitude], { icon:iconFor((o.category||'').toLowerCase()) })
          .addTo(dataLayer)
          .bindPopup(
            popupHtml(o),
            {
              className: "dc-popup",
              closeButton: true,
              maxWidth: 300, // On laisse un peu de marge
              minWidth: 280,
              keepInView: true,
              autoPan: true,
              autoPanPaddingTopLeft: [10, 60],
              autoPanPaddingBottomRight: [10, 10]
            }
          );

        marker.on("click", () => marker.openPopup());
        bounds.push([o.latitude,o.longitude]);
      });
      if(bounds.length){ map.fitBounds(bounds,{padding:[30,30]}); }
    }

    Promise.all([
      fetch('/api/v1/opportunities').then(r=>r.ok?r.json():[]).catch(()=>[]),
      fetch('/api/v1/stories').then(r=>r.ok?r.json():[]).catch(()=>[])
    ]).then(([opps, stories])=>{
      (stories||[]).forEach(s=> s.category='histoires');
      dataset = ([]).concat(opps||[], stories||[]);
      plot(dataset);
    });

    document.querySelectorAll('.chip').forEach(ch=>{
      if (ch.dataset.bound === '1') return;
      ch.dataset.bound = '1';
      ch.addEventListener('click', ()=>{
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('is-active'));
        ch.classList.add('is-active');
        const cat=ch.dataset.cat;
        if(cat==='toutes'){ plot(dataset); return; }
        plot((dataset||[]).filter(o=> (o.category||'').toLowerCase()===cat));
      });
    });

    window._declicDataInit = true;
    window._declicPlot = plot;
  }

  if (!window._declicMeLayer) window._declicMeLayer = L.layerGroup().addTo(map);
  window._declicMeLayer.clearLayers();

  let meDot=null, meHalo=null, meAcc=null;

  function updateMe(lat, lng, acc){
    const p=[lat,lng];

    if (!meHalo) {
      meHalo = L.circleMarker(p, { radius:12, color:'#ffffff', opacity:0.9, weight:3, fill:true, fillOpacity:.15 })
        .addTo(window._declicMeLayer);
    } else { meHalo.setLatLng(p); }

    if (!meDot) {
      meDot = L.circleMarker(p, { radius:7, color:'#2563eb', weight:2, fill:true, fillOpacity:1 })
        .addTo(window._declicMeLayer);
    } else { meDot.setLatLng(p); }

    const r = (acc && isFinite(acc)) ? Math.min(Math.max(acc, 80), 1200) : 0;
    if (r) {
      if (!meAcc) meAcc = L.circle(p, { radius:r, color:'#60a5fa', weight:1, fill:true, fillOpacity:.12 })
        .addTo(window._declicMeLayer);
      meAcc.setLatLng(p); meAcc.setRadius(r);
    }
  }

  // --- CORRECTION GEOLOCALISATION ---
  // On remplace la fonction simple par une version plus robuste (timeout 15s + erreurs)

  const btnEl = document.getElementById('btn-locate');
  function bindLocateButton(){
    if (!btnEl) return;
    const btn = btnEl.cloneNode(true); btnEl.replaceWith(btn);
    btn.addEventListener('click', ()=> (window._declicWatchId ? stopFollow() : startFollow()));
    window._declicButton = btn;
  }
  bindLocateButton();

  function startFollow(){
    if (!('geolocation' in navigator)) {
      alert("La g√©olocalisation n'est pas disponible sur cet appareil.");
      return;
    }
    if (window._declicWatchId) return;

    // Feedback imm√©diat
    if (window._declicButton) window._declicButton.innerHTML = '<span>‚è≥</span> <span>Recherche...</span>';

    const geoOptions = { enableHighAccuracy:true, timeout:15000, maximumAge:0 };

    navigator.geolocation.getCurrentPosition(
      p => {
        updateMe(p.coords.latitude, p.coords.longitude, p.coords.accuracy);
        // Si on trouve, on change le bouton
        if (window._declicButton) window._declicButton.innerHTML = '<span>üõë</span> <span>Arr√™ter le suivi</span>';
        // On recentre la carte sur l'utilisateur
        const map = window._declicMap;
        if(map) map.panTo([p.coords.latitude, p.coords.longitude], { animate:true });
      },
      e => {
        console.warn('[geo] getCurrentPosition ERR', e);
        if(e.code === 1) alert("Vous devez autoriser la g√©olocalisation pour que cela fonctionne.");
        else if(e.code === 3) alert("Le d√©lai d'attente GPS est d√©pass√©. R√©essayez dehors ou avec une meilleure connexion.");
        stopFollow();
      },
      geoOptions
    );

    window._declicWatchId = navigator.geolocation.watchPosition(
      p => updateMe(p.coords.latitude, p.coords.longitude, p.coords.accuracy),
      e => console.warn('[geo] watch ERR', e),
      geoOptions
    );
  }

  function stopFollow(){
    if (window._declicWatchId) { navigator.geolocation.clearWatch(window._declicWatchId); window._declicWatchId=null; }
    if (window._declicButton) window._declicButton.innerHTML = '<span>üìç</span> <span>Me localiser</span>';
  }
}
</script>
<% end %>
