<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>D√©clic ‚Äî Trouvez votre prochaine opportunit√© de changement</title>
  <meta name="description" content="B√©n√©volat, formations, rencontres, reconversion‚Ä¶ D√©couvrez des opportunit√©s pr√®s de chez vous.">

  <!-- Tailwind (CDN pour la maquette) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: { brand: { 600:'#4f46e5', 700:'#4338ca' } }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body { font-family: 'Inter', sans-serif; }
    /* Hauteur de carte responsive */
    #map { height: 360px; } @media (min-width:1024px){ #map{ height:420px; } }
    /* Espace sous header fixe */
    :root { --safe-top: env(safe-area-inset-top, 0px); }
    .hero-pad { padding-top: calc(64px + var(--safe-top)); }
    /* Pins emoji */
    .picon{ width:26px;height:26px;border-radius:9999px;border:2px solid #fff;display:grid;place-items:center;
      color:#fff;font-size:14px;box-shadow:0 1px 4px rgba(0,0,0,.25);position:relative;background:var(--c,#6366f1);}
    .picon::after{content:"";position:absolute;left:50%;bottom:-6px;transform:translateX(-50%);
      border:6px solid transparent;border-top-color:var(--c,#6366f1);}
    /* Chips */
    .chip{ transition:.15s; } .chip.is-active{ background:#111827;color:#fff; }
    /* Drawer: cach√© par d√©faut (√©vite chevauchements) */
    #mobile-menu[aria-hidden="true"]{ display:none!important; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
<div class="flex min-h-screen flex-col">

  <!-- ===== Header fixe ===== -->
  <header class="fixed inset-x-0 top-0 z-[70] bg-white/90 backdrop-blur border-b border-gray-100">
    <div class="mx-auto max-w-7xl h-14 px-4 sm:px-6 lg:px-8 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2">
        <span class="grid place-items-center w-7 h-7 rounded-lg bg-gradient-to-br from-fuchsia-600 via-purple-600 to-indigo-600 text-white text-[11px] font-bold">D</span>
        <span class="font-semibold">D√©clic</span>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#explorer" class="hover:text-gray-900">Explorer</a>
        <a href="#parcours" class="hover:text-gray-900">Parcours</a>
        <a href="#temoignages" class="hover:text-gray-900">T√©moignages</a>
        <a href="/opportunities/new" class="ml-2 inline-flex items-center px-3 py-1.5 rounded-lg bg-brand-600 text-white font-medium hover:bg-brand-700">Proposer</a>
      </nav>
      <button id="btn-open-menu" class="md:hidden inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50" aria-controls="mobile-menu" aria-expanded="false">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
    </div>
  </header>

  <!-- ===== Drawer mobile droit ===== -->
  <div id="mobile-menu" class="fixed inset-0 z-[80] hidden" aria-hidden="true">
    <div id="mobile-overlay" data-close class="absolute inset-0 bg-black/40 opacity-0 transition-opacity duration-200"></div>
    <aside id="mobile-panel" class="absolute right-0 top-14 w-72 sm:w-80 max-w-[80%] h-auto max-h-[calc(100vh-56px)] overflow-auto bg-white shadow-xl border-l border-gray-100 rounded-bl-2xl transform translate-x-full transition-transform duration-200">
      <div class="px-4 py-3 flex items-center justify-between border-b border-gray-100">
        <div class="flex items-center gap-2">
          <span class="grid place-items-center w-7 h-7 rounded-lg bg-gradient-to-br from-fuchsia-600 via-purple-600 to-indigo-600 text-white text-[11px] font-bold">D</span>
          <span class="font-semibold">D√©clic</span>
        </div>
        <button id="btn-close-menu" class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <nav class="p-4 space-y-1 text-sm">
        <a href="#explorer" data-close class="block px-3 py-2 rounded-lg hover:bg-gray-50">Explorer</a>
        <a href="#parcours" data-close class="block px-3 py-2 rounded-lg hover:bg-gray-50">Parcours</a>
        <a href="#temoignages" data-close class="block px-3 py-2 rounded-lg hover:bg-gray-50">T√©moignages</a>
        <a href="/opportunities/new" class="mt-2 block px-3 py-2 rounded-lg bg-brand-600 text-white font-medium text-center hover:bg-brand-700">Proposer une opportunit√©</a>
      </nav>
    </aside>
  </div>

  <!-- ===== Hero ===== -->
  <section class="relative hero-pad">
    <div class="absolute inset-0">
      <img src="https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?q=80&w=1920&auto=format&fit=crop" alt="" class="w-full h-full object-cover"/>
    </div>
    <div class="absolute inset-0 bg-gradient-to-r from-fuchsia-800/70 via-purple-700/65 to-emerald-600/60 mix-blend-multiply"></div>

    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 sm:py-12">
      <div class="max-w-3xl">
        <h1 class="text-white text-4xl sm:text-5xl lg:text-6xl font-extrabold leading-tight">
          Trouvez votre prochaine<br/><span class="text-yellow-300">opportunit√© de changement</span>
        </h1>
        <p class="mt-4 text-base sm:text-lg text-white/90 max-w-2xl">B√©n√©volat, formations, rencontres, reconversion‚Ä¶ D√©couvrez des milliers d‚Äôopportunit√©s pr√®s de chez vous.</p>

        <div class="mt-6 flex flex-col sm:flex-row gap-3">
          <a href="#explorer" class="inline-flex items-center justify-center px-4 py-2.5 rounded-lg bg-white text-gray-900 font-semibold hover:bg-gray-50"><span class="mr-2">üó∫Ô∏è</span> Explorer la carte</a>
          <form action="#explorer" class="flex-1 min-w-0">
            <div class="flex items-center bg-white/95 rounded-lg overflow-hidden shadow-sm">
              <span class="pl-3"><svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-4.35-4.35M17 10a7 7 0 1 1-14 0 7 7 0 0 1 14 0z"/></svg></span>
              <input type="text" placeholder="Ville, th√®me, organisation‚Ä¶" class="w-full px-3 py-2.5 bg-transparent focus:outline-none"/>
              <button class="px-4 py-2.5 bg-brand-600 text-white font-medium hover:bg-brand-700">Rechercher</button>
            </div>
          </form>
        </div>

        <ul class="mt-4 flex flex-col sm:flex-row gap-3 sm:gap-6 text-white/95 text-sm">
          <li class="flex items-center"><span class="mr-2">‚úÖ</span><span><strong>15 000+</strong> opportunit√©s r√©f√©renc√©es</span></li>
          <li class="flex items-center"><span class="mr-2">üó∫Ô∏è</span><span><strong>Toute la France</strong> couverte</span></li>
          <li class="flex items-center"><span class="mr-2">üíú</span><span><strong>Gratuit</strong> et accessible √† tous</span></li>
        </ul>
      </div>
    </div>
  </section>

  <!-- ===== Contenu ===== -->
  <main class="flex-1">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
      <!-- IMPORTANT: min-w-0 partout + ordres mobiles -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8 items-start">

<!-- Colonne ‚ÄúChoisissez votre parcours‚Äù (cach√©e sur mobile, ++ grande sur desktop) -->
<div id="parcours"
     class="block order-1 lg:order-none col-span-12 lg:col-span-4 min-w-0 space-y-6">



  <!-- Je veux entreprendre (entreprendre) -->
  <%= link_to parcours_path(category: "entreprendre"),
      class: "block rounded-2xl p-6 lg:p-8 text-white shadow-md transition hover:shadow-lg",
      style: "background:linear-gradient(135deg,#f59e0b 0%,#ef4444 50%,#fb7185 100%);" do %>
    <div class="flex items-start gap-4 lg:gap-5">
      <span class="inline-flex h-12 w-12 lg:h-16 lg:w-16 items-center justify-center rounded-xl bg-white/20 text-2xl lg:text-3xl">üöÄ</span>
      <div class="min-w-0">
        <p class="font-semibold text-lg lg:text-xl">Je veux entreprendre</p>
        <p class="text-white/90 text-[15px] lg:text-base leading-snug">
          Lance ton projet avec le soutien d‚Äôentrepreneurs exp√©riment√©s
        </p>
      </div>
    </div>
  <% end %>


  <!-- Je veux me former(formation) -->
  <%= link_to parcours_path(category: "formation"),
      class: "block rounded-2xl p-6 lg:p-8 text-white shadow-md transition hover:shadow-lg",
      style: "background:linear-gradient(135deg,#6366f1 0%,#38bdf8 100%);" do %>
    <div class="flex items-start gap-4 lg:gap-5">
      <span class="inline-flex h-12 w-12 lg:h-16 lg:w-16 items-center justify-center rounded-xl bg-white/20 text-2xl lg:text-3xl">üìò</span>
      <div class="min-w-0">
        <p class="font-semibold text-lg lg:text-xl">Je veux me former</p>
        <p class="text-white/90 text-[15px] lg:text-base leading-snug">
          D√©couvre des formations pour d√©velopper tes comp√©tences
        </p>
      </div>
    </div>
  <% end %>

    <!-- Je veux aider (b√©n√©volat) -->
  <%= link_to parcours_path(category: "benevolat"),
      class: "block rounded-2xl p-6 lg:p-8 text-white shadow-md transition hover:shadow-lg",
      style: "background:linear-gradient(135deg,#f43f5e 0%,#ec4899 100%);" do %>
    <div class="flex items-start gap-4 lg:gap-5">
      <span class="inline-flex h-12 w-12 lg:h-16 lg:w-16 items-center justify-center rounded-xl bg-white/20 text-2xl lg:text-3xl">‚ù§Ô∏è</span>
      <div class="min-w-0">
        <p class="font-semibold text-lg lg:text-xl">Je veux aider</p>
        <p class="text-white/90 text-[15px] lg:text-base leading-snug">
          Trouve des missions de b√©n√©volat qui correspondent √† tes valeurs
        </p>
      </div>
    </div>
  <% end %>

  <!-- Je veux rencontrer (rencontres) -->
  <%= link_to parcours_path(category: "rencontres"),
      class: "block rounded-2xl p-6 lg:p-8 text-white shadow-md transition hover:shadow-lg",
      style: "background:linear-gradient(135deg,#10b981 0%,#06b6d4 100%);" do %>
    <div class="flex items-start gap-4 lg:gap-5">
      <span class="inline-flex h-12 w-12 lg:h-16 lg:w-16 items-center justify-center rounded-xl bg-white/20 text-2xl lg:text-3xl">ü§ù</span>
      <div class="min-w-0">
        <p class="font-semibold text-lg lg:text-xl">Je veux rencontrer</p>
        <p class="text-white/90 text-[15px] lg:text-base leading-snug">
          Rejoins des communaut√©s et cr√©e des liens authentiques
        </p>
      </div>
    </div>
  <% end %>

<!-- Belles histoires -->
<%= link_to stories_path(category: "belles_histoires"),
    class: "block rounded-2xl p-6 lg:p-8 text-white shadow-md transition hover:shadow-lg",
    style: "background:linear-gradient(135deg,#6d28d9 0%,#a855f7 50%,#d946ef 100%);" do %>
  <div class="flex items-start gap-4 lg:gap-5">
    <span class="inline-flex h-12 w-12 lg:h-16 lg:w-16 items-center justify-center rounded-xl bg-white/20 text-2xl lg:text-3xl">üìñ</span>
    <div class="min-w-0">
      <p class="font-semibold text-lg lg:text-xl">Belles histoires</p>
      <p class="text-white/90 text-[15px] lg:text-base leading-snug">
        D√©couvrez des reconversions et des d√©clics inspirants
      </p>
    </div>
  </div>
<% end %>



</div>



        <!-- Carte ‚Äî 2e en mobile -->
        <section id="explorer" class="order-2 lg:order-none col-span-12 lg:col-span-4 min-w-0">
          <h2 class="text-2xl sm:text-3xl font-extrabold">Explorez les opportunit√©s</h2>
          <p class="text-gray-600 mt-2">D√©couvrez sur la carte toutes les possibilit√©s d‚Äôengagement pr√®s de chez vous</p>

          <div class="mt-4 flex flex-wrap gap-2 text-sm">
            <button data-cat="toutes"       class="chip px-3 py-1 rounded-full bg-gray-200 text-gray-800 is-active">Toutes</button>
            <button data-cat="benevolat"    class="chip px-3 py-1 rounded-full bg-rose-100 text-rose-700">B√©n√©volat</button>
            <button data-cat="formation"    class="chip px-3 py-1 rounded-full bg-blue-100 text-blue-700">Formation</button>
            <button data-cat="rencontres"   class="chip px-3 py-1 rounded-full bg-green-100 text-green-700">Rencontres</button>
            <button data-cat="entreprendre" class="chip px-3 py-1 rounded-full bg-orange-100 text-orange-700">Entreprendre</button>
          </div>

          <div class="mt-4 bg-white rounded-2xl shadow overflow-hidden">
            <div id="map"></div>
          </div>
        </section>

        <!-- Liste ‚Äî 3e en mobile, LIMIT√âE √Ä 3 -->
        <section class="order-3 lg:order-none col-span-12 lg:col-span-4 min-w-0">
          <h2 class="text-2xl sm:text-3xl font-extrabold">Quelques opportunit√©s</h2>
          <p class="text-gray-600 mt-2">Les derni√®res missions et √©v√©nements pr√®s de chez vous</p>

          <div class="mt-6 space-y-4">
            <% Array(@opportunities).first(3).to_a.each do |o| %>
              <article class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md transition">
                <div class="flex items-center gap-2 mb-2">
                  <% badge = case o.category
                    when 'benevolat' then 'bg-rose-100 text-rose-700'
                    when 'formation' then 'bg-blue-100 text-blue-700'
                    when 'rencontres' then 'bg-green-100 text-green-700'
                    else 'bg-orange-100 text-orange-700'
                  end %>
                  <span class="text-xs font-semibold px-2 py-1 rounded-full <%= badge %>"><%= o.category.to_s.capitalize %></span>
                </div>
                <h3 class="font-semibold text-gray-900 truncate"><%= o.title %></h3>
                <p class="text-sm text-gray-600"><%= o.organization %></p>
                <p class="text-sm text-gray-700 mt-2"><%= o.description.to_s.truncate(110) %></p>
                <div class="mt-3 flex items-center justify-between">
                  <div class="flex items-center gap-3 text-xs text-gray-500">
                    <% if o.location.present? %><span>üìç <%= o.location %></span><% end %>
                    <% if o.time_commitment.present? %><span>‚è± <%= o.time_commitment %></span><% end %>
                  </div>
                  <a href="/opportunities/<%= o.respond_to?(:slug) && o.slug.present? ? o.slug : o.id %>" class="inline-flex items-center px-3 py-1.5 rounded-lg bg-brand-600 text-white text-xs font-medium hover:bg-brand-700">En savoir plus</a>
                </div>
              </article>
            <% end %>
          </div>
        </section>

      </div>
    </div>

    <!-- T√©moignages -->
    <section id="temoignages" class="bg-white py-14">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-10">
          <h2 class="text-2xl sm:text-3xl font-extrabold">Ils ont chang√© leur vie</h2>
          <p class="text-gray-600 mt-2">Histoires vraies de personnes qui ont trouv√© leur D√©clic</p>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <% Array(@testimonials).first(4).to_a.each do |t| %>
            <article class="bg-gray-50 rounded-xl border border-gray-100 shadow-sm p-6">
              <div class="flex items-center gap-3 mb-4">

<% logical = t.image_url.to_s.sub(%r{\A/assets/}, '') %>
<% logical = 'avatars/default-avatar.png' unless asset_exists?(logical) %>
<%= image_tag logical, alt: t.name, class: "w-12 h-12 rounded-full object-cover" %>


                <div class="min-w-0">
                  <h3 class="font-semibold truncate"><%= t.name %></h3>
                  <p class="text-xs text-gray-500"><%= t.role %> ‚Äî <%= t.age %> ans</p>
                </div>
              </div>
              <p class="text-gray-700 text-sm leading-relaxed"><%= t.story %></p>
            </article>
          <% end %>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== Footer ===== -->
  <footer class="bg-gray-950 text-white py-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center gap-2 mb-2">
        <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-fuchsia-600 via-purple-600 to-indigo-600 grid place-content-center">
          <span class="text-white font-bold text-[10px]">D</span>
        </div>
        <span class="font-semibold">D√©clic</span>
      </div>
      <p class="text-gray-300 max-w-md">Trouvez votre voie vers l‚Äôengagement et donnez du sens √† votre vie.</p>
      <p class="text-gray-400 mt-3 text-sm">¬© <%= Time.current.year %> D√©clic. Tous droits r√©serv√©s.</p>
    </div>
  </footer>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* Drawer mobile */
(function(){
  const root=document.documentElement, body=document.body;
  const menu=document.getElementById('mobile-menu');
  const panel=document.getElementById('mobile-panel');
  const overlay=document.getElementById('mobile-overlay');
  const openBtn=document.getElementById('btn-open-menu');
  const closeBtn=document.getElementById('btn-close-menu');
  if(!menu||!panel||!overlay||!openBtn||!closeBtn) return;

  const lock=()=>{ root.classList.add('overflow-hidden'); body.classList.add('overflow-hidden'); };
  const unlock=()=>{ root.classList.remove('overflow-hidden'); body.classList.remove('overflow-hidden'); };

  function open(){ menu.removeAttribute('aria-hidden'); menu.classList.remove('hidden'); openBtn.setAttribute('aria-expanded','true'); lock();
    requestAnimationFrame(()=>{ overlay.classList.add('opacity-100'); panel.classList.remove('translate-x-full'); }); }
  function close(){ overlay.classList.remove('opacity-100'); panel.classList.add('translate-x-full');
    const onEnd=()=>{ menu.setAttribute('aria-hidden','true'); menu.classList.add('hidden'); unlock(); panel.removeEventListener('transitionend',onEnd); };
    panel.addEventListener('transitionend',onEnd); openBtn.setAttribute('aria-expanded','false'); }

  openBtn.addEventListener('click',open); closeBtn.addEventListener('click',close);
  menu.querySelectorAll('[data-close]').forEach(el=>el.addEventListener('click',close));
  window.addEventListener('keydown',e=>{ if(e.key==='Escape' && !menu.classList.contains('hidden')) close(); });
})();

/* Carte + filtres (opportunit√©s + belles histoires) */
(function(){
  if(!document.getElementById('map') || !window.L) return;

  const map=L.map('map',{zoomControl:true,scrollWheelZoom:true}).setView([46.6,2.2],6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);

  // Ajout de la cat√©gorie "histoires"
  const colors={benevolat:'#ef4444',formation:'#3b82f6',rencontres:'#10b981',entreprendre:'#f59e0b',histoires:'#a855f7',default:'#6366f1'};
  const emojis={benevolat:'‚ù§Ô∏è',    formation:'üìò',     rencontres:'üë•',       entreprendre:'üíº',        histoires:'üìñ',        default:'‚≠ê'};

  function iconFor(cat){
    const c=colors[cat]||colors.default, e=emojis[cat]||emojis.default;
    return L.divIcon({className:'',html:`<div class="picon" style="--c:${c}"><span>${e}</span></div>`,iconSize:[26,32],iconAnchor:[13,28],popupAnchor:[0,-26]});
  }

  const layerGroup=L.layerGroup().addTo(map);
  let lastPopup=null;

  function addMarker(o){
    if(!o||!o.latitude||!o.longitude) return;
    const cat=(o.category||'').toLowerCase();
    const m=L.marker([o.latitude,o.longitude],{icon:iconFor(cat)}).addTo(layerGroup);
    const url= cat==='histoires' ? `/stories/${o.slug||o.id}` : `/opportunities/${o.slug||o.id}`;
    const badgeBg = {benevolat:'#fee2e2',formation:'#dbeafe',rencontres:'#d1fae5',entreprendre:'#ffedd5',histoires:'#ede9fe'}[cat]||'#eef2ff';
    const label = cat==='histoires' ? 'Belle histoire' : (o.category||'').charAt(0).toUpperCase()+(o.category||'').slice(1);
    m.bindPopup(`<div style="min-width:220px">
      <div style="margin-bottom:6px"><span style="font-size:11px;padding:2px 6px;border-radius:9999px;background:${badgeBg};color:#111;">${label}</span></div>
      <strong>${o.title||''}</strong><br/><small>${o.organization||''}</small>
      <p style="margin:.5rem 0">${(o.description||'').slice(0,110)}${(o.description||'').length>110?'‚Ä¶':''}</p>
      <a href="${url}" class="text-indigo-600 underline text-sm">Voir la fiche</a></div>`);
    m.on('popupopen',e=>{ if(lastPopup && lastPopup!==e.popup) lastPopup.close(); lastPopup=e.popup; });
    return m;
  }

  // Fallbacks fournis par le contr√¥leur (si l‚ÄôAPI ne r√©pond pas)
  const oppFallback=<%= raw(Array(@opportunities).map{|o|{
    id:o.id,slug:(o.respond_to?(:slug) ? o.slug : nil),title:o.title,description:o.description,category:o.category,
    organization:o.organization,location:o.location,latitude:(o.latitude ? o.latitude.to_f : nil),longitude:(o.longitude ? o.longitude.to_f : nil)
  }}.to_json) %>;

  const storiesFallback=<%= raw(defined?(@stories) ? Array(@stories).map{|s|{
    id:s.id,slug:(s.respond_to?(:slug) ? s.slug : nil),title:(s.respond_to?(:title) ? s.title : ''),description:(s.try(:chapo)||s.try(:description)||''),
    category:'histoires',organization:(s.try(:source_name)||s.try(:organization)||''),location:s.try(:location)||'',
    latitude:(s.try(:latitude) ? s.latitude.to_f : nil),longitude:(s.try(:longitude) ? s.longitude.to_f : nil)
  }}.to_json : '[]') %>;

  let opportunities=[], stories=[];
  let currentCat='toutes';

  function plot(items){
    layerGroup.clearLayers();
    const bounds=[];
    items.forEach(o=>{ const m=addMarker(o); if(m) bounds.push([o.latitude,o.longitude]); });
    if(bounds.length) map.fitBounds(bounds,{padding:[30,30]});
  }

  function dataset(cat){
    const opps = opportunities||[], hist = stories||[];
    if(cat==='toutes') return [...opps, ...hist];
    if(cat==='histoires') return hist;
    return opps.filter(o=>(o.category||'').toLowerCase()===cat);
  }

  // Chargement API ‚Üí fallback
  fetch('/api/v1/opportunities')
    .then(r=>r.ok?r.json():Promise.reject())
    .then(data=>{ opportunities = Array.isArray(data)?data:[]; window.__opps=opportunities; plot(dataset(currentCat)); })
    .catch(()=>{ opportunities = oppFallback||[]; window.__opps=opportunities; plot(dataset(currentCat)); });

  fetch('/api/v1/stories')
    .then(r=>r.ok?r.json():Promise.reject())
    .then(data=>{ stories = Array.isArray(data)?data.map(s=>({...s, category:'histoires'})):[]; window.__stories=stories; plot(dataset(currentCat)); })
    .catch(()=>{ stories = storiesFallback||[]; window.__stories=stories; plot(dataset(currentCat)); });

  // Filtres (n√©cessite un bouton .chip[data-cat="histoires"] si tu veux filtrer)
  const chips=[...document.querySelectorAll('.chip')];
  chips.forEach(chip=>chip.addEventListener('click',()=>{
    chips.forEach(c=>c.classList.remove('is-active')); chip.classList.add('is-active');
    currentCat=chip.dataset.cat;
    plot(dataset(currentCat));
  }));
})();

</script>
</body>
</html>

