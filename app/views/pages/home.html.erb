<%# app/views/pages/home.html.erb ‚Äî v9.5 : fix t√©moignages (grille + cartes + avatars) %>

<%#
  Nettoyage l√©ger Markdown c√¥t√© ERB pour √©viter que les images Unsplash s'affichent en texte
%>

<%
def strip_unsplash_md(txt)
  s = txt.to_s.dup
  # Supprime images Markdown ![...](url)
  s.gsub!(/!\[[^\]]*\]\([^)]+\)/, " ")
  # Remplace liens Markdown [texte](url) -> texte
  s.gsub!(/\[([^\]]+)\]\([^\)]+\)/, '\1')
  # Supprime toutes les URLs brutes
  s.gsub!(%r{https?://\S+}, ' ')
  # Supprime les titres Markdown (###, ##, #) - √âCHAPP√â correctement
  s.gsub!(/^\#{1,6}\s+/, '')
  s.gsub!(/\s\#{1,6}\s+/, ' ')
  # Supprime le gras/italique (**texte**, *texte*, __texte__, _texte_)
  s.gsub!(/\*\*([^\*]+)\*\*/, '\1')
  s.gsub!(/\*([^\*]+)\*/, '\1')
  s.gsub!(/__([^_]+)__/, '\1')
  s.gsub!(/_([^_]+)_/, '\1')
  # Supprime autres marqueurs Markdown
  s.gsub!(/`([^`]+)`/, '\1')  # code inline
  s.gsub!(/[>\-\+]{1,}\s*/, '')  # listes, citations (sans # qui pose probl√®me)
  # Nettoie espaces multiples
  s.gsub!(/\s+/, ' ')
  s.strip
end
%>

<div class="home-ms">
<!-- HERO -->
<header class="hm-hero" role="banner">
<%= link_to "‚ö°Ô∏è Pourquoi D√©clic ?", philosophie_path, class: "hm-badge", aria: { label: "Pourquoi D√©clic ?" } %>

<div class="hm-hero-inner">
<div class="container">
<h1 class="hm-title">
Change ta vie, <span class="grad">en quelques clics</span>
</h1>
<p class="hm-chapo">
D√©clic agr√®ge les mille et une opportunit√©s locales pour entreprendre, se former, rencontrer,
aider ‚Äî et pour d√©couvrir des <strong>‚Äúbelles histoires‚Äù</strong> qui inspirent.
</p>

<dl class="hm-stats">
<div><dt>Opportunit√©s</dt><dd>15&nbsp;000+</dd></div>
<div><dt>Villes</dt><dd>300+</dd></div>
<div><dt>Communaut√©</dt><dd>10k</dd></div>
</dl>
</div>
</div>

<% hero_src = (asset_path('hero_home.jpg') rescue nil)
hero_src ||= "https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?q=80&w=2400&auto=format&fit=crop" %>
<div class="hm-hero-img" style="--hero:url('<%= hero_src %>')"></div>
</header>

<!-- PARCOURS -->
<section id="parcours" class="hm-slice alt">
<div class="container">
<h2 class="hm-h2">Choisis ton D√©clic</h2>

<div class="hm-grid-cards">
<% btn_base = "hm-card" %>

<%= link_to parcours_path(category: "entreprendre"), class: "#{btn_base} -entreprendre" do %>
<span class="hm-emoji">üöÄ</span>
<div class="hm-card-txt">
<p class="t1">Je veux entreprendre</p>
<p class="t2">Lance ton projet avec des mentors</p>
</div>
<% end %>

<%= link_to parcours_path(category: "formation"), class: "#{btn_base} -formation" do %>
<span class="hm-emoji">üìò</span>
<div class="hm-card-txt">
<p class="t1">Je veux me former</p>
<p class="t2">Des formations pour progresser</p>
</div>
<% end %>

<%= link_to parcours_path(category: "benevolat"), class: "#{btn_base} -benevolat" do %>
<span class="hm-emoji">‚ù§Ô∏è</span>
<div class="hm-card-txt">
<p class="t1">Je veux aider</p>
<p class="t2">Des missions utiles et humaines</p>
</div>
<% end %>

<%= link_to parcours_path(category: "rencontres"), class: "#{btn_base} -rencontres" do %>
<span class="hm-emoji">ü§ù</span>
<div class="hm-card-txt">
<p class="t1">Je veux rencontrer</p>
<p class="t2">Des communaut√©s pr√®s de chez toi</p>
</div>
<% end %>

<%= link_to stories_path, class: "#{btn_base} -histoires" do %>
<span class="hm-emoji">üìñ</span>
<div class="hm-card-txt">
<p class="t1">‚ÄúBelles histoires !‚Äù</p>
<p class="t2">D√©clics, reconversions, prises de risque</p>
</div>
<% end %>
</div>
</div>
</section>

<!-- CARTE -->
<section id="explorer" class="hm-slice bg-muted grad-behind-map">
<div class="container">
<h2 class="hm-h2">Explorez les opportunit√©s</h2>
<p class="hm-sub">D√©couvre sur la carte toutes les possibilit√©s d‚Äôengagement pr√®s de chez toi.</p>

<div class="hm-filterbar">
<button class="chip is-active" data-cat="toutes">üåç Toutes</button>
<button class="chip" data-cat="benevolat">‚ù§Ô∏è B√©n√©volat</button>
<button class="chip" data-cat="formation">üìò Formation</button>
<button class="chip" data-cat="rencontres">üë• Rencontres</button>
<button class="chip" data-cat="entreprendre">üíº Entreprendre</button>
<button class="chip" data-cat="histoires">üìñ Belles histoires</button>
</div>

<div class="hm-mapwrap">
<div id="map" class="hm-map"></div>
<button id="btn-locate" class="hm-locate"><span>üìç</span> <span>Me localiser</span></button>
</div>
</div>
</section>

<!-- QUELQUES OPPORTUNIT√âS -->
<section class="hm-slice grad-soft">
<div class="container">
<h2 class="hm-h2">Quelques opportunit√©s</h2>
<div class="hm-cards">
<% (@opportunities || []).first(6).each do |o| %>
<%= link_to opportunity_path(o), class: "hm-card-op" do %>
<p class="k"><%= o.category.to_s.capitalize %></p>
<p class="t"><%= o.title %></p>
<p class="d"><%= strip_unsplash_md(o.description) %></p>
<p class="l">üìç <%= o.location %></p>
<% end %>
<% end %>
</div>
</div>
</section>

<!-- T√âMOIGNAGES -->
<section id="temoignages" class="hm-slice bg-muted grad-behind-testis">
<div class="container">
<h2 class="hm-h2">Ils/elles ont trouv√© leur d√©clic</h2>

<%
# Portraits pour les t√©moignages (dans app/assets/images/avatars)
# Mapping bas√© sur le nom du t√©moignage
avatar_mapping = {
  'Marie' => asset_path('avatars/Marie.jpeg'),
  'Thomas' => asset_path('avatars/Thomas.jpeg'),
  'Emma' => asset_path('avatars/Emma.jpeg'),
  'Julien' => asset_path('avatars/Julien.jpeg')
}

# Fallback g√©n√©rique
default_avatar = asset_path('avatars/default-avatar.png')
%>

<div class="hm-testis">
<% (@testimonials || []).each do |t| %>
<%
# Utilise l'avatar bas√© sur le nom, sinon le default
img = avatar_mapping[t.name] || default_avatar
%>

<article class="hm-testi">
<div class="who">
<img src="<%= img %>" alt="<%= t.name %>" width="64" height="64"
class="hm-avatar" loading="lazy"
onerror="this.src='<%= default_avatar %>'">
<div class="id">
<p class="name"><%= t.name %></p>
<p class="role"><%= t.role %></p>
</div>
</div>
<p class="story"><%= t.story %></p>
</article>
<% end %>
</div>
</div>
</section>



<!-- CTA -->
<section class="hm-cta">
<div class="container">
<h2>Envie d‚Äôagir √† ton tour ?</h2>
<p>D√©couvre des opportunit√©s pr√®s de chez toi ou partage ta propre histoire pour inspirer d‚Äôautres personnes.</p>
<div class="buttons">
<%= link_to "Voir les actions locales", (url_for(controller: :opportunities, action: :index, category: 'toutes') rescue root_path(anchor:"explorer")), class: "btn primary" %>
<%= link_to "Partager mon histoire", (respond_to?(:new_story_path) ? new_story_path : stories_path), class: "btn secondary" %>
</div>
</div>
</section>
</div>

<style>
/* ====== Th√®me global ====== */
.home-ms{ --a1:#7e5bef; --a2:#3b82f6; --muted:#f4f2fb; color:#0f172a; font-family:"Inter",system-ui,sans-serif;
background: radial-gradient(1400px 800px at 10% -10%, #efe8ff 0%, transparent 60%) no-repeat,
linear-gradient(180deg, #fbfaff 0%, #f6f3ff 60%, #f3f1ff 100%); }
.home-ms .container{ max-width:1280px; margin:0 auto; padding:0 24px; }
[id]{ scroll-margin-top:96px; }

/* ====== HERO ====== */
.hm-hero{ position:relative; color:#fff; overflow:hidden; background:linear-gradient(160deg,var(--a1),var(--a2)); }
.hm-hero-inner{ position:relative; padding-top:clamp(72px,8vw,120px); padding-bottom:clamp(44px,6.5vw,84px); z-index:10; }
.hm-hero::after{ content:""; position:absolute; inset:0; background:linear-gradient(180deg,rgba(7,9,22,.62),rgba(7,9,22,.62)); mix-blend:multiply; z-index:2; }
.hm-hero-img{ position:absolute; inset:0; background:var(--hero,none) center/cover no-repeat; filter:blur(2px) saturate(1.05) brightness(0.9); opacity:.85; z-index:1; }

/* Badge */
.hm-badge{
position:absolute; top:14px; right:calc(18px + env(safe-area-inset-right)); z-index:30;
display:inline-flex; align-items:center; gap:.55rem; padding:.55rem .9rem; border-radius:999px;
font:900 .95rem/1 "Epilogue"; color:#1e1b4b; background:linear-gradient(135deg,#fef3c7,#fde68a,#fcd34d);
box-shadow:0 8px 20px rgba(0,0,0,.12); border:1px solid rgba(17,24,39,.06); text-decoration:none;
}
@media (min-width:1024px){ .hm-badge{ padding:.7rem 1.1rem; font-size:1.05rem; } .hm-badge:hover{ transform:translateY(-1px); transition:transform .12s ease; } }
@media (max-width:480px){ .hm-badge{ top:10px; right:10px; font-size:.88rem; padding:.45rem .7rem; } }

.hm-title{ font-family:"Epilogue",Inter; font-weight:900; letter-spacing:-.02em; line-height:1.03; font-size:clamp(2.8rem,5vw,4.6rem); margin:.2rem 0 .5rem; text-shadow:0 2px 16px rgba(0,0,0,.25); }
.hm-title .grad{ background:linear-gradient(90deg,#f472b6,#a855f7,#6366f1); -webkit-background-clip:text; background-clip:text; color:transparent; }
.hm-chapo{ max-width:980px; font:600 clamp(1.12rem,1.05vw + .9rem,1.5rem)/1.65 "Inter"; text-shadow:0 1px 8px rgba(0,0,0,.18); }

.hm-stats{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:16px; margin-top:18px; }
.hm-stats>div{ background:rgba(255,255,255,.92); backdrop-filter: blur(6px); border:1px solid #e6e8ee; border-radius:18px; padding:16px 18px; box-shadow:0 12px 34px rgba(15,23,42,.18); color:#0f172a; text-align:center; }
.hm-stats dt{ font:700 .82rem/1 "Inter"; color:#6b7280; text-transform:uppercase; letter-spacing:.04em; }
.hm-stats dd{ margin:.25rem 0 0; font:900 1.8rem/1 "Epilogue"; }
@media (max-width:640px){ .hm-stats{ grid-template-columns:1fr; gap:10px; } .hm-stats>div{ padding:12px 14px; } .hm-stats dd{ font-size:1.4rem; } }

/* ====== Slices ====== */
.hm-slice{ padding:clamp(2rem,4.8vw,4rem) 0; }
.hm-slice.alt{ background: radial-gradient(920px 440px at 8% -12%, #efe8ff 0%, transparent 60%) no-repeat,
linear-gradient(180deg,#f6f2ff 0%, #ede9fe 100%); }
.bg-muted{ background:var(--muted); }
.grad-soft{ background: radial-gradient(900px 420px at 85% -10%, #eee7ff 0%, transparent 66%),
linear-gradient(180deg,#f9f7ff 0%, #f3f1ff 100%); }
.grad-behind-map{ background: radial-gradient(980px 460px at 50% -14%, #e9e2ff 0%, transparent 70%), var(--muted); }
.grad-behind-testis{ background: radial-gradient(820px 380px at 12% 118%, #ece6ff 0%, transparent 66%), var(--muted); }

.hm-h2{ font-family:"Epilogue"; font-weight:900; font-size:clamp(2.1rem,3.2vw,2.7rem); color:#0f172a; margin:0 0 1rem; }
.hm-h2::after{ content:""; display:block; width:100px; height:6px; border-radius:999px; background:var(--a1); margin:.55rem 0 .1rem; }
.hm-sub{ margin:.2rem 0 1rem; color:#475569; font-size:1.05rem; }


/* ====== GROS BOUTONS ====== */
.hm-grid-cards{
  display:flex;
  flex-wrap: wrap;
  justify-content: center;
  gap:28px;
  max-width:1220px;
  margin-inline:auto;
}

.hm-card{
  display:grid;
  grid-template-columns:110px 1fr;
  gap:22px;
  align-items:center;
  padding:36px 30px;
  border-radius:30px;
  color:#fff;
  text-decoration:none;
  box-shadow:0 18px 44px rgba(0,0,0,.16);
  min-height:240px;
  flex: 1 1 calc(33.333% - 19px);
  max-width: 400px;
  transition:transform .15s ease, box-shadow .15s ease;
}

.hm-card:hover{ transform:translateY(-6px); box-shadow:0 22px 62px rgba(0,0,0,.20); }
.hm-emoji{ width:100px; height:100px; border-radius:24px; background:rgba(255,255,255,.22); font-size:50px; display:grid; place-items:center; }
.hm-card-txt .t1{ font:900 clamp(1.2rem,1vw + 1rem,1.6rem)/1.15 "Epilogue"; margin:0; }
.hm-card-txt .t2{ margin-top:.45rem; font:700 clamp(1rem,.7vw + .7rem,1.22rem)/1.45 "Inter"; opacity:.98; }
.hm-card.-entreprendre{ background:linear-gradient(135deg,#f59e0b,#ef4444,#fb7185); }
.hm-card.-formation{ background:linear-gradient(135deg,#6366f1,#38bdf8); }
.hm-card.-benevolat{ background:linear-gradient(135deg,#f43f5e,#ec4899); }
.hm-card.-rencontres{ background:linear-gradient(135deg,#10b981,#06b6d4); }
.hm-card.-histoires{ background:linear-gradient(135deg,#6d28d9,#a855f7,#d946ef); }

@media (max-width:900px){
  .hm-card{
    flex: 1 1 calc(50% - 14px);
  }
}

@media (max-width:560px){
  .hm-card{
    grid-template-columns:80px 1fr;
    padding:22px 18px;
    min-height:192px;
    border-radius:22px;
    flex: 1 1 100%;
  }
  .hm-emoji{
    width:72px;
    height:72px;
    border-radius:18px;
    font-size:36px;
  }
}

/* ====== Carte & filtres ====== */
.hm-filterbar{ display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px; }
.chip{ display:inline-flex; align-items:center; justify-content:center; padding:.6rem 1rem; border-radius:999px; background:#fff; border:1px solid #e6e8ee; font:800 .95rem/1.1 "Inter"; }
.chip.is-active{ background:var(--a1); color:#fff; border-color:transparent; }
.hm-mapwrap{ position:relative; }

/* Carte */
.hm-map{
  height: 560px;
  width: 100%;
  border-radius: 20px;
  border: 1px solid #e6e8ee;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(15,23,42,.10);
}

/* Sur mobile : on laisse le popup d√©passer de la carte */
@media (max-width: 768px){
  .hm-map{
    overflow: visible; /* important pour voir tout le popup */
  }
}



/* ====== LEAFLET popup D√©clic (unique et responsive) ====== */

/* On enl√®ve la marge interne de Leaflet autour du contenu,
   sinon √ßa ajoute des pixels en plus √† la largeur r√©elle */
.leaflet-popup.dc-popup .leaflet-popup-content {
  margin: 0 !important;
  padding: 0;
}

/* Wrapper principal du popup D√©clic */
.leaflet-popup.dc-popup .leaflet-popup-content-wrapper {
  padding: 0;
  border-radius: 16px;
  box-shadow: 0 18px 40px rgba(15,23,42,.18);
  border: 1px solid #eef2f7;

  /* On laisse la largeur s‚Äôadapter, mais jamais plus large que l‚Äô√©cran */
  width: auto !important;
  max-width: calc(100vw - 32px);
}

/* Petite pointe du popup */
.leaflet-popup.dc-popup .leaflet-popup-tip {
  display: block;
}

/* Bouton de fermeture */
.leaflet-popup-close-button {
  color: #0f172a;
  font-weight: 900;
  font-size: 18px;
}

/* Contenu du popup */
.dcpp {
  display: grid;
  grid-template-columns: 56px 1fr;
  gap: 12px;
  padding: 12px;
  box-sizing: border-box;

  max-width: 100%;          /* ne d√©passe pas le wrapper */
  overflow-wrap: anywhere;  /* casse les mots trop longs */
}

.dcpp-img {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  background: #f1f5f9 center/cover no-repeat;
  border: 1px solid #e2e8f0;
}

.dcpp-title{
  font: 900 1rem/1.15 "Epilogue";
  margin: 0 0 4px;
  letter-spacing: -.01em;
}

.dcpp-org{
  font: 700 .9rem/1.3 "Inter";
  color: #475569;
  margin: 0;
}

.dcpp-addr{
  font: 500 .9rem/1.3 "Inter";
  color: #6b7280;
  margin: .2rem 0 .35rem;
}

.dcpp-blurb{
  font: 500 .9rem/1.35 "Inter";
  color: #334155;
  margin: .1rem 0 .5rem;
}

.dcpp-actions{
  display: flex;
  gap: 8px;
  margin-top: .25rem;
}

.dcpp-actions a{
  display: inline-flex;
  align-items: center;
  gap: .4rem;
  font: 800 .9rem/1 "Epilogue";
  text-decoration: none;
  color: #fff;
  padding: .6rem .8rem;
  border-radius: 10px;
  background: var(--cat, #7e5bef);
}

.dcpp a:focus{
  outline: 2px solid #7c3aed;
  outline-offset: 2px;
  border-radius: 8px;
}

/* Version responsive du popup (mobile) */
@media (max-width: 520px) {

  .leaflet-popup.dc-popup .leaflet-popup-content-wrapper {
    border-radius: 14px;
    max-width: calc(100vw - 24px); /* un peu plus serr√© sur les tr√®s petits √©crans */
  }

  .dcpp{
    grid-template-columns: 44px 1fr;
    gap: 10px;
  }

  .dcpp-img{
    width: 44px;
    height: 44px;
  }

  .dcpp-blurb{
    overflow-wrap: anywhere;
    word-break: break-word;
  }
}

/* Sur mobile, on autorise le popup √† d√©passer du div .hm-map,
   mais pas de l‚Äô√©cran (gr√¢ce au max-width ci-dessus) */
@media (max-width: 480px){
  .hm-map{
    overflow: visible;
  }
}




/* ====== Cards opportunit√©s ====== */
.hm-cards{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:18px; }
@media (max-width:980px){ .hm-cards{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
@media (max-width:640px){ .hm-cards{ grid-template-columns:1fr; } }
.hm-card-op{ display:block; padding:18px; border-radius:20px; background:#fff; border:1px solid #e6e8ee; box-shadow:0 10px 26px rgba(15,23,42,.08); text-decoration:none; color:#0f172a; }
.hm-card-op .k{ color:#64748b; font-size:.82rem; margin:0 0 .4rem; }
.hm-card-op .t{ font:900 1.16rem/1.2 "Epilogue"; margin:0; }
.hm-card-op .d{ font:1rem/1.55 "Inter"; color:#475569; margin:.4rem 0 .35rem; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
.hm-card-op .l{ font:1rem/1.4 "Inter"; color:#1f2937; margin:0; }

/* ====== T√âMOIGNAGES (fix) ====== */
.hm-testis{
display:grid;
grid-template-columns:repeat(4, minmax(0,1fr));
gap:18px;
}
@media (max-width:1100px){ .hm-testis{ grid-template-columns:repeat(3, minmax(0,1fr)); } }
@media (max-width:820px){ .hm-testis{ grid-template-columns:repeat(2, minmax(0,1fr)); } }
@media (max-width:520px){ .hm-testis{ grid-template-columns:1fr; } }

.hm-testi{
background:#fff;
border:1px solid #e6e8ee;
border-radius:18px;
padding:16px;
box-shadow:0 10px 26px rgba(15,23,42,.08);
}
.hm-testi .who{
display:flex; align-items:center; gap:12px; margin-bottom:8px;
}
.hm-avatar{
width:64px; height:64px; border-radius:50%;
object-fit:cover; flex:0 0 64px; border:2px solid #fff; box-shadow:0 2px 10px rgba(15,23,42,.12);
}
.hm-testi .name{ margin:0; font:900 1.05rem/1.1 "Epilogue"; color:#0f172a; }
.hm-testi .role{ margin:.15rem 0 0; font:700 .9rem/1.2 "Inter"; color:#64748b; }
.hm-testi .story{
margin:.4rem 0 0; color:#334155; font:500 .98rem/1.45 "Inter";
display:-webkit-box; -webkit-line-clamp:5; -webkit-box-orient:vertical; overflow:hidden;
}



/* ====== CTA ====== */
.hm-cta{ text-align:center; color:#fff; background: linear-gradient(160deg, var(--a1), color-mix(in oklab, var(--a1), var(--a2) 40%)); padding:clamp(2.4rem,5vw,4.2rem) 0; }
.hm-cta h2{ margin:0 0 .6rem; font:900 clamp(1.6rem,3vw,2.2rem)/1.1 "Epilogue"; }
.hm-cta p{ margin:0 0 1rem; font:700 1rem/1.6 "Inter"; opacity:.98; }
.hm-cta .buttons{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
.hm-cta .btn{ display:inline-block; border-radius:999px; padding:.9rem 1.3rem; text-decoration:none; font:900 1rem/1 "Epilogue"; }
.hm-cta .btn.primary{ background:#fff; color:#111827; box-shadow:0 10px 26px rgba(0,0,0,.12); }
.hm-cta .btn.secondary{ background:transparent; border:2px solid #fff; color:#fff; }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>



<% content_for :scripts do %>
<script>
// Nettoyage Markdown (supprime images ![...](...) et transforme [txt](url) -> txt)
window.DeclicCleanMd = function(md){
  return (md || "")
    .replace(/!\[[^\]]*\]\([^\)]+\)/g, "")     // images
    .replace(/\[([^\]]+)\]\((.*?)\)/g, "$1")     // liens
    .replace(/[*_`>#]/g, "")                          // emphases
    .replace(/\s+/g, " ")                            // espaces multiples
    .trim();
};
</script>
<script>
document.addEventListener('turbo:load', bootHome);
document.addEventListener('DOMContentLoaded', bootHome);

function bootHome(){
const mapEl = document.getElementById('map');
if (!mapEl || !window.L) return;

// ---- Map unique ----
let map = window._declicMap;
if (!map) {
map = L.map(mapEl, { zoomControl:true, attributionControl:false }).setView([46.6, 2.2], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
maxZoom: 19,
detectRetina: true,
crossOrigin: true
}).addTo(map);

window._declicMap = map;
} else {
requestAnimationFrame(()=> map.invalidateSize());
}

map.on('click', () => map.closePopup());

if (!window._declicDataInit) {
const colors={benevolat:'#f43f5e',formation:'#3b82f6',rencontres:'#10b981',entreprendre:'#f59e0b',histoires:'#a855f7',default:'#7e5bef'};
const emojis={benevolat:'‚ù§Ô∏è',formation:'üìò',rencontres:'ü§ù',entreprendre:'üöÄ',histoires:'üìñ',default:'üìç'};

const iconFor = (c)=>{
const bg = colors[c] || colors.default;
const em = emojis[c] || emojis.default;
return L.divIcon({
className:'',
html:`<div style="width:26px;height:26px;border-radius:9999px;border:2px solid #fff;display:grid;place-items:center;color:#fff;font-size:14px;box-shadow:0 1px 4px rgba(0,0,0,.25);background:${bg}">${em}</div>`,
iconSize:[26,32], iconAnchor:[13,28], popupAnchor:[0,-16]
});
};

const esc = s => (s || '').toString()
  .replace(/&/g,'&amp;')
  .replace(/</g,'&lt;')
  .replace(/>/g,'&gt;');

const trunc = (s, n = 120) => {
  let t = (s || '').toString();

  // 1) supprime images Markdown ![...](url)
  t = t.replace(/!\[[^\]]*\]\([^)]+\)/g, ' ');
  // 2) transforme [texte](url) -> texte
  t = t.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '$1');
  // 3) supprime toute URL brute restante (dont Unsplash)
  t = t.replace(/https?:\/\/\S+/g, ' ');
  // 4) normalise les espaces
  t = t.replace(/\s+/g, ' ').trim();

  if (t.length <= n) return esc(t);
  const cut = t.slice(0, n);
  const back = cut.lastIndexOf(' ');
  return esc((back > 60 ? cut.slice(0, back) : cut).trim()) + '‚Ä¶';
};


function parseDate(x){ if(!x) return null; const d=new Date(x); return isNaN(d)?null:d; }
function frLongDate(d){ return d?d.toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'}):''; }
function frHM(d){ return d?d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}):''; }

function thumbFor(o){
if(o.image_url) return o.image_url;
const cat=(o.category||'').toLowerCase();
if(cat==='benevolat') return 'https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?q=80&w=300&auto=format&fit=crop';
if(cat==='formation') return 'https://images.unsplash.com/photo-1555949963-ff9fe0c870eb?q=80&w=300&auto=format&fit=crop';
if(cat==='rencontres') return 'https://images.unsplash.com/photo-1511632765486-a01980e01a18?q=80&w=300&auto=format&fit=crop';
if(cat==='entreprendre') return 'https://images.unsplash.com/photo-1556157382-97eda2d62296?q=80&w=300&auto=format&fit=crop';
if(cat==='histoires') return 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=300&auto=format&fit=crop';
return 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=300&auto=format&fit=crop';
}

function mdPlain(s){
  return (s||'')
    .replace(/!\[[^\]]*\]\([^\)]+\)/g,' ')                    // images ![...](...)
    .replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'$1')    // [texte](url) -> texte
    .replace(/https?:\/\/\S+/g,' ')                            // URL brutes
    .replace(/[\*_`>#]/g,'')                                   // emphases MD
    .replace(/\s+/g,' ')                                       // espaces multiples
    .trim();
}
function popupHtml(o){
  // Nettoyage Markdown (√©vite URLs/Unsplash en brut dans l'extrait)
  function stripMd(md){
    return (md||"")
      .replace(/!\[[^\]]*\]\([^\)]+\)/g,"")   // supprime images ![...](...)
      .replace(/\[([^\]]+)\]\((.*?)\)/g,"$1") // [txt](url) -> txt
      .replace(/[*_`>#]/g,"")                // emphases Markdown
      .replace(/\s+/g," ")                   // espaces multiples
      .trim();
  }
  const excerpt = mdPlain(o && o.description ? o.description : '').slice(0,140);

// Nettoyage Markdown (√©vite URLs/Unsplash en brut)
  function cleanMd(md){
    return (md||'')
      .replace(/!\[[^\]]*\]\([^\)]+\)/g, '')     // supprime images ![...](...)
      .replace(/\[([^\]]+)\]\((.*?)\)/g, '$1')    // [txt](url) -> txt
      .replace(/[*_`>#]/g, '')                         // enl√®ve la mise en forme
      .replace(/\s+/g, ' ')                           // espaces multiples
      .trim();
  }

  function cleanMd(md){
    return (md||"")
      .replace(/!\[[^\]]*\]\([^\)]+\)/g, "")
      .replace(/\[([^\]]+)\]\((.*?)\)/g, "$1")
      .replace(/[*_`>#]/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }

const colors={benevolat:'#f43f5e',formation:'#3b82f6',rencontres:'#10b981',entreprendre:'#f59e0b',histoires:'#a855f7',default:'#7e5bef'};
const cat = (o.category||'').toLowerCase();
const ciColor = colors[cat] || colors.default;
const base = (cat==='histoires') ? '/stories' : '/opportunities';
const url = `${base}/${o.slug||o.id}`;
const st = new Date(o.starts_at||o.start_at||o.start_time||o.date||o.scheduled_on);
const en = o.ends_at||o.end_at||o.end_time ? new Date(o.ends_at||o.end_at||o.end_time) : null;
const when = isNaN(st) ? (o.schedule_text||'') : `üìÖ ${st.toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'})} ‚Äî ${st.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}${en?`‚Äì${en.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`:''}`;
const addr = o.location ? `üìç ${o.location}` : '';
const img = thumbFor(o);
  const extract = cleanMd(o.description).slice(0, 140);
const blurb = mdPlain(o.summary || o.description || o.chapo || '').slice(0,140);
return `
<div class="dcpp" style="--cat:${ciColor}" role="dialog" aria-label="Opportunit√©">
<div class="dcpp-img" style="background-image:url('${img}')"></div>
<div>
<h3 class="dcpp-title">${esc(o.title||'')}</h3>
${o.organization?`<p class="dcpp-org">${esc(o.organization)}</p>`:''}
${when?`<p class="dcpp-addr">${esc(when)}</p>`:''}
${addr?`<p class="dcpp-addr">${esc(addr)}</p>`:''}
<p class="dcpp-blurb">${blurb}</p>
<div class="dcpp-actions">
<a href="${url}" aria-label="D√©clic">D√©clic !</a>
</div>
</div>
</div>
`;
}

const dataLayer = L.layerGroup().addTo(map);
window._declicDataLayer = dataLayer;
let dataset = [];

function plot(items){
dataLayer.clearLayers();
const bounds=[];
(items||[]).forEach(o=>{
if(!o.latitude || !o.longitude) return;
const marker = L.marker([o.latitude,o.longitude], { icon:iconFor((o.category||'').toLowerCase()) })
.addTo(dataLayer)

.bindPopup(
  popupHtml(o),
  {
    className: "dc-popup",
    closeButton: true,
    // ‚úÖ FIX: largeur max adapt√©e au container (avec padding 24px √ó 2)
    maxWidth: Math.min(window.innerWidth - 60, 300),
    minWidth: Math.min(window.innerWidth - 80, 240),
    keepInView: true,
    autoPan: true,
    autoPanPaddingTopLeft: [10, 60],
    autoPanPaddingBottomRight: [10, 10]
  }
);


marker.on("click", () => marker.openPopup());
marker.on("popupopen", (e)=> {
const link = e.popup.getElement().querySelector(".dcpp-actions a");
if (link) link.focus({preventScroll:true});
});
bounds.push([o.latitude,o.longitude]);
});
if(bounds.length){ map.fitBounds(bounds,{padding:[30,30]}); }
}

Promise.all([
fetch('/api/v1/opportunities').then(r=>r.ok?r.json():[]).catch(()=>[]),
fetch('/api/v1/stories').then(r=>r.ok?r.json():[]).catch(()=>[])
]).then(([opps, stories])=>{
(stories||[]).forEach(s=> s.category='histoires');
dataset = ([]).concat(opps||[], stories||[]);
plot(dataset);
});

document.querySelectorAll('.chip').forEach(ch=>{
if (ch.dataset.bound === '1') return;
ch.dataset.bound = '1';
ch.addEventListener('click', ()=>{
document.querySelectorAll('.chip').forEach(c=>c.classList.remove('is-active'));
ch.classList.add('is-active');
const cat=ch.dataset.cat;
if(cat==='toutes'){ plot(dataset); return; }
plot((dataset||[]).filter(o=> (o.category||'').toLowerCase()===cat));
});
});

window._declicDataInit = true;
window._declicPlot = plot;
}

// ---- G√©oloc : one-shot + suivi opt-in ----
if (!window._declicMeLayer) window._declicMeLayer = L.layerGroup().addTo(map);
window._declicMeLayer.clearLayers();

let meDot=null, meHalo=null, meAcc=null;

function updateMe(lat, lng, acc){
const p=[lat,lng];

if (!meHalo) {
meHalo = L.circleMarker(p, { radius:12, color:'#ffffff', opacity:0.9, weight:3, fill:true, fillOpacity:.15 })
.addTo(window._declicMeLayer);
} else { meHalo.setLatLng(p); }

if (!meDot) {
meDot = L.circleMarker(p, { radius:7, color:'#2563eb', weight:2, fill:true, fillOpacity:1 })
.addTo(window._declicMeLayer);
} else { meDot.setLatLng(p); }

const r = (acc && isFinite(acc)) ? Math.min(Math.max(acc, 80), 1200) : 0;
if (r) {
if (!meAcc) meAcc = L.circle(p, { radius:r, color:'#60a5fa', weight:1, fill:true, fillOpacity:.12 })
.addTo(window._declicMeLayer);
meAcc.setLatLng(p); meAcc.setRadius(r);
}
}

if ('geolocation' in navigator) {
navigator.geolocation.getCurrentPosition(
pos => {
updateMe(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy);
const p = L.latLng(pos.coords.latitude, pos.coords.longitude);
if (!map.getBounds().pad(-0.05).contains(p)) {
map.panTo(p, { animate:true });
}
},
err => {},
{ enableHighAccuracy:true, timeout:5000, maximumAge:15000 }
);
}

const btnEl = document.getElementById('btn-locate');
function bindLocateButton(){
if (!btnEl) return;
const btn = btnEl.cloneNode(true); btnEl.replaceWith(btn);
btn.addEventListener('click', ()=> (window._declicWatchId ? stopFollow() : startFollow()));
window._declicButton = btn;
}
bindLocateButton();

function startFollow(){
if (!('geolocation' in navigator)) { alert("La g√©olocalisation n'est pas disponible."); return; }
if (window._declicWatchId) return;

navigator.geolocation.getCurrentPosition(
p => updateMe(p.coords.latitude, p.coords.longitude, p.coords.accuracy),
e => console.warn('[geo] getCurrentPosition ERR', e),
{ enableHighAccuracy:true, timeout:8000, maximumAge:0 }
);
window._declicWatchId = navigator.geolocation.watchPosition(
p => updateMe(p.coords.latitude, p.coords.longitude, p.coords.accuracy),
e => console.warn('[geo] watch ERR', e),
{ enableHighAccuracy:true, timeout:20000, maximumAge:5000 }
);
if (window._declicButton) window._declicButton.innerHTML = '<span>üõë</span> <span>Arr√™ter le suivi</span>';
}

function stopFollow(){
if (window._declicWatchId) { navigator.geolocation.clearWatch(window._declicWatchId); window._declicWatchId=null; }
if (window._declicButton) window._declicButton.innerHTML = '<span>üìç</span> <span>Me localiser</span>';
}
}
</script>
<% end %>
